#LyX 2.4 created this file. For more info see https://www.lyx.org/
\lyxformat 620
\begin_document
\begin_header
\save_transient_properties true
\origin unavailable
\textclass book
\begin_preamble
% for: LaTeX DogWagger version=`4.0.1' fileTarget=`dummy.txt' startComment=`#' noWarn=`yes'
%========================================================================
% LaTeX Dogwagger takes LaTeX files and pulls out verbatim comments,    %
% concatenating the text enclosed in these verbatim comments            %
% into executable code. Copyright (C) J van Schalkwyk, 2005.            %
% LaTeX Dogwagger is made available under the GNU Public Licence (GPL). %
% To NOT include a particular verbatim section, a comment line          %
%   containing the text: DogWagger dogsAllowed=`no' must precede *ANY*  %
%   line containing the text \begin{verbatim} !                         %
%===============================================================
%
%\usepackage[dvipsnames]{color} % clashes
% \PassOptionsToPackage{dvipsnames}{color} % Gray fails too
%
\usepackage[compact]{titlesec}
\hyphenation{data-base time-stamps}
\titleformat{\chapter}{\Huge\sffamily}{\thesection}{0.5em}{}
\titleformat{\section}{\LARGE\sffamily}{\thesection}{0.4em}{}
\titleformat{\subsection}{\large\sffamily}{\thesubsection}{0.3em}{}
\titleformat{\subsubsection}{\large\sffamily}{\thesubsubsection}{0.5em}{}

%%%%%%%%%%%%
% Modify format of Table Of Contents:
\usepackage[]{tocloft}

\renewcommand{\cfttoctitlefont}{\hfill\huge\sf}  % Big "Contents" title
\renewcommand{\cftaftertoctitle}{\hfill} % and hfill * 2 centres title. 


\renewcommand{\cftchapfont}{\sf\Large}
\renewcommand{\cftsecfont}{\sf\large}        % section titles in SF, Large.
\renewcommand{\cftsubsecfont}{\sf}             % subsections are SF.
\renewcommand{\cftsubsecpagefont}{\sf}    % page numbers in sans serif

\newlength{\mylen}
\setlength{\mylen}{0.5em}
\addtolength{\cftchapnumwidth}{\mylen}
% \setlength{\cftchapnumwidth}{2em} % chap number in TOC: 2012-04-04
\addtolength{\cftsecindent}{\mylen}


%%% end TOC modification

%%http://en.wikibooks.org/wiki/LaTeX/Internationalization 

% also check out: shorttoc
\end_preamble
\use_default_options false
\begin_modules
theorems-ams
eqs-within-sections
figs-within-sections
\end_modules
\maintain_unincluded_children no
\language british
\language_package auto
\inputencoding utf8
\fontencoding auto
\font_roman "palatino" "Noto Serif"
\font_sans "helvet" "Noto Sans"
\font_typewriter "courier" "DejaVu Sans Mono"
\font_math "auto" "auto"
\font_default_family default
\use_non_tex_fonts true
\font_sc false
\font_roman_osf false
\font_sans_osf false
\font_typewriter_osf false
\font_sf_scale 88 88
\font_tt_scale 90 90
\use_microtype false
\use_dash_ligatures false
\graphics default
\default_output_format default
\output_sync 0
\bibtex_command default
\index_command default
\float_placement H
\float_alignment class
\paperfontsize 10
\spacing single
\use_hyperref true
\pdf_bookmarks false
\pdf_bookmarksnumbered false
\pdf_bookmarksopen false
\pdf_bookmarksopenlevel 1
\pdf_breaklinks false
\pdf_pdfborder true
\pdf_colorlinks true
\pdf_backref false
\pdf_pdfusetitle true
\papersize a4
\use_geometry false
\use_package amsmath 2
\use_package amssymb 2
\use_package cancel 1
\use_package esint 1
\use_package mathdots 1
\use_package mathtools 1
\use_package mhchem 1
\use_package stackrel 1
\use_package stmaryrd 1
\use_package undertilde 1
\cite_engine basic
\cite_engine_type default
\biblio_style plainnat
\use_bibtopic false
\use_indices false
\paperorientation portrait
\suppress_date false
\justification true
\use_refstyle 0
\use_formatted_ref 0
\use_minted 0
\use_lineno 0
\boxbgcolor #c8c8c8
\index Index
\shortcut idx
\color #008000
\end_index
\secnumdepth 3
\tocdepth 2
\paragraph_separation indent
\paragraph_indentation default
\is_math_indent 0
\math_numbering_side default
\quotes_style english
\dynamic_quotes 0
\papercolumns 1
\papersides 1
\paperpagestyle fancy
\tablestyle default
\tracking_changes false
\output_changes false
\change_bars false
\postpone_fragile_content false
\html_math_output 0
\html_css_as_file 0
\html_be_strict false
\docbook_table_output 0
\docbook_mathml_prefix 1
\end_header

\begin_body

\begin_layout Title

\size giant
small time
\size larger

\begin_inset VSpace bigskip
\end_inset


\begin_inset Newline newline
\end_inset

Launcher for `timely'
\size normal
 
\begin_inset Newline newline
\end_inset


\size scriptsize
 Version 4,000,000
\end_layout

\begin_layout Author
J.
 M.
 van Schalkwyk
\end_layout

\begin_layout Standard

\size large
\begin_inset CommandInset toc
LatexCommand tableofcontents

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Newpage newpage
\end_inset


\end_layout

\begin_layout Chapter
Introduction
\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
ok:
 
\end_layout

\begin_layout Plain Layout
[ NB.
 THIS REVISION HAS RIPPED OUT A LOT FROM timely_*.lyx.
 FULLY REFACTORED WITH REFERENCES TO THE LIBRARY ROUTINES APPROPRIATELY MADE.] 
\end_layout

\end_inset


\end_layout

\begin_layout Standard
I built the 
\series bold
timely
\series default
 Perl module for use within my data extractor scripting language 
\series bold
vector seekwell
\series default
,
 but it was convenient (especially for pedagogic purposes) to have a simpler stand alone that makes it easy to launch the Perl code that does the extraction of rules from IANA's tz,
 and the corresponding translation into an SQL table.
 
\end_layout

\begin_layout Standard
I then realised that it was more sensible to shrink the library module,
 and move the one-off or seldom-used stuff to this Perl program.
 This required a fair bit of refactoring,
 and could still be done a lot better.
 (Volunteers?) 
\end_layout

\begin_layout Section
Basic needs
\begin_inset CommandInset label
LatexCommand label
name "sec:Basic-needs"

\end_inset


\end_layout

\begin_layout Standard
You will need:
\end_layout

\begin_layout Enumerate
Perl (e.g.
 Strawberry Perl,
 if you're on Windows;
 Perl is native to Linux.) 
\end_layout

\begin_layout Enumerate
\begin_inset CommandInset href
LatexCommand href
name "MariaDB"
target "https://mariadb.org/"
literal "false"

\end_inset

 or MySQL installed (under Windows,
 use WampServer) as well as an ODBC connection,
 properly set up.
 For details,
 see Section
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:Linux"
plural "false"
caps "false"
noprefix "false"
nolink "false"

\end_inset

.
 
\end_layout

\begin_deeper
\begin_layout Enumerate
It's wise to go to 
\begin_inset CommandInset href
LatexCommand href
name "http://localhost/phpmyadmin/"
target "http://localhost/phpmyadmin/"
literal "false"

\end_inset

 and log in as 
\family typewriter
root
\family default
,
 noting that by default there's no password!
 Set a secure password under User accounts | Edit privileges (for root) and [Change password].
 
\end_layout

\begin_layout Enumerate
You may wish to create a subsidiary `vanilla' user on localhost with limited privileges i.e.
 SELECT,
 INSERT,
 UPDATE to use for your connection.
 
\end_layout

\end_deeper
\begin_layout Enumerate
A recent copy of the tz files from IANA 
\begin_inset CommandInset href
LatexCommand href
name "https://www.iana.org/time-zones"
target "https://www.iana.org/time-zones"
literal "false"

\end_inset

 e.g.
 
\emph on
tzdata2025c.tar.gz
\emph default
 with the ability to unzip it (using gzip or 7z) 
\end_layout

\begin_layout Enumerate
My Perl script 
\emph on
Dogwagger405.pl
\emph default
 from 
\begin_inset CommandInset href
LatexCommand href
name "https://github.com/jvanschalkwyk/dogwagger/"
target "https://github.com/jvanschalkwyk/dogwagger/"
literal "false"

\end_inset

 
\end_layout

\begin_layout Enumerate
A directory into which you can place the .lyx file (e.g.
 
\emph on
~/smalltime/
\emph default
 ) as well as the subdirectories
\end_layout

\begin_deeper
\begin_layout Enumerate

\emph on
smalltime/perl/
\emph default
 and 
\end_layout

\begin_layout Enumerate

\emph on
smalltime/sql/ 
\emph default
and 
\end_layout

\begin_layout Enumerate

\emph on
smalltime/perl/lib/
\emph default
 (in this example) and
\end_layout

\begin_layout Enumerate

\emph on
smalltime/perl/tz/
\emph default
 (for the decompressed tz files) and
\end_layout

\begin_layout Enumerate

\emph on
smalltime/perl/log/ 
\end_layout

\end_deeper
\begin_layout Enumerate
A cut-down version of the 
\series bold
\emph on
f
\emph default
ehr
\series default
 database with just the required tables.
 This will be called 
\series bold
smalltime
\series default
.
 We'll build it below.
 
\end_layout

\begin_layout Enumerate
A copy of the timely.pm Perl module in the 
\emph on
lib
\emph default
 sub-subdirectory.
 The source code is in 
\emph on
timely_400.lyx
\emph default
 
\end_layout

\begin_layout Enumerate
The Perl script small.pl from Chapter
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand ref
reference "chap:The-Perl-script"
plural "false"
caps "false"
noprefix "false"
nolink "false"

\end_inset

.
 This simply:
\end_layout

\begin_deeper
\begin_layout Enumerate
Connects via ODBC to MySQL
\end_layout

\begin_layout Enumerate
Makes the appropriate calls to the 
\emph on
timely.pm
\emph default
 Perl module.
 
\end_layout

\end_deeper
\begin_layout Standard
\begin_inset Separator plain
\end_inset


\end_layout

\begin_layout Standard
Let's start with that database.
 
\end_layout

\begin_layout Chapter
Minimal database
\begin_inset CommandInset label
LatexCommand label
name "chap:Minimal-database"

\end_inset


\end_layout

\begin_layout Standard
You will first need to install MySQL,
 setting up a root password and so on.
 This chapter describes the SQL code you'll use to make the 
\series bold
smalltime
\series default
 database.
 To extract the various files contained in this 
\emph on
literate
\emph default
 document,
 you'll need to export the source LyX file as .tex,
 and then run my Dogwagger script,
 obtainable from GitHub:
 
\begin_inset CommandInset href
LatexCommand href
name "https://github.com/jvanschalkwyk/dogwagger"
target "https://github.com/jvanschalkwyk/dogwagger"
literal "false"

\end_inset

.
 Details are in Chapter
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand ref
reference "chap:Batch-files"
plural "false"
caps "false"
noprefix "false"
nolink "false"

\end_inset

.
\end_layout

\begin_layout Section
Create database & tables 
\end_layout

\begin_layout Standard
From the MySQL command line:
 
\end_layout

\begin_layout Enumerate
Create the database;
\begin_inset Separator latexpar
\end_inset


\end_layout

\begin_deeper
\begin_layout Quote

\family typewriter
\series bold
create schema smalltime CHARACTER SET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
 
\end_layout

\end_deeper
\begin_layout Enumerate
Run the SQL script,
 specifying the correct source e.g:
\end_layout

\begin_layout Quote

\family typewriter
\series bold
use smalltime;
\end_layout

\begin_layout Quote

\family typewriter
\series bold
source /smalltime/sql/smalltime.sql;
\end_layout

\begin_layout Standard
\begin_inset Separator plain
\end_inset


\end_layout

\begin_layout Standard
This is a Windows example,
 but on Linux or Mac,
 the only change you'll need is to specify a different path to the file 
\emph on
smalltime.sql
\emph default
.
 In Linux,
 use the path 
\emph on
~/smalltime/
\emph default
 (etc).
 
\end_layout

\begin_layout Standard
First we will need to generate the SQL in this file,
 extracting it as described in Chapter
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand ref
reference "chap:Batch-files"
plural "false"
caps "false"
noprefix "false"
nolink "false"

\end_inset

.
 The rest of this chapter is devoted to creating the target file 
\emph on
sql/smalltime.sql
\emph default
,
 as follows.
 
\end_layout

\begin_layout Standard
\begin_inset Newpage pagebreak
\end_inset


\end_layout

\begin_layout Standard
\align left
\begin_inset CommandInset line
LatexCommand rule
offset "0.5ex"
width "100col%"
height "3pt"

\end_inset


\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger newTarget=`sql/smalltime.sql' startComment=`--' noWarn=`yes'
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

-- The main SQL file is smalltime.sql
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

 SET default_storage_engine = INNODB;
 -- trust nobody
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

 SET @GLOBALS_UNLIMITED = 999999999999999999;
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Section
Key sources
\begin_inset CommandInset label
LatexCommand label
name "table:SKEYS"

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Note Note
status collapsed

\begin_layout Plain Layout
also see:
\end_layout

\begin_layout Plain Layout
MS
\end_layout

\begin_layout Plain Layout
http://stackoverflow.com/questions/10648448/i-need-row-level-locking
\end_layout

\begin_layout Plain Layout
http://blogs.msdn.com/b/sqlserverstorageengine/archive/2006/05/17/lock-escalation.aspx
\end_layout

\begin_layout Plain Layout
Oracle
\end_layout

\begin_layout Plain Layout
http://www.dba-oracle.com/t_locks_row_level_locking_update.htm
\end_layout

\begin_layout Plain Layout
http://broadh2o.net/docs/database/oracle/oracleLocks.html
\end_layout

\begin_layout Plain Layout
http://www.datadisk.co.uk/html_docs/oracle/locking.htm
\end_layout

\begin_layout Plain Layout
MySQL
\end_layout

\begin_layout Plain Layout
Must use Innodb (otherwise get table-level lock)
\end_layout

\begin_layout Plain Layout
http://dev.mysql.com/doc/refman/5.0/en/innodb-locks-set.html
\end_layout

\begin_layout Plain Layout
http://dev.mysql.com/doc/refman/5.0/en/internal-locking.html
\end_layout

\end_inset


\end_layout

\begin_layout Standard
The PHP Fetchkey
\begin_inset space ~
\end_inset

() routine will be used to provide sequential keys.
 This routine requires an 
\series bold
SKEYS
\series default
 table,
 from which the sequential keys are retrieved for each table:
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
hskip -5mm
\end_layout

\end_inset


\begin_inset CommandInset line
LatexCommand rule
offset "0ex"
width "30col%"
height "0.1mm"

\end_inset


\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

SELECT Now() `Starting`,"SKEYS" `Table`;
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

CREATE TABLE SKEYS (
\end_layout

\begin_layout Plain Layout

  kName varchar(32)
\end_layout

\begin_layout Plain Layout

    ,constraint bad_key_pk primary key(kName)
\end_layout

\begin_layout Plain Layout

  ,kValue BIGINT
\end_layout

\begin_layout Plain Layout

  ,klock BIGINT
\end_layout

\begin_layout Plain Layout

  ,kuser integer
\end_layout

\begin_layout Plain Layout

  )CHARACTER SET=utf8mb4 
\end_layout

\begin_layout Plain Layout

    COLLATE=utf8mb4_unicode_ci;
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
This is a cut-down version of the 
\series bold
\emph on
f
\emph default
ehr
\series default
 list:
 
\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
[FIX ME!!!] 
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

SET @MIN_NORMAL_KEY = 2000;
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

INSERT INTO SKEYS (kName,
 kValue,
 klock) VALUES 
\end_layout

\begin_layout Plain Layout

  ('SOURCES',
            @MIN_NORMAL_KEY+100,
 0),
\end_layout

\begin_layout Plain Layout

  ('PLACES',
             @MIN_NORMAL_KEY+1000,
 0),
\end_layout

\begin_layout Plain Layout

  ('PEOPLE',
             @MIN_NORMAL_KEY+40000,
 0),
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  ('Institutions',
       @MIN_NORMAL_KEY+2000,
 0),
\end_layout

\begin_layout Plain Layout

  ('Sourcecripts',
       @MIN_NORMAL_KEY+3000,
 0)
\end_layout

\begin_layout Plain Layout

  ;
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
Codes between 100 and 999 should be reserved for test cases.
 Codes from 100–999 should not be used for real entries (But countries in the 
\series bold
PLACES
\series default
 table are different).
 
\end_layout

\begin_layout Subsection
Supplement
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

SET @MIN_TEST_KEY = 100;
\end_layout

\begin_layout Plain Layout

SET @MIN_NORMAL_KEY = 2000;
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

INSERT INTO SKEYS (kName,
 kValue,
 klock) VALUES 
\end_layout

\begin_layout Plain Layout

  ('timely',
 @MIN_TEST_KEY-1,
 0),
\end_layout

\begin_layout Plain Layout

  ('relationships',
 @MIN_NORMAL_KEY,
 0)
\end_layout

\begin_layout Plain Layout

  ;
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Subsection
Access & timing
\end_layout

\begin_layout Standard
We need to be concerned about how the key tables will perform in providing multiple sequential keys.
 Potentially a requesting process might be locked out as multiple competing processes queue for sequential keys.
 There is also the problem where a process dies while a generator key is locked.
 These problems justify the lock field in the 
\series bold
SKEYS
\series default
 table.
 Through careful management of this field,
 we can deal with failure,
 regardless of the database used (Another strong argument for 
\emph on
not 
\emph default
using auto-incrementing keys).
 
\end_layout

\begin_layout Section
Crude timestamp conversion
\begin_inset CommandInset label
LatexCommand label
name "sec:Crude-timestamp-conversion"

\end_inset


\end_layout

\begin_layout Standard
These are Julian Day i.e.
 JD
\begin_inset space ~
\end_inset

(),
 the latter returning a Julian time
\begin_inset Foot
status collapsed

\begin_layout Plain Layout
Which we may refer to in the subsequent text as `Julian day number',
 understanding that this includes a fractional day,
 and is expressed in microseconds.
\end_layout

\end_inset

 in microseconds,
 based on proleptic GPS time;
 and Gregorian Time i.e.
 GT
\begin_inset space ~
\end_inset

(),
 which converts the Julian day value just described to a Gregorian timestamp.
 The limitation here is that FROM_UNIXTIME is constrained.
 We will subsequently explore more sophisticated conversions.
 Specifically,
 see Section
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand ref
reference "sec:Dates"
plural "false"
caps "false"
noprefix "false"
nolink "false"

\end_inset

.
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

CREATE FUNCTION GT (b BIGINT)
\end_layout

\begin_layout Plain Layout

  RETURNS CHAR(26) DETERMINISTIC
\end_layout

\begin_layout Plain Layout

  RETURN FROM_UNIXTIME( b/1000000 - 210866760000 );
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

CREATE FUNCTION JD (s VARCHAR(26))
\end_layout

\begin_layout Plain Layout

RETURNS BIGINT DETERMINISTIC
\end_layout

\begin_layout Plain Layout

RETURN 1000000*(86400*(1721059+TO_DAYS(s))+TIME_TO_SEC(s));
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Section
The REASONS table
\begin_inset CommandInset label
LatexCommand label
name "sec:The-REASONS-table"

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
[The following needs careful examination and reconciliation][explore,
 fix]
\end_layout

\end_inset


\end_layout

\begin_layout Standard
We need a reason for any alteration.
 Here's the table:
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

SET @SYSOP = 2000;
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

SELECT Now() `Starting`,"REASONS" `Table`;
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

CREATE TABLE REASONS
\end_layout

\begin_layout Plain Layout

( rsn integer
\end_layout

\begin_layout Plain Layout

    ,constraint reason_pk PRIMARY KEY(rsn)
\end_layout

\begin_layout Plain Layout

  ,description varchar(128)
\end_layout

\begin_layout Plain Layout

  ,shortname varchar(32)
\end_layout

\begin_layout Plain Layout

  ,t_amended BIGINT 
\end_layout

\begin_layout Plain Layout

  ,reason int
\end_layout

\begin_layout Plain Layout

  ,p_amended BIGINT 
\end_layout

\begin_layout Plain Layout

  ,amender integer   
\end_layout

\begin_layout Plain Layout

--  ,constraint bad_reason_amender foreign key(amender)
\end_layout

\begin_layout Plain Layout

--     references PEOPLE(person)
\end_layout

\begin_layout Plain Layout

  ,srcID BIGINT
\end_layout

\begin_layout Plain Layout

  ,src BIGINT
\end_layout

\begin_layout Plain Layout

--    ,constraint bad_reason_src foreign key(src)
\end_layout

\begin_layout Plain Layout

--       references SOURCES(src)
\end_layout

\begin_layout Plain Layout

  ,ver integer default 0
\end_layout

\begin_layout Plain Layout

  ,chk int
\end_layout

\begin_layout Plain Layout

) CHARACTER SET=utf8mb4 
\end_layout

\begin_layout Plain Layout

  COLLATE=utf8mb4_unicode_ci;SHOW WARNINGS;DESCRIBE REASONS;
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
The constraints on amender and src aren't yet created,
 as the relevant tables are still to arrive below.
 
\end_layout

\begin_layout Standard
The reason why we call the PK 
\begin_inset Quotes eld
\end_inset

rsn
\begin_inset Quotes erd
\end_inset

 is that we have a reason field (as in every other table) and even though this is a 
\begin_inset Quotes eld
\end_inset

meta-reason
\begin_inset Quotes erd
\end_inset

,
 we wish to preserve this structure.
 
\end_layout

\begin_layout Standard
We have the option of a `null' reason entry (rsn=0),
 for imported data where no reason can be determined.
 This is also used where the reason is simply creation of the first entry;
 the choice of the description `unknown' is perhaps less than well-inspired,
 but is shorter than `not stated'.
 The following reasons have a pharmaceutical flavour,
 but more will be needed for other purposes.
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

INSERT INTO REASONS (
\end_layout

\begin_layout Plain Layout

  rsn,
 description,
 t_amended,
 reason,
 
\end_layout

\begin_layout Plain Layout

  p_amended,
 amender,
 src,
 chk,
 ver)
\end_layout

\begin_layout Plain Layout

VALUES 
\end_layout

\begin_layout Plain Layout

  (0,
  'unknown',
   0,
 0,
 0,
 @SYSOP,
 2001,
 0,
 0),
\end_layout

\begin_layout Plain Layout

  (-1,
 'deleted',
   0,
 0,
 0,
 @SYSOP,
 2001,
 0,
 0),
\end_layout

\begin_layout Plain Layout

  ( 1,
 'omitted',
   0,
 0,
 0,
 @SYSOP,
 2001,
 0,
 0),
\end_layout

\begin_layout Plain Layout

  ( 2,
 'given',
     0,
 0,
 0,
 @SYSOP,
 2001,
 0,
 0),
\end_layout

\begin_layout Plain Layout

  ( 3,
 'deferred',
  0,
 0,
 0,
 @SYSOP,
 2001,
 0,
 0),
\end_layout

\begin_layout Plain Layout

  (10,
 'abandoned',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0,
 0)
\end_layout

\begin_layout Plain Layout

;
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
The 'deleted' value with a primary key of -1 is very special,
 as it is used (carefully) to signal that a row is in error and has been deleted.
 This has substantial consequences for the handling of any row so flagged.
 Any negative value should be considered 
\begin_inset Quotes eld
\end_inset

erroneous
\begin_inset Quotes erd
\end_inset

.
 
\end_layout

\begin_layout Section
The SOURCES table
\end_layout

\begin_layout Standard
Every line of every table will refer to a data source.
 This should permit clear identification of where data originated,
 and a check on its validity.
 (Every row also has the option of a chk value,
 but this is of limited value,
 and will not of course provide any security unless you replace it with a cryptographic hash).
 In the following we establish a convention used throughout the remaining code:
 show warnings and describe the table on creation.
 This facilitates debugging of the console-level MySQL output.
 
\end_layout

\begin_layout Subsection
Source Scripts
\begin_inset CommandInset label
LatexCommand label
name "subsec:Source-Scripts"

\end_inset


\end_layout

\begin_layout Standard
We make the provision for also referencing a particular source script that was used to extract data.
 This is currently a facility that I've not used much.
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

SELECT Now() `Sourcescripts`,"" `Table`;
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

CREATE TABLE Sourcescripts
\end_layout

\begin_layout Plain Layout

( sourcescript BIGINT
\end_layout

\begin_layout Plain Layout

  ,constraint bad_sourcescript_pk PRIMARY KEY(sourcescript)
\end_layout

\begin_layout Plain Layout

  ,description varchar(64)
\end_layout

\begin_layout Plain Layout

  ,version integer
\end_layout

\begin_layout Plain Layout

  ,amender integer
\end_layout

\begin_layout Plain Layout

--  ,constraint bad_sourcescript_amender foreign key(amender)
\end_layout

\begin_layout Plain Layout

--    references PEOPLE(person)
\end_layout

\begin_layout Plain Layout

  ,t_amended BIGINT 
\end_layout

\begin_layout Plain Layout

  ,reason int
\end_layout

\begin_layout Plain Layout

  ,p_amended BIGINT 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  ,src BIGINT
\end_layout

\begin_layout Plain Layout

  ,srcID BIGINT
\end_layout

\begin_layout Plain Layout

  ,ver integer default 0 -- version of this row
\end_layout

\begin_layout Plain Layout

  ,chk int
\end_layout

\begin_layout Plain Layout

)CHARACTER SET=utf8mb4 
\end_layout

\begin_layout Plain Layout

    COLLATE=utf8mb4_unicode_ci;SHOW WARNINGS;DESCRIBE Sourcescripts;
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
The 
\family typewriter
bad_sourcescript_amender
\family default
 constraint should only be added once 
\series bold
PEOPLE
\series default
 has been defined in Section
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:PEOPLE"
nolink "false"

\end_inset

.
  The script version should comprise 
\begin_inset Formula $10^{6}$
\end_inset

 * major version + 
\begin_inset Formula $10^{3}$
\end_inset

* minor version + subsidiary version number
\begin_inset space \thinspace{}
\end_inset

(ignored if not present).
 
\begin_inset Note Note
status collapsed

\begin_layout Plain Layout
Technically,
 the following should never be used except perhaps for the `internal generation' source.
\end_layout

\end_inset

 Do not confuse 
\series bold
version
\series default
 with 
\series bold
ver
\series default
,
 the version of this row (that describes a script),
 a row that might conceivably have contained erroneous information and have been fixed,
 without any change to the actual script itself.
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

-- SET @SYSOP = 2000;
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

INSERT INTO Sourcescripts(sourcescript,
 description,
 version,
 amender,
 
\end_layout

\begin_layout Plain Layout

   src,
 chk)
\end_layout

\begin_layout Plain Layout

 VALUES(0,
 'none',
 0,
 @SYSOP,
 2001,
 0);
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Subsection
The actual SOURCES
\begin_inset CommandInset label
LatexCommand label
name "subsec:The-actual-SOURCES"

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
The 
\family typewriter
chk
\family default
 field in tables that reference 
\family sans
SOURCES
\family default
 might be left empty,
 a simple CRC,
 or (for the paranoid) a cryptographic hash of the source data that gave rise to the relevant database row.

\emph on
 
\series bold

\begin_inset Note Note
status collapsed

\begin_layout Plain Layout

\series bold
\emph on
[NOTE [explore this] THAT WE NEED A CANONICAL FORM FOR REPRESENTATION OF EACH SOURCE.
 This should conform to our standard 
\begin_inset Quotes eld
\end_inset

source organisation
\begin_inset Quotes erd
\end_inset

 i.e.
 datum1=value1|...|datumn=valuen;
 the obvious order is alphabetical by datum indentifiers!]
\end_layout

\end_inset


\series default
 
\emph default
UTF-8 should be used throughout.
\end_layout

\end_inset

Even the 
\series bold
SOURCES
\series default
 table should have a src,
 but clearly the constraint needs to be added later!
\begin_inset Foot
status collapsed

\begin_layout Plain Layout
Because it's possible that a source may describe more than one patient,
 or something other than a patient datum,
 it is not reasonable to 
\begin_inset Quotes eld
\end_inset

denormalise
\begin_inset Quotes erd
\end_inset

 as elsewhere by having a 
\family sans
tag_person
\family default
 field.
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

SELECT Now() `Starting`,"SOURCES" `Table`;
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

CREATE TABLE SOURCES
\end_layout

\begin_layout Plain Layout

( src BIGINT
\end_layout

\begin_layout Plain Layout

  ,constraint bad_src_pk PRIMARY KEY(src)
\end_layout

\begin_layout Plain Layout

  ,master varchar(128)
\end_layout

\begin_layout Plain Layout

  ,nature integer
\end_layout

\begin_layout Plain Layout

  ,institution integer
\end_layout

\begin_layout Plain Layout

--  ,constraint bad_source_institution foreign key(institution)
\end_layout

\begin_layout Plain Layout

--     references Institutions(institution)
\end_layout

\begin_layout Plain Layout

  ,script BIGINT
\end_layout

\begin_layout Plain Layout

  ,constraint bad_source_script foreign key(script)
\end_layout

\begin_layout Plain Layout

     references Sourcescripts(sourcescript)
\end_layout

\begin_layout Plain Layout

  ,amender int 
\end_layout

\begin_layout Plain Layout

--  ,constraint bad_source_amender foreign key(amender)
\end_layout

\begin_layout Plain Layout

--     references PEOPLE(person)
\end_layout

\begin_layout Plain Layout

  ,t_amended BIGINT 
\end_layout

\begin_layout Plain Layout

  ,reason int
\end_layout

\begin_layout Plain Layout

  ,p_amended BIGINT 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  ,ssource BIGINT  -- check need for this field [explore]
\end_layout

\begin_layout Plain Layout

  ,chk int
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  ,ver integer default 0  -- version
\end_layout

\begin_layout Plain Layout

)CHARACTER SET=utf8mb4 
\end_layout

\begin_layout Plain Layout

    COLLATE=utf8mb4_unicode_ci;
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Note Note
status collapsed

\begin_layout Plain Layout
[WITH THIS STRUCTURE,
 DO WE REALLY NEED A SEPARATE DBTABLES table?
 Surely a SOURCES entry and a DBTABLES entry are cognate?
\end_layout

\end_inset


\end_layout

\begin_layout Standard
Note that 
\family sans
source
\family default
 is a reserved keyword in SQL.
 The 
\family sans
SOURCES
\family default
 table comprises several identities:
\end_layout

\begin_layout Description
master a reference to a string that identifies the external `master document'.
 This might for example be the name of a table in a database,
 or a document identifier.
 
\end_layout

\begin_layout Description
script an identifier (including version) of the script used to parse the master;
\end_layout

\begin_layout Description
nature describes the type of source.
 No associated table at present,
 but 0=undefined,
 1=database
\end_layout

\begin_layout Description
institution a foreign key that references the institution from which the document originates.
\end_layout

\begin_layout Standard
The 
\family typewriter
bad_source_institution
\family default
 constraint cannot be added until the 
\family sans
Institutions
\family default
 table has been defined.
 The 
\family typewriter
ver
\family default
 field should rarely be used,
 if ever,
 although it's conceivable that a master value might be incorrectly specified and need amendment,
 a benign use of 
\family typewriter
ver
\family default
.
 
\begin_inset Note Note
status open

\begin_layout Plain Layout
[EXPLORE REMOVING IT]
\end_layout

\end_inset

 We have a self-reference and a 
\begin_inset Quotes eld
\end_inset

0
\begin_inset Quotes erd
\end_inset

 value:
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

ALTER TABLE SOURCES ADD CONSTRAINT src_reflex foreign key(ssource)
\end_layout

\begin_layout Plain Layout

  references SOURCES(src);
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard

\series bold
\begin_inset Note Note
status open

\begin_layout Plain Layout

\series bold
[Should a source have its own src and chk fields?]
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

INSERT INTO SOURCES
\end_layout

\begin_layout Plain Layout

 (src,
 master,
 institution,
 script,
 amender,
 
\end_layout

\begin_layout Plain Layout

  t_amended,
 reason,
 p_amended,
 ssource,
 chk)
\end_layout

\begin_layout Plain Layout

VALUES
\end_layout

\begin_layout Plain Layout

 (2001,
 'internal generation',
 0,
 0,
 @SYSOP,
 0,
 0,
 0,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

 (0,
 NULL,
 0,
 0,
 @SYSOP,
 NULL,
 NULL,
 0,
 2001,
 NULL);
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

-- we can also amend REASONS:
 
\end_layout

\begin_layout Plain Layout

ALTER TABLE REASONS ADD CONSTRAINT bad_reason_src foreign key(src)
\end_layout

\begin_layout Plain Layout

   references SOURCES(src);
 
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
– we should describe/reference the required coding for 'check' here too.
 [fix me]
\end_layout

\end_inset


\end_layout

\begin_layout Standard
We insert an initial value for 
\begin_inset Quotes eld
\end_inset

internal generation
\begin_inset Quotes erd
\end_inset

,
 which uses the minimum permissible key value.
 
\series bold

\begin_inset Note Note
status collapsed

\begin_layout Plain Layout

\series bold
[NEED TO FLESH OUT THE PRACTICAL ASPECTS OF THE CHECK VALUES.]
\end_layout

\end_inset

 
\series default
We also need the integral time-zone source,
 
\series bold
\emph on
tz
\series default
\emph default
:
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

INSERT INTO SOURCES
\end_layout

\begin_layout Plain Layout

 (src,
 master,
 institution,
 script,
 amender,
 t_amended,
 reason,
 
\end_layout

\begin_layout Plain Layout

  p_amended,
 ssource,
 chk)
\end_layout

\begin_layout Plain Layout

VALUES
\end_layout

\begin_layout Plain Layout

 (2005,
 'TZ database',
 0,
 0,
 @SYSOP,
 0,
 0,
 0,
 2001,
 0);
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Section
PEOPLE
\begin_inset CommandInset label
LatexCommand label
name "subsec:PEOPLE"

\end_inset


\end_layout

\begin_layout Standard
Obviously the central table of our database refers to people.
 These people can occupy various roles,
 which should be checked for validity.
 Note that the patient occupies a very special role,
 in that each table that refers to patient data has a denormalised patient reference called 
\family typewriter
tag_person
\family default
.
 This field is used in low-level checking for an error involving patient data misattribution,
 and permits ready caching of data by patient.
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

SELECT Now() `Starting`,"PEOPLE" `Table`;
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

CREATE TABLE PEOPLE
\end_layout

\begin_layout Plain Layout

( person integer
\end_layout

\begin_layout Plain Layout

    ,constraint person_pk PRIMARY KEY(person)
\end_layout

\begin_layout Plain Layout

  ,t_amended BIGINT 
\end_layout

\begin_layout Plain Layout

  ,reason int
\end_layout

\begin_layout Plain Layout

  ,p_amended BIGINT 
\end_layout

\begin_layout Plain Layout

  ,amender int 
\end_layout

\begin_layout Plain Layout

  ,t_born BIGINT 
\end_layout

\begin_layout Plain Layout

  ,t_born_P int
\end_layout

\begin_layout Plain Layout

  ,p_born BIGINT
\end_layout

\begin_layout Plain Layout

  ,t_died BIGINT
\end_layout

\begin_layout Plain Layout

  ,t_died_P int
\end_layout

\begin_layout Plain Layout

  ,p_died BIGINT
\end_layout

\begin_layout Plain Layout

  ,flags BIGINT
\end_layout

\begin_layout Plain Layout

  ,srcID BIGINT
\end_layout

\begin_layout Plain Layout

  ,src BIGINT
\end_layout

\begin_layout Plain Layout

    ,constraint src_people foreign key(src)
\end_layout

\begin_layout Plain Layout

       references SOURCES(src)
\end_layout

\begin_layout Plain Layout

  ,ver integer default 0
\end_layout

\begin_layout Plain Layout

  ,chk int
\end_layout

\begin_layout Plain Layout

)CHARACTER SET=utf8mb4 
\end_layout

\begin_layout Plain Layout

    COLLATE=utf8mb4_unicode_ci;
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Note Note
status collapsed

\begin_layout Plain Layout
fixup PEOPLE
\end_layout

\begin_layout Plain Layout
\begin_inset ERT
status open

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

ALTER TABLE PEOPLE ADD flags BIGINT;
\end_layout

\begin_layout Plain Layout

-- WHAT ABOUT E_PEOPLE ?
\end_layout

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
The fields should be mostly self-explanatory.
 The 
\family typewriter
src
\family default
 details where the data originated.
 A constraint on the amender will need to be inserted subsequently,
 as MySQL doesn't like 
\emph on
de novo
\emph default
 self-referential tables:
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

-- insert reference to system operator,
 code 2000.
 
\end_layout

\begin_layout Plain Layout

INSERT INTO PEOPLE
\end_layout

\begin_layout Plain Layout

  (person,
 t_amended,
 p_amended,
 amender,
 t_born,
 p_born,
 src,
 chk,
 ver)
\end_layout

\begin_layout Plain Layout

VALUES
\end_layout

\begin_layout Plain Layout

  (@SYSOP,
   0,
         0,
         @SYSOP,
    0,
      0,
      2001,
  0,
    0);
\end_layout

\begin_layout Plain Layout

-- we really should insert valid times and check value here.
 [fix me]
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

INSERT INTO PEOPLE
\end_layout

\begin_layout Plain Layout

  (person,
 t_amended,
 p_amended,
 amender,
 t_born,
 p_born,
 src,
 chk,
 ver)
\end_layout

\begin_layout Plain Layout

VALUES
\end_layout

\begin_layout Plain Layout

  (0,
   0,
  0,
   @SYSOP,
  0,
  0,
  2001,
 0,
  0);
 -- "nobody"
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
In the above,
 the 
\begin_inset Quotes eld
\end_inset

first user
\begin_inset Quotes erd
\end_inset

 has code 2000 (the minimum permissible value),
 and the src is 
\begin_inset Quotes eld
\end_inset

internal
\begin_inset Quotes erd
\end_inset

 (code zero);
 the 
\begin_inset Quotes eld
\end_inset

nobody
\begin_inset Quotes erd
\end_inset

 code is used to indicate missing data or a 
\begin_inset Quotes eld
\end_inset

null person
\begin_inset Quotes erd
\end_inset

 (e.g.
 scheduling where you cannot know the identity of the person involved).
\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
–
\end_layout

\begin_layout Subsection
An international note
\end_layout

\begin_layout Plain Layout
In certain countries,
 there's a legal requirement that patient-identifying data are kept on a separate server from other data.
 I've taken a 
\begin_inset Quotes eld
\end_inset

middle ground
\begin_inset Quotes erd
\end_inset

 approach here,
 as the 
\series bold
PERSONAL
\series default
 table contains all such data apart from two types—
dates of birth and death are present in the 
\series bold
PEOPLE
\series default
 table.
\begin_inset Foot
status open

\begin_layout Plain Layout
Previously I also had a 
\series bold
PTIDS
\series default
 table used specifically for a variety of identifiers—
but this seems excessive as these can similarly be stored in 
\series bold
PERSONAL
\series default
.
\end_layout

\end_inset


\begin_inset Note Note
status open

\begin_layout Plain Layout
[formerly PTIDS]
\end_layout

\end_inset

 To conform to the two-server approach,
 some work would consequently be required despite sequestering the data in these tables.
\begin_inset Foot
status collapsed

\begin_layout Plain Layout
Its debatable that these regulatory efforts make a blind bit of difference—
but sometimes the law is the law.
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Subsection
Updates
\end_layout

\begin_layout Standard
Now that 
\series bold
PEOPLE
\series default
 is defined and populated as above,
 we can add relevant constraints to other tables:
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

ALTER TABLE PEOPLE ADD CONSTRAINT bad_people_amender foreign key(amender)
\end_layout

\begin_layout Plain Layout

  references PEOPLE(person);
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

ALTER TABLE Sourcescripts ADD CONSTRAINT bad_sourcescript_amender foreign key(amender)
\end_layout

\begin_layout Plain Layout

  references PEOPLE(person);
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

ALTER TABLE SOURCES ADD CONSTRAINT bad_source_amender foreign key(amender)
\end_layout

\begin_layout Plain Layout

  references PEOPLE(person);
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

-- for REASONS too:
\end_layout

\begin_layout Plain Layout

ALTER TABLE REASONS ADD CONSTRAINT bad_reason_amender foreign key(amender)
\end_layout

\begin_layout Plain Layout

  references PEOPLE(person);
 
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Section
PLACES
\begin_inset CommandInset label
LatexCommand label
name "sec:Places"

\end_inset


\end_layout

\begin_layout Standard
The rationale for the following fields is discussed below.
 This is all rather crude,
 I'm afraid.
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

SELECT Now() `Starting`,"PLACES" `Table`;
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

CREATE TABLE PLACES
\end_layout

\begin_layout Plain Layout

( place BIGINT
\end_layout

\begin_layout Plain Layout

    ,constraint place_pk PRIMARY KEY (place)
\end_layout

\begin_layout Plain Layout

  ,description varchar(128)
\end_layout

\begin_layout Plain Layout

  ,shortname varchar(32)
\end_layout

\begin_layout Plain Layout

  ,amender int 
\end_layout

\begin_layout Plain Layout

  ,constraint bad_place_amender foreign key(amender)
\end_layout

\begin_layout Plain Layout

      references PEOPLE(person)
\end_layout

\begin_layout Plain Layout

  ,srcID BIGINT
\end_layout

\begin_layout Plain Layout

  ,src BIGINT
\end_layout

\begin_layout Plain Layout

    ,constraint src_place foreign key(src)
\end_layout

\begin_layout Plain Layout

       references SOURCES(src)
\end_layout

\begin_layout Plain Layout

  ,t_amended BIGINT 
\end_layout

\begin_layout Plain Layout

  ,reason int
\end_layout

\begin_layout Plain Layout

  ,p_amended BIGINT 
\end_layout

\begin_layout Plain Layout

    -- here have relevant geospatial coordinates,
 with precision:
\end_layout

\begin_layout Plain Layout

  ,east integer
\end_layout

\begin_layout Plain Layout

  ,north integer
\end_layout

\begin_layout Plain Layout

  ,elevation integer
\end_layout

\begin_layout Plain Layout

  ,east_P integer -- precision
\end_layout

\begin_layout Plain Layout

  ,north_P integer 
\end_layout

\begin_layout Plain Layout

  ,elevation_P integer
\end_layout

\begin_layout Plain Layout

  ,ver integer default 0
\end_layout

\begin_layout Plain Layout

  ,chk int
\end_layout

\begin_layout Plain Layout

)CHARACTER SET=utf8mb4 
\end_layout

\begin_layout Plain Layout

    COLLATE=utf8mb4_unicode_ci;SHOW WARNINGS;DESCRIBE PLACES;
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
Precision is in nominal centimetres (at the equator).
 The p_amended entry is of interest,
 as it makes the PLACES table recursive.
 This evil does however allow the tricky designer (if they wish) to create a hierarchy of places,
 in that p_amended might contain other places.
\begin_inset Foot
status open

\begin_layout Plain Layout
This is one of the few nods made by the database to ontology.
\end_layout

\end_inset

 A null place:
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

INSERT INTO PLACES (place,
 description,
 
\end_layout

\begin_layout Plain Layout

  p_amended,
 t_amended,
 reason,
 amender,
 src,
 chk)
\end_layout

\begin_layout Plain Layout

  VALUES (0,
 'nowhere',
 
\end_layout

\begin_layout Plain Layout

  0,
 0,
 0,
 @SYSOP,
 2001,
 0);
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
We can now add the necessary constraint:
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

ALTER TABLE PLACES ADD CONSTRAINT bad_place_place foreign key(p_amended)
\end_layout

\begin_layout Plain Layout

  references PLACES(place);
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
We also require a base for 
\begin_inset Quotes eld
\end_inset

UTC
\begin_inset Quotes erd
\end_inset

 (universal time).
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

 insert into PLACES (place,
 description,
 amender,
 p_amended,
 src,
 east,
 north,
 reason) 
\end_layout

\begin_layout Plain Layout

  values (1,
 'UTC',
 @SYSOP,
 0,
 0,
 0,
 0,
 0);
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
The Perl 
\family sans
\series bold
vector seekwell
\family default
\series default
 program will also establish a 
\series bold
PLACES
\series default
 entry that refers back to this base.
 
\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
The 2001 code will be set up (as follows) when the Perl tz database script is run (See 
\emph on
vector_seekwell_125.lyx
\emph default
),
 so the following is 
\emph on
not 
\emph default
included in the main SQL script and is simply provided for 
\begin_inset Quotes eld
\end_inset

completeness
\begin_inset Quotes erd
\end_inset

 of documentation.
\end_layout

\begin_layout Plain Layout
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger dogsAllowed=`no'
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

  insert into PLACES (place,
 description,
 amender,
 p_amended,
 src,
 east,
 north,
 reason) 
\end_layout

\begin_layout Plain Layout

   values (2001,
 'UTC',
 @SYSOP,
 1,
 0,
 0,
 0,
 0);
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Subsection
Coordinates
\begin_inset CommandInset label
LatexCommand label
name "subsec:Coordinates"

\end_inset


\end_layout

\begin_layout Standard
The Universal Transverse Mercator coordinate system (UTM) is commonly used,
 but this is not my choice (See below).
\begin_inset Foot
status collapsed

\begin_layout Plain Layout
At the equator,
 1.1
\begin_inset space ~
\end_inset

m precision requires GPS coordinates with seconds specified to to 5 digit precision.
 Although the Military grid reference system (which uses a single,
 compound reference) has the merit of simplicity and also describes precision,
 its compound nature violates one of the rules of our system.
 
\begin_inset Note Note
status collapsed

\begin_layout Plain Layout

\lang english
http://en.wikipedia.org/wiki/Military_grid_reference_system
\end_layout

\end_inset


\end_layout

\end_inset

 UTM specifies a zone (there are 60 such zones) and then two offsets in metres,
 first the easting,
 and then the northing.
 All coordinates are positive,
 due to arbitrary addition of 500
\begin_inset space ~
\end_inset

km to the central meridians and 10,000
\begin_inset space ~
\end_inset

km to the distance south of the equator in the southern hemisphere.
 
\begin_inset Note Note
status collapsed

\begin_layout Plain Layout

\size normal
\color none
\lang english
A disadvantage of UTM is that it has some dodgy bits off the coast of Norway and near the poles.
 No.
 This is the latitude bands.
 [??]
\end_layout

\end_inset

 A reference coordinate system is required —
 this is commonly WGS
\begin_inset space ~
\end_inset

84 (the World Geodetic System).
 The shape of the earth is modelled,
 and position is specified on this modelled shape.
 Note that if we wished to specify coordinates above the surface of the earth,
 we need a field to represent elevation.
\begin_inset Foot
status open

\begin_layout Plain Layout
GPS is currently not that hot at determining elevation.
\end_layout

\end_inset

 
\begin_inset Note Note
status collapsed

\begin_layout Plain Layout

\series bold
http://stefanobittante.blogspot.com/2009/10/gps-coordinates-digit-precision.html
\end_layout

\begin_layout Plain Layout
http://www.dbartlett.com/ cf.
 WGS 84
\end_layout

\begin_layout Plain Layout
http://gpsinformation.net/main/utm-faq.html
\end_layout

\begin_layout Plain Layout
http://en.wikipedia.org/wiki/World_Geodetic_System
\end_layout

\end_inset


\begin_inset Note Note
status collapsed

\begin_layout Plain Layout
I think it is wise to specify a third (altitudinal) component in metres,
 and a fourth integer component that specifies the precision of the other three values,
 with a default precision of 1 metre in all three directions.
\end_layout

\end_inset


\end_layout

\begin_layout Standard
Simple use of GPS coordinates is unwise,
 as common queries become inefficient.
 For example if we ask 
\begin_inset Quotes eld
\end_inset

Who is on Ward 65?
\begin_inset Quotes erd
\end_inset

 this becomes translated into a complex query involving a range of 3-D coordinates,
 together with their tolerances.
 In addition,
 storage will be inefficient.
 Tabular abstraction seems appropriate.
\end_layout

\begin_layout Subsection
My choice
\end_layout

\begin_layout Standard
Simplest is to use latitude and longitude in degrees,
 with altitute above WGS
\begin_inset space ~
\end_inset

84 specified as an integer value in cm.
 The circumference of the earth at the equator is given as 40,075,161.2m
\begin_inset Foot
status open

\begin_layout Plain Layout
See e.g.
 
\begin_inset CommandInset href
LatexCommand href
name "http://en.wikipedia.org/wiki/Decimal_degrees circumference"
target "http://en.wikipedia.org/wiki/Decimal_degrees circumference"
literal "false"

\end_inset


\end_layout

\end_inset

,
 so 180 degrees will correspond to ~2,003,758,060
\begin_inset space ~
\end_inset

cm.
 This is less than the number we can fit into 
\begin_inset Formula $2^{31}$
\end_inset

(a signed 32-bit integer:
 2,147,483,648) so it makes sense to use signed integers to represent degrees of displacement in longitude and latitude (Potential precision will improve as we near the poles).
 We will convert the number of degrees to an integer by dividing by 9;
 multiplying by 100,187,903;
 and then converting to an integer by truncation of the floating point number used in calculation.
\begin_inset Foot
status open

\begin_layout Plain Layout
On reflection,
 it may be best to apply rounding here.
\end_layout

\end_inset

 
\begin_inset Note Note
status collapsed

\begin_layout Plain Layout
11131989.222222222222222222222222
\end_layout

\end_inset

 
\begin_inset Note Note
status collapsed

\begin_layout Plain Layout
SHOULD WE ROUND?
 IF SO,
 WHAT ROUNDING SYSTEM?
\end_layout

\end_inset


\end_layout

\begin_layout Standard
For the sake of consistency,
 we'll use the same conversion for North-South displacements (South is negative),
 despite the fact that a North/South 
\begin_inset Quotes eld
\end_inset

great circle
\begin_inset Quotes erd
\end_inset

 does not have the same dimensions as the equatorial great circle (the Earth approximates an oblate spheroid).
 
\begin_inset Note Note
status open

\begin_layout Plain Layout
[CHECK THIS]
\end_layout

\end_inset


\end_layout

\begin_layout Subsection
Using Google maps
\end_layout

\begin_layout Standard
This is very convenient,
 especially as you can type in a pair of coordinates and Google Maps will take you there.
 To get a pair from Google Maps,
 find your location and then click on the link icon in the top right section of the browser.
 You will obtain a URL something like:
\end_layout

\begin_layout Quote

\family typewriter
http://www.google.co.nz/mapmaker?ll=-36.861493,174.772696&spn=0.021666,0.032701
\end_layout

\begin_layout Quote

\family typewriter
&z=15&lyt=large_map&hll=-36.860051,174.773517&hyaw=264.663684154463
\end_layout

\begin_layout Standard
The 
\begin_inset Quotes eld
\end_inset

ll
\begin_inset Quotes erd
\end_inset

 coordinates approximate the latitude and longitude,
 but may be offset.
 
\begin_inset Note Note
status collapsed

\begin_layout Plain Layout
Better is the Dutch site:
 http://www.gpscoordinaten.nl/bepaal-gps-coordinaten.php
\end_layout

\begin_layout Plain Layout
\begin_inset Note Note
status open

\begin_layout Plain Layout
This provides -36.89939,
 174.82819 S 36 53.963,
 E 174 49.691 S 36 53 57.8,
 E 174 49 41.5 64029938,
 21662257 hoogte:
 37.0 meter
\end_layout

\end_inset


\end_layout

\end_inset

 Certain websites allow direct access e.g.
 
\begin_inset CommandInset href
LatexCommand href
name "https://www.gps-coordinates.net/"
target "https://www.gps-coordinates.net/"
literal "false"

\end_inset

 For example,
 for Auckland City Hospital,
 we obtain S 36.86055° | E 174.76995°,
 and if we then type -36.86055,174.76995 into Google maps,
 we obtain the location.
 (The negative value is because we're south of the equator).
 
\end_layout

\begin_layout Subsection
Conversion
\end_layout

\begin_layout Standard
The World coordinate converter can be useful (
\begin_inset CommandInset href
LatexCommand href
name "https://twcc.fr/"
target "https://twcc.fr/"
literal "false"

\end_inset

) as it is detailed,
 and provides a variety of options.
 Also see 
\begin_inset CommandInset href
LatexCommand href
name "http://boulter.com/gps/"
target "http://boulter.com/gps/"
literal "false"

\end_inset

.
 In the above example,
 we obtain 60S 301203 5918276 for UTM coordinates.
\begin_inset Note Note
status open

\begin_layout Plain Layout
\begin_inset Foot
status open

\begin_layout Plain Layout
In New Zealand,
 GPS coordinates are specified relative to NZ Geodetic Datum 2000.
 See 
\begin_inset CommandInset href
LatexCommand href
name "http://www.linz.govt.nz/geodetic/find-out/nz-gps"
target "http://www.linz.govt.nz/geodetic/find-out/nz-gps"
literal "false"

\end_inset

.
\end_layout

\end_inset

 
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Note Note
status collapsed

\begin_layout Plain Layout
PREVIOUSLY:
\end_layout

\begin_layout Plain Layout
I propose we use a three-level categorization of (a) A 
\emph on
geolocation
\emph default
,
 centred on geospatial coordinates,
 e.g.
 an institution;
 (b) an enclosure (which we will term a `
\emph on
volume
\emph default
'),
 and (c) a 
\emph on
place
\emph default
 within that volume.
 The last two will use 
\emph on
relative 
\emph default
coordinates.
\begin_inset Foot
status open

\begin_layout Plain Layout
Note that we avoid a massive hierarchy (`building',
 `floor',
 `ward',
 `room',
 `bedspace' etc),
 so some 
\emph on
localised 
\emph default
inefficiency is needed to e.g.
 localise a bedspace.
 We will specify coordinates for a volume as relative to the geolocation,
 and coordinates for the domain as relative to the volume.
 The `common currency' will be the domain.
\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Note Note
status open

\begin_layout Plain Layout
Note that we will have a special domain that spreads over the entire room (to represent an undetermined location within a room).
 But how will we specify an undetermined location within a building?
 Answer:
 Have an undetermined (generic) room that encompasses the entire building,
 and a undetermined location within this.
\end_layout

\begin_layout Plain Layout
Note 2:
 The reference point for a room within a building is the most southerly,
 most westerly point that allows a rectangle to be drawn such that it originates at this point,
 has edges that run due north and due east,
 and minimally encompasses the entire room.
 The geospatial reference points for the geolocation and the domain are similar!
\end_layout

\begin_layout Plain Layout
Note 3:
 Each of the geolocation,
 room and domain will have a width and height that describes the reference rectangle.
\end_layout

\begin_layout Plain Layout
note 4:
 WE MAY end UP WITH MORE THAN 4 billion locations.
 Bugger.
 Cf:
\end_layout

\begin_layout Plain Layout
http://unstats.un.org/unsd/demographic/sconcerns/housing/default.htm
\end_layout

\begin_layout Plain Layout
http://unstats.un.org/unsd/demographic/sconcerns/housing/chss2001.htm
\end_layout

\begin_layout Plain Layout
–
\end_layout

\begin_layout Plain Layout
We may be looking at over a billion housing units,
 let alone other locations.
\end_layout

\end_inset


\end_layout

\end_inset

 
\begin_inset Note Note
status collapsed

\begin_layout Plain Layout
Save coordinates in various formats:
\end_layout

\begin_layout Plain Layout
http://www.gps-data-team.com/map/
\end_layout

\end_inset

 
\begin_inset Note Note
status collapsed

\begin_layout Subsubsection
Grouping at a location
\end_layout

\begin_layout Plain Layout
It will be very useful to associate e.g.
 wards in a hospital.
 This is however meta-information,
 and should not be built in as a constraining ontological hierarchy (in my opinion).
 This will be done easily using M_ tables,
 but internal dual references permit a two-place hierarchy to be estalished.
 
\begin_inset Note Note
status open

\begin_layout Plain Layout
[fix me,
 insert cross-reference].
 NOTE THAT THE META TABLE WILL PERMIT SPECIFICATION OF THE TYPE OF REFERENCE.
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Subsection
Country
\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
[Must add South Sudan,
 change Swaziland to Eswatini,
 etc.
 fix me!]
\end_layout

\end_inset


\end_layout

\begin_layout Standard
Rather than having a separate `countries' table as first conceptualised,
 simply create 
\series bold
PLACES
\series default
 entries.
 These will have a p_amended value of zero;
 however 
\emph on
regions
\emph default
 that will be used in time-zone representation will have countries as their parents,
 coded slightly irregularly in p_amended.
 A further irregularity is that the place codes (which range from 004–894) are technically 
\begin_inset Quotes eld
\end_inset

forbidden codes
\begin_inset Quotes erd
\end_inset

 in our standard coding structure,
 but correspond exactly to the ISO-3166-1 codes!
\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
IT MAKES SENSE TO SPECIFY COUNTRIES AND REGIONS AS PLACES.
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

INSERT INTO PLACES (place,
 description,
 p_amended,
 t_amended,
 reason,
 
\end_layout

\begin_layout Plain Layout

  amender,
 src,
 chk) VALUES 
\end_layout

\begin_layout Plain Layout

(4,'Afghanistan',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(8,'Albania',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(10,'Antarctica',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(12,'Algeria',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(16,'American Samoa',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(20,'Andorra',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(24,'Angola',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(28,'Antigua and Barbuda',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(31,'Azerbaijan',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(32,'Argentina',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(36,'Australia',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(40,'Austria',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(44,'Bahamas',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(48,'Bahrain',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(50,'Bangladesh',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(51,'Armenia',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(52,'Barbados',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(56,'Belgium',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(60,'Bermuda',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(64,'Bhutan',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(68,'Bolivia,
 Plurinational State of',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(70,'Bosnia and Herzegovina',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(72,'Botswana',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(74,'Bouvet Island',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(76,'Brazil',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(84,'Belize',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(86,'British Indian Ocean Territory',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(90,'Solomon Islands',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(92,'Virgin Islands,
 British',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(96,'Brunei Darussalam',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(100,'Bulgaria',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(104,'Myanmar',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(108,'Burundi',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(112,'Belarus',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(116,'Cambodia',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(120,'Cameroon',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(124,'Canada',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(132,'Cape Verde',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(136,'Cayman Islands',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(140,'Central African Republic',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(144,'Sri Lanka',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(148,'Chad',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(152,'Chile',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(156,'China',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(158,'Taiwan,
 Province of China',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(162,'Christmas Island',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(166,'Cocos (Keeling) Islands',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(170,'Colombia',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(174,'Comoros',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(175,'Mayotte',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(178,'Congo',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(180,'Congo,
 the Democratic Republic of the',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(184,'Cook Islands',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(188,'Costa Rica',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(191,'Croatia',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(192,'Cuba',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(196,'Cyprus',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(203,'Czech Republic',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(204,'Benin',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(208,'Denmark',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(212,'Dominica',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(214,'Dominican Republic',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(218,'Ecuador',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(222,'El Salvador',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(226,'Equatorial Guinea',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(231,'Ethiopia',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(232,'Eritrea',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(233,'Estonia',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(234,'Faroe Islands',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(238,'Falkland Islands (Malvinas)',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(239,'South Georgia and the South Sandwich Islands',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(242,'Fiji',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(246,'Finland',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(248,'Åland Islands',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(250,'France',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(254,'French Guiana',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(258,'French Polynesia',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(260,'French Southern Territories',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(262,'Djibouti',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(266,'Gabon',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(268,'Georgia',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(270,'Gambia',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0);
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
More:
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

INSERT INTO PLACES (place,
 description,
 p_amended,
 t_amended,
 reason,
 
\end_layout

\begin_layout Plain Layout

  amender,
 src,
 chk) VALUES
\end_layout

\begin_layout Plain Layout

(275,'Palestine,
 State of',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(276,'Germany',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(288,'Ghana',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(292,'Gibraltar',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(296,'Kiribati',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(300,'Greece',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(304,'Greenland',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(308,'Grenada',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(312,'Guadeloupe',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(316,'Guam',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(320,'Guatemala',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(324,'Guinea',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(328,'Guyana',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(332,'Haiti',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(334,'Heard Island and McDonald Islands',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(336,'Holy See (Vatican City State)',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(340,'Honduras',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(344,'Hong Kong',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(348,'Hungary',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(352,'Iceland',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(356,'India',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(360,'Indonesia',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(364,'Iran,
 Islamic Republic of',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(368,'Iraq',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(372,'Ireland',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(376,'Israel',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(380,'Italy',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(384,'Côte d''Ivoire',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(388,'Jamaica',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(392,'Japan',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(398,'Kazakhstan',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(400,'Jordan',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(404,'Kenya',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(408,'Korea,
 Democratic People''s Republic of',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(410,'Korea,
 Republic of',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(414,'Kuwait',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(417,'Kyrgyzstan',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(418,'Lao People''s Democratic Republic',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(422,'Lebanon',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(426,'Lesotho',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(428,'Latvia',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(430,'Liberia',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(434,'Libya',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(438,'Liechtenstein',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(440,'Lithuania',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(442,'Luxembourg',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(446,'Macao',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(450,'Madagascar',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(454,'Malawi',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(458,'Malaysia',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(462,'Maldives',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(466,'Mali',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(470,'Malta',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(474,'Martinique',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(478,'Mauritania',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(480,'Mauritius',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(484,'Mexico',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(492,'Monaco',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(496,'Mongolia',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(498,'Moldova,
 Republic of',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(499,'Montenegro',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(500,'Montserrat',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(504,'Morocco',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(508,'Mozambique',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(512,'Oman',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(516,'Namibia',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(520,'Nauru',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(524,'Nepal',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(528,'Netherlands',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0);
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
Yet more:
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

INSERT INTO PLACES (place,
 description,
 p_amended,
 t_amended,
 reason,
 
\end_layout

\begin_layout Plain Layout

  amender,
 src,
 chk) VALUES
\end_layout

\begin_layout Plain Layout

(531,'Curaçao',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(533,'Aruba',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(534,'Sint Maarten (Dutch part)',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(535,'Bonaire,
 Sint Eustatius and Saba',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(540,'New Caledonia',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(548,'Vanuatu',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(554,'New Zealand',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(558,'Nicaragua',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(562,'Niger',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(566,'Nigeria',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(570,'Niue',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(574,'Norfolk Island',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(578,'Norway',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(580,'Northern Mariana Islands',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(581,'United States Minor Outlying Islands',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(583,'Micronesia,
 Federated States of',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(584,'Marshall Islands',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(585,'Palau',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(586,'Pakistan',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(591,'Panama',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(598,'Papua New Guinea',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(600,'Paraguay',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(604,'Peru',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(608,'Philippines',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(612,'Pitcairn',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(616,'Poland',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(620,'Portugal',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(624,'Guinea-Bissau',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(626,'Timor-Leste',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(630,'Puerto Rico',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(634,'Qatar',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(638,'Réunion',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(642,'Romania',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(643,'Russian Federation',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(646,'Rwanda',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(652,'Saint Barthélemy',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(654,'Saint Helena,
 Ascension and Tristan da Cunha',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(659,'Saint Kitts and Nevis',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(660,'Anguilla',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(662,'Saint Lucia',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(663,'Saint Martin (French part)',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(666,'Saint Pierre and Miquelon',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(670,'Saint Vincent and the Grenadines',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(674,'San Marino',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(678,'Sao Tome and Principe',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(682,'Saudi Arabia',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(686,'Senegal',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(688,'Serbia',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(690,'Seychelles',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(694,'Sierra Leone',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(702,'Singapore',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(703,'Slovakia',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(704,'Viet Nam',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(705,'Slovenia',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(706,'Somalia',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(710,'South Africa',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(716,'Zimbabwe',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(724,'Spain',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(728,'South Sudan',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(729,'Sudan',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(732,'Western Sahara',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(740,'Suriname',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(744,'Svalbard and Jan Mayen',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(748,'Swaziland',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(752,'Sweden',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(756,'Switzerland',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(760,'Syrian Arab Republic',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0);
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
Finally:
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

INSERT INTO PLACES (place,
 description,
 p_amended,
 t_amended,
 reason,
 
\end_layout

\begin_layout Plain Layout

  amender,
 src,
 chk) VALUES
\end_layout

\begin_layout Plain Layout

(762,'Tajikistan',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(764,'Thailand',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(768,'Togo',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(772,'Tokelau',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(776,'Tonga',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(780,'Trinidad and Tobago',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(784,'United Arab Emirates',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(788,'Tunisia',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(792,'Turkey',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(795,'Turkmenistan',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(796,'Turks and Caicos Islands',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(798,'Tuvalu',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(800,'Uganda',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(804,'Ukraine',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(807,'Macedonia,
 the former Yugoslav Republic of',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(818,'Egypt',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(826,'United Kingdom',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(831,'Guernsey',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(832,'Jersey',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(833,'Isle of Man',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(834,'Tanzania,
 United Republic of',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(840,'United States',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(850,'Virgin Islands,
 U.S.',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(854,'Burkina Faso',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(858,'Uruguay',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(860,'Uzbekistan',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(862,'Venezuela,
 Bolivarian Republic of',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(876,'Wallis and Futuna',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(882,'Samoa',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(887,'Yemen',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0),
\end_layout

\begin_layout Plain Layout

(894,'Zambia',
 0,
 0,
 0,
 @SYSOP,
 2001,
 0);
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Subsection
Country codes
\end_layout

\begin_layout Standard
Introduced in Version
\begin_inset space ~
\end_inset

1,023,000.
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

SELECT Now() `Starting`,"countrycodes" `Table`;
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

CREATE TABLE countrycodes
\end_layout

\begin_layout Plain Layout

( country BIGINT
\end_layout

\begin_layout Plain Layout

    ,constraint cc_country FOREIGN KEY (country)
\end_layout

\begin_layout Plain Layout

      references PLACES(place)
\end_layout

\begin_layout Plain Layout

    ,constraint cc_pk PRIMARY KEY (country)
\end_layout

\begin_layout Plain Layout

  ,ccode varchar(2)
\end_layout

\begin_layout Plain Layout

  ,tla varchar(3)
\end_layout

\begin_layout Plain Layout

  ,ver integer default 0
\end_layout

\begin_layout Plain Layout

  ,chk int default 0
\end_layout

\begin_layout Plain Layout

)CHARACTER SET=utf8mb4 
\end_layout

\begin_layout Plain Layout

    COLLATE=utf8mb4_unicode_ci;SHOW WARNINGS;DESCRIBE countrycodes;
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
Populate the table:
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout

{
\backslash
footnotesize
\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

INSERT INTO countrycodes (ccode,
 tla,
 country)
\end_layout

\begin_layout Plain Layout

VALUES
\end_layout

\begin_layout Plain Layout

('XX',
 'NUL',
 0),
 -- generic null!
\end_layout

\begin_layout Plain Layout

('UT',
 'UTC',
 1),
 -- for UTC !
 
\end_layout

\begin_layout Plain Layout

('AF',
 'AFG',4),
   ('AX',
 'ALA',248),
 ('AL',
 'ALB',8),
   ('DZ',
 'DZA',12),
  ('AS',
 'ASM',16),
 
\end_layout

\begin_layout Plain Layout

('AD',
 'AND',20),
  ('AO',
 'AGO',24),
  ('AI',
 'AIA',660),
 ('AQ',
 'ATA',10),
  ('AG',
 'ATG',28),
 
\end_layout

\begin_layout Plain Layout

('AR',
 'ARG',32),
  ('AM',
 'ARM',51),
  ('AW',
 'ABW',533),
 ('AU',
 'AUS',36),
  ('AT',
 'AUT',40),
 
\end_layout

\begin_layout Plain Layout

('AZ',
 'AZE',31),
  ('BS',
 'BHS',44),
  ('BH',
 'BHR',48),
  ('BD',
 'BGD',50),
  ('BB',
 'BRB',52),
 
\end_layout

\begin_layout Plain Layout

('BY',
 'BLR',112),
 ('BE',
 'BEL',56),
  ('BZ',
 'BLZ',84),
  ('BJ',
 'BEN',204),
 ('BM',
 'BMU',60),
 
\end_layout

\begin_layout Plain Layout

('BT',
 'BTN',64),
  ('BO',
 'BOL',68),
  ('BQ',
 'BES',535),
 ('BA',
 'BIH',70),
  ('BW',
 'BWA',72),
 
\end_layout

\begin_layout Plain Layout

('BV',
 'BVT',74),
  ('BR',
 'BRA',76),
  ('IO',
 'IOT',86),
  ('BN',
 'BRN',96),
  ('BG',
 'BGR',100),
 
\end_layout

\begin_layout Plain Layout

('BF',
 'BFA',854),
\end_layout

\begin_layout Plain Layout

('BI',
 'BDI',108),
 ('KH',
 'KHM',116),
 ('CM',
 'CMR',120),
 ('CA',
 'CAN',124),
 ('CV',
 'CPV',132),
 
\end_layout

\begin_layout Plain Layout

('KY',
 'CYM',136),
 ('CF',
 'CAF',140),
 ('TD',
 'TCD',148),
 ('CL',
 'CHL',152),
 ('CN',
 'CHN',156),
 
\end_layout

\begin_layout Plain Layout

('CX',
 'CXR',162),
 ('CC',
 'CCK',166),
 ('CO',
 'COL',170),
 ('KM',
 'COM',174),
 ('CG',
 'COG',178),
 
\end_layout

\begin_layout Plain Layout

('CD',
 'COD',180),
 ('CK',
 'COK',184),
 ('CR',
 'CRI',188),
 ('CI',
 'CIV',384),
 ('HR',
 'HRV',191),
 
\end_layout

\begin_layout Plain Layout

('CU',
 'CUB',192),
 ('CW',
 'CUW',531),
 ('CY',
 'CYP',196),
 ('CZ',
 'CZE',203),
 ('DK',
 'DNK',208),
\end_layout

\begin_layout Plain Layout

('DJ',
 'DJI',262),
 ('DM',
 'DMA',212),
 ('DO',
 'DOM',214),
 ('EC',
 'ECU',218),
 ('EG',
 'EGY',818),
 
\end_layout

\begin_layout Plain Layout

('SV',
 'SLV',222),
 ('GQ',
 'GNQ',226),
 ('ER',
 'ERI',232),
 ('EE',
 'EST',233),
 ('ET',
 'ETH',231),
 
\end_layout

\begin_layout Plain Layout

('FK',
 'FLK',238),
 ('FO',
 'FRO',234),
 ('FJ',
 'FJI',242),
 ('FI',
 'FIN',246),
 ('FR',
 'FRA',250),
 
\end_layout

\begin_layout Plain Layout

('GF',
 'GUF',254),
 ('PF',
 'PYF',258),
 ('TF',
 'ATF',260),
 ('GA',
 'GAB',266),
 ('GM',
 'GMB',270),
 
\end_layout

\begin_layout Plain Layout

('GE',
 'GEO',268),
 ('DE',
 'DEU',276),
 ('GH',
 'GHA',288),
 ('GI',
 'GIB',292),
 ('GR',
 'GRC',300),
 
\end_layout

\begin_layout Plain Layout

('GL',
 'GRL',304),
 ('GD',
 'GRD',308),
 ('GP',
 'GLP',312),
 ('GU',
 'GUM',316),
 ('GT',
 'GTM',320),
 
\end_layout

\begin_layout Plain Layout

('GG',
 'GGY',831),
 ('GN',
 'GIN',324),
 ('GW',
 'GNB',624),
 ('GY',
 'GUY',328),
 ('HT',
 'HTI',332),
 
\end_layout

\begin_layout Plain Layout

('HM',
 'HMD',334),
 ('VA',
 'VAT',336),
 ('HN',
 'HND',340),
 ('HK',
 'HKG',344),
 ('HU',
 'HUN',348),
 
\end_layout

\begin_layout Plain Layout

('IS',
 'ISL',352),
 ('IN',
 'IND',356),
 ('ID',
 'IDN',360),
 ('IR',
 'IRN',364),
 ('IQ',
 'IRQ',368),
 
\end_layout

\begin_layout Plain Layout

('IE',
 'IRL',372),
 ('IM',
 'IMN',833),
 ('IL',
 'ISR',376),
 ('IT',
 'ITA',380),
 ('JM',
 'JAM',388),
\end_layout

\begin_layout Plain Layout

('JP',
 'JPN',392),
 ('JE',
 'JEY',832),
 ('JO',
 'JOR',400),
 ('KZ',
 'KAZ',398),
 ('KE',
 'KEN',404),
 
\end_layout

\begin_layout Plain Layout

('KI',
 'KIR',296),
 ('KP',
 'PRK',408),
 ('KR',
 'KOR',410),
 ('KW',
 'KWT',414),
 ('KG',
 'KGZ',417),
 
\end_layout

\begin_layout Plain Layout

('LA',
 'LAO',418),
 ('LV',
 'LVA',428),
 ('LB',
 'LBN',422),
 ('LS',
 'LSO',426),
 ('LR',
 'LBR',430),
 
\end_layout

\begin_layout Plain Layout

('LY',
 'LBY',434),
 ('LI',
 'LIE',438),
 ('LT',
 'LTU',440),
 ('LU',
 'LUX',442),
 ('MO',
 'MAC',446);
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

INSERT INTO countrycodes (ccode,
 tla,
 country)
\end_layout

\begin_layout Plain Layout

VALUES
\end_layout

\begin_layout Plain Layout

('MK',
 'MKD',807),
 ('MG',
 'MDG',450),
 ('MW',
 'MWI',454),
 ('MY',
 'MYS',458),
 ('MV',
 'MDV',462),
 
\end_layout

\begin_layout Plain Layout

('ML',
 'MLI',466),
 ('MT',
 'MLT',470),
 ('MH',
 'MHL',584),
 ('MQ',
 'MTQ',474),
 ('MR',
 'MRT',478),
 
\end_layout

\begin_layout Plain Layout

('MU',
 'MUS',480),
 ('YT',
 'MYT',175),
 ('MX',
 'MEX',484),
 ('FM',
 'FSM',583),
 ('MD',
 'MDA',498),
 
\end_layout

\begin_layout Plain Layout

('MC',
 'MCO',492),
 ('MN',
 'MNG',496),
 ('ME',
 'MNE',499),
 ('MS',
 'MSR',500),
 ('MA',
 'MAR',504),
 
\end_layout

\begin_layout Plain Layout

('MZ',
 'MOZ',508),
 ('MM',
 'MMR',104),
 ('NA',
 'NAM',516),
 ('NR',
 'NRU',520),
 ('NP',
 'NPL',524),
 
\end_layout

\begin_layout Plain Layout

('NL',
 'NLD',528),
 ('NC',
 'NCL',540),
 ('NZ',
 'NZL',554),
 ('NI',
 'NIC',558),
 ('NE',
 'NER',562),
 
\end_layout

\begin_layout Plain Layout

('NG',
 'NGA',566),
 ('NU',
 'NIU',570),
 ('NF',
 'NFK',574),
 ('MP',
 'MNP',580),
 ('NO',
 'NOR',578),
 
\end_layout

\begin_layout Plain Layout

('OM',
 'OMN',512),
 ('PK',
 'PAK',586),
 ('PW',
 'PLW',585),
 ('PS',
 'PSE',275),
 ('PA',
 'PAN',591),
 
\end_layout

\begin_layout Plain Layout

('PG',
 'PNG',598),
 ('PY',
 'PRY',600),
 ('PE',
 'PER',604),
 ('PH',
 'PHL',608),
 ('PN',
 'PCN',612),
 
\end_layout

\begin_layout Plain Layout

('PL',
 'POL',616),
 ('PT',
 'PRT',620),
 ('PR',
 'PRI',630),
 ('QA',
 'QAT',634),
 ('RE',
 'REU',638),
 
\end_layout

\begin_layout Plain Layout

('RO',
 'ROU',642),
 ('RU',
 'RUS',643),
 ('RW',
 'RWA',646),
 ('BL',
 'BLM',652),
 ('SH',
 'SHN',654),
 
\end_layout

\begin_layout Plain Layout

('KN',
 'KNA',659),
 ('LC',
 'LCA',662),
 ('MF',
 'MAF',663),
 ('PM',
 'SPM',666),
 ('VC',
 'VCT',670),
 
\end_layout

\begin_layout Plain Layout

('WS',
 'WSM',882),
 ('SM',
 'SMR',674),
 ('ST',
 'STP',678),
 ('SA',
 'SAU',682),
 ('SN',
 'SEN',686),
 
\end_layout

\begin_layout Plain Layout

('RS',
 'SRB',688),
 ('SC',
 'SYC',690),
 ('SL',
 'SLE',694),
 ('SG',
 'SGP',702),
 ('SX',
 'SXM',534),
 
\end_layout

\begin_layout Plain Layout

('SK',
 'SVK',703),
 ('SI',
 'SVN',705),
 ('SB',
 'SLB',90),
 ('SO',
 'SOM',706),
 ('ZA',
 'ZAF',710),
 
\end_layout

\begin_layout Plain Layout

('GS',
 'SGS',239),
 ('SS',
 'SSD',728),
 ('ES',
 'ESP',724),
 ('LK',
 'LKA',144),
 ('SD',
 'SDN',729),
 
\end_layout

\begin_layout Plain Layout

('SR',
 'SUR',740),
 ('SJ',
 'SJM',744),
 ('SZ',
 'SWZ',748),
 ('SE',
 'SWE',752),
 ('CH',
 'CHE',756),
 
\end_layout

\begin_layout Plain Layout

('SY',
 'SYR',760),
 ('TW',
 'TWN',158),
 ('TJ',
 'TJK',762),
 ('TZ',
 'TZA',834),
 ('TH',
 'THA',764),
 
\end_layout

\begin_layout Plain Layout

('TL',
 'TLS',626),
 ('TG',
 'TGO',768),
 ('TK',
 'TKL',772),
 ('TO',
 'TON',776),
 ('TT',
 'TTO',780),
 
\end_layout

\begin_layout Plain Layout

('TN',
 'TUN',788),
 ('TR',
 'TUR',792),
 ('TM',
 'TKM',795),
 ('TC',
 'TCA',796),
 ('TV',
 'TUV',798),
 
\end_layout

\begin_layout Plain Layout

('UG',
 'UGA',800),
 ('UA',
 'UKR',804),
 ('AE',
 'ARE',784),
 ('GB',
 'GBR',826),
 ('US',
 'USA',840),
 
\end_layout

\begin_layout Plain Layout

('UM',
 'UMI',581),
 ('UY',
 'URY',858),
 ('UZ',
 'UZB',860),
 ('VU',
 'VUT',548),
 ('VE',
 'VEN',862),
 
\end_layout

\begin_layout Plain Layout

('VN',
 'VNM',704),
 ('VG',
 'VGB',92),
 ('VI',
 'VIR',850),
 ('WF',
 'WLF',876),
 ('EH',
 'ESH',732),
 
\end_layout

\begin_layout Plain Layout

('YE',
 'YEM',887),
 ('ZM',
 'ZMB',894),
 ('ZW',
 'ZWE',716);
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}}
\end_layout

\end_inset


\end_layout

\begin_layout Subsection
Regions
\end_layout

\begin_layout Standard
We will represent regions as 
\series bold
PLACES
\series default
,
 with a `parent' country in the p_created field,
 as discussed above (This is relevant to the tz database).
 
\end_layout

\begin_layout Section
Institutions
\begin_inset CommandInset label
LatexCommand label
name "subsec:Institutions"

\end_inset


\end_layout

\begin_layout Standard
This table refers to e.g.
 the manufacturers of specific medicines,
 devices,
 instances of a `thing',
 and of `lots' of organisms.
 Clearly one manufacturer may produce many such items,
 and may even cross the 
\begin_inset Quotes eld
\end_inset

boundaries
\begin_inset Quotes erd
\end_inset

 of devices,
 drugs etc.
 
\end_layout

\begin_layout Standard
Rather confusingly,
 an entire database may also be represented as an 
\begin_inset Quotes eld
\end_inset

Institution
\begin_inset Quotes erd
\end_inset

,
 and then SOURCES that are dependent on it constitute individual tables (This prevents the clumsiness of having separate a separate DataBases table with a dependent DataTables table,
 and then being unable to reference these as a `source')
\begin_inset Note Note
status open

\begin_layout Plain Layout
[explore]
\end_layout

\end_inset

.
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

SELECT Now() `Starting`,"Institutions" `Table`;
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

CREATE TABLE Institutions
\end_layout

\begin_layout Plain Layout

( institution integer
\end_layout

\begin_layout Plain Layout

    ,constraint institution_pk PRIMARY KEY(institution)
\end_layout

\begin_layout Plain Layout

  ,international_identifier varchar(64)
\end_layout

\begin_layout Plain Layout

  ,name varchar(128)
\end_layout

\begin_layout Plain Layout

  ,nature int default 0
\end_layout

\begin_layout Plain Layout

  ,site BIGINT
\end_layout

\begin_layout Plain Layout

  ,constraint bad_institution_site foreign key(site)
\end_layout

\begin_layout Plain Layout

     references PLACES(place)
\end_layout

\begin_layout Plain Layout

  ,t_amended BIGINT 
\end_layout

\begin_layout Plain Layout

  ,reason int
\end_layout

\begin_layout Plain Layout

  ,p_amended BIGINT 
\end_layout

\begin_layout Plain Layout

  ,amender int 
\end_layout

\begin_layout Plain Layout

  ,constraint bad_institution_amender foreign key(amender)
\end_layout

\begin_layout Plain Layout

      references PEOPLE(person)
\end_layout

\begin_layout Plain Layout

  ,srcID BIGINT
\end_layout

\begin_layout Plain Layout

  ,src BIGINT
\end_layout

\begin_layout Plain Layout

    ,constraint src_institution foreign key(src)
\end_layout

\begin_layout Plain Layout

       references SOURCES(src)
\end_layout

\begin_layout Plain Layout

  ,ver integer default 0
\end_layout

\begin_layout Plain Layout

  ,chk int
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  -- will likely need other fields here.
 
\end_layout

\begin_layout Plain Layout

)CHARACTER SET=utf8mb4 
\end_layout

\begin_layout Plain Layout

    COLLATE=utf8mb4_unicode_ci;SHOW WARNINGS;DESCRIBE Institutions;
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
The 
\series bold
nature
\series default
 field does not refer to an external table at present,
 but 0=not characterised,
 1=is a database.
 
\series bold

\begin_inset Note Note
status collapsed

\begin_layout Plain Layout

\series bold
[NEED TO LOOK INTO INTERNATIONALLY ACCEPTABLE IDENTIFIERS FOR MANUFACTURERS]
\end_layout

\end_inset

 
\series default
Note that the 
\family typewriter
international_identifier
\family default
 is an alternative (candidate) primary key.
 The 
\family typewriter
site
\family default
 refers to the location of the institution,
 whereas 
\family typewriter
p_amended
\family default
 is the location of the amender!
\begin_inset Foot
status open

\begin_layout Plain Layout
In keeping with our usual convention of a time/location pair.
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

INSERT INTO Institutions (institution,
 name,
 international_identifier,
\end_layout

\begin_layout Plain Layout

                     site,
\end_layout

\begin_layout Plain Layout

                     t_amended,
 reason,
 p_amended,
\end_layout

\begin_layout Plain Layout

                     amender,
 src,
 chk)
\end_layout

\begin_layout Plain Layout

  VALUES (0,
 'unknown',
 '0',
 
\end_layout

\begin_layout Plain Layout

          0,
\end_layout

\begin_layout Plain Layout

          0,
 0,
 0,
 
\end_layout

\begin_layout Plain Layout

          @SYSOP,
 2001,
 0);
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
Now that we've defined Institutions,
 we can add a further constraint to Sources:
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

ALTER TABLE SOURCES ADD CONSTRAINT bad_source_institution 
\end_layout

\begin_layout Plain Layout

  foreign key(institution) references Institutions(institution);
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Section
Time
\end_layout

\begin_layout Subsection
Daylight saving time (DST)
\end_layout

\begin_layout Standard
DST is further discussed in 
\emph on
seek_400.lyx
\emph default
 and the associated file 
\emph on
timely_400.lyx
\emph default
,
 where Perl routines are provided that populate the following 
\series bold
timely
\series default
 table.
 
\emph on

\begin_inset Note Note
status collapsed

\begin_layout Plain Layout

\emph on
[The composite primary key is a really silly idea.
 We must replace this with an extra,
 generated,
 unique PK,
 which will fix up the list problems that otherwise inevitably arise when we derive child matrices in insecure mode.
 FIX ME!!]
\end_layout

\end_inset


\emph default

\begin_inset Note Note
status collapsed

\begin_layout Plain Layout
[EXAMINE THE WRINKLES INDUCED BY GPS vs UTC times]
\end_layout

\end_inset

 The main idea with the 
\series bold
timely
\series default
 table is simple—
we convert the weirdly complex set of rules in the IANA tz database into a simple table of transition times for each time zone!
 The Perl code mentioned does this tricky transformation.
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

SELECT Now() `Starting`,"timely" `Table`;
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

CREATE TABLE timely
\end_layout

\begin_layout Plain Layout

( timekey integer 
\end_layout

\begin_layout Plain Layout

    ,
 constraint timely_pk PRIMARY KEY(timekey)
\end_layout

\begin_layout Plain Layout

  ,region BIGINT
\end_layout

\begin_layout Plain Layout

    ,constraint timely_region_fk FOREIGN KEY (region)
\end_layout

\begin_layout Plain Layout

      references PLACES(place)
\end_layout

\begin_layout Plain Layout

  ,
 year integer
\end_layout

\begin_layout Plain Layout

  ,
 transition BIGINT
\end_layout

\begin_layout Plain Layout

  ,
 zone_offset BIGINT
\end_layout

\begin_layout Plain Layout

  ,
 dst BIGINT
\end_layout

\begin_layout Plain Layout

  ,
 ignored integer default 0
\end_layout

\begin_layout Plain Layout

  ,
 ver integer default 0
\end_layout

\begin_layout Plain Layout

  ,
 chk int
\end_layout

\begin_layout Plain Layout

)CHARACTER SET=utf8mb4 
\end_layout

\begin_layout Plain Layout

    COLLATE=utf8mb4_unicode_ci;SHOW WARNINGS;DESCRIBE timely;
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Note Note
status collapsed

\begin_layout Plain Layout
Set up the PK.
\end_layout

\begin_layout Plain Layout
\begin_inset ERT
status open

\begin_layout Plain Layout

--
\end_layout

\begin_layout Plain Layout

-- but will still need to insert column headers.
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

SELECT *
\end_layout

\begin_layout Plain Layout

FROM timely
\end_layout

\begin_layout Plain Layout

ORDER BY region,
 year,
 transition
\end_layout

\begin_layout Plain Layout

INTO OUTFILE 'C:/fehr/serve/insecure/tables/timely.csv'
\end_layout

\begin_layout Plain Layout

FIELDS TERMINATED BY ','
\end_layout

\begin_layout Plain Layout

ENCLOSED BY ''
\end_layout

\begin_layout Plain Layout

LINES TERMINATED BY '
\backslash
r
\backslash
n';
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
In the above,
 all BIGINT time values are in microseconds.
 The times are Julian day values.
 The table will ordinarily be populated by a Perl routine that reads the TZ database.
 There may be multiple entries for each year,
 the year referring to local wall time.
 Within each year there is at least one entry,
 but if nothing exciting is going on,
 then this entry will merely be on 31 December at 23:59:59,
 and the 
\series bold
ignored 
\series default
flag will be set.
 If a 
\begin_inset Quotes eld
\end_inset

real
\begin_inset Quotes erd
\end_inset

 transition coincides with this time,
 then 1
\begin_inset space \thinspace{}
\end_inset

s is added to the real time in determining the 
\begin_inset Quotes eld
\end_inset

ignored
\begin_inset Quotes erd
\end_inset

 row,
 which is still inserted.
 
\end_layout

\begin_layout Subsection
Leap seconds
\begin_inset CommandInset label
LatexCommand label
name "subsec:Leap-seconds"

\end_inset


\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

SELECT Now() `Starting`,"leapseconds" `Table`;
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

CREATE TABLE leapseconds
\end_layout

\begin_layout Plain Layout

( leapsecond int 
\end_layout

\begin_layout Plain Layout

    ,constraint leapkey PRIMARY KEY (leapsecond) 
\end_layout

\begin_layout Plain Layout

  ,gpstime BIGINT
\end_layout

\begin_layout Plain Layout

  ,utctime BIGINT
\end_layout

\begin_layout Plain Layout

  ,toffset int -- baseline is -9
\end_layout

\begin_layout Plain Layout

  ,ver integer default 0
\end_layout

\begin_layout Plain Layout

  ,chk int
\end_layout

\begin_layout Plain Layout

)CHARACTER SET=utf8mb4 
\end_layout

\begin_layout Plain Layout

    COLLATE=utf8mb4_unicode_ci;SHOW WARNINGS;DESCRIBE leapseconds;
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
At certain unpredictable points,
 UTC time jumps in relation to GPS time,
 which ticks monotonically.
 So far,
 the jumps have always been +1s (as the Earth slows) but theoretically the jump could be negative,
 or even by two seconds.
 This table specifies the relative offset in 
\series bold
offset
\series default
,
 and the GPS and UTC times (in Julian microseconds) in the respective BIGINT variables.
 Note however that it's easy to convert the times by simply adding or subtracting the value in 
\series bold
offset 
\series default
as the relevant fraction of a day.
 So,
 to convert a GPS time to a UTC time,
 start at the top,
 and if the time is greater than or equal to the value in gpstime,
 then 
\emph on
subtract
\emph default
 the value in 
\series bold
offset
\series default
 (seconds).
 Otherwise test the next time down,
 until you get to the first entry;
 if the date is less than this entry,
 then add 9.
 Similarly,
 to convert UTC to GPS,
 conveniently use the Julian value in utctime,
 but 
\emph on
add
\emph default
 the offset value in seconds.
 In either case,
 divide the seconds value by 86400 to obtain a day fraction.
 
\end_layout

\begin_layout Standard
The leapseconds table will be populated from the TZ database by a Perl script.
\end_layout

\begin_layout Subsection
PTABLES
\begin_inset CommandInset label
LatexCommand label
name "subsec:PTABLES"

\end_inset


\end_layout

\begin_layout Standard
The 
\series bold
PTABLES
\series default
 table describes the database tables accessible to at least one usergroup.
 It must only be defined when all other relevant tables have been!
 It's important to note that the list of tables is largely reproduced in the 
\series bold
SKEYS
\series default
 table—
used for PK generation—
but it seems unwise to use that table for our purposes here.
 
\series bold
SKEYS
\series default
 is also more limited,
 as it doesn't accommodate a number of other tables like L_ tables (if present).
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

CREATE TABLE PTABLES
\end_layout

\begin_layout Plain Layout

( ptable integer AUTO_INCREMENT 
\end_layout

\begin_layout Plain Layout

    ,constraint bad_ptable_pk primary key(ptable)
\end_layout

\begin_layout Plain Layout

  ,tablename varchar(64)
\end_layout

\begin_layout Plain Layout

  
\end_layout

\begin_layout Plain Layout

  ,t_amended BIGINT
\end_layout

\begin_layout Plain Layout

  ,reason int
\end_layout

\begin_layout Plain Layout

  ,p_amended BIGINT
\end_layout

\begin_layout Plain Layout

    ,constraint bad_ptable_amended_at foreign key(p_amended)
\end_layout

\begin_layout Plain Layout

       references PLACES(place)
\end_layout

\begin_layout Plain Layout

  ,amender integer 
\end_layout

\begin_layout Plain Layout

    ,constraint bad_pillar_amender foreign key(amender)
\end_layout

\begin_layout Plain Layout

      references PEOPLE(person)
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  ,flags integer 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  ,ver integer default 0
\end_layout

\begin_layout Plain Layout

  ,chk int
\end_layout

\begin_layout Plain Layout

) CHARACTER SET=utf8mb4 
\end_layout

\begin_layout Plain Layout

  COLLATE=utf8mb4_unicode_ci;SHOW WARNINGS;DESCRIBE PTABLES;
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
Crudely select into this table:
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

-- SET @SYSOP = 2000;
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

INSERT INTO PTABLES
\end_layout

\begin_layout Plain Layout

  ( tablename,
 t_amended,
 reason,
 p_amended,
 amender)
\end_layout

\begin_layout Plain Layout

SELECT
\end_layout

\begin_layout Plain Layout

   T.TABLE_NAME
\end_layout

\begin_layout Plain Layout

   ,JD(CURRENT_TIMESTAMP)
\end_layout

\begin_layout Plain Layout

   ,0
\end_layout

\begin_layout Plain Layout

   ,0
\end_layout

\begin_layout Plain Layout

   ,@SYSOP
\end_layout

\begin_layout Plain Layout

FROM INFORMATION_SCHEMA.TABLES T WHERE T.TABLE_SCHEMA = 'smalltime'
\end_layout

\begin_layout Plain Layout

  AND T.TABLE_NAME NOT IN ('SKEYS',
 'USERS',
 'PCOLUMNS',
 'PTABLES',
 'PERMITS') 
\end_layout

\begin_layout Plain Layout

  AND T.TABLE_NAME NOT LIKE 'E
\backslash
_%';
 
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Subsection
PCOLUMNS
\begin_inset CommandInset label
LatexCommand label
name "subsec:PCOLUMNS"

\end_inset


\end_layout

\begin_layout Standard
The 
\series bold
PCOLUMS
\series default
 table describes the database columns for the tables in PTABLES.
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

CREATE TABLE PCOLUMNS 
\end_layout

\begin_layout Plain Layout

( pcolumn integer AUTO_INCREMENT 
\end_layout

\begin_layout Plain Layout

    ,constraint bad_pcolumn_pk primary key(pcolumn)
\end_layout

\begin_layout Plain Layout

  ,ptable integer 
\end_layout

\begin_layout Plain Layout

    ,constraint bad_pcolumn_table foreign key(ptable)
\end_layout

\begin_layout Plain Layout

       references PTABLES(ptable)
\end_layout

\begin_layout Plain Layout

  ,colname varchar(64)
\end_layout

\begin_layout Plain Layout

  ,canonical_position integer 
\end_layout

\begin_layout Plain Layout

  ,column_type varchar(1) -- I J T F not varchar(64) 
\end_layout

\begin_layout Plain Layout

  ,maximum_length integer 
\end_layout

\begin_layout Plain Layout

  
\end_layout

\begin_layout Plain Layout

  ,t_amended BIGINT
\end_layout

\begin_layout Plain Layout

  ,reason int
\end_layout

\begin_layout Plain Layout

  ,p_amended BIGINT
\end_layout

\begin_layout Plain Layout

    ,constraint bad_pcolumn_amended_at foreign key(p_amended)
\end_layout

\begin_layout Plain Layout

       references PLACES(place)
\end_layout

\begin_layout Plain Layout

  ,amender integer 
\end_layout

\begin_layout Plain Layout

    ,constraint bad_pcolumn_amender foreign key(amender)
\end_layout

\begin_layout Plain Layout

      references PEOPLE(person)
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  ,ver integer default 0
\end_layout

\begin_layout Plain Layout

  ,chk int
\end_layout

\begin_layout Plain Layout

) CHARACTER SET=utf8mb4 
\end_layout

\begin_layout Plain Layout

  COLLATE=utf8mb4_unicode_ci;SHOW WARNINGS;DESCRIBE PCOLUMNS;
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
Select in all of the columns that are relevant:
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

-- SET @SYSOP = 2000;
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

INSERT INTO PCOLUMNS
\end_layout

\begin_layout Plain Layout

  ( ptable,
 colname,
 canonical_position,
 column_type,
 maximum_length,
\end_layout

\begin_layout Plain Layout

    t_amended,
 reason,
 p_amended,
 amender )
\end_layout

\begin_layout Plain Layout

SELECT
\end_layout

\begin_layout Plain Layout

  D.ptable
\end_layout

\begin_layout Plain Layout

  ,C.COLUMN_NAME 
\end_layout

\begin_layout Plain Layout

  ,C.ORDINAL_POSITION 
\end_layout

\begin_layout Plain Layout

  ,CASE 
\end_layout

\begin_layout Plain Layout

    WHEN C.COLUMN_TYPE LIKE 'varchar%' THEN 'T'
\end_layout

\begin_layout Plain Layout

    WHEN C.COLUMN_TYPE LIKE 'bigint%' THEN 'I'
\end_layout

\begin_layout Plain Layout

    WHEN C.COLUMN_TYPE LIKE 'int%' THEN 'J'
\end_layout

\begin_layout Plain Layout

    WHEN C.COLUMN_TYPE LIKE 'float%' THEN 'F'
\end_layout

\begin_layout Plain Layout

    ELSE 'Q'
\end_layout

\begin_layout Plain Layout

  END 
\end_layout

\begin_layout Plain Layout

  ,C.CHARACTER_MAXIMUM_LENGTH
\end_layout

\begin_layout Plain Layout

  ,JD(CURRENT_TIMESTAMP)
\end_layout

\begin_layout Plain Layout

  ,0
\end_layout

\begin_layout Plain Layout

  ,0
\end_layout

\begin_layout Plain Layout

  ,@SYSOP
\end_layout

\begin_layout Plain Layout

FROM INFORMATION_SCHEMA.COLUMNS C
\end_layout

\begin_layout Plain Layout

  INNER JOIN PTABLES D ON C.TABLE_NAME = D.tablename
\end_layout

\begin_layout Plain Layout

WHERE C.TABLE_SCHEMA = 'smalltime'
\end_layout

\begin_layout Plain Layout

  AND C.COLUMN_NAME NOT IN ( 'ver',
 'chk' ) 
\end_layout

\begin_layout Plain Layout

  AND D.tablename NOT IN ( 'skeys',
 'usergroups',
 'users' );
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
Note that 'workstations' and 'mytables' are now redundant references.
 
\end_layout

\end_inset


\end_layout

\begin_layout Section
Special tz tables
\end_layout

\begin_layout Standard

\series bold
\emph on
Create
\series default
\emph default
 the following ancillary rule tables in 
\series bold
\emph on
f
\emph default
ehr
\series default
.
 There is minimal processing,
 and the tables are denormalized with respect to rule_name.
 The sole intent of these tables is to permit reconciliation of rules when a new tz version is encountered.
 They are 
\emph on
not
\emph default
 used to perform calculations,
 but to record what was used by the 
\emph on
timely.pm
\emph default
 module in translating tz rules into entries in the 
\series bold
timely
\series default
 table.
 
\end_layout

\begin_layout Subsection
rule sets:
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

SELECT Now() `Starting`,"tz_rules" `Table`;
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

CREATE TABLE tz_rules
\end_layout

\begin_layout Plain Layout

( tz_rule integer
\end_layout

\begin_layout Plain Layout

  ,rule_name varchar(16)
\end_layout

\begin_layout Plain Layout

  ,from_year varchar(8)
\end_layout

\begin_layout Plain Layout

  ,to_year varchar(8)
\end_layout

\begin_layout Plain Layout

  ,in_on_at varchar(64)
\end_layout

\begin_layout Plain Layout

  ,dst varchar(8)
\end_layout

\begin_layout Plain Layout

  ,is_active integer default 1
\end_layout

\begin_layout Plain Layout

)CHARACTER SET=utf8mb4 
\end_layout

\begin_layout Plain Layout

    COLLATE=utf8mb4_unicode_ci;SHOW WARNINGS;DESCRIBE tz_rules;
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Subsection
zone cutoff rules
\end_layout

\begin_layout Standard
To prevent duplicates and check,
 each rule row can be identified not just by the sequential,
 internal PK in tz_rule or tz_cutoff,
 but respectively by rule_name+from_year+to_year+in_on_at;
 and region+until_text.
 This allows us (at the start of any re-importation) to:
\end_layout

\begin_layout Itemize
Reset all active values to 0
\end_layout

\begin_layout Itemize
Re-activate all identified rows to 1
\end_layout

\begin_layout Itemize
Add new rows,
 as needed,
 in either table.
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

SELECT Now() `Starting`,"tz_cutoffs" `Table`;
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

CREATE TABLE tz_cutoffs
\end_layout

\begin_layout Plain Layout

( tz_cutoff integer
\end_layout

\begin_layout Plain Layout

  ,stdoff varchar(16)
\end_layout

\begin_layout Plain Layout

  ,rule_name varchar(16)
\end_layout

\begin_layout Plain Layout

  ,region BIGINT
\end_layout

\begin_layout Plain Layout

    ,constraint tz_cutoffs_region FOREIGN KEY (region)
\end_layout

\begin_layout Plain Layout

      references PLACES(place)
\end_layout

\begin_layout Plain Layout

  ,until_text varchar(16)
\end_layout

\begin_layout Plain Layout

  ,is_active integer default 1
\end_layout

\begin_layout Plain Layout

)CHARACTER SET=utf8mb4 
\end_layout

\begin_layout Plain Layout

    COLLATE=utf8mb4_unicode_ci;SHOW WARNINGS;DESCRIBE tz_cutoffs;
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
We also need source rows in 
\series bold
SKEYS
\series default
:
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

INSERT INTO SKEYS (kName,
        kValue,
 klock) VALUES 
\end_layout

\begin_layout Plain Layout

                  ('tz_rules',
   1000,
   0),
\end_layout

\begin_layout Plain Layout

                  ('tz_cutoffs',
 1000,
   0);
 
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Chapter
ODBC connection to 
\series bold
\emph on
smalltime
\series default
\emph default

\begin_inset CommandInset label
LatexCommand label
name "sec:ODBC-connection-to-fehr"

\end_inset


\end_layout

\begin_layout Standard
The following describes a typical Windows connection.
 For Linux,
 see Section
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:Linux"
plural "false"
caps "false"
noprefix "false"
nolink "false"

\end_inset

.
 
\end_layout

\begin_layout Enumerate
Download MySQL Connector/ODBC Install using the `typical' installation configuration.
 
\begin_inset Note Note
status collapsed

\begin_layout Plain Layout
OTHER POTENTIAL IDEAS:
 
\end_layout

\begin_layout Plain Layout
—
 Open a Command prompt running as admin (an `elevated' command prompt) and say:
\end_layout

\begin_layout Quote

\family typewriter
cmdkey /add:MYSQL_SMALLTIME /user:myusernamehere /pass:therelevantpassword
\end_layout

\begin_deeper
\begin_layout Quote
cmdkey /generic:MYSQL_SMALLTIME /user:myusername /pass:mypassword
\end_layout

\begin_layout Quote
You should get 
\begin_inset Quotes eld
\end_inset

Credential added successfully
\begin_inset Quotes erd
\end_inset


\end_layout

\end_deeper
\end_inset


\begin_inset Note Note
status collapsed

\begin_layout Plain Layout
Open PowerShell,
 and enter the following **with the relevant user/password filled in** \SpecialChar ldots
 
\end_layout

\begin_layout Quote

\family typewriter
[Environment]::SetEnvironmentVariable("SMALLTIME_USER",
 "youruser",
 "User")
\end_layout

\begin_deeper
\begin_layout Quote

\family typewriter
[Environment]::SetEnvironmentVariable("SMALLTIME_PASS",
 "yourpass",
 "User")
\end_layout

\begin_layout Quote
\begin_inset Note Note
status open

\begin_layout Quote

\family typewriter
[Environment]::SetEnvironmentVariable("SMALLTIME_USER",
 "root",
 "User")
\end_layout

\begin_layout Quote

\family typewriter
[Environment]::SetEnvironmentVariable("SMALLTIME_PASS",
 "---------------",
 "User")
\end_layout

\end_inset


\end_layout

\end_deeper
\end_inset


\end_layout

\begin_layout Enumerate
Open a Windows command prompt 
\series bold
\emph on
as administrator
\series default
\emph default
 and say:
\end_layout

\begin_deeper
\begin_layout Quote

\family typewriter
C:
\backslash
Windows
\backslash
System32
\backslash
odbcad32.exe
\end_layout

\begin_layout Enumerate
Make sure you're on the System DSN tab 
\end_layout

\begin_layout Enumerate
Note that other ways of doing this may fail in Windows 11 (even if you select run as admin) or succeed intermittently.
 Also see:
\begin_inset Newline newline
\end_inset


\begin_inset CommandInset href
LatexCommand href
name "https://www.tech2geek.net/how-to-fix-odbc-settings-not-saving-in-windows-11-pro/"
target "https://www.tech2geek.net/how-to-fix-odbc-settings-not-saving-in-windows-11-pro/"
literal "false"

\end_inset

 
\end_layout

\end_deeper
\begin_layout Enumerate
Click the [Add ] button 
\end_layout

\begin_layout Enumerate
Select the MySQL ODBC Unicode driver,
 and click [Finish];
\end_layout

\begin_layout Enumerate
Enter SMALLTIME as the Data Source Name,
 inserting the relevant user name and 
\emph on
password 
\end_layout

\begin_layout Description
Data
\begin_inset space \thinspace{}
\end_inset

Source
\begin_inset space \thinspace{}
\end_inset

Name:
 SMALLTIME 
\end_layout

\begin_layout Description
Description:
 
\series bold
\emph on
smalltime
\series default
\emph default
 data (or whatever)
\end_layout

\begin_layout Description
TCP/IP
\begin_inset space \thinspace{}
\end_inset

server:
 selected
\end_layout

\begin_layout Description
Port:
 3306
\end_layout

\begin_layout Description
User:
 A specific user (or root,
 if you want to be dangerous) 
\end_layout

\begin_layout Description
Database:
 all databases should pop up!
 (Make sure WampServer is running and `green').
 Select 
\series bold
\emph on
smalltime
\series default
\emph default
 —
 you can now test the connection using the [Test] button next to the database name.
 
\end_layout

\begin_layout Section
Linux
\begin_inset CommandInset label
LatexCommand label
name "subsec:Linux"

\end_inset


\end_layout

\begin_layout Standard
This can be more challenging than with Windows.
 In the following we go through the whole gamut,
 and build the ODBC driver—
but I should explore other database connection options that fill in for ODBC.
 
\end_layout

\begin_layout Standard
\begin_inset Note Note
status collapsed

\begin_layout Plain Layout
\begin_inset Note Note
status open

\begin_layout Plain Layout
https://dev.mysql.com/doc/connector-odbc/en/connector-odbc-installation-binary-deb.html
\end_layout

\begin_layout Plain Layout
\begin_inset Note Note
status open

\begin_layout Plain Layout
The hard way:
\end_layout

\begin_layout Plain Layout
https://dev.mysql.com/doc/connector-odbc/en/connector-odbc-installation-binary-unix-tarball.html
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout
Under Linux,
 do the following:
\end_layout

\begin_layout Enumerate
Download the driver from 
\begin_inset CommandInset href
LatexCommand href
name "https://dev.mysql.com/downloads/connector/odbc/"
target "https://dev.mysql.com/downloads/connector/odbc/"
literal "false"

\end_inset

 —
 e.g.
 the .deb file for your version of Ubuntu;
\end_layout

\begin_deeper
\begin_layout Enumerate
wget https://dev.mysql.com/get/Downloads/Connector-ODBC/8.0/mysql-connector-odbc_8.0.21-1ubuntu20.04_amd64.deb
\end_layout

\end_deeper
\begin_layout Enumerate
Install it,
 eg.
 by storing the .deb file in a convenient directory and saying:
\end_layout

\begin_deeper
\begin_layout Enumerate
sudo dpkg -i mysql-connector-odbc_8.0.22-1ubuntu20.04_amd64.deb 
\end_layout

\begin_layout Enumerate
Hmm sudo apt-get 
\begin_inset ERT
status open

\begin_layout Plain Layout

--
\end_layout

\end_inset

fix-broken install 
\begin_inset Note Note
status open

\begin_layout Plain Layout
\begin_inset ERT
status open

\begin_layout Plain Layout

dpkg:
 dependency problems prevent configuration of mysql-connector-odbc:amd64:
  mysql-connector-odbc:amd64 depends on mysql-community-client-plugins;
 however:
   Package mysql-community-client-plugins is not installed.
  mysql-connector-odbc:amd64 depends on libodbc1 (>= 2.3.1);
 however:
   Package libodbc1 is not installed.
  mysql-connector-odbc:amd64 depends on odbcinst1debian2 (>= 2.3.1);
 however:
   Package odbcinst1debian2 is not installed.
\end_layout

\begin_layout Plain Layout

dpkg:
 error processing package mysql-connector-odbc:amd64 (--install):
  dependency problems - leaving unconfigured Errors were encountered while processing:
  mysql-connector-odbc:amd64 
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\end_deeper
\begin_layout Plain Layout
\begin_inset Separator plain
\end_inset


\end_layout

\begin_layout Plain Layout
Hmm,
 another way:
 https://www.howtoforge.com/adding-an-odbc-driver-for-mysql-on-ubuntu
\end_layout

\begin_layout Enumerate
sudo apt-get install iodbc
\end_layout

\begin_layout Enumerate
sudo apt-get install libmyodbc [THIS DOES NOT WORK]
\end_layout

\begin_layout Enumerate
iodbcadm-gtk
\end_layout

\begin_layout Plain Layout
\begin_inset Separator plain
\end_inset


\end_layout

\begin_layout Plain Layout
So what to do?
 It seems reasonable to sudo dpkg as above 
\emph on
after
\emph default
 installing:
\end_layout

\begin_layout Itemize
mysql-community-client-plugins :
 https://pkgs.org/download/mysql-community-client-plugins 
\end_layout

\begin_deeper
\begin_layout Itemize
thence:
 https://ubuntu.pkgs.org/20.04/mysql-8.0-amd64/ 
\end_layout

\begin_layout Itemize
FUCK!
\end_layout

\begin_layout Itemize
Try 
\family typewriter
sudo apt-get install libssl-dev
\family default
 !!
 cf.
 https://www.zabbix.com/forum/zabbix-help/413942-error-not-found-mysqlclient-library-on-ubuntu-server-20-04-lts 
\end_layout

\begin_layout Itemize
s
\family typewriter
udo apt-get install libmysqlclient-dev 
\end_layout

\end_deeper
\begin_layout Itemize
sudo apt-get install libodbc1
\end_layout

\begin_layout Itemize
sudo apt-get install odbcinst1debian2 
\end_layout

\begin_layout Plain Layout
\begin_inset Separator plain
\end_inset


\end_layout

\begin_layout Plain Layout
Finally:
 
\end_layout

\begin_layout Plain Layout
\begin_inset Note Note
status open

\begin_layout Plain Layout
DLL HELL!
\end_layout

\begin_layout Plain Layout
https://unix.stackexchange.com/questions/270872/install-mysql-has-no-installation-candidate
\end_layout

\end_inset


\end_layout

\begin_layout Quote
https://repo.mysql.com/apt/ubuntu/pool/mysql-8.0/m/mysql-community/mysql-community-client-plugins_8.0.22-1ubuntu20.04_amd64.deb
\end_layout

\begin_layout Quote
sudo dpkg -i mysql-community-client-plugins_8.0.22-1ubuntu20.04_amd64.deb 
\end_layout

\begin_layout Quote
sudo dpkg -i mysql-connector-odbc_8.0.22-1ubuntu20.04_amd64.deb
\end_layout

\begin_layout Plain Layout
\begin_inset Separator plain
\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Note Note
status open

\begin_layout Plain Layout
Look for:
\end_layout

\begin_layout Plain Layout
${LibDir}/odbc/libmyodbc8S.so
\end_layout

\begin_layout Plain Layout
${DocDir}/mysql-connector-odbc-setup/*
\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout
ls /usr/lib/x86_64-linux-gnu/odbc/libodbc*.so 
\end_layout

\begin_layout Enumerate
Now,
 create these files in /etc :
\begin_inset Note Note
status collapsed

\begin_layout Plain Layout
https://askubuntu.com/questions/1165430/how-to-install-and-configure-the-latest-odbc-driivers-for-both-mysql-postgresq
\end_layout

\end_inset


\end_layout

\begin_deeper
\begin_layout Enumerate
odbcinst.ini
\end_layout

\begin_layout Enumerate
odbc.ini
\end_layout

\end_deeper
\begin_layout Subsection
Or:
 Try MariaDB instead
\end_layout

\end_inset


\end_layout

\begin_layout Subsection
Install MySQL / MariaDB
\end_layout

\begin_layout Standard
See 
\begin_inset CommandInset href
LatexCommand href
name "https://www.digitalocean.com/community/tutorials/how-to-install-mariadb-on-ubuntu-22-04"
target "https://www.digitalocean.com/community/tutorials/how-to-install-mariadb-on-ubuntu-22-04"
literal "false"

\end_inset


\end_layout

\begin_layout Quote

\family typewriter
sudo apt install mariadb-server
\end_layout

\begin_layout Quote

\family typewriter
sudo mysql_secure_installation
\end_layout

\begin_layout Standard
\SpecialChar ldots
 follow the instructions,
 set your password.
 Then:
\end_layout

\begin_layout Subsection
Make a separate admin account:
\end_layout

\begin_layout Quote

\family typewriter
sudo mariadb
\end_layout

\begin_layout Quote

\family typewriter
GRANT ALL ON *.* TO 'admin'@'localhost' IDENTIFIED BY 'password' WITH GRANT OPTION;
\end_layout

\begin_layout Quote

\family typewriter
FLUSH PRIVILEGES;
\end_layout

\begin_layout Quote

\family typewriter
exit
\end_layout

\begin_layout Standard
Check status:
 
\end_layout

\begin_layout Quote

\family typewriter
sudo systemctl status mariadb
\end_layout

\begin_layout Standard
## to start would say:
 ## sudo systemctl start mariadb
\end_layout

\begin_layout Standard
## Now check mysqladmin:
\end_layout

\begin_layout Quote

\family typewriter
sudo mysqladmin version
\end_layout

\begin_layout Subsection
Install PhpMyAdmin
\end_layout

\begin_layout Quote

\family typewriter
sudo apt install phpmyadmin
\end_layout

\begin_layout Standard
#THIS WILL INSTALL APACHE 
\end_layout

\begin_layout Standard
You may next want to visit:
 http://localhost/ ;
 Then say:
 
\end_layout

\begin_layout Quote

\family typewriter
sudo nano /etc/apache2/apache2.conf
\end_layout

\begin_layout Standard
Modify by adding this:
\end_layout

\begin_layout Quote

\family typewriter
# Modified by JvS on 2025-12-17
\end_layout

\begin_layout Quote

\family typewriter
Include /etc/phpmyadmin/apache.conf
\end_layout

\begin_layout Quote

\family typewriter
# end modification.
\end_layout

\begin_layout Quote

\family typewriter
sudo service apache2 restart
\end_layout

\begin_layout Standard
# then navigate to 
\end_layout

\begin_layout Standard
http://localhost/phpmyadmin/ 
\end_layout

\begin_layout Standard
Login as admin (rather than root) 
\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
–
\end_layout

\begin_layout Subsection
Finding server’s public IP (later)
\end_layout

\begin_layout Quote

\family typewriter
sudo apt install curl
\end_layout

\begin_layout Quote

\family typewriter
curl http://icanhazip.com
\end_layout

\begin_layout Plain Layout
\SpecialChar ldots
 or perhaps:
 ip addr show ens3 | grep inet | awk '{ print $2;
 }' | sed 's/
\backslash
/.*$//' 
\end_layout

\end_inset


\end_layout

\begin_layout Subsection
Make vanilla user
\end_layout

\begin_layout Standard
Login to http://localhost/phpmyadmin/ as admin
\end_layout

\begin_layout Standard
User accounts | Add user account \SpecialChar ldots
 
\end_layout

\begin_layout Standard
User name:
 vanilla
\end_layout

\begin_layout Standard
localhost
\end_layout

\begin_layout Standard
[password] 
\end_layout

\begin_layout Standard
Limit privileges to SELECT,
 INSERT,
 UPDATE and DELETE
\end_layout

\begin_layout Standard
(We need DELETE for the initial setup of smalltime,
 but after this wise to remove this privilege).
 
\end_layout

\begin_layout Subsection
Make your actual database
\end_layout

\begin_layout Standard
Do this,
 as noted in Chapter
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand ref
reference "chap:Minimal-database"
plural "false"
caps "false"
noprefix "false"
nolink "false"

\end_inset

.
 
\end_layout

\begin_layout Subsection
MariaDB connector
\end_layout

\begin_layout Standard
\begin_inset CommandInset href
LatexCommand href
name "https://mariadb.com/docs/connectors/connectors-quickstart-guides/connector-odbc-guide"
target "https://mariadb.com/docs/connectors/connectors-quickstart-guides/connector-odbc-guide"
literal "false"

\end_inset


\end_layout

\begin_layout Quote

\family typewriter
sudo apt update
\end_layout

\begin_layout Quote

\family typewriter
sudo apt upgrade
\end_layout

\begin_layout Quote

\family typewriter
sudo apt install unixodbc unixodbc-dev
\end_layout

\begin_layout Standard
You may encounter **pain** NB.
 get the right version.
 Check your Debian version.
 ** The following are examples only**
\end_layout

\begin_layout Standard
Go to:
 
\begin_inset CommandInset href
LatexCommand href
name "https://mariadb.com/downloads/connectors/connectors-data-access/odbc-connector/"
target "https://mariadb.com/downloads/connectors/connectors-data-access/odbc-connector/"
literal "false"

\end_inset


\end_layout

\begin_layout Standard
Download ODBC connector | version 3.2.7-GA for Debian 12 64 bit 
\end_layout

\begin_layout Standard
This will go to e.g.
 /home/jo/Downloads/ 
\end_layout

\begin_layout Quote

\family typewriter
sudo mv Downloads/maria*.deb /usr/src
\end_layout

\begin_layout Quote

\family typewriter
cd /usr/src/
\end_layout

\begin_layout Quote

\family typewriter
ls
\end_layout

\begin_layout Quote

\family typewriter
sudo dpkg -i mariadb-connector-odbc_3.2.7-1+maria~bookworm_amd64.deb
\end_layout

\begin_layout Standard
You may need 
\family typewriter
sudo apt --fix-broken install
\family default
 rather a lot.
 
\end_layout

\begin_layout Subsection
Configure odbcinst.ini and odbc.ini
\end_layout

\begin_layout Standard
Look for driver definition in 
\emph on
/etc/odbcinst.ini
\emph default
 
\end_layout

\begin_layout Enumerate
For user DSNs,
 you need to create/modify 
\emph on
~/.odbc.ini
\emph default
 
\end_layout

\begin_layout Enumerate
For system DSNs,
 you must create/modify 
\emph on
/etc/odbc.ini
\emph default
 
\end_layout

\begin_layout Standard
First,
 find the driver/setup:
\end_layout

\begin_layout Quote

\family typewriter
ls -la /usr/lib/x86_64-linux-gnu/ | grep odbc
\end_layout

\begin_layout Standard
Look for libmaodbc.so 
\end_layout

\begin_layout Standard
Open the file 
\emph on
/etc/odbcinst.ini
\emph default
 and edit (sudo) the driver definition along the lines of:
\end_layout

\begin_layout Quote

\family typewriter
[MariaDB_ODBC_Driver]
\end_layout

\begin_layout Quote

\family typewriter
Description = MariaDB Connector/ODBC
\end_layout

\begin_layout Quote

\family typewriter
Driver = /usr/lib/x86_64-linux-gnu/libmaodbc.so
\end_layout

\begin_layout Quote

\family typewriter
Setup = /usr/lib/x86_64-linux-gnu/libmaodbc.so
\end_layout

\begin_layout Quote

\family typewriter
UsageCount = 1
\end_layout

\begin_layout Standard
Similarly edit 
\emph on
odbc.ini
\emph default
 which provides the DSN,
 and store it in 
\emph on
~/.odbc.ini
\emph default
 
\end_layout

\begin_layout Quote

\family typewriter
[SMALLTIME]
\end_layout

\begin_layout Quote

\family typewriter
Description = My MariaDB Database
\end_layout

\begin_layout Quote

\family typewriter
Driver = MariaDB_ODBC_Driver
\end_layout

\begin_layout Quote

\family typewriter
SERVER = 127.0.0.1
\end_layout

\begin_layout Quote

\family typewriter
PORT = 3306
\end_layout

\begin_layout Quote

\family typewriter
DATABASE = smalltime
\end_layout

\begin_layout Quote

\family typewriter
User = admin
\end_layout

\begin_layout Quote

\family typewriter
Password = ***yourpasswordgoeshere***
\end_layout

\begin_layout Standard
Permissible variation:
\end_layout

\begin_layout Standard
You can change 127.0.0.1 to localhost instead.
 
\end_layout

\begin_layout Standard
Don’t use admin as the user.
 Rather use an under-privileged vanilla account!
 
\end_layout

\begin_layout Subsection
TEST:
\end_layout

\begin_layout Quote

\family typewriter
isql SMALLTIME your_username your_password
\end_layout

\begin_layout Standard
If this fails,
 check dependencies:
 
\end_layout

\begin_layout Quote

\family typewriter
ldd /usr/lib/x86_64-linux-gnu/libmaodbc.so
\end_layout

\begin_layout Standard
Make sure that e.g.
 MariaDB_ODBC_Driver is identically represented as the Driver in SMALLTIME.
 
\end_layout

\begin_layout Standard
## Check drivers:
 odbcinst -q -d and then odbcinst -q -s 
\end_layout

\begin_layout Standard
## Should list the name of the driver ;
 and the data source.
 
\end_layout

\begin_layout Standard
## (may need to install odbcinst )
\end_layout

\begin_layout Standard
Use stat /dtc/odbcinst.ini to check the permissions,
 which should be 644.
 Otherwise might need to chmod.
 
\end_layout

\begin_layout Chapter
The Perl script
\begin_inset CommandInset label
LatexCommand label
name "chap:The-Perl-script"

\end_inset


\end_layout

\begin_layout Section
The main file 
\begin_inset CommandInset label
LatexCommand label
name "sec:The-main-file"

\end_inset


\end_layout

\begin_layout Standard
This is 
\emph on
perl/small.pl
\emph default
.
 It continues in Chapter
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand ref
reference "chap:Key-Perl-routines"
plural "false"
caps "false"
noprefix "false"
nolink "false"

\end_inset

.
 If you've established the desired directories e.g.
 
\emph on
~/smalltime
\emph default
 and 
\emph on
~/smalltime/perl
\emph default
,
 to run the program in in Linux say:
\end_layout

\begin_layout Quote

\family typewriter
cd ~/smalltime/perl
\end_layout

\begin_layout Quote

\family typewriter
perl small.pl
\end_layout

\begin_layout Standard
\begin_inset Separator plain
\end_inset


\end_layout

\begin_layout Standard
The command line menu should appear.
 The first time,
 you'll say
\family typewriter
 r all 
\family default
to read the entire source from the IANA tz files you've put in ~/
\emph on
smalltime/perl/tz/
\emph default
.
 (See Section
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand ref
reference "sec:Populating-timely-table"
plural "false"
caps "false"
noprefix "false"
nolink "false"

\end_inset

 for details).
 Windows is similar.
 Most powerful is then
\family typewriter
 v all 
\family default
as this validates all transitions against the timezone data installed in the Perl module.
 Not that particularly on Windows,
 the Perl version may not be up to date,
 resulting in discrepancies.
 
\end_layout

\begin_layout Standard
\begin_inset CommandInset line
LatexCommand rule
offset "0.5ex"
width "100col%"
height "3pt"

\end_inset


\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger newTarget=`perl/small.pl' startComment=`# ' noWarn=`yes'
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

#!/usr/local/bin/perl -w
\end_layout

\begin_layout Plain Layout

use strict;
\end_layout

\begin_layout Plain Layout

use warnings;
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

# check the following:
 
\end_layout

\begin_layout Plain Layout

use feature 'unicode_strings';
 
\end_layout

\begin_layout Plain Layout

use utf8;
 
\end_layout

\begin_layout Plain Layout

use open ':encoding(utf8)';
\end_layout

\begin_layout Plain Layout

binmode(STDOUT,
 ":utf8");
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

use constant LEAPSECONDCOUNT => 27;
  # see usage below 
\end_layout

\begin_layout Plain Layout

my $TOPCOUNTRY = 999;
           # max in PLACES table.
 *DO NOT* fiddle!
 
\end_layout

\begin_layout Plain Layout

                                # don't make it a constant (interpolated).
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

my $FULLDEBUG = 0;
 # [nasty] 
\end_layout

\begin_layout Plain Layout

my $TOPYEAR = 2035;
\end_layout

\begin_layout Plain Layout

my $LOWYEAR = 1895;
\end_layout

\begin_layout Plain Layout

my($PRETTYDOTS) = 60;
  # count of dots on console before newline 
\end_layout

\begin_layout Plain Layout

my $TICK  = 
\begin_inset Quotes eld
\end_inset

✔
\begin_inset Quotes erd
\end_inset

;
 # or '_/' if no Utf8.
 
\end_layout

\begin_layout Plain Layout

my $MAXOOPS = 100;
              # maximum errors.
 See usage.
\end_layout

\begin_layout Plain Layout

my $READKEYBLOCKINGPROBLEM = 0;
 # A problem with Perl upgrade to 5.28 !
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

my $TZDIR = 'tz';
        # sub-directory that contains tz data files
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

package main;
 
\end_layout

\begin_layout Plain Layout

## use Time::HiRes qw(gettimeofday usleep);
  # high-resolution timing 
\end_layout

\begin_layout Plain Layout

## use POSIX qw(floor ceil);
 
\end_layout

\begin_layout Plain Layout

## use File::Copy qw(move);
 # more 'compatible' than rename
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

use Term::ReadKey;
  # only used to interrupt long loops by pressing Esc
\end_layout

\begin_layout Plain Layout

$| = 1;
             # turn on autoflushing 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

## ensure lib/Timely module is visible:
 [???
 is this necessary ???] 
\end_layout

\begin_layout Plain Layout

use FindBin;
 
\end_layout

\begin_layout Plain Layout

use lib 
\begin_inset Quotes eld
\end_inset

$FindBin::Bin/lib
\begin_inset Quotes erd
\end_inset

;
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

use Timely;
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
This complains:
\end_layout

\begin_layout Plain Layout
\begin_inset ERT
status open

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

# use Timely qw( BeginTimely );
 
\end_layout

\begin_layout Plain Layout

  
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
Security if environment variable set [hmm] 
\end_layout

\begin_layout Plain Layout
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

my $username = $ENV{SMALLTIME_USER} || die "SMALLTIME_USER not set";
\end_layout

\begin_layout Plain Layout

my $password = $ENV{SMALLTIME_PASS} || die "SMALLTIME_PASS not set";
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
In the following,
 
\family typewriter
@OLDMENUVALUES
\family default
 is used to retain these attributes and access them when appropriate—
only used in checking whether various menu parameters have changed,
 and emboldening the displayed text accordingly.
 
\begin_inset Note Note
status open

\begin_layout Plain Layout
[nasty]
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

             # NAMES:
 ('region',
 'placename',
 'INTERVAL',
 'utc',
 'DayNumber',
 
\end_layout

\begin_layout Plain Layout

             #         'sec',
 'wall',
 'myz',
 'mydst');
 
\end_layout

\begin_layout Plain Layout

 my(@OLDMENUVALUES) = ('',
       '',
          '',
         '',
    '',
          
\end_layout

\begin_layout Plain Layout

                       '',
    '',
     '',
    ''     );
 
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Note Note
status collapsed

\begin_layout Plain Layout
NOPE,
 THIS DOAN WORK NUTHIN
\end_layout

\begin_layout Plain Layout
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

## security:
 cf:
 ## cmdkey /generic:SMALLTIME /user:myusername /pass:mypassword
\end_layout

\begin_layout Plain Layout

# 
\end_layout

\begin_layout Plain Layout

use Win32::Security::Credentials;
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

my $cred = Win32::Security::Credentials->new( target => 'MYSQL_SMALLTIME',
 
\end_layout

\begin_layout Plain Layout

                                              type => CRED_TYPE_GENERIC );
 
\end_layout

\begin_layout Plain Layout

my $username = $cred->username;
 
\end_layout

\begin_layout Plain Layout

my $password = $cred->password;
 
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Note Note
status collapsed

\begin_layout Plain Layout
\begin_inset ERT
status open

\begin_layout Plain Layout

## use Text::Unidecode;
 # for ASCII conversions from Unicode 
\end_layout

\begin_layout Plain Layout

## ^ need to install if use.
 hmm.
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

## explore UTF8:
  cf.
 https://stackoverflow.com/questions/627661/how-can-i-output-utf-8-from-perl 
\end_layout

\begin_layout Plain Layout

#binmode(STDOUT,
 ":utf8");
\end_layout

\begin_layout Plain Layout

## NB.
 Under Windows in your console you will still need to say 
\end_layout

\begin_layout Plain Layout

##      chcp 65000
\end_layout

\begin_layout Plain Layout

##   ...
 in order to get the active code page right!
 (Default is 850)
\end_layout

\begin_layout Plain Layout

## Also note that   use utf8;
   doesn't alter output,
 it's for input.
 
\end_layout

\begin_layout Plain Layout

## For STDOUT,
 STDIN & STDERR,
 might also say:
\end_layout

\begin_layout Plain Layout

##   use open qw/:std :utf8/;
 
\end_layout

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
Some important constants.
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

use constant ZoneReadFailed => 1000;
 # arbitrary failure code (should be > 100) 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  ## COLOURS:
 30–37 = black,
 red,
 green,
 yellow,
 blue,
 magenta,
 cyan,
 white.
 
\end_layout

\begin_layout Plain Layout

use constant ANSIBLACK => 30;
 
\end_layout

\begin_layout Plain Layout

use constant ANSIRED => 31;
 
\end_layout

\begin_layout Plain Layout

use constant ANSIGREEN => 32;
 
\end_layout

\begin_layout Plain Layout

use constant ANSIYELLOW => 33;
 
\end_layout

\begin_layout Plain Layout

use constant ANSIBLUE => 34;
 
\end_layout

\begin_layout Plain Layout

use constant ANSIMAGENTA => 35;
 
\end_layout

\begin_layout Plain Layout

use constant ANSICYAN => 36;
 
\end_layout

\begin_layout Plain Layout

use constant ANSIWHITE => 37;
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

use constant MAXZOFF => 1+14*3600;
  # ) maximum ZONE offset (+14 for Kiritimati);
 
\end_layout

\begin_layout Plain Layout

use constant MAXDST => 1+12*3600;
   # ) seconds 
\end_layout

\begin_layout Plain Layout

use constant MINIMUMDATE => 2378496*86400;
    # < 1800 is just silly 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  ## convenient constants used in tz rule translation:
 
\end_layout

\begin_layout Plain Layout

use constant  DASHRULE => '-';
\end_layout

\begin_layout Plain Layout

use constant  FIXEDDST => 'd';
\end_layout

\begin_layout Plain Layout

use constant  FIXEDDZ => 'z';
\end_layout

\begin_layout Plain Layout

use constant  DSTTRAN => 'x';
\end_layout

\begin_layout Plain Layout

use constant  FINALRULE => 'y';
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

use constant EPSILONSECONDS => 0.010;
     # [fix this up cf below.
 10 ms.
 ] 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  ## ERROR codes:
 
\end_layout

\begin_layout Plain Layout

use constant OnlyHelp => 1;
 
\end_layout

\begin_layout Plain Layout

use constant BadTopYear => 2;
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

my $LEAPSECONDS = LEAPSECONDCOUNT;
 
\end_layout

\begin_layout Plain Layout

my $BASEDATABASE = 'SMALLTIME';
    # the target database *written to* 
\end_layout

\begin_layout Plain Layout

                                   # for change specify db=foo on the command line.
 
\end_layout

\begin_layout Plain Layout

  my $TZDATABASEID = 0;
              # a source (src) ID 
\end_layout

\begin_layout Plain Layout

  my $USERID = 2000;
               # 'standard' default main user
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

my @STORAGE;
 
\end_layout

\begin_layout Plain Layout

my %LOCALS = ();
                   # current set of locals (empty) 
\end_layout

\begin_layout Plain Layout

my %ZONECODES;
                     #  internal database zone codes 
\end_layout

\begin_layout Plain Layout

my %REZONE;
                        # the reverse lookup of ZONECODES 
\end_layout

\begin_layout Plain Layout

my %RULES;
                         # associative array for rules
\end_layout

\begin_layout Plain Layout

my %ZONES;
                         # and for zones
\end_layout

\begin_layout Plain Layout

my %LINKS;
                         # time zone links e.g.
 Europe/Jersey
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

 use DBI;
 
\end_layout

\begin_layout Plain Layout

 my @driver_names = DBI->available_drivers;
\end_layout

\begin_layout Plain Layout

 print ("Drivers for DBI:
 @driver_names 
\backslash
n");
 
\end_layout

\begin_layout Plain Layout

 my @data_sources = DBI->data_sources('ODBC');
 
\end_layout

\begin_layout Plain Layout

 print("DBI data sources for ODBC are @data_sources 
\backslash
n");
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

my $BUG = 0;
                    # debugging,
 See Debug_() 
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Note Note
status collapsed

\begin_layout Plain Layout
was:
\end_layout

\begin_layout Plain Layout
\begin_inset ERT
status open

\begin_layout Plain Layout

#  my $THISPLACE = 0;
               # Current location (unused at present)
\end_layout

\begin_layout Plain Layout

#  my $USERGROUP = 0;
               # default ID of user group,
 unused 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

##  &PreArgs(2000);
 # 2000 is default value for $USERID.
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

my $SCRIPTDIRECTORY = "../seek";
   # no terminal slash,
 [ eg w/smalltime/perl ] 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Note Note
status collapsed

\begin_layout Plain Layout
Note that if you say 
\family typewriter
use Win32::ODBC
\family default
 above,
 Perl will demand this at compile-time,
 even if it's never used!
 
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Note Note
status collapsed

\begin_layout Plain Layout
–
\end_layout

\begin_layout Plain Layout
More:
\end_layout

\begin_layout Plain Layout
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

  my $MAXSAFEFLOAT = 4503599627370496;
\end_layout

\begin_layout Plain Layout

  my $MINSAFEFLOAT = -($MAXSAFEFLOAT);
 
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Note Note
status open

\begin_layout Plain Layout
\begin_inset ERT
status open

\begin_layout Plain Layout

# debug:
\end_layout

\begin_layout Plain Layout

my @LASTMANSTANDING = ();
 
\end_layout

\begin_layout Plain Layout

my $LALEN = 0;
 
\end_layout

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Note Note
status collapsed

\begin_layout Plain Layout
To install DateTime in Windows is as simple as command line:
\end_layout

\begin_layout Quote

\family typewriter
\series bold
ppm install DateTime
\end_layout

\begin_layout Plain Layout
\SpecialChar ldots
 unless you're behind a corporate firewall,
 in which case some work is required.
 See Sections
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand ref
reference "sec:You-will-need"
nolink "false"

\end_inset

 and 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:A-note-on-PPM"
nolink "false"

\end_inset

.
\end_layout

\begin_layout Plain Layout
\begin_inset Note Note
status open

\begin_layout Plain Layout
In the following,
 
\family typewriter
$FIXTIMEZONE
\family default
 set to 1 invokes the TZ database functionality;
 otherwise specify 0.
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Note Note
status collapsed

\begin_layout Plain Layout
Removed:
 
\end_layout

\begin_layout Plain Layout
\begin_inset ERT
status open

\begin_layout Plain Layout

my $MAXIMUM_SMALL_INTEGER = 2147483647;
\end_layout

\begin_layout Plain Layout

my $MINIMUM_SMALL_INTEGER = -2147483648;
\end_layout

\begin_layout Plain Layout

my $MAXIMUM_LARGE_INTEGER = 9223372036854775807;
\end_layout

\begin_layout Plain Layout

my $MINIMUM_LARGE_INTEGER = -9223372036854775808;
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

 # make the following constants [fix me] 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

## my $MAXIMUM_FLOAT = 1e100;
 # CONSERVATIVE,
 cf.
  perl -MPOSIX=DBL_MAX -wle"print DBL_MAX()"
\end_layout

\begin_layout Plain Layout

## my $MINIMUM_FLOAT = -$MAXIMUM_FLOAT;
 # likewise.
 FOR BOTH,
 tempting to use + / + Inf [explore] 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

 
\end_layout

\begin_layout Plain Layout

my $MAX_SQL_WRITES = 50000;
 # split up writes with more than this number of rows
\end_layout

\begin_layout Plain Layout

   # ^ consider moving this out to package.
 [explore]
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  my $WINDOWS = 0;
 # signal we're NOT on Windows [explore DBI use]
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  # Detect OS:
\end_layout

\begin_layout Plain Layout

  my $OPERATING_SYSTEM;
\end_layout

\begin_layout Plain Layout

if($^O =~ /darwin/i)
\end_layout

\begin_layout Plain Layout

  { $OPERATING_SYSTEM = 'Mac';
\end_layout

\begin_layout Plain Layout

  }
\end_layout

\begin_layout Plain Layout

elsif($^O =~ /linux/i)
\end_layout

\begin_layout Plain Layout

  { $OPERATING_SYSTEM = 'Linux';
\end_layout

\begin_layout Plain Layout

  }
\end_layout

\begin_layout Plain Layout

elsif($^O =~ /win/i)
\end_layout

\begin_layout Plain Layout

  { $OPERATING_SYSTEM = 'Windows';
\end_layout

\begin_layout Plain Layout

    $WINDOWS = 1;
 
\end_layout

\begin_layout Plain Layout

    # hack:
 change console mode:
\end_layout

\begin_layout Plain Layout

    `chcp 65001`;
\end_layout

\begin_layout Plain Layout

  } else
\end_layout

\begin_layout Plain Layout

  { $OPERATING_SYSTEM = 'Unknown';
 # perhaps fail at this point!
\end_layout

\begin_layout Plain Layout

    &DoWarn(3,
 " UNKNOWN OPERATING SYSTEM:
 '$^O'");
 
\end_layout

\begin_layout Plain Layout

  };
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  &PreArgs();
 # read command line arguments 
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
\begin_inset Note Note
status collapsed

\begin_layout Plain Layout
Other removals:
\end_layout

\begin_layout Plain Layout
\begin_inset ERT
status open

\begin_layout Plain Layout

  my $CURRENTJULIAN;
  # must be set before use.
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  my $START_TIME = [Time::HiRes::gettimeofday()];
\end_layout

\begin_layout Plain Layout

  my $CURRENT_TIME = [Time::HiRes::gettimeofday()];
\end_layout

\begin_layout Plain Layout

  my $DEBUGTEXT = 'DEBUG-';
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout
Various things:
 
\end_layout

\begin_layout Plain Layout
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger
\end_layout

\begin_layout Plain Layout

{
\backslash
footnotesize
\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

  my @EITHER_FLAGS = (0);
 # array of error trapping flags (scripting) 
\end_layout

\begin_layout Plain Layout

  my $EITHER_COUNT = 0;
 # and index into the flags
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}}
\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Note Note
status collapsed

\begin_layout Plain Layout
Removed:
\end_layout

\begin_layout Plain Layout
\begin_inset ERT
status open

\begin_layout Plain Layout

my %ALLTABLES;
 
\end_layout

\begin_layout Plain Layout

my @LOCALSTACK;
 # used to push/pop locals when moving to/from script
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

my %GLOBALS;
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

my @TRANSPORT;
 # used to transport variables from caller to called script
\end_layout

\begin_layout Plain Layout

my %RECENTSCRIPTS;
 # keep track :
 was a script run?
 
\end_layout

\begin_layout Plain Layout

my %CSV_TOUCHED;
 # store names of files on first write to CSV
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

my $CURRENT_COLUMN=-1;
 # used in debugging
\end_layout

\begin_layout Plain Layout

my $CURRENT_ROW=-1;
    #
\end_layout

\begin_layout Plain Layout

my $CURRENT_SRC='';
    #
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  # make the following constants [fix me] 
\end_layout

\begin_layout Plain Layout

my $MAX_CSV_HEADER_LENGTH = 1024;
 # arbitrary but should be big enough for most
\end_layout

\begin_layout Plain Layout

my $PART_EMPTY = '__';
 # NB.
 this is also built into whole_zone_125 ( i.e.
 Timely module ) [explore]
\end_layout

\begin_layout Plain Layout

my $PART_NULL = '#';
 
\end_layout

\begin_layout Plain Layout

my $NULL = "N:$PART_NULL";
 
\end_layout

\begin_layout Plain Layout

my $EMPTY = "E:$PART_EMPTY";
 # [explore usage & use]
\end_layout

\begin_layout Plain Layout

my $NULLTEXT = 'T:';
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  my $IS_EITHER = 0;
 
\end_layout

\begin_layout Plain Layout

 
\end_layout

\begin_layout Plain Layout

  my $TRAP_FLAG = 0;
 # part of the same process
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

my $CSV_NEWLINE = "
\backslash
n";
 # under Windows will automagically become 
\backslash
r
\backslash
n!
\end_layout

\begin_layout Plain Layout

if(!
 $WINDOWS)
\end_layout

\begin_layout Plain Layout

  { $CSV_NEWLINE = "
\backslash
r
\backslash
n";
 # For Linux,
 have 
\backslash
r
\backslash
n spelt out # [ugh to the lot]
\end_layout

\begin_layout Plain Layout

  };
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

my $LEGACY = 0;
                 # if 1,
 will connect to legacy PainForm database too!
\end_layout

\begin_layout Plain Layout

my $Painform_odbc;
              #  ??
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

my $CREATING = 0;
               # 1 = CREATE new Ward entries from Painform 1,
 with associations
\end_layout

\begin_layout Plain Layout

my $ASSOCIATING = 0;
            # 1 = NEWLY associate CMS ward entries with existing ward entries in smalltime
\end_layout

\begin_layout Plain Layout

my $IMPORT = 0;
                 # rather than getting between dates,
 get NHIs from legacy database!
\end_layout

\begin_layout Plain Layout

my $REFRESHSTAFF = 0;
     # load staff from CSV derived from Intranet list of L8 anaesthetists (later add other levels)
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

my $MAINW = '';
                 # stub
\end_layout

\begin_layout Plain Layout

my $NEWMATRIX = '';
             # used to recover (delete matrix) if error on e.g.
 loading CSV.
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

my $TOLERANT = 0;
      # bit flags,
 only current one is <Multiple> for bit #1 (bit #0 is unused).
 
\end_layout

\begin_layout Plain Layout

use constant MultipleFlag => 1;
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Note Note
status collapsed

\begin_layout Plain Layout
–
\end_layout

\begin_layout Subsection

\series bold
\emph on
smalltime
\series default
\emph default
 constants
\end_layout

\begin_layout Plain Layout
\begin_inset Note Note
status open

\begin_layout Plain Layout
A clumsy lot (most of these should be looked up,
 not hard-coded here,
 and 
\emph on
will 
\emph default
be moved out to CSV tables).
\end_layout

\begin_layout Plain Layout
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

############################## database insertion templates #########################
\end_layout

\begin_layout Plain Layout

my $CANON13 = "src,
 srcID,
 dd_patient,
 t_amended,
 reason,
 p_amended,
 amender,
\end_layout

\begin_layout Plain Layout

  t_start,
 t_start_P,
 p_start,
 starter,
 p_end,
 ender ";
\end_layout

\begin_layout Plain Layout

    # there are only 13 items as t_end and t_end_P are null by default.
 
\end_layout

\begin_layout Plain Layout

my $PENTAD = "formulation,
 device,
 thing,
 anatomy,
 organism";
\end_layout

\begin_layout Plain Layout

my $TEXT5  = "0,0,0,0,0";
\end_layout

\begin_layout Plain Layout

my $intrv_PENTAD  = "batch,
 gadget,
 item,
 structure,
 lot";
  # MINOR VARIANT
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

# [resolve the above]
\end_layout

\begin_layout Plain Layout

######################################################################################
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard

\end_layout

\begin_layout Section
Connect to 
\series bold
\emph on
smalltime
\series default
\emph default

\begin_inset CommandInset label
LatexCommand label
name "sec:Connect-to-SafeHouse"

\end_inset


\end_layout

\begin_layout Standard
The undef values are needed for username/password,
 and assume that a relevant,
 `automated' database login has been setup.
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

my %DATABASES;
 
\end_layout

\begin_layout Plain Layout

my $smalltime_h;
\end_layout

\begin_layout Plain Layout

  print 
\begin_inset Quotes eld
\end_inset


\backslash
nConnecting to '$BASEDATABASE'
\backslash
n
\begin_inset Quotes erd
\end_inset

;
 
\end_layout

\begin_layout Plain Layout

  $smalltime_h = DBI->connect(
\begin_inset Quotes eld
\end_inset

dbi:ODBC:$BASEDATABASE
\begin_inset Quotes erd
\end_inset

,
\end_layout

\begin_layout Plain Layout

                                  undef,
 
\end_layout

\begin_layout Plain Layout

                                  undef,
 
\end_layout

\begin_layout Plain Layout

                                  { AutoCommit => 0,
\end_layout

\begin_layout Plain Layout

                                    RaiseError => 1,
\end_layout

\begin_layout Plain Layout

                                    LongReadLen => 50000000});
\end_layout

\begin_layout Plain Layout

if(!
 defined $smalltime_h)
\end_layout

\begin_layout Plain Layout

  { die "*CRASH* could not make ODBC instance for $BASEDATABASE
\backslash
n";
 
\end_layout

\begin_layout Plain Layout

  };
 
\end_layout

\begin_layout Plain Layout

  $smalltime_h->{LongTruncOk} = 0;
 
\end_layout

\begin_layout Plain Layout

  $smalltime_h->{LongReadLen} = 100000000;
 # 100M !
 
\end_layout

\begin_layout Plain Layout

  print "
\backslash
n
\backslash
n
\backslash
nThe AutoCommit attribute is:
 " .
 $smalltime_h->{AutoCommit} .
 "
\backslash
n";
\end_layout

\begin_layout Plain Layout

  print 
\begin_inset Quotes eld
\end_inset

Maximum read length is:
 
\begin_inset Quotes eld
\end_inset

 .
 $smalltime_h->{LongReadLen} .
 
\begin_inset Quotes eld
\end_inset


\backslash
n
\begin_inset Quotes erd
\end_inset

;
 
\end_layout

\begin_layout Plain Layout

  print 
\begin_inset Quotes eld
\end_inset

The value of LongTruncOk is:
 
\begin_inset Quotes eld
\end_inset

 .
 $smalltime_h->{LongTruncOk} .
 
\begin_inset Quotes eld
\end_inset


\backslash
n
\backslash
n
\backslash
n
\begin_inset Quotes erd
\end_inset

;
 
\end_layout

\begin_layout Plain Layout

    # cf.
 https://docstore.mik.ua/orelly/linux/dbi/ch06_02.htm 
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
Stuff:
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

  $DATABASES{$BASEDATABASE} = $smalltime_h;
 # note this is case-sensitive.
 
\end_layout

\begin_layout Plain Layout

  my(@LEAPDATA) = Timely::BeginTimely($smalltime_h,
 1);
    # open log.
 [2nd argument is redundant] 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

if(scalar @LEAPDATA < $LEAPSECONDS) 
\end_layout

\begin_layout Plain Layout

  { &PopulateLeapSeconds($TZDIR);
 # fix or die.
 
\end_layout

\begin_layout Plain Layout

    @LEAPDATA = Timely::BeginTimely($smalltime_h,
 1);
\end_layout

\begin_layout Plain Layout

  if(scalar @LEAPDATA < $LEAPSECONDS) 
\end_layout

\begin_layout Plain Layout

    { die 
\begin_inset Quotes eld
\end_inset

Unable to update leap seconds <@LEAPDATA>
\begin_inset Quotes erd
\end_inset

;
 
\end_layout

\begin_layout Plain Layout

    };
 
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

  print "
\backslash
n Leap data length:
 " .
 scalar @LEAPDATA;
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  my($region,
 $regionNAME,
 $hits) = Timely::FindRegion('UTC/UTC');
 
\end_layout

\begin_layout Plain Layout

  Timely::SetUtcCode($region);
 #$UTCCODE 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

&ClearNewWarnings();
 
\end_layout

\begin_layout Plain Layout

Timely::SetMaxKeyFetch(2500000);
          # 2.5M new keys [explore]
\end_layout

\begin_layout Plain Layout

Timely::SetUserId($USERID);
\end_layout

\begin_layout Plain Layout

Timely::SetTzDatabase($TZDATABASEID);
 
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
excised:
\end_layout

\begin_layout Plain Layout
\begin_inset ERT
status open

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  BEGIN { push @INC,
 'lib' }
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

 print ("
\backslash
n
\backslash
n
\backslash
n** DEBUGGING INC:
 <@INC> ");
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
–
\end_layout

\begin_layout Subsection
Logging of reads,
 writes & updates
\end_layout

\begin_layout Plain Layout
\begin_inset Note Note
status open

\begin_layout Plain Layout
[Hmm remove these]
\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout
It is sometimes useful to know how many writes,
 reads and updates were made to the various 
\series bold
\emph on
smalltime
\series default
\emph default
 tables.
 We create an associative array for each:
\end_layout

\begin_layout Plain Layout
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger
\end_layout

\begin_layout Plain Layout

{
\backslash
footnotesize
\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

my %FEHR_READS = ();
 
\end_layout

\begin_layout Plain Layout

my %FEHR_WRITES = ();
\end_layout

\begin_layout Plain Layout

my %FEHR_UPDATES = ();
\end_layout

\begin_layout Plain Layout

my $FEHR_DEBUG_DEPTH = 0;
  # used to prevent repeated listing.
 See usage.
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

## Also use smalltime PTABLES to populate these with names!
 
\end_layout

\begin_layout Plain Layout

  my($DB) = $DATABASES{$BASEDATABASE};
 # as above
\end_layout

\begin_layout Plain Layout

  my($q) = 'SELECT tablename from PTABLES';
 # WHERE 1 
\end_layout

\begin_layout Plain Layout

  my(@DAT) = Timely::SQLManySQL($DB,
 $q,
 'Get smalltime table names');
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  my($row);
 
\end_layout

\begin_layout Plain Layout

foreach $row (@DAT)
\end_layout

\begin_layout Plain Layout

  { my($tname) = @$row[0];
\end_layout

\begin_layout Plain Layout

    ## print 
\begin_inset Quotes eld
\end_inset

Debug:
 tablename=$tname
\backslash
n
\begin_inset Quotes erd
\end_inset

;
 
\end_layout

\begin_layout Plain Layout

    $tname =~ tr/A-Z/a-z/;
 # lowercase [nasty]
\end_layout

\begin_layout Plain Layout

    $FEHR_READS{$tname} = 0;
 
\end_layout

\begin_layout Plain Layout

    $FEHR_WRITES{$tname} = 0;
 
\end_layout

\begin_layout Plain Layout

    $FEHR_UPDATES{$tname} = 0;
 
\end_layout

\begin_layout Plain Layout

  };
 
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}}
\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout
Note that under Windows,
 MySQL turns all table names by default into lower case.
 
\begin_inset Note Note
status open

\begin_layout Plain Layout
[consider rejigging this]
\end_layout

\end_inset

 We thus store lowercase names,
 and interrogate lowercase names:
 nasty!
 
\begin_inset Note Note
status open

\begin_layout Plain Layout
[fix me!]
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Section
Run timely
\end_layout

\begin_layout Standard
This was previously a module invocation,
 Timely::Timely();
 now we simply invoke Timely
\begin_inset space ~
\end_inset

(
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:Timely"
plural "false"
caps "false"
noprefix "false"
nolink "false"

\end_inset

).
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

  my($fail) = Timely();
 
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard

\emph on
\begin_inset Note Note
status open

\begin_layout Section
Testing CMS values
\end_layout

\begin_layout Plain Layout

\emph on
[The code removed was a complex set of SQL queries that have now been turned into a simple scripting system]
\end_layout

\end_inset


\end_layout

\begin_layout Section
Done
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

  &ImplementExit($fail);
  # this should COMMIT unless $fail is nonzero.
  
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  
\end_layout

\begin_layout Plain Layout

##################################################
\end_layout

\begin_layout Plain Layout

#              END OF MAIN ROUTINE               #
\end_layout

\begin_layout Plain Layout

##################################################
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Chapter
Key Perl routines
\begin_inset CommandInset label
LatexCommand label
name "chap:Key-Perl-routines"

\end_inset


\end_layout

\begin_layout Standard
This imports the UI from the timely module,
 and also has a few utility functions.
 
\end_layout

\begin_layout Section
Timely
\begin_inset CommandInset label
LatexCommand label
name "sec:Timely"

\end_inset

 
\end_layout

\begin_layout Standard
Check our date routines are functional using TestJulian;
 then invoke the main,
 interactive routine.
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

sub Timely #
\end_layout

\begin_layout Plain Layout

{ my($fail);
 
\end_layout

\begin_layout Plain Layout

  $fail = &TestJulian();
  # check Julian_day number conversions are working
\end_layout

\begin_layout Plain Layout

if($fail)
\end_layout

\begin_layout Plain Layout

  { return($fail);
 
\end_layout

\begin_layout Plain Layout

  };
 
\end_layout

\begin_layout Plain Layout

  return( &Converter() );
  # USER INTERFACE
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
Must return 0 on success;
 or a non-zero failure code on failure.
 
\end_layout

\begin_layout Section
Read Time Zones
\begin_inset CommandInset label
LatexCommand label
name "chap:Time-zones-TZ"

\end_inset


\end_layout

\begin_layout Standard
This section allows a user to interact with a diagnostic program from the command line.
 The menu is manufactured by SetMenu
\begin_inset space ~
\end_inset

(
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:Set-up-menu"
plural "false"
caps "false"
noprefix "false"
nolink "false"

\end_inset

).
 Various tests are made,
 including checks against the Perl DateTime module,
 which is built around the tz database and program.
 First,
 it's important to be able to find a named timezone (region).
 The following summarises the help available from the command line via the menu,
 and by saying 
\family typewriter
\series bold
h
\family default
\series default
 :
 
\end_layout

\begin_layout Description
f finds a zone based on a partial name match.
 The first match is returned,
 currently with no warning about duplicates :(
\end_layout

\begin_layout Description
a gives 
\emph on
all
\emph default
 the transition times 
\emph on
around
\emph default
 the current zone.
\end_layout

\begin_layout Standard
The following timestamp setting/checking options are useful.
 They all set the current time too.
 
\end_layout

\begin_layout Description
u Enter UTC-based date (actual internal representation is as a proleptic GPS date,
 press Enter to obtain the delta in seconds,
 and the corresponding wall time for the currently selected zone,
 default is Auckland).
\end_layout

\begin_layout Description
g Enter GPS timestamp (proleptic) and obtain corresponding UTC value as Gregorian YYYY-MM- etc.
 
\end_layout

\begin_layout Description
j Enter wall timestamp for this region (YYYY-MM-etc) and get back Julian value for GPS timestamp.
 
\end_layout

\begin_layout Description
n Now:
 get the current time.
 
\end_layout

\begin_layout Standard
\begin_inset Separator plain
\end_inset


\end_layout

\begin_layout Standard
The g and j commands are complementary,
 for example if in Auckland you say 
\family typewriter
j 2020-01-01 12:59:42
\family default
 ,
 then you obtain a Julian value of 2458849.5 reflecting `proleptic GPS time'.
 This corresponds to UTC of 2019-12-31 23:59:42,
 i.e.
 there is a difference of 18
\begin_inset space ~
\end_inset

s between UTC and GPS for this time.
 If instead I say 
\family typewriter
g 2458849.5
\family default
 I get the same result.
 In addition we have a variety of tests:
\end_layout

\begin_layout Description
t Test a given time for the current region,
 across all years,
 e.g.
 
\family typewriter
t 01-01 00:00:00
\family default
 ;
 you can limit the check to 
\emph on
after
\emph default
 a specific year by specifying the year too.
 
\begin_inset Note Note
status open

\begin_layout Plain Layout
This only checks the internal algorithm,
 and doesn't validate the timestamp against the tz standard.
\end_layout

\end_inset

The value entered is UTC based.
 See ZoneTest
\begin_inset space ~
\end_inset

(
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:Testing-zones"
plural "false"
caps "false"
noprefix "false"
nolink "false"

\end_inset

).
\end_layout

\begin_layout Description
w Similar to 
\series bold
t
\series default
,
 but uses wall time.
 
\end_layout

\begin_layout Description
v validates all transition times against tz.
 The default is to test just the current zone.
 More exciting is 
\family typewriter
v all
\family default
 which does this for every single time zone,
 a great way of picking out anomalies.
 You can even add to or subtract from the transition point,
 using say v+1 or v-1.
 
\end_layout

\begin_layout Standard
\begin_inset Separator plain
\end_inset


\end_layout

\begin_layout Standard
Testing at intervals may be useful,
 but doesn't do an external check against tz dates—
internal validation is the only test.
 [explain] 
\end_layout

\begin_layout Description
i Sets the interval in seconds.
 This will take forever with a small interval.
 
\end_layout

\begin_layout Description
y Specify the year to check at that interval
\end_layout

\begin_layout Standard
\begin_inset Separator plain
\end_inset


\end_layout

\begin_layout Standard
Pressing the Enter key alone will simply re-display the Timely help menu.
 
\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
The standard suffixes:
\end_layout

\begin_layout Description
s local standard time (wall clock time without the DST!)
\end_layout

\begin_layout Description
g All of the following {g u z} mean UTC / GMT / nautical time zone Z (the same)
\end_layout

\begin_layout Description
u
\end_layout

\begin_layout Description
z
\end_layout

\begin_layout Description
w The wall clock time,
 the same as leaving out the suffix
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Note Note
status collapsed

\begin_layout Plain Layout
BROKEN:
 http://www.cstdbill.com/tzdb/tz-how-to.html
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
Useful:
\end_layout

\begin_layout Plain Layout
http://stackoverflow.com/questions/2532729/daylight-saving-time-and-time-zone-best-practices
\end_layout

\begin_layout Plain Layout
https://en.wikipedia.org/wiki/Tz_database
\end_layout

\begin_layout Plain Layout
http://www.iana.org/time-zones
\end_layout

\begin_layout Plain Layout
== on Unix systems:
\end_layout

\begin_layout Plain Layout
ls /usr/share/zoneinfo
\end_layout

\begin_layout Plain Layout
==
\end_layout

\begin_layout Plain Layout

\series bold
http://en.wikipedia.org/wiki/ISO_8601
\end_layout

\begin_layout Plain Layout
http://msdn.microsoft.com/en-us/library/ms973825.aspx#datetime_topic6
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
As hinted at in 
\emph on
Painform_125.lyx
\emph default
,
 
\begin_inset Note Note
status open

\begin_layout Plain Layout
1,025,000
\end_layout

\end_inset


\end_layout

\end_inset

Daylight saving is complex.
 In spring
\begin_inset Note Note
status open

\begin_layout Plain Layout
spring forward
\end_layout

\end_inset

,
 the local time leaps forward at a particular time,
 creating a gap (invalid local times during the transition interval);
 in autumn 
\begin_inset Note Note
status open

\begin_layout Plain Layout
fall back
\end_layout

\end_inset

 the local time falls back,
 creating non-unique Gregorian timestamps.
 There are also zone changes.
 In 
\series bold
\emph on
f
\emph default
ehr
\series default
,
 I use proleptic GPS timestamps,
 specified in a Julian form as a big integer (microseconds).
\end_layout

\begin_layout Standard
It's convenient to have the ability to reference not only the standard TZ time zones,
 but also UTC.
\begin_inset Foot
status collapsed

\begin_layout Plain Layout
See 
\begin_inset CommandInset href
LatexCommand href
name "http://cldr.unicode.org/development/development-process/design-proposals/extended-windows-olson-zid-mapping"
target "http://cldr.unicode.org/development/development-process/design-proposals/extended-windows-olson-zid-mapping"
literal "false"

\end_inset

 for Windows/Olson mapping.
\end_layout

\end_inset

 
\begin_inset Note Note
status open

\begin_layout Plain Layout
The former are imported directly,
 but the latter is created:
\end_layout

\begin_layout Plain Layout
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% DogWagger dogsAllowed=`no'
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

 insert into PLACES (place,
 description,
 amender,
 p_amended,
 src,
 east,
 north) 
\end_layout

\begin_layout Plain Layout

  values (1,
 'UTC',
 2000,
 0,
 0,
 0,
 0);
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  insert into PLACES (place,
 description,
 amender,
 p_amended,
 src,
 east,
 north) 
\end_layout

\begin_layout Plain Layout

   values ($UTCCODE,
 'UTC',
 2000,
 1,
 0,
 0,
 0);
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout
The intention is that we have two entries —
 a bland 
\begin_inset Quotes eld
\end_inset

country
\begin_inset Quotes erd
\end_inset

 stub that represents UTC,
 and an associated 
\begin_inset Quotes eld
\end_inset

neutral
\begin_inset Quotes erd
\end_inset

 time zone accessible as 'UTC' with a place identifier of 2001.
 The latter refers to the former using the p_amended field.
\end_layout

\end_inset


\end_layout

\begin_layout Section
Countries & regions
\end_layout

\begin_layout Standard
In 
\series bold
\emph on
f
\emph default
ehr
\series default
,
 
\begin_inset Note Note
status open

\begin_layout Plain Layout
As noted in 
\emph on
fehr_code_125.lyx
\emph default
,
 
\begin_inset Note Note
status open

\begin_layout Plain Layout
1,025,000
\end_layout

\end_inset


\end_layout

\end_inset

countries and regions are simply 
\series bold
PLACES
\series default
.
 Country codes are kept in the 
\series bold
countrycodes
\series default
 table.
 
\end_layout

\begin_layout Standard
For each country code,
 the rules have varied in the past,
 generally by year;
 the rules also vary by 
\emph on
parts
\emph default
 of many countries,
 for example the USA and Australia,
 and even within parts of states (the Navajo nation).
 Note that although 
\series bold
PLACES
\series default
 does not 
\emph on
mandate 
\emph default
a reference to a particular time zone,
 the p_amended field can be used to signify a zone.
 
\end_layout

\begin_layout Standard
A similar relationship is established within the 
\series bold
L_location
\series default
 table at the discretion of the user,
 who puts in a 
\series bold
p_amended
\series default
 entry to signify a given region.
 This region code is then used to identify a time zone and daylight saving for that
\series bold
 L_location
\series default
 entry.
 
\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
[IT MIGHT BE AN IDEA TO RESERVE CODES from 100 to 100000 for regions,
 or even up to 
\begin_inset Formula $10^{6}$
\end_inset

,
 but coding an internal structure in keys is generally considered rather dodgy.
 EXPLORE THE SENSE OF THIS APPROACH ?????????????????????????????????]
\end_layout

\end_inset


\end_layout

\begin_layout Subsection
Leap seconds
\end_layout

\begin_layout Standard
The rules and the 
\series bold
leapseconds 
\series default
table are as specified above in Chapter
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand ref
reference "chap:Minimal-database"
plural "false"
caps "false"
noprefix "false"
nolink "false"

\end_inset

.
 
\begin_inset Note Note
status open

\begin_layout Plain Layout
in 
\emph on
fehr_sql_400.lyx
\emph default
.
 
\begin_inset Note Note
status open

\begin_layout Plain Layout
1,025,000
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Subsection
Country codes
\end_layout

\begin_layout Standard
These map countries to two- and three-letter country codes.
 
\end_layout

\begin_layout Subsection
DST dates
\end_layout

\begin_layout Standard
In the TZ database,
 rules for DST dates are often related to e.g.
 
\begin_inset Quotes eld
\end_inset

The first Sunday in October
\begin_inset Quotes erd
\end_inset

,
 or whatever,
 rather than a given calendar date such as 7 October.
 For the various countries,
 we effectively have pairs of dates between which a value must be subtracted in converting from local time to GPS time.
 This offset too will vary across the years;
 there are also some anomalies.
\end_layout

\begin_layout Standard
Internally we record timestamps using GPS time.
 However,
 users who input dates will generally input local timestamps.
 They will not generally be aware of ambiguities or time skips.
 
\begin_inset Note Note
status open

\begin_layout Plain Layout
One approach that can be used to translate between
\emph on
 
\emph default
a local time and GPS time is as follows:
\end_layout

\begin_layout Enumerate
Create composite primary keys of the country code and the year (in which the DST starts),
\begin_inset Foot
status open

\begin_layout Plain Layout
This is convenient in indexing into a table to find the year of interest
\end_layout

\end_inset

 and then associate:
\begin_inset Separator latexpar
\end_inset


\end_layout

\begin_deeper
\begin_layout Enumerate
The standard time-zone offset for that year (from 1 January) 
\series bold
zone_offset 
\series default

\begin_inset Foot
status open

\begin_layout Plain Layout
Note that in some countries,
 this has varied by year
\end_layout

\end_inset

;
 [MUST HOWEVER LOOK AT CASES WHERE THE TIME ZONE OFFSET CHANGES DURING THE YEAR.
 [explore]
\end_layout

\begin_layout Enumerate
The extra amount to be offset when DST is active,
 
\series bold
dst_add
\series default
,
 recorded in microseconds.
 This is the time that local time moves forward in spring;
\end_layout

\begin_layout Enumerate
The start of DST,
 less the offset,
 recorded as the big integer 
\series bold
dst_start
\series default
;
\end_layout

\begin_layout Enumerate
The end of DST,
 recorded as the big integer 
\series bold
dst_end
\series default
.
\end_layout

\end_deeper
\begin_layout Enumerate
Be precise about what is meant by 
\begin_inset Quotes eld
\end_inset

start of DST
\begin_inset Quotes erd
\end_inset

 and 
\begin_inset Quotes eld
\end_inset

end of DST
\begin_inset Quotes erd
\end_inset

:
\begin_inset Separator latexpar
\end_inset


\end_layout

\begin_deeper
\begin_layout Enumerate
Use standard methods to translate from Gregorian to Julian,
 assuming no time-zone offset.
 Call the translated value 
\family typewriter
t_mid
\family default
;
\end_layout

\begin_layout Enumerate
Subtract the standard time-zone offset for that country and year —
 call the resulting value 
\family typewriter
t_off
\family default
;
\end_layout

\begin_layout Enumerate
If 
\family typewriter
t_off
\family default
 is between the start and end of DST,
 then we are 
\begin_inset Quotes eld
\end_inset

in the DST zone
\begin_inset Quotes erd
\end_inset

,
 and will usually subtract dst_add from 
\family typewriter
t_off
\family default
.
 However:
\begin_inset Separator latexpar
\end_inset


\end_layout

\begin_deeper
\begin_layout Enumerate
If 
\family typewriter
t_off
\family default
 is between dst_start and dst_start+dst_add,
 then the time is invalid (falls in the gap that results from the spring forward).
 We signal that a time is within the discontinuity by 
\emph on
not
\emph default
 subtracting dst_add from 
\family typewriter
t_off
\family default

\begin_inset Note Note
status open

\begin_layout Plain Layout
[explore this??]
\end_layout

\end_inset

,
 
\emph on
and
\emph default
 by adding dst_add to the 
\emph on
precision
\emph default
 of the resulting timestamp (with the appropriate precision encoding,
 i.e.
 microbels).
\end_layout

\begin_layout Enumerate
If 
\family typewriter
t_off
\family default
 is in the 
\emph on
last hour
\emph default
 of DST (ie.
 within 
\series bold
dst_add
\series default
 of 
\series bold
dst_end
\series default
),
 then we have an ambiguous time.
 We cannot know (from the local time) whether we are in the last hour before the end of DST (and must still subtract dst_add),
 or we're in the 
\begin_inset Quotes eld
\end_inset

groundhog hour
\begin_inset Quotes erd
\end_inset

 that results after we jump back an hour!
 We represent this by subtracting dst_add from 
\family typewriter
t_off
\family default
 and also adding dst_add to the precision of the timestamp.
\end_layout

\end_deeper
\begin_layout Enumerate
Now that you have a 
\begin_inset Quotes eld
\end_inset

Julian UTC
\begin_inset Quotes erd
\end_inset

 time,
 convert to GPS time by subtracting the relevant number of seconds;
\end_layout

\end_deeper
\begin_layout Enumerate
Reverse the process in translating from GPS time to local time:
\begin_inset Separator latexpar
\end_inset


\end_layout

\begin_deeper
\begin_layout Enumerate
Convert from GPS to the 
\begin_inset Quotes eld
\end_inset

Julian UTC
\begin_inset Quotes erd
\end_inset

 equivalent,
 by adding the relevant number of seconds [EXPLORE,
 CHECK];
\end_layout

\begin_layout Enumerate
Determine the year.
 [explore this].
 Retrieve the relevant limits from the DST table.
 If the GPS time is 
\emph on
not
\emph default
 between dst_start and dst_end,
 simply add the standard time zone offset,
 and convert to Gregorian.
\end_layout

\begin_layout Enumerate
Conversely (in the DST zone),
 generally we will add dst_add.
 Note:
\begin_inset Separator latexpar
\end_inset


\end_layout

\begin_deeper
\begin_layout Enumerate
There are no special rules if we're near the end of the zone,
 we just add dst_add;
\end_layout

\begin_layout Enumerate
If we're in the first hour,
 we will add dst_add (We might consider regenerating the invalid time described above,
 but this depends on knowing the 
\begin_inset Quotes eld
\end_inset

actual
\begin_inset Quotes erd
\end_inset

 precision that 
\begin_inset Quotes eld
\end_inset

should have been
\begin_inset Quotes erd
\end_inset

 associated with the timestamp,
 an assumption that seems dodgy).
\end_layout

\end_deeper
\begin_layout Enumerate
Finally,
 add the standard time-zone offset for that year and convert to Gregorian.
\end_layout

\end_deeper
\begin_layout Enumerate
NB.
 In the Southern Hemisphere,
 DST extends across the boundary of the year.
 We store the end and start dates for that year,
 so we can determine that the times are 
\begin_inset Quotes eld
\end_inset

reversed
\begin_inset Quotes erd
\end_inset

 (i.e.
 we're south of the equator) if the end time is before the start time!
 Unfortunately for such countries,
 the DST at the start of the year need not be the same as the DST for the following interval,
 around the end of the year.
 For example,
 in New Zealand in 1927,
 DST started on 6 November at +1:00,
 but for 1928 DST (after 14 October) was only +0:30.
\end_layout

\end_inset


\end_layout

\begin_layout Section
Converter
\begin_inset CommandInset label
LatexCommand label
name "sec:Converter"

\end_inset


\end_layout

\begin_layout Standard
This subroutine prints to the console cf.
 SetMenu
\begin_inset space ~
\end_inset

(
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:Set-up-menu"
plural "false"
caps "false"
noprefix "false"
nolink "false"

\end_inset

),
 interacting with the user to allow conversion to and from Julian,
 as well as providing user control for re-reading the database and running the main tests.
 It loops around until the user chooses to exit.
 
\end_layout

\begin_layout Standard
This routine must return a non-zero value on failure,
 0 for success.
\begin_inset Foot
status open

\begin_layout Plain Layout
I wrote it yonks ago,
 and it's pretty damn clumsy.
 
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

sub Converter 
\end_layout

\begin_layout Plain Layout

{
\end_layout

\begin_layout Plain Layout

  ## &Cls();
  ## temp removal 2021-03-13 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  my($INTERVAL) = 3000;
 # seconds,
 a bit < 1 hour.
\end_layout

\begin_layout Plain Layout

  my($NUMBR) = Timely::GpsJulian(2000,1,1,
 0,0,0,
 0,
 0,
 0);
 # seconds!!
\end_layout

\begin_layout Plain Layout

  # GPS time is here e.g.
 13s ahead of UTC
\end_layout

\begin_layout Plain Layout

  my($region,
 $regionNAME,
 $hits) = Timely::FindRegion('Auckland');
 # [parochial] 
\end_layout

\begin_layout Plain Layout

  Timely::SetRegion($region);
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  my($MENU) = &SetMenu($NUMBR,
 $region,
 $INTERVAL,
 $regionNAME,
 1);
 # 1=Welcome
\end_layout

\begin_layout Plain Layout

  print $MENU;
 
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
The main loop.
 First,
 
\family typewriter
\series bold
r 
\family default
\series default
to read.
 The wrinkle here is that selecting this option sets the 
\family typewriter
$confirm
\family default
 flag,
 which requires y/yes to actually start the protracted ReadZones
\begin_inset space ~
\end_inset

(
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:Establish-zones-ReadZone-tz"
plural "false"
caps "false"
noprefix "false"
nolink "false"

\end_inset

) process.
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

  my($confirm) = 0;
 
\end_layout

\begin_layout Plain Layout

AGAIN:
 while( <STDIN> )
\end_layout

\begin_layout Plain Layout

  { chomp;
\end_layout

\begin_layout Plain Layout

  if($confirm)
\end_layout

\begin_layout Plain Layout

    { $confirm = 0;
 
\end_layout

\begin_layout Plain Layout

    if( /^y/i )
\end_layout

\begin_layout Plain Layout

      { my($fail);
 
\end_layout

\begin_layout Plain Layout

        $fail = &ReadZones(0,
 '');
  # read all zones [at present] 0 signals this...
\end_layout

\begin_layout Plain Layout

        ## ^ best should simply return failure code here if fails:
\end_layout

\begin_layout Plain Layout

      if(length $fail > 0)  # expected null string
\end_layout

\begin_layout Plain Layout

        { print 
\begin_inset Quotes eld
\end_inset


\backslash
n*FAILED* '$fail'
\backslash
n
\begin_inset Quotes erd
\end_inset

;
 
\end_layout

\begin_layout Plain Layout

          return(ZoneReadFailed);
  
\end_layout

\begin_layout Plain Layout

        };
 
\end_layout

\begin_layout Plain Layout

      };
\end_layout

\begin_layout Plain Layout

      print $MENU;
\end_layout

\begin_layout Plain Layout

      next AGAIN;
\end_layout

\begin_layout Plain Layout

    };
\end_layout

\begin_layout Plain Layout

  if( /^r
\backslash
s*(.*?)
\backslash
s*$/i ) # READ
\end_layout

\begin_layout Plain Layout

    { my($zpart) = $1;
 
\end_layout

\begin_layout Plain Layout

    if(length $zpart < 1)
\end_layout

\begin_layout Plain Layout

      { my($fail) = &ReadZones($region,
 $regionNAME);
 # region limited.
\end_layout

\begin_layout Plain Layout

      if(length $fail > 0)
\end_layout

\begin_layout Plain Layout

        { print 
\begin_inset Quotes eld
\end_inset


\backslash
nOops!
 '$fail'
\backslash
n
\begin_inset Quotes erd
\end_inset

;
 # the error message.
\end_layout

\begin_layout Plain Layout

        } else
\end_layout

\begin_layout Plain Layout

        { print 
\begin_inset Quotes eld
\end_inset


\backslash
nCompleted zone read:
 '$regionNAME'.
\backslash
n
\begin_inset Quotes erd
\end_inset

;
 
\end_layout

\begin_layout Plain Layout

        };
 
\end_layout

\begin_layout Plain Layout

      } 
\end_layout

\begin_layout Plain Layout

    elsif($zpart eq 'all') # only this will do 
\end_layout

\begin_layout Plain Layout

      { print "
\backslash
n Read ENTIRE TZ database?
 Are you sure?
 (y|n) ";
\end_layout

\begin_layout Plain Layout

        $confirm = 1;
\end_layout

\begin_layout Plain Layout

      } 
\end_layout

\begin_layout Plain Layout

    else
\end_layout

\begin_layout Plain Layout

      { print 
\begin_inset Quotes eld
\end_inset


\backslash
nUnknown read option '$zpart'
\backslash
n
\begin_inset Quotes erd
\end_inset

;
 
\end_layout

\begin_layout Plain Layout

      };
 
\end_layout

\begin_layout Plain Layout

      next AGAIN;
 
\end_layout

\begin_layout Plain Layout

    };
 
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Subsection
The rest
\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
[clumsy]
\end_layout

\end_inset

Test for other commands.
 The list of options is contained in the regex [adf\SpecialChar ldots
 and resolved in the subsequent code.
 Options that are currently unused are:
 
\family typewriter
b c e k m o p x
\family default
.
 If the user presses Enter,
 then the help menu will simply be displayed without any verbiage.
 The multiple uses of UpdateMenu
\begin_inset space ~
\end_inset

(
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:Update-Menu"
plural "false"
caps "false"
noprefix "false"
nolink "false"

\end_inset

) are a convenience.
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

  if( !
 /^
\backslash
s*([adfghijlnqstuvwyz
\backslash
+
\backslash
-
\backslash
?])
\backslash
s*(.*?)
\backslash
s*$/i ) # 'r' already processed
\end_layout

\begin_layout Plain Layout

    { 
\end_layout

\begin_layout Plain Layout

    if(length $_ > 0)
\end_layout

\begin_layout Plain Layout

      { &Cls();
 
\end_layout

\begin_layout Plain Layout

        print " Unknown option ($_)
\backslash
n";
\end_layout

\begin_layout Plain Layout

      } else
\end_layout

\begin_layout Plain Layout

      { $MENU = &UpdateMenu($NUMBR,
 $region,
 $INTERVAL,
 $regionNAME);
 
\end_layout

\begin_layout Plain Layout

      };
 
\end_layout

\begin_layout Plain Layout

      next AGAIN;
 
\end_layout

\begin_layout Plain Layout

    } else
\end_layout

\begin_layout Plain Layout

    { my($inp) = $2;
\end_layout

\begin_layout Plain Layout

      my($ch)  = $1;
\end_layout

\begin_layout Plain Layout

      $ch =~ tr/A-Z/a-z/;
  # lower case
\end_layout

\begin_layout Plain Layout

    if($FULLDEBUG)
\end_layout

\begin_layout Plain Layout

      { print "
\backslash
n$inp--> ";
\end_layout

\begin_layout Plain Layout

      };
 
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Subsubsection
Simple
\end_layout

\begin_layout Standard
Several small commands:
 q h t and w follow.
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

  if( $ch eq 'q' )    # Quit
\end_layout

\begin_layout Plain Layout

    { return(0);
     # success.
 Will force COMMIT by caller!
 
\end_layout

\begin_layout Plain Layout

    };
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
h is for Help:
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

  if( ( $ch eq 'h' )    # help [might make this more fancy?] 
\end_layout

\begin_layout Plain Layout

    ||( $ch eq '?'  )
\end_layout

\begin_layout Plain Layout

    )
\end_layout

\begin_layout Plain Layout

    { my($hlp) = &ShowHelp($inp);
 # returns '' on success!
 
\end_layout

\begin_layout Plain Layout

    if(length $hlp > 0) # failed
\end_layout

\begin_layout Plain Layout

      { # $MENU = &UpdateMenu($NUMBR,
 $region,
 $INTERVAL,
 $regionNAME);
\end_layout

\begin_layout Plain Layout

        print $MENU;
 
\end_layout

\begin_layout Plain Layout

        print $hlp;
 
\end_layout

\begin_layout Plain Layout

      };
 
\end_layout

\begin_layout Plain Layout

      next AGAIN;
\end_layout

\begin_layout Plain Layout

    };
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
t is for Test:
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

  if( $ch eq 't' ) # TEST
\end_layout

\begin_layout Plain Layout

    { &ZoneTest($inp,
 $NUMBR,
 $LOWYEAR,
 $TOPYEAR);
 # global source 
\end_layout

\begin_layout Plain Layout

      print $MENU;
\end_layout

\begin_layout Plain Layout

      next AGAIN;
\end_layout

\begin_layout Plain Layout

    };
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
w is for wall-time test:
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

  if( $ch eq 'w' ) # WALL TEST
\end_layout

\begin_layout Plain Layout

    { &WallTest($inp,
 $NUMBR,
 $LOWYEAR,
 $TOPYEAR-1);
\end_layout

\begin_layout Plain Layout

      print $MENU;
\end_layout

\begin_layout Plain Layout

      next AGAIN;
\end_layout

\begin_layout Plain Layout

    };
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Subsubsection
More
\end_layout

\begin_layout Standard
Enter Gregorian date.
 The Gregorian date is adjusted according to the local settings to a Julian value in internal database format.
 It is possible that the submitted Gregorian date may be invalid.
 In addition to returning the Julian day,
 InternalJulian
\begin_inset space ~
\end_inset

() checks the value.
 More invocation of UpdateMenu
\begin_inset space ~
\end_inset

(
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:Update-Menu"
plural "false"
caps "false"
noprefix "false"
nolink "false"

\end_inset

).
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

    if($ch eq 'g')  # convert TO Julian
\end_layout

\begin_layout Plain Layout

      {
\end_layout

\begin_layout Plain Layout

        my($n) = Timely::InternalJulian($inp,
 $region,
 $regionNAME);
\end_layout

\begin_layout Plain Layout

      if($n)
\end_layout

\begin_layout Plain Layout

        { $NUMBR = $n;
\end_layout

\begin_layout Plain Layout

          $MENU = &UpdateMenu($NUMBR,
 $region,
 $INTERVAL,
 $regionNAME);
 
\end_layout

\begin_layout Plain Layout

          next AGAIN;
 
\end_layout

\begin_layout Plain Layout

        };
\end_layout

\begin_layout Plain Layout

      }
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
The converse,
 Julian to Gregorian.
 The Julian value is always stored in the internal format of the database,
 ie.
 proleptic GPS time.
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

     elsif($ch eq 'j' ) # TO Gregorian wall time
\end_layout

\begin_layout Plain Layout

      { # here might further check $inp,
 but simply do:
\end_layout

\begin_layout Plain Layout

      if($inp =~ /^
\backslash
s*(
\backslash
d+
\backslash
.?
\backslash
d*)
\backslash
s*$/ )
\end_layout

\begin_layout Plain Layout

        { my($JD) = $1;
 
\end_layout

\begin_layout Plain Layout

        if($JD > 3000000)
\end_layout

\begin_layout Plain Layout

          { print 
\begin_inset Quotes eld
\end_inset

A bit too late!
\backslash
n
\begin_inset Quotes erd
\end_inset

;
 
\end_layout

\begin_layout Plain Layout

            next AGAIN;
\end_layout

\begin_layout Plain Layout

          };
 
\end_layout

\begin_layout Plain Layout

          $inp = $JD*86400;
 # convert to seconds 
\end_layout

\begin_layout Plain Layout

          my($YYYY,$MM,$DD,$h,$m,$s,
 $dz,
 $dd,
 $hog,
 $deltz,
 $delds) 
\end_layout

\begin_layout Plain Layout

                             # unused ^    ^    ^     ^       ^
\end_layout

\begin_layout Plain Layout

                = Timely::J2G(1,
 $region,
 $inp);
 # dz,dd are dummy
\end_layout

\begin_layout Plain Layout

        if($YYYY)
\end_layout

\begin_layout Plain Layout

          { $NUMBR = $inp;
 
\end_layout

\begin_layout Plain Layout

            $MENU = &UpdateMenu($NUMBR,
 $region,
 $INTERVAL,
 $regionNAME);
 
\end_layout

\begin_layout Plain Layout

            next AGAIN;
 
\end_layout

\begin_layout Plain Layout

          };
\end_layout

\begin_layout Plain Layout

        };
 
\end_layout

\begin_layout Plain Layout

        print 
\begin_inset Quotes eld
\end_inset

Bad Julian '$inp'
\backslash
n
\begin_inset Quotes erd
\end_inset

;
 
\end_layout

\begin_layout Plain Layout

      } 
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
Use `u' like 'j',
 but the conversion to Julian is based on a UTC timestamp,
 not a local one:
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

    elsif($ch eq 'u')  # UTC to Julian
\end_layout

\begin_layout Plain Layout

      { my ($utc) = GetUtcCode();
 
\end_layout

\begin_layout Plain Layout

        my($n) = Timely::InternalJulian($inp,
 $utc,
 'UTC/UTC');
\end_layout

\begin_layout Plain Layout

      if($n)
\end_layout

\begin_layout Plain Layout

        { $NUMBR = $n;
\end_layout

\begin_layout Plain Layout

          $MENU = &UpdateMenu($NUMBR,
 $region,
 $INTERVAL,
 $regionNAME);
 
\end_layout

\begin_layout Plain Layout

          next AGAIN;
 
\end_layout

\begin_layout Plain Layout

        };
\end_layout

\begin_layout Plain Layout

      }
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
With `v',
 can check transition times for one or all zones:
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

    elsif($ch eq 'v')  #
\end_layout

\begin_layout Plain Layout

      { 
\end_layout

\begin_layout Plain Layout

        &Multitest($inp,
 $region);
 # []
\end_layout

\begin_layout Plain Layout

      }
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
Code `n' signals 
\begin_inset Quotes eld
\end_inset

Set current time
\begin_inset Quotes erd
\end_inset

:
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

    elsif($ch eq 'n')  # get current time,
 put into $NUMBR
\end_layout

\begin_layout Plain Layout

      { my($now) = Timely::ModTimeNow();
 
\end_layout

\begin_layout Plain Layout

        $NUMBR = Timely::JulianFromUnix($now);
 # seconds 
\end_layout

\begin_layout Plain Layout

        $MENU = &UpdateMenu($NUMBR,
 $region,
 $INTERVAL,
 $regionNAME);
 
\end_layout

\begin_layout Plain Layout

        next AGAIN;
 
\end_layout

\begin_layout Plain Layout

      }
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
Find a region code (internal) based on a partial search on the name,
 returning first match.
 Again,
 UpdateMenu
\begin_inset space ~
\end_inset

(
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:Update-Menu"
plural "false"
caps "false"
noprefix "false"
nolink "false"

\end_inset

).
 NB THERE IS NO CHECKING FOR SQL injection!
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

     elsif($ch eq 'f' ) # inp is target
\end_layout

\begin_layout Plain Layout

      { 
\end_layout

\begin_layout Plain Layout

      if($inp =~ /^
\backslash
s*$/ )
\end_layout

\begin_layout Plain Layout

        { print 
\begin_inset Quotes eld
\end_inset

Current region:
 $region $regionNAME
\backslash
n
\begin_inset Quotes erd
\end_inset

;
 
\end_layout

\begin_layout Plain Layout

        } else
\end_layout

\begin_layout Plain Layout

        { my($rgn,
 $desc,
 $hits) = Timely::FindRegion($inp);
 
\end_layout

\begin_layout Plain Layout

        if($hits < 1)
\end_layout

\begin_layout Plain Layout

          { print "No match '$inp',
 nothing changed
\backslash
n";
\end_layout

\begin_layout Plain Layout

          } elsif($hits > 1)
\end_layout

\begin_layout Plain Layout

          { print 
\begin_inset Quotes eld
\end_inset

Multiple ($hits) matches!
 Refine your specification.
\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

          } else
\end_layout

\begin_layout Plain Layout

          { 
\end_layout

\begin_layout Plain Layout

          if($FULLDEBUG)
\end_layout

\begin_layout Plain Layout

            { print "Match set to '$desc',
 code=$rgn
\backslash
n";
\end_layout

\begin_layout Plain Layout

            };
 
\end_layout

\begin_layout Plain Layout

            Timely::SetRegion($rgn);
 
\end_layout

\begin_layout Plain Layout

            $region = $rgn;
      # 
\end_layout

\begin_layout Plain Layout

            $regionNAME = $desc;
 # 
\end_layout

\begin_layout Plain Layout

            $MENU = &UpdateMenu($NUMBR,
 $region,
 $INTERVAL,
 $regionNAME);
\end_layout

\begin_layout Plain Layout

          };
\end_layout

\begin_layout Plain Layout

        };
\end_layout

\begin_layout Plain Layout

      } 
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
Set the testing interval for the current zone (See also `y')
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

     elsif($ch eq 'i' ) # interval in seconds
\end_layout

\begin_layout Plain Layout

      { 
\end_layout

\begin_layout Plain Layout

      if($inp !~ /^
\backslash
s*(
\backslash
d+)$/)
\end_layout

\begin_layout Plain Layout

        { print " Incorrect interval(seconds)
\backslash
n";
\end_layout

\begin_layout Plain Layout

        } else
\end_layout

\begin_layout Plain Layout

        { $INTERVAL = $1;
\end_layout

\begin_layout Plain Layout

          print " Interval set to $INTERVAL seconds
\backslash
n";
\end_layout

\begin_layout Plain Layout

        };
\end_layout

\begin_layout Plain Layout

      } 
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
For one zone,
 test a given year (at the current interval):
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

     elsif($ch eq 'y' ) # year :
 or year range
\end_layout

\begin_layout Plain Layout

      { 
\end_layout

\begin_layout Plain Layout

        &TestOneZone($region,
 $inp,
 $INTERVAL);
 # assumes MYTIMELY already set up 
\end_layout

\begin_layout Plain Layout

      } 
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset

 
\end_layout

\begin_layout Standard
Test year (or range) with benchmark comparison (validation):
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

     elsif($ch eq 'z' ) # year :
 or year range
\end_layout

\begin_layout Plain Layout

      { 
\end_layout

\begin_layout Plain Layout

        &ReconcileOneZone($region,
 $regionNAME,
 $inp,
 $INTERVAL);
 # 
\end_layout

\begin_layout Plain Layout

      } 
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
Display transitions around a particular year or range of years:
 `a':
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

     elsif($ch eq 'a' ) # year
\end_layout

\begin_layout Plain Layout

      { my($txt) = &Around($region,
 $inp,
 $NUMBR);
 
\end_layout

\begin_layout Plain Layout

      if(length $txt > 0)
\end_layout

\begin_layout Plain Layout

        { print $txt;
 
\end_layout

\begin_layout Plain Layout

        };
 
\end_layout

\begin_layout Plain Layout

        next AGAIN;
 
\end_layout

\begin_layout Plain Layout

      }
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
Plus and minus,
 with UpdateMenu
\begin_inset space ~
\end_inset

(
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:Update-Menu"
plural "false"
caps "false"
noprefix "false"
nolink "false"

\end_inset

) once more.
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

    elsif( ($ch eq '+') 
\end_layout

\begin_layout Plain Layout

         ||($ch eq '-') 
\end_layout

\begin_layout Plain Layout

         )
\end_layout

\begin_layout Plain Layout

      { my($sgn) = 1;
\end_layout

\begin_layout Plain Layout

      if($ch eq '-')
\end_layout

\begin_layout Plain Layout

        { $sgn = -1;
 
\end_layout

\begin_layout Plain Layout

        };
 
\end_layout

\begin_layout Plain Layout

        my ($k) = &TimeInSeconds($sgn,
 $inp);
 # returns zero on failure.
 
\end_layout

\begin_layout Plain Layout

      if($k)
\end_layout

\begin_layout Plain Layout

        { 
\end_layout

\begin_layout Plain Layout

        if(abs($k) < 5000000000)
\end_layout

\begin_layout Plain Layout

          { # print 
\begin_inset Quotes eld
\end_inset

Debug:
 $k $sgn 
\begin_inset Quotes eld
\end_inset

 .
 $NUMBR .
 
\begin_inset Quotes eld
\end_inset


\backslash
n
\begin_inset Quotes erd
\end_inset

 ;
 
\end_layout

\begin_layout Plain Layout

            $NUMBR += $k;
 
\end_layout

\begin_layout Plain Layout

            $MENU = &UpdateMenu($NUMBR,
 $region,
 $INTERVAL,
 $regionNAME);
\end_layout

\begin_layout Plain Layout

          } else
\end_layout

\begin_layout Plain Layout

          { print 
\begin_inset Quotes eld
\end_inset

Perhaps $k seconds is a shade too large?
\backslash
n
\begin_inset Quotes erd
\end_inset

;
\end_layout

\begin_layout Plain Layout

          };
 
\end_layout

\begin_layout Plain Layout

        };
 
\end_layout

\begin_layout Plain Layout

        next AGAIN;
\end_layout

\begin_layout Plain Layout

      }
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
List leapseconds:
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

     elsif($ch eq 'l' ) # year
\end_layout

\begin_layout Plain Layout

      { &ListLeapseconds();
 
\end_layout

\begin_layout Plain Layout

        next AGAIN;
 
\end_layout

\begin_layout Plain Layout

      }
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
Done:
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

      else  # braces + belt.
 
\end_layout

\begin_layout Plain Layout

      { print "
\backslash
n Woops!
 unknown command '$ch'
\backslash
n";
\end_layout

\begin_layout Plain Layout

      };
 
\end_layout

\begin_layout Plain Layout

    };
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
End of that nasty big loop.
 
\end_layout

\begin_layout Subsection
Update Menu
\begin_inset CommandInset label
LatexCommand label
name "subsec:Update-Menu"

\end_inset


\end_layout

\begin_layout Standard
Update menu with supplied values.
 A convenience.
 The Julian number in 
\family typewriter
$NUMBR
\family default
 is in seconds,
 not days.
 SetMenu
\begin_inset space ~
\end_inset

(
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:Set-up-menu"
plural "false"
caps "false"
noprefix "false"
nolink "false"

\end_inset

) rejigs the menu.
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

sub UpdateMenu # 
\end_layout

\begin_layout Plain Layout

{ my($NUMBR,
 $region,
 $INTERVAL,
 $regionNAME) = @_;
\end_layout

\begin_layout Plain Layout

  
\end_layout

\begin_layout Plain Layout

  my($MENU) = &SetMenu($NUMBR,
 $region,
 $INTERVAL,
 $regionNAME,
 0);
\end_layout

\begin_layout Plain Layout

  print $MENU;
\end_layout

\begin_layout Plain Layout

  return($MENU);
 
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Subsection
Time in seconds
\begin_inset CommandInset label
LatexCommand label
name "subsec:Time-in-seconds"

\end_inset


\end_layout

\begin_layout Standard
Options are e.g.
 60 and hh:mm:ss (no truncated form) such as 00:10:30.
 The sign is a text '+' or '-' 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

sub TimeInSeconds # 
\end_layout

\begin_layout Plain Layout

{ my($sgn,
 $txt) = @_;
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  # also allow d[ays]
\end_layout

\begin_layout Plain Layout

if($txt =~ /^
\backslash
s*(
\backslash
d+
\backslash
.?
\backslash
d*)
\backslash
s*da?y?s?/ ) # [hack]
\end_layout

\begin_layout Plain Layout

  { return( int($sgn * $1*86400) );
\end_layout

\begin_layout Plain Layout

  };
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  my($I);
 
\end_layout

\begin_layout Plain Layout

if( $txt =~ /^
\backslash
s*(
\backslash
d+)
\backslash
s*$/ )
\end_layout

\begin_layout Plain Layout

  { return($sgn * $1);
 
\end_layout

\begin_layout Plain Layout

  };
   # [ might have magnitude checks ?]
\end_layout

\begin_layout Plain Layout

if( $txt =~ /^
\backslash
s*(
\backslash
d+):(
\backslash
d{2}):(
\backslash
d{2})
\backslash
s*$/ ) 
\end_layout

\begin_layout Plain Layout

        # allow eg.
 3:00:00 or even 12345:99:99 !
 [might constrain further??] 
\end_layout

\begin_layout Plain Layout

  { return( $sgn * ($3 + 60*$2 + 3600*$1) );
 
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  print 
\begin_inset Quotes eld
\end_inset

Invalid time '$txt',
 enter either a number or hh:mm:ss e.g.
 00:40:30
\backslash
n
\begin_inset Quotes erd
\end_inset

;
 
\end_layout

\begin_layout Plain Layout

  return(0);
 
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Subsection
Show help
\begin_inset CommandInset label
LatexCommand label
name "subsec:Show-help"

\end_inset


\end_layout

\begin_layout Standard
Help with the more complex commands:
 t w v y z 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

sub ShowHelp # 
\end_layout

\begin_layout Plain Layout

{ my($qry) = @_;
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

if( $qry =~ /^elp(.+)/i )  # accommodate help or HELP etc.
 
\end_layout

\begin_layout Plain Layout

  { $qry = $1;
 
\end_layout

\begin_layout Plain Layout

  };
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  my($h);
 
\end_layout

\begin_layout Plain Layout

if( $qry =~ /^
\backslash
s*(frill)/ )
\end_layout

\begin_layout Plain Layout

  { # special 
\end_layout

\begin_layout Plain Layout

  } 
\end_layout

\begin_layout Plain Layout

elsif($qry !~ /^
\backslash
s*([rtvwyz])/)
\end_layout

\begin_layout Plain Layout

  { return(
\begin_inset Quotes eld
\end_inset

  Help options are  r t v w y z  &  frills.
 
\begin_inset Quotes eld
\end_inset


\end_layout

\begin_layout Plain Layout

           .
 
\begin_inset Quotes eld
\end_inset

Try:
  h t  OR:
  h frills
\backslash
n
\begin_inset Quotes erd
\end_inset

);
 # standard failure
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

  $h = $1;
 
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
Multiple options,
 starting with read & test:
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

  my($txt);
 
\end_layout

\begin_layout Plain Layout

if( $h eq 'r')
\end_layout

\begin_layout Plain Layout

  { $txt = 
\begin_inset Quotes eld
\end_inset

Read 'raw' tz source data.
 Options are:
 
\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset


\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset

  r all   Read,
 APPLY AND REWRITE the entire data set!
\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset

          **use with appropriate caution**
\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset

          (seekwell/perl/tz must contain tz source files)
\backslash
n
\begin_inset Quotes erd
\end_inset

 
\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset


\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset

  r       On its own 'r' reads data for the current zone alone.
\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset

          This is a 'fake' read---nothing is changed.
\backslash
n
\begin_inset Quotes erd
\end_inset

;
 
\end_layout

\begin_layout Plain Layout

  }
\end_layout

\begin_layout Plain Layout

elsif( $h eq 't')
\end_layout

\begin_layout Plain Layout

  { $txt = 
\begin_inset Quotes eld
\end_inset

Test a specific month,
 day and UTC time for ALL zones and years!
\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset

  With no parameters,
 this defaults to the current menu time.
 
\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset


\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset

  Entered values also work e.g.
   t 07-01 00:00:00 
\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset

  as well as the lowest year:
     t 2000-07-01 00:00:00
\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset

  or even a RANGE of years:
       t 1990 2000-07-01 00:00:00
\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset

  Default time,
 between years:
    t 1990 2000
\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset


\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset

  The process FOR EACH timestamp FOR EACH zone is:
\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset

    1.
 Use Timely to convert UTC to zone-specific Gregorian
\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset

    2.
 Also convert UTC value to local Gregorian using tz
\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset

    3.
 If they match,
 print '.',
 otherwise issue warning.
\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 '';
 
\end_layout

\begin_layout Plain Layout

  }
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
Then validate and wall test:
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

elsif( $h eq 'v')
\end_layout

\begin_layout Plain Layout

  { $txt = 
\begin_inset Quotes eld
\end_inset

On its own,
 v validates all database transition times for this zone.
\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset


\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset

  If you want to laboriously test all zones,
 say:
   v all
\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset

  You can even test transition times with an offset.
 
\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset

  Try for example:
   v+1   OR   v-1 
\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset

  Even constructs like:
   v+3600 all   will work 
\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset


\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset

  The details are interesting:
 the Julian transition is retrieved,
\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset

  and converted to Gregorian for this zone,
 both in Timely and tz.
 
\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset

  A warning is issued if the two don't match.
 Note that this is NOT
\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset

  a guarantee that the transition point recorded in the database is
\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset

  correct,
 merely that the two wall timestamps ultimately match.
\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 '';
 
\end_layout

\begin_layout Plain Layout

  }
\end_layout

\begin_layout Plain Layout

elsif( $h eq 'w')
\end_layout

\begin_layout Plain Layout

  { $txt = 
\begin_inset Quotes eld
\end_inset

This is similar to 't' but instead uses wall time.
 
\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset


\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset

  The same options otherwise apply.
 Examples are:
\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset

       w 01-05 00:45:00
\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset

       w 2000-01-05 00:45:00
\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset

       w 1990  2000-01-05 00:45:00
\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset

   etc.
\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset


\backslash
n
\begin_inset Quotes erd
\end_inset

    
\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset

  Given a WALL timestamp,
 do two things:
\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset

    1.
 Use Timely to convert to a UTC time;
\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset

    2.
 Use tz to do the same;
\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset

  The two can then be compared.
 As one wall timestamp may have 
\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset

  two associated UTC values,
 tz defaults to the later time.
\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset

  Timely by default uses the earlier,
 so an adjustment is made.
\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset


\backslash
n
\begin_inset Quotes erd
\end_inset

    
\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset

  Errors will result for invalid wall times,
 for example:
\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset

       w 2020-09-27 02:30:00 
\backslash
n
\begin_inset Quotes erd
\end_inset

 
\end_layout

\begin_layout Plain Layout

         .
 '';
 
\end_layout

\begin_layout Plain Layout

  }
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
Year and tZ year:
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

elsif( $h eq 'y')
\end_layout

\begin_layout Plain Layout

  { $txt = 
\begin_inset Quotes eld
\end_inset

Check sequential timestamps within a given year,
 internally.
 
\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset


\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset

  The simplest option is something like   y 2000 
\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset

  Year start YYYY-01-01 00:00:00 is converted to a Julian timestamp.
\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset

  This is then sequentially increased by increment 'i',
 each time:
 
\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset

    1.
 Convert to a Gregorian timestamp for this zone;
\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset

    2.
 Convert the Gregorian value back to Julian;
 and 
\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset

    3.
 Compare Julian values,
 issuing a warning if they don't match.
\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset

  Dot prints every 50 validations,
 and newline every $PRETTYDOTS dots.
\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset

  
\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset

  An internal check with *no* external (e.g.
 tz) validation.
 See z too.
\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset


\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset

  You can even specify a range of years e.g.
 y 2000 2010 as well as
\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset

  full timestamps along the lines of:
\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset

       y 2020-07-01 00:00:00  2021-06-30 23:59:59
\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 '';
 
\end_layout

\begin_layout Plain Layout

  }
\end_layout

\begin_layout Plain Layout

elsif( $h eq 'z')
\end_layout

\begin_layout Plain Layout

  { $txt = 
\begin_inset Quotes eld
\end_inset

Like 'y',
 but sequential timestamps are *validated*.
 
\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset


\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset

  As with 'y' you can say e.g.
   z 2000   and things like:
 
\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset

      z 2020-07-01 00:00:00  2021-06-30 23:59:59
\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset

      z 2020  2022
\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset

      z 1900-06-01 00:00:00  1901
\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset

      z 1900  1900-01-01 23:59:59
\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset

  If just YYYY is specified,
 default is year start/end 
\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset


\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset

  The UTC start value is converted to a Julian timestamp.
\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset

  This is then sequentially increased by 'i',
 and each time:
 
\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset

    1.
 The UTC time derived from the Julian is converted to both a 
\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset

       Timely wall time and a tz wall time,
 for this zone.
 
\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset

    2.
 A warning is issued if they're not the same.
\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset

  Print dot every 50 validations,
 newline every $PRETTYDOTS dots.
\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 '';
 
\end_layout

\begin_layout Plain Layout

  }
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
Rather special:
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

elsif( $h eq 'frill')
\end_layout

\begin_layout Plain Layout

  { $txt = 
\begin_inset Quotes eld
\end_inset

                    A few 'frills' and 'factoids':
 
\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

       .
 "  --------------------------------------------------------------------
\backslash
n"
\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset


\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset

  NB:
 Z and DST offsets apply *up to* the database transition time
\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset

  Use  l   to list Leap seconds
\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset

  Use  u YYYY-MM-DD hh:mm:ss   to enter UTC timestamp,
 like g
\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset


\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset

       + 1200       Add a number of seconds to menu timestamp
\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset

       - 60         Similarly can move earlier,
 here by 60 s
\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset

       + 23:59:59   Can also add hours,
 minutes and seconds
\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset

       + 2.5 days   Add 2.5 days 
\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset


\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset

  With f for find,
 add a question mark to print all the matches!
\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset

     ...
 and for an exact match try e.g.
   f 'EST' 
\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset

     ...
 and you can find by Timely zone ID number too,
 FWIW.
\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset


\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset

  With e.g.
  y 2000   any - and + signs signal testing around DST 
\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset

  and zone transitions.
 With small  i  values,
 these can burgeon!
 
\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset

  Similarly,
 '>>' signals that in comparing times,
 the Timely 
\backslash
n
\begin_inset Quotes eld
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset

  value was 'adjusted up' to make it compatible with the tz one.
\backslash
n
\begin_inset Quotes erd
\end_inset

  
\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset

  (With DST/Z decrements,
 two UTC times map to one wall time!)
\backslash
n
\begin_inset Quotes erd
\end_inset

 
\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset


\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset

  The topmost year with t (for Test) is one greater than that with 
\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset

  w for Wall time because e.g.
 12-31 23:59:59 may anticipate UTC 
\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset

  by several hours in the latter case.
 
\backslash
n
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 '';
 
\end_layout

\begin_layout Plain Layout

    $h = '!';
 
\end_layout

\begin_layout Plain Layout

  }
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
Done:
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

else  # exceptional failure,
 won't happen without programming error above:
 
\end_layout

\begin_layout Plain Layout

  { print 
\begin_inset Quotes eld
\end_inset


\backslash
nUnknown help option:
 '$h'
\backslash
n
\begin_inset Quotes erd
\end_inset

;
 
\end_layout

\begin_layout Plain Layout

    return('');
 # just in case.
 
\end_layout

\begin_layout Plain Layout

  };
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  my($M) = 
\end_layout

\begin_layout Plain Layout

    "
\backslash
n  ====================-----     HELP ($h)      -----==================="
\end_layout

\begin_layout Plain Layout

  .
 
\begin_inset Quotes eld
\end_inset


\backslash
n  $txt
\begin_inset Quotes erd
\end_inset

 
\end_layout

\begin_layout Plain Layout

  .
 "
\backslash
n  --------------------------------------------------------------------
\backslash
n";
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  print($M);
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  return('');
 # success
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Subsection
Clear screen
\begin_inset CommandInset label
LatexCommand label
name "subsec:Clear-screen"

\end_inset


\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

sub Cls # 
\end_layout

\begin_layout Plain Layout

{ 
\end_layout

\begin_layout Plain Layout

if(Timely::CheckOS() eq 'Windows') # or use $OPERATING_SYSTEM [?] 
\end_layout

\begin_layout Plain Layout

  { system 'cls';
 
\end_layout

\begin_layout Plain Layout

  } else
\end_layout

\begin_layout Plain Layout

  { system 'clear';
 
\end_layout

\begin_layout Plain Layout

  };
   # or simply and obscurely:
   system $^O eq 'MSWin32' ?
 'cls' :
 'clear';
\end_layout

\begin_layout Plain Layout

} 
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Subsection
Setup menu
\begin_inset CommandInset label
LatexCommand label
name "subsec:Set-up-menu"

\end_inset


\end_layout

\begin_layout Standard
Manufacture a text menu.
 Important arguments are:
\end_layout

\begin_layout Description
NUMBR the current GPS timestamp
\end_layout

\begin_layout Description
$region the zone.
 
\end_layout

\begin_layout Standard
\begin_inset Separator plain
\end_inset


\end_layout

\begin_layout Standard
Other arguments include the sampling interval,
 the place,
 and an optional welcome message—
a frill.
 The menu will printed to the console by the calling routine.
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

sub SetMenu # 
\end_layout

\begin_layout Plain Layout

{ my($NUMBR,
 $region,
 $INTERVAL,
 $placename,
 $welcome) = @_;
\end_layout

\begin_layout Plain Layout

  
\end_layout

\begin_layout Plain Layout

  my($DayNumber) = &JulianDay($NUMBR);
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  my($hi) = '     TIMELY      ';
\end_layout

\begin_layout Plain Layout

if($welcome)
\end_layout

\begin_layout Plain Layout

  {  $hi =  'Welcome to TIMELY';
 
\end_layout

\begin_layout Plain Layout

  };
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  my($utc) = Timely::Greg($NUMBR,
 0,
 0,
 1);
  # 1=GPS is ON
\end_layout

\begin_layout Plain Layout

  my($sec) = &GpsOffset($NUMBR);
 
\end_layout

\begin_layout Plain Layout

  
\end_layout

\begin_layout Plain Layout

 my($wall) = '?';
 
\end_layout

\begin_layout Plain Layout

  my($gYYYY,$gM,$gD,$gh,$gm,$gs,
 $Z_OFF,
 $DST,
 $hog,
 $deltz,
 $delds) 
\end_layout

\begin_layout Plain Layout

                                              # stubs ^       ^
\end_layout

\begin_layout Plain Layout

         = Timely::J2G(1,
 $region,
 $NUMBR);
 # Z_OFF,DST=day parts
\end_layout

\begin_layout Plain Layout

if($gYYYY)  
\end_layout

\begin_layout Plain Layout

  { $wall = Timely::PrettyDate(0,$gYYYY,$gM,$gD,$gh,$gm,$gs);
 # cf.
 InternalJulian
\end_layout

\begin_layout Plain Layout

    #print 
\begin_inset Quotes eld
\end_inset

Wall in SetMenu is $wall
\backslash
n
\begin_inset Quotes erd
\end_inset

;
 
\end_layout

\begin_layout Plain Layout

    my($yours) = Timely::FetchTzDate($NUMBR,
 $placename,
 $gYYYY,
 $gM,
 $gD,
 
\end_layout

\begin_layout Plain Layout

                                     $gh,
 $gm,
 $gs);
  # 
\end_layout

\begin_layout Plain Layout

    #print 
\begin_inset Quotes eld
\end_inset

FetchTzDate gave $yours
\backslash
n
\begin_inset Quotes erd
\end_inset

;
 
\end_layout

\begin_layout Plain Layout

    #
\end_layout

\begin_layout Plain Layout

    $yours =~ s/T/ /;
 
\end_layout

\begin_layout Plain Layout

  if($yours eq $utc)
\end_layout

\begin_layout Plain Layout

    { $wall .=  $TICK;
\end_layout

\begin_layout Plain Layout

    } 
\end_layout

\begin_layout Plain Layout

  elsif
\end_layout

\begin_layout Plain Layout

    ( ($region != Timely::GetUtcCode() ) # don't try with UTC base 
\end_layout

\begin_layout Plain Layout

     ## && !
 $hog   ## <-- a conceit!
 
\end_layout

\begin_layout Plain Layout

    )
\end_layout

\begin_layout Plain Layout

    { # $wall .= 
\begin_inset Quotes eld
\end_inset

 (?
 $yours)
\begin_inset Quotes erd
\end_inset

;
   # 
\begin_inset Quotes eld
\end_inset

 ?
 $yours
\begin_inset Quotes erd
\end_inset

;
 # temporary.
 
\end_layout

\begin_layout Plain Layout

      $wall .= &Colourise('?',
 ANSIRED);
 
\end_layout

\begin_layout Plain Layout

    };
 
\end_layout

\begin_layout Plain Layout

  if($hog)
\end_layout

\begin_layout Plain Layout

    {   # Esc code will be 
\backslash
033[31
\end_layout

\begin_layout Plain Layout

      my($foo) = &Colourise('?',
 ANSIRED);
  # see quotemeta below 
\backslash
Q 
\backslash
E 
\end_layout

\begin_layout Plain Layout

    if($wall =~ /^(.*
\backslash
d
\backslash
d)
\backslash
Q$foo
\backslash
E/) 
\end_layout

\begin_layout Plain Layout

         # if contains red '?' [hmm] AND is groundhog,
 consolidate to:
\end_layout

\begin_layout Plain Layout

      { $wall = $1 .
 &Colourise('*',
 ANSIRED);
 # red star = 1st groundhog!
\end_layout

\begin_layout Plain Layout

      } else
\end_layout

\begin_layout Plain Layout

      { $wall .= '*';
 
\end_layout

\begin_layout Plain Layout

      };
 
\end_layout

\begin_layout Plain Layout

    };
 
\end_layout

\begin_layout Plain Layout

  };
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  # eye candy:
 extra spaces as length of placename goes from 30 down to 7
\end_layout

\begin_layout Plain Layout

  my($filler) = Timely::Padding(' ',
 (30 - (length $placename))/2 );
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  # here determine DST and Z 
\end_layout

\begin_layout Plain Layout

  # ...
 
\end_layout

\begin_layout Plain Layout

  my($mydst) = &Tim($DST);
\end_layout

\begin_layout Plain Layout

  my($myz) = &Tim($Z_OFF);
 
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
Noteworthy is the invocation of J2G
\begin_inset space ~
\end_inset

(),
 which in turn calls FullGregorian
\begin_inset space ~
\end_inset

().
 J2G
\begin_inset space ~
\end_inset

() also invokes Anomalous
\begin_inset space ~
\end_inset

(),
 which looks up the Z and DST values for the supplied proleptic GPS timestamp in 
\family typewriter
$NUMBR
\family default
.
 It's important to note that in the interval +DST following a back transition at time T (DST is now cancelled),
 the wall time will fall back by DST.
 This obviously only completes once we've reached T+DST.
 It is thus very valuable to signal back from J2G
\begin_inset space ~
\end_inset

() if we're in this transition interval.
 In other words,
 we need to:
\end_layout

\begin_layout Enumerate
Check whether the supplied time is within the last transition + D
\begin_inset Foot
status collapsed

\begin_layout Plain Layout
In the case of D now returning to zero,
 or,
 at least a value less than the prior DST,
 thinking of 
\begin_inset Quotes eld
\end_inset

super DST
\begin_inset Quotes erd
\end_inset

 which occurred,
 for example,
 in the UK during the Second World War
\end_layout

\end_inset

;
 and 
\end_layout

\begin_layout Enumerate
If so,
 signal this.
 
\end_layout

\begin_layout Standard
\begin_inset Separator plain
\end_inset


\end_layout

\begin_layout Standard

\end_layout

\begin_layout Standard
The menu itself:
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

  $placename = &Colourise($placename,
 ANSIBLUE);
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

   ($region,
 $placename,
 $INTERVAL,
 $utc,
 $DayNumber,
 $sec,
 $wall,
 $myz,
 $mydst) = 
\end_layout

\begin_layout Plain Layout

    &PrettyAll($region,
 $placename,
 $INTERVAL,
 $utc,
 $DayNumber,
 
\end_layout

\begin_layout Plain Layout

               $sec,
 $wall,
 $myz,
 $mydst);
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  my($M) = 
\end_layout

\begin_layout Plain Layout

    "
\backslash
n  ===================================================================="
\end_layout

\begin_layout Plain Layout

  .
 "
\backslash
n  ====================----- $hi -----==================="
\end_layout

\begin_layout Plain Layout

  .
 "
\backslash
n                $filler ($region :
 $placename)"
\end_layout

\begin_layout Plain Layout

  .
 "
\backslash
n                  q=QUIT  h=HELP r=READ  t=TEST  n=Now"
\end_layout

\begin_layout Plain Layout

  .
 "
\backslash
n  ------------------------------settings------------------------------"
\end_layout

\begin_layout Plain Layout

  .
 "
\backslash
n  f name     eg.
 f Auckl      Find & set region "
\end_layout

\begin_layout Plain Layout

  .
 "
\backslash
n  g YYYY-MM-DD hh:mm:ss       enter Gregorian wall timestamp (u=UTC)"
\end_layout

\begin_layout Plain Layout

  .
 "
\backslash
n  j number   eg.
 g 2415020.5  enter Julian GPS day number"
\end_layout

\begin_layout Plain Layout

  .
 "
\backslash
n  i interval eg.
 i $INTERVAL       set year test Interval (seconds)"
\end_layout

\begin_layout Plain Layout

  .
 "
\backslash
n  -------------------------------tests--------------------------------"
\end_layout

\begin_layout Plain Layout

  .
 "
\backslash
n  y year     eg.
 y 2000       test current zone,
 Year at interval i"
\end_layout

\begin_layout Plain Layout

  .
 "
\backslash
n  z year     eg.
 z 2000       tZ timestamp validation at interval i"
\end_layout

\begin_layout Plain Layout

  .
 "
\backslash
n  a year     eg.
 a 2000       show transitions Around year"
\end_layout

\begin_layout Plain Layout

  .
 
\begin_inset Quotes eld
\end_inset


\backslash
n  v     the lot:
 v all        Validate vs source,
 try v+1 OR v-1 too
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

  .
 "
\backslash
n  t MM-DD hh:mm:ss            Test *all* eg.
 t 12-31 23:59:59"
\end_layout

\begin_layout Plain Layout

  .
 "
\backslash
n  w MM-DD hh:mm:ss            as for t but Wall time!"
\end_layout

\begin_layout Plain Layout

  .
 "
\backslash
n  --------------------------------------------------------------------"
\end_layout

\begin_layout Plain Layout

  .
 "
\backslash
n  UTC :
 $utc <= GPS $DayNumber delta=$sec s"
\end_layout

\begin_layout Plain Layout

  .
 
\begin_inset Quotes eld
\end_inset


\backslash
n  Wall:
 $wall   Z=$myz   DST=$mydst
\begin_inset Quotes erd
\end_inset

 
\end_layout

\begin_layout Plain Layout

  .
 "
\backslash
n  ====================================================================
\backslash
n";
\end_layout

\begin_layout Plain Layout

  return($M);
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
\begin_inset ERT
status open

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  .
 "
\backslash
n  z integer  eg.
 z -300       set Zone offset   ($Z_OFF min)"
\end_layout

\begin_layout Plain Layout

  .
 "
\backslash
n  d integer  eg.
 d 60         set Dst           ($DST min)"
\end_layout

\begin_layout Plain Layout

  .
 "
\backslash
n  s (use current time/zone to Set dst and zone offset)"
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Subsubsection
\begin_inset Quotes eld
\end_inset

Tim
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
[explore value]
\end_layout

\end_inset


\end_layout

\begin_layout Standard
This converts a Julian time fraction (expressed as seconds) to minutes;
 formerly the submitted values were in fractions of a day.
 
\begin_inset Note Note
status open

\begin_layout Plain Layout
We use Biggen
\begin_inset space ~
\end_inset

() to add or subtract a small time to compensate for imprecise digital representation of numbers,
 and truncation.
 [explore] 
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

sub Tim # 
\end_layout

\begin_layout Plain Layout

{ my($t) = @_;
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  return($t/60);
 # just integer seconds.
 
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
Some time offsets (especially older ones) are not limited to integral minute values (cf.
 Australia/Currie) so we allow two decimal places.
 
\end_layout

\begin_layout Subsection
Pretty
\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
[obsolete]
\end_layout

\begin_layout Plain Layout
Given a Julian day value as proleptic GPS time,
 return the numeric value,
 a formatted date (or error message) for printing,
 and the GPS offset in seconds.
\end_layout

\begin_layout Plain Layout
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

sub MyJulian #
\end_layout

\begin_layout Plain Layout

{ my($NUMBR,
 $Z_OFF,
 $DST);
\end_layout

\begin_layout Plain Layout

    ($NUMBR,
 $Z_OFF,
 $DST)=@_;
\end_layout

\begin_layout Plain Layout

  my($r);
\end_layout

\begin_layout Plain Layout

  $r = Timely::Greg($NUMBR*86400,$Z_OFF/(60*24),$DST/(60*24),1);
  # 1=GPS is ON
\end_layout

\begin_layout Plain Layout

    # Greg_() accepts 2nd and 3rd parameters as fractions of a DAY
\end_layout

\begin_layout Plain Layout

  my($sec) = &GpsOffset($NUMBR*86400);
 
\end_layout

\begin_layout Plain Layout

  return($r,
 $sec);
 
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Subsubsection
DoubleDigit
\end_layout

\begin_layout Standard
(Also present in timely_400.lyx)
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

sub DoubleDigit # 
\end_layout

\begin_layout Plain Layout

{ my($i) = @_;
\end_layout

\begin_layout Plain Layout

  return(&Lead($i,2));
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Subsubsection
Pretty things
\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
[Note:
 Windows terminal supports ANSI escape codes,
 unlike the old DOS terminal.
 cf.
 https://docs.microsoft.com/en-us/windows/terminal/get-started
\end_layout

\end_inset


\end_layout

\begin_layout Standard
Embolden values that changed:
 a convenience.
 Given a fixed number (n=9) of variables,
 embolden and update them—
unless working under Windows.
 
\begin_inset Note Note
status open

\begin_layout Plain Layout
[explore fix for the latter]
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

sub PrettyAll  # NB.
 checks length but not *order* of submitted parameters :( 
\end_layout

\begin_layout Plain Layout

{ my(@LOTS) = @_;
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

if($OPERATING_SYSTEM eq 'Windows') # [clumsy] 
\end_layout

\begin_layout Plain Layout

  { return(@LOTS);
   # just return.
 
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  my($N) = scalar @LOTS;
 
\end_layout

\begin_layout Plain Layout

if( $N != scalar @OLDMENUVALUES )
\end_layout

\begin_layout Plain Layout

  { die 
\begin_inset Quotes eld
\end_inset

Missing parameter for PrettyAll_(),
 n=
\begin_inset Quotes erd
\end_inset

 .
 $N ;
\end_layout

\begin_layout Plain Layout

    return;
 
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

  my($i) = 0;
 
\end_layout

\begin_layout Plain Layout

while($i < $N)
\end_layout

\begin_layout Plain Layout

  { $LOTS[$i] = &PrettyBold($LOTS[$i],
 $i);
 
\end_layout

\begin_layout Plain Layout

    $i ++;
 
\end_layout

\begin_layout Plain Layout

  };
 
\end_layout

\begin_layout Plain Layout

  return(@LOTS);
 
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
The subsidiary emboldening:
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

sub PrettyBold # 
\end_layout

\begin_layout Plain Layout

{ my($new,
 $i) = @_;
 
\end_layout

\begin_layout Plain Layout

if( $OLDMENUVALUES[$i] ne $new )  # Global :( 
\end_layout

\begin_layout Plain Layout

  { $OLDMENUVALUES[$i] = $new;
 # update 
\end_layout

\begin_layout Plain Layout

    $new = 
\begin_inset Quotes eld
\end_inset


\backslash
033[1m
\begin_inset Quotes erd
\end_inset

 .
 $new .
 
\begin_inset Quotes eld
\end_inset


\backslash
033[0m
\begin_inset Quotes erd
\end_inset

;
  # ANSI escape (bold) ...
 ESC 'reset' code.
 
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

  return($new);
 
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Subsubsection
Colourise
\begin_inset CommandInset label
LatexCommand label
name "subsec:Colourise"

\end_inset


\end_layout

\begin_layout Standard
30–37 = black,
 red,
 green,
 yellow,
 blue,
 magenta,
 cyan,
 white.
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

sub Colourise # 
\end_layout

\begin_layout Plain Layout

{ my($txt,
 $clr) = @_;
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  # [might check $clr is valid]
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

if($OPERATING_SYSTEM ne 'Windows')
\end_layout

\begin_layout Plain Layout

  { $txt = 
\begin_inset Quotes eld
\end_inset


\backslash
033[
\begin_inset Quotes eld
\end_inset

 .
 $clr .
 
\begin_inset Quotes eld
\end_inset

m
\begin_inset Quotes erd
\end_inset

 .
 $txt .
 
\begin_inset Quotes eld
\end_inset


\backslash
033[0m
\begin_inset Quotes erd
\end_inset

;
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

  return($txt);
 
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Subsubsection
Julian Day
\begin_inset CommandInset label
LatexCommand label
name "subsec:Julian-Day"

\end_inset


\end_layout

\begin_layout Standard
Convert seconds to Julian day number:
 a convenient wrapper.
 (Is duplicated in 
\emph on
timely_400.lyx
\emph default
).
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

sub JulianDay # 
\end_layout

\begin_layout Plain Layout

{ my($s) = @_;
\end_layout

\begin_layout Plain Layout

  return($s/86400.0);
 
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Subsubsection
Usage
\end_layout

\begin_layout Standard
If you enter a Julian value of e.g.
 2415020.5 you should by default obtain the start of the 20th century;
 note however if you set the zone offset to 60 minutes,
 then the time in this zone for the same Julian value will be 1 hour later.
 Zone offsets may be positive or negative,
 but DST (which has a similar effect) can only be positive.
\begin_inset Note Note
status open

\begin_layout Plain Layout
[BUT THE TZ DATABASE SEEMS TO CONTAIN SOME -VES.
 EXPLORE ???]
\end_layout

\end_inset


\end_layout

\begin_layout Standard
Setting GPS (t 1) will have the effect of converting e.g.
 1900-01-01 00:00:00 not to 2415020.5 but to a value that is nine seconds earlier,
 as proleptic GPS time is here earlier.
 Now try the same with eg.
 2000.
 
\end_layout

\begin_layout Section
Kept rules
\end_layout

\begin_layout Standard
This section allows us to retain tz rules,
 check and update/retire them.
 There are two classes of rule:
 tz_rules and tz_cutoffs,
 with corresponding tables.
 We can thus invoke any of:
 
\end_layout

\begin_layout Description
tz_rule_save
\begin_inset space ~
\end_inset

() Save a rule—
if present,
 simply make sure it's active,
 and return the code (ID),
 otherwise,
 create a new one
\end_layout

\begin_layout Description
tz_rules_inactivate_all
\begin_inset space ~
\end_inset

() Clear the is_active flag to zero for all entries
\end_layout

\begin_layout Description
tz_cutoff_save
\begin_inset space ~
\end_inset

() Save cutoff rule,
 as for tz_rule_save
\begin_inset space ~
\end_inset

(),
 returning the internal ID
\end_layout

\begin_layout Description
tz_cutoff_inactivate_all
\begin_inset space ~
\end_inset

() Clear is_active flag to zero for all entries
\end_layout

\begin_layout Standard
\begin_inset Separator plain
\end_inset


\end_layout

\begin_layout Subsection
Save tz rule
\end_layout

\begin_layout Standard
Save/update an existing rule,
 stored in the 
\series bold
\emph on
f
\emph default
ehr
\series default
 database.
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

sub tz_rule_save #
\end_layout

\begin_layout Plain Layout

{ my($rule_name,
 $from_year,
 $to_year,
 $in,
 $on,
 $at,
 $dst) = @_;
\end_layout

\begin_layout Plain Layout

 
\end_layout

\begin_layout Plain Layout

  my($handDB) = $smalltime_h;
  
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  my($inonat) = 
\begin_inset Quotes eld
\end_inset

$in $on $at
\begin_inset Quotes erd
\end_inset

;
 # note space separators [explore]
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  my($q) = 
\begin_inset Quotes eld
\end_inset

SELECT tz_rule FROM tz_rules WHERE rule_name = '$rule_name' 
\begin_inset Quotes eld
\end_inset


\end_layout

\begin_layout Plain Layout

           .
 
\begin_inset Quotes eld
\end_inset

AND from_year = '$from_year' 
\begin_inset Quotes eld
\end_inset


\end_layout

\begin_layout Plain Layout

           .
 
\begin_inset Quotes eld
\end_inset

AND to_year = '$to_year' 
\begin_inset Quotes eld
\end_inset


\end_layout

\begin_layout Plain Layout

           .
 
\begin_inset Quotes eld
\end_inset

AND in_on_at = '$inonat' 
\begin_inset Quotes eld
\end_inset

;
\end_layout

\begin_layout Plain Layout

  my($tz_rule) = Timely::GetSQL($handDB,
 $q,
 'find old rule');
\end_layout

\begin_layout Plain Layout

if($tz_rule)
\end_layout

\begin_layout Plain Layout

  { return($tz_rule);
 # found
\end_layout

\begin_layout Plain Layout

  };
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  ## ?????????????????????????/ what if the DST has changed for a rule?!
 
\end_layout

\begin_layout Plain Layout

  
\end_layout

\begin_layout Plain Layout

  # else need to make new entry:
\end_layout

\begin_layout Plain Layout

  ($tz_rule) = Timely::FetchKey('tz_rules',
 'tz rules');
\end_layout

\begin_layout Plain Layout

    # [here might check this succeeded..]
\end_layout

\begin_layout Plain Layout

  my($iq) = 
\begin_inset Quotes eld
\end_inset

INSERT INTO tz_rules 
\begin_inset Quotes eld
\end_inset


\end_layout

\begin_layout Plain Layout

            .
 
\begin_inset Quotes eld
\end_inset

(tz_rule,
 rule_name,
 from_year,
 to_year,
 in_on_at,
 dst) 
\begin_inset Quotes eld
\end_inset


\end_layout

\begin_layout Plain Layout

            .
 
\begin_inset Quotes eld
\end_inset

VALUES ($tz_rule,
 '$rule_name',
 '$from_year',
 '$to_year',
 
\begin_inset Quotes eld
\end_inset


\end_layout

\begin_layout Plain Layout

            .
      
\begin_inset Quotes eld
\end_inset

'$inonat',
 '$dst')
\begin_inset Quotes erd
\end_inset

;
 
\end_layout

\begin_layout Plain Layout

if( !
 Timely::DoSQL($handDB,
 $iq,
 'new tz rule') )
\end_layout

\begin_layout Plain Layout

  { die 
\begin_inset Quotes eld
\end_inset

Failed to insert new tz rule:
 
\begin_inset Quotes eld
\end_inset


\end_layout

\begin_layout Plain Layout

        .
  
\begin_inset Quotes eld
\end_inset

$rule_name,
 $from_year,
 $to_year,
 $in,
 $on,
 $at,
 $dst
\begin_inset Quotes erd
\end_inset

;
\end_layout

\begin_layout Plain Layout

  };
 
\end_layout

\begin_layout Plain Layout

  return($tz_rule);
 
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Subsection
inactivate tz rules
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

sub tz_rules_inactivate_all #
\end_layout

\begin_layout Plain Layout

{
\end_layout

\begin_layout Plain Layout

  my($handDB) = $smalltime_h;
  
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  my($q) = 
\begin_inset Quotes eld
\end_inset

UPDATE tz_rules SET is_active = 0 WHERE 1
\begin_inset Quotes erd
\end_inset

;
 
\end_layout

\begin_layout Plain Layout

if(Timely::DoSQL($handDB,
 $q,
 
\begin_inset Quotes eld
\end_inset

reset all tz rules
\begin_inset Quotes erd
\end_inset

) < 0)
\end_layout

\begin_layout Plain Layout

  { die 
\begin_inset Quotes eld
\end_inset

Failed to reset tz_rules
\begin_inset Quotes erd
\end_inset

;
\end_layout

\begin_layout Plain Layout

  };
 
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Subsection
Save cutoff rule
\end_layout

\begin_layout Standard
Apart from the PK tz_cutoff,
 only the region is an integer.
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

sub tz_cutoff_save #
\end_layout

\begin_layout Plain Layout

{ my($stdoff,
 $rule_name,
 $region,
 $until_text) = @_;
\end_layout

\begin_layout Plain Layout

 
\end_layout

\begin_layout Plain Layout

  my($handDB) = $smalltime_h;
  
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  # unfortunately:
\end_layout

\begin_layout Plain Layout

if(!
 defined $until_text)
\end_layout

\begin_layout Plain Layout

  { $until_text = '';
 
\end_layout

\begin_layout Plain Layout

  };
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  my($q) = 
\begin_inset Quotes eld
\end_inset

SELECT tz_cutoff FROM tz_cutoffs WHERE stdoff='$stdoff' 
\begin_inset Quotes eld
\end_inset


\end_layout

\begin_layout Plain Layout

             .
 
\begin_inset Quotes eld
\end_inset

AND rule_name = '$rule_name' 
\begin_inset Quotes eld
\end_inset


\end_layout

\begin_layout Plain Layout

             .
 
\begin_inset Quotes eld
\end_inset

AND region = $region 
\begin_inset Quotes eld
\end_inset


\end_layout

\begin_layout Plain Layout

             .
 
\begin_inset Quotes eld
\end_inset

AND until_text = '$until_text'
\begin_inset Quotes erd
\end_inset

;
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  my($tz_cutoff) = Timely::GetSQL($handDB,
 $q,
 'find old rule');
\end_layout

\begin_layout Plain Layout

if($tz_cutoff)
\end_layout

\begin_layout Plain Layout

  { return($tz_cutoff);
 # found
\end_layout

\begin_layout Plain Layout

  };
 
\end_layout

\begin_layout Plain Layout

  
\end_layout

\begin_layout Plain Layout

  # new entry:
\end_layout

\begin_layout Plain Layout

  ($tz_cutoff) = Timely::FetchKey('tz_cutoffs',
 'tz cutoffs');
\end_layout

\begin_layout Plain Layout

    # [here might check this succeeded..]
\end_layout

\begin_layout Plain Layout

  my($iq) = 
\begin_inset Quotes eld
\end_inset

INSERT INTO tz_cutoffs 
\begin_inset Quotes eld
\end_inset


\end_layout

\begin_layout Plain Layout

            .
     
\begin_inset Quotes eld
\end_inset

 (tz_cutoff,
 stdoff,
 rule_name,
 region,
 until_text) 
\begin_inset Quotes eld
\end_inset


\end_layout

\begin_layout Plain Layout

            .
 
\begin_inset Quotes eld
\end_inset

VALUES ($tz_cutoff,
 '$stdoff',
 '$rule_name',
 $region,
 '$until_text')
\begin_inset Quotes erd
\end_inset

;
 
\end_layout

\begin_layout Plain Layout

if( !
 Timely::DoSQL($handDB,
 $iq,
 'new tz cutoff') )
\end_layout

\begin_layout Plain Layout

  { die 
\begin_inset Quotes eld
\end_inset

Failed to insert new tz cutoff:
 $stdoff,
 $rule_name,
 $region,
 $until_text
\begin_inset Quotes erd
\end_inset

;
\end_layout

\begin_layout Plain Layout

  };
 
\end_layout

\begin_layout Plain Layout

  return($tz_cutoff);
 
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Subsection
Inactivate cutoff rules
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

sub tz_cutoff_inactivate_all #
\end_layout

\begin_layout Plain Layout

{ 
\end_layout

\begin_layout Plain Layout

  my($handDB) = $smalltime_h;
  
\end_layout

\begin_layout Plain Layout

  
\end_layout

\begin_layout Plain Layout

  my($q) = 
\begin_inset Quotes eld
\end_inset

UPDATE tz_cutoffs SET is_active = 0 WHERE 1
\begin_inset Quotes erd
\end_inset

;
 
\end_layout

\begin_layout Plain Layout

if(Timely::DoSQL($handDB,
 $q,
 
\begin_inset Quotes eld
\end_inset

reset all cutoff rules
\begin_inset Quotes erd
\end_inset

) < 0)
\end_layout

\begin_layout Plain Layout

  { die 
\begin_inset Quotes eld
\end_inset

Failed to reset tz_cutoffs
\begin_inset Quotes erd
\end_inset

;
\end_layout

\begin_layout Plain Layout

  };
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Section

\series medium
\begin_inset Argument 1
status open

\begin_layout Plain Layout
populate
\end_layout

\end_inset

Populate
\series default
 timely
\begin_inset CommandInset label
LatexCommand label
name "sec:Populating-timely-table"

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
[cf:
 
\series bold
http://en.wikipedia.org/wiki/List_of_tz_database_time_zones
\end_layout

\begin_layout Plain Layout
ftp://ftp.iana.org/tz/releases/tzdata2014b.tar.gz]
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
\begin_inset Quotes eld
\end_inset

The rules for daylight saving time are specified in named rule sets.
 Each rule set has one or more rule lines in the time zone text files.
 A rule line contains the name of the rule set to which it belongs,
 the first year in which the rule applies,
 the last year in which the rule applies (or "only" if it applies only in one year or "max" if it is the rule currently in effect),
 the type of year to which the rule applies ("-" if it applies to all years in the specified range,
 which is almost always the case,
 otherwise a name used as an argument to a script that indicates whether the year is of the specified type),
 the month in which the rule takes effect,
 the day on which the rule takes effect (which could either be a specific day or a specification such as "the last Sunday of the month"),
 the time of day at which the rule takes effect,
 the amount of time to add to the offset to UTC when the rule is in effect,
 and the letter or letters to use in the time zone abbreviation (for example,
 "S" if the rule governs standard time and "D" if it governs daylight saving time).
\begin_inset Quotes erd
\end_inset

 [Wikipedia]
\end_layout

\end_inset


\end_layout

\begin_layout Standard
If we `unzip' the TZ database,
 we obtain several files from the data file (e.g.
 
\emph on
tzdata2014c.tar.gz
\emph default
) and from the code file (e.g.
 
\emph on
tzcode2014c.tar.gz
\emph default
).
 The former refer to:
\end_layout

\begin_layout Enumerate
Time zone boundaries;
\end_layout

\begin_layout Enumerate
UTC offsets;
\end_layout

\begin_layout Enumerate
Daylight saving.
 
\end_layout

\begin_layout Standard
In the relevant data files,
 the # character is used to signal a comment.
 The code file allows you to build,
 install and test the C code on a Linux system;
 particularly useful is the file 
\emph on
zic.8.txt
\emph default
.
 My task is to encode all relevant data in two tables:
 
\series bold
timely
\series default
 (which encodes time zones and daylight saving) and 
\series bold
leapseconds
\series default
 which simply records transitions of UTC leap seconds
\begin_inset Note Note
status collapsed

\begin_layout Plain Layout
obsolete:
 (which will inform/replace the sections that discuss 
\begin_inset Quotes eld
\end_inset

UTC to GPS
\begin_inset Quotes erd
\end_inset

 in 
\emph on
fehrCode_125.tex
\emph default
 
\begin_inset Note Note
status open

\begin_layout Plain Layout
1,025,000
\end_layout

\end_inset

and similar documents,
 currently encapsulated in the functions ApplyGps
\begin_inset space ~
\end_inset

() and GPS2UTC
\begin_inset space ~
\end_inset

() )
\end_layout

\end_inset

.
 
\end_layout

\begin_layout Standard
The tz files can be installed on a Linux system.
 Note that the data are not authoritative,
 and somewhat patchy before 1970 —
 the authors have simply done the best they can.
 There is a short README (text) and 
\emph on
zone.tab
\emph default
 describes the various zones by numeric code,
 coordinates,
 TZ (e.g.
 Europe/Andorra;
 Antarctica/McMurdo,
 Antarctica/Rothera,
 etc etc ).
 
\end_layout

\begin_layout Subsection
zo
\emph on
ne.tab
\end_layout

\begin_layout Standard
Our first task is to allocate unique codes for each of the one or more zones that map to a country.
 
\begin_inset Note Note
status collapsed

\begin_layout Plain Layout
[FIX ME:
 this uses 2-char country codes,
 so we create an ancillary 
\series bold
country_codes
\series default
 table that maps 
\series bold
countries 
\series default
to these country codes (cf 
\emph on
iso3166.tab
\emph default
),
 we then need to populate the 
\series bold
regions
\series default
 table from 
\emph on
zones.tab
\emph default
 with unique region codes.
 Although unsatisfactory,
 I've chosen simply to multiply the ISO country code (numeric) by 100 and sequentially add the implied index of each region in the order in which they appear in 
\emph on
zone.tab
\emph default
.
 So `Antarctica',
 code `AQ' has a code of 010 —
 this translates to 1000 + 0 for /Mcmurdo,
 +1 for Rothera etc.
 In doing so we must:
\end_layout

\begin_layout Itemize
not duplicate or overwrite prior similar entries in the SQL table,
 and
\end_layout

\begin_layout Itemize
signal any anomalies,
 for example a missing entry in either the source or target (SQL) table.
\end_layout

\end_inset


\end_layout

\begin_layout Subsection
region files
\end_layout

\begin_layout Standard
These files are named 
\emph on
africa
\emph default
,
 
\emph on
antarctica
\emph default
,
 
\emph on
asia
\emph default
,
 
\emph on
australasia
\emph default
,
 
\emph on
europe
\emph default
,
 
\emph on
northamerica
\emph default
,
 
\emph on
pacificnew
\emph default
,
 and 
\emph on
southamerica
\emph default
.
 The pacificnew file is an oddity (see it).
 The 
\emph on
australasia
\emph default
 file also includes the pacific islands (oceania).
 NB.
 As they stand,
 the rules do not accommodate general rules like e.g.
 +45 minutes for NZ Chatham Islands,
 so there are duplicate rules (See the relevant file).
 More generally,
 apart from Links,
 there are # comments,
 Rules and Zones.
 Consider e.g.
 the file 
\emph on
antarctica
\emph default
.
 
\end_layout

\begin_layout Subsection
Rules
\end_layout

\begin_layout Standard
These have the following properties:
\end_layout

\begin_layout Description
name The second entry after 
\begin_inset Quotes eld
\end_inset

Rule
\begin_inset Quotes erd
\end_inset

,
 names the rule;
\end_layout

\begin_layout Description
from/to The duration of applicability,
 by Gregorian year;
 
\begin_inset Separator latexpar
\end_inset


\end_layout

\begin_deeper
\begin_layout Itemize
if only one year,
 the TO field has value 
\begin_inset Quotes eld
\end_inset


\emph on
only
\emph default

\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Itemize

\emph on
min
\emph default
imum (any variant) specifies minimum year —
 but this variant seems not to be used!
\end_layout

\begin_layout Itemize

\emph on
max
\emph default
imum is the maximum year (presumably,
 
\begin_inset Quotes eld
\end_inset

till the topmost year specified
\begin_inset Quotes erd
\end_inset

)
\end_layout

\end_deeper
\begin_layout Description
type (ignore,
 should be 
\begin_inset Quotes erd
\end_inset

-
\begin_inset Quotes erd
\end_inset

);
 theoretically checks whether the year conforms to a type specification;
\end_layout

\begin_layout Description
IN the relevant month.
 Months can be abbreviated eg Jan,
 Feb,
 \SpecialChar ldots

\end_layout

\begin_layout Description
ON the relevant day of that month.
 This may be a day e.g.
 30 (ie.
 30th),
 or:
\begin_inset Separator latexpar
\end_inset


\end_layout

\begin_deeper
\begin_layout Description
lastSun i.e.
 
\begin_inset Quotes eld
\end_inset

last Sunday of the month
\begin_inset Quotes erd
\end_inset

,
 similarly lastMon etc.
 
\end_layout

\begin_layout Description
Sun>=n e.g.
 
\begin_inset Quotes eld
\end_inset

Sun>=8
\begin_inset Quotes erd
\end_inset

 means the second Sunday of the month 
\end_layout

\begin_layout Description
Sun<=n last Sunday on or before n (but this seems never to be used!)
\end_layout

\begin_layout Description
Mon etc.
 Any weekday is valid.
 Sat Sun Mon Tue Wed Thu Fri
\end_layout

\end_deeper
\begin_layout Description
AT The time on that day,
 according to the 
\emph on
local 
\emph default
clock (eg.
 2 
\emph on
or 
\emph default
2:00 
\emph on
or 
\emph default
15:00 
\emph on
or 
\emph default
1:28:14;
 0 is midnight at the start of the day,
 24 is midnight at the end of the day) ,
 unless there is the suffix:
\begin_inset Note Note
status open

\begin_layout Plain Layout
As already shown in Section
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand ref
reference "sec:How-tz-works"
plural "false"
caps "false"
noprefix "false"
nolink "false"

\end_inset


\end_layout

\end_inset


\begin_inset Separator latexpar
\end_inset


\end_layout

\begin_deeper
\begin_layout Description
s local standard time (wall clock time without the DST!)
\end_layout

\begin_layout Description
g All of the following {g u z} mean UTC / GMT / nautical time zone Z (the same)
\end_layout

\begin_layout Description
u
\end_layout

\begin_layout Description
z
\end_layout

\begin_layout Description
w The wall clock time,
 the same as leaving out the suffix
\end_layout

\end_deeper
\begin_layout Description
save The wall clock offset with the rule in effect (0 for standard time ie no delta;
 otherwise the daylight saving value,
 usually 1:00).
 
\begin_inset Note Note
status open

\begin_layout Plain Layout
This does not mean 
\begin_inset Quotes eld
\end_inset

transition to a wall clock offset of x
\begin_inset Quotes erd
\end_inset

,
 it means 
\begin_inset Quotes eld
\end_inset

the wall clock offset 
\emph on
should be
\emph default
 +x
\begin_inset Quotes erd
\end_inset

.
 [???,
 EXPLORE]
\end_layout

\end_inset


\end_layout

\begin_layout Description
letter/s This field can take on various values,
 to specify how the time zone's name changes,
 e.g.
 CST vs CDT.
 These letters are `aesthetic' in that they specify names but don't condition how the data are translated into the 
\series bold
timely
\series default
 table.
\end_layout

\begin_deeper
\begin_layout Description
- n/a
\end_layout

\begin_layout Description
D
\end_layout

\begin_layout Description
S
\end_layout

\begin_layout Description
W War time
\end_layout

\begin_layout Description
P Peace time !
\end_layout

\end_deeper
\begin_layout Standard
The rules have sequential entries.
 As an example:
\begin_inset VSpace bigskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset space \hspace{}
\length -1cm
\end_inset


\begin_inset Tabular
<lyxtabular version="3" rows="10" columns="10">
<features tabularvalignment="middle">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
# Rule
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
NAME
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
FROM
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
TO
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
TYPE
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
IN
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
ON
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
AT
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
SAVE
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
LETTER/S
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
Rule
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
ArgAQ
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
1964
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
1966
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
-
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
Mar
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
1
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
0:00
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
0
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
-
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
Rule
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
ArgAQ
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
1964
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
1966
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
-
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
Oct
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
15
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
0:00
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
1:00
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
S
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
Rule
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
ArgAQ
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
1967
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
only
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
-
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
Apr
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
2
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
0:00
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
0
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
-
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
Rule
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
ArgAQ
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
1967
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
1968
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
-
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
Oct
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
Sun>=1
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
0:00
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
1:00
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
S
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
Rule
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
ArgAQ
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
1968
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
1969
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
-
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
Apr
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
Sun>=1
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
0:00
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
0
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
-
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
Rule
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
ArgAQ
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
1974
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
only
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
-
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
Jan
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
23
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
0:00
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
1:00
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
S
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
Rule
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
ArgAQ
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
1974
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
only
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
-
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
May
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
1
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
0:00
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
0
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
-
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
Rule
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
ChileAQ
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
1972
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
1986
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
-
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
Mar
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
Sun>=9
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
3:00u
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
0
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
-
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
Rule
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
ChileAQ
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
1974
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
1987
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
-
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
Oct
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
Sun>=9
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
4:00u
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
1:00
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
S
\end_layout

\end_inset
</cell>
</row>
</lyxtabular>

\end_inset


\end_layout

\begin_layout Standard
\begin_inset VSpace bigskip
\end_inset


\end_layout

\begin_layout Subsection
Zone data
\end_layout

\begin_layout Standard
The files contain lines with:
\end_layout

\begin_layout Description
Zone A key-word e.g.
 Australia/Adelaide.
 The following lines also apply to the same Zone until a new entry is encoutered.
 
\end_layout

\begin_layout Description
NAME the name of the zone
\end_layout

\begin_layout Description
GMTOFF the standard GMT offset (from GMT/UTC),
 can be negative.
 e.g.
 -5:50:36 or -6:00
\end_layout

\begin_layout Description
RULES The relevant rule (as above),
 a positive time offset like 
\begin_inset Quotes eld
\end_inset

1:00
\begin_inset Quotes erd
\end_inset

 (We 
\emph on
have 
\emph default
set our clocks ahead),
 or a 
\begin_inset Quotes eld
\end_inset

-
\begin_inset Quotes erd
\end_inset

 (no change).
\end_layout

\begin_layout Description
FORMAT the abbreviated name,
 which may contain 
\begin_inset Quotes eld
\end_inset

%s
\begin_inset Quotes erd
\end_inset

 to permit substitution of the LETTER/S from above.
 There are actually 4 possible forms:
\begin_inset Separator latexpar
\end_inset


\end_layout

\begin_deeper
\begin_layout Description
zzz signals 
\begin_inset Quotes eld
\end_inset

null
\begin_inset Quotes erd
\end_inset

;
\end_layout

\begin_layout Description
LMT or whatever,
 an alphabetic string that is 
\emph on
not 
\begin_inset Quotes eld
\end_inset

zzz
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Description
XXX/YYY a pair of strings,
 the first for standard time,
 the second for the DST abbreviation
\end_layout

\begin_layout Description
X%sY where 
\begin_inset Quotes eld
\end_inset

%s
\begin_inset Quotes erd
\end_inset

 will be replaced by the relevant text from the rule's LETTER column!
\end_layout

\end_deeper
\begin_layout Description
UNTIL The specified state is in effect 
\emph on
until 
\emph default
the 
\begin_inset Quotes eld
\end_inset

UNTIL
\begin_inset Quotes erd
\end_inset

 entry,
 eg.
 until 1883 Nov 18 12:09:24 .
 After this,
 the state of the 
\emph on
next
\emph default
 line is in force.
 This is made more difficult as if we're setting the clocks back,
 there are two possible times —
 here the first occurrence rules.
 If there is no UNTIL entry,
 this means 
\begin_inset Quotes eld
\end_inset

continue till the present
\begin_inset Quotes erd
\end_inset

 (and potentially,
 beyond).
 
\end_layout

\begin_layout Standard
The Zone data look like this:
\end_layout

\begin_layout Standard
\begin_inset VSpace bigskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset space \hspace{}
\length -1cm
\end_inset


\begin_inset Tabular
<lyxtabular version="3" rows="19" columns="5">
<features tabularvalignment="middle">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
# Zone (NAME)
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
GMTOFF
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
RULES
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
FORMAT
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
[UNTIL]
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
Zone Antarctica/Casey
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
0
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
-
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
zzz
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
1969
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
8:00
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
-
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
WST
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
2009 Oct 18 2:00
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
# W (Aus) Standard Time
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
11:00
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
-
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
CAST
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
2010 Mar 5 2:00
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
# Casey Time
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
8:00
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
-
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
WST
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
2011 Oct 28 2:00
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
11:00
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
-
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
CAST
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
2012 Feb 21 17:00u
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
8:00
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
-
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
WST
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
Zone Antarctica/Davis
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
0
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
-
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
zzz
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
1957 Jan 13
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
7:00
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
-
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
DAVT
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
1964 Nov # Davis Time
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
0
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
-
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
zzz
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
1969 Feb
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
7:00
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
-
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
DAVT
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
2009 Oct 18 2:00
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
5:00
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
-
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
DAVT
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
2010 Mar 10 20:00u
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
\SpecialChar ldots

\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
Zone Antarctica/Palmer
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
0
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
-
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
zzz
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
1965
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
-4:00
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
ArgAQ
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
AR%sT
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
1969 Oct 5
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
-3:00
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
ArgAQ
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
AR%sT
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
1982 May
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
-4:00
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
ChileAQ
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size small
CL%sT
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
</row>
</lyxtabular>

\end_inset


\end_layout

\begin_layout Standard
\begin_inset VSpace bigskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
Some lack a rule.
 There are other rules e.g.
 the 
\begin_inset Quotes eld
\end_inset

Troll
\begin_inset Quotes erd
\end_inset

 rule.
\end_layout

\begin_layout Plain Layout
In some cases [UNTIL] specifies something like `lastFri'.
\end_layout

\begin_layout Plain Layout
On importing these data,
 please note that the Zone names will not have tab characters to their right if they are of sufficient length.
 Some lines have tabs and then just a comment character and should be ignored.
 Dates are YYYY then Month as Jan–Dec,
 and then day,
 and may lack a following time.
\end_layout

\begin_layout Plain Layout
In interpreting the above data:
\end_layout

\begin_layout Itemize
We must signal gaps in the rules (where no other rule applies)
\end_layout

\begin_layout Itemize
We must signal inconsistencies between rule data and `UNTIL' data (if such exist)
\end_layout

\end_inset


\end_layout

\begin_layout Subsubsection
Notes
\end_layout

\begin_layout Standard
From the horse's mouth:
\end_layout

\begin_layout Itemize
For areas with more than two types of local time,
 you may need to use local standard time in the AT field of the earliest transition time's rule 
\series bold
\emph on
to ensure that the earliest transition time
\series default
\emph default
 recorded in the compiled file is correct;
 
\end_layout

\begin_layout Itemize
If,
 for a particular zone,
 a clock advance caused by the start of daylight saving coincides with and is equal to a clock retreat caused by a change in UT offset,
 zic produces a single transition to daylight saving at the new UT offset (without any change in wall clock time).
 To get separate transitions use multiple zone continuation lines specifying transition instants using universal time.
\end_layout

\begin_layout Subsubsection
Link lines
\end_layout

\begin_layout Standard
This starts with 
\begin_inset Quotes eld
\end_inset

Link
\begin_inset Quotes erd
\end_inset

 and then has the LINK-FROM and LINK-TO entries.
 The LINK-FROM entry must be a NAME of a Zone;
 the LINK-TO entry is simply an alternate name (alias) for that zone.
 
\begin_inset Note Note
status open

\begin_layout Plain Layout
[EXPLORE THIS IN DETAIL:
 fix me!]
\end_layout

\end_inset


\end_layout

\begin_layout Subsection
others
\end_layout

\begin_layout Standard
The 
\emph on
leapseconds
\emph default
 file simply records the year,
 month and day of the relevant leap second (all have been +ve so far,
 but we must accommodate a possible -ve);
 an alternative source (in a different format) is 
\emph on
leap-seconds.list
\emph default
.
 There are some specialised files,
 including 
\emph on
backward
\emph default
,
 which gives older time zone names;
 and 
\emph on
etcetera
\emph default
,
 which contains codes for odd cases like ships at sea.
 We do not currently accommodate these.
 
\end_layout

\begin_layout Section
\begin_inset Argument 1
status open

\begin_layout Plain Layout
Tz
\end_layout

\end_inset

Perl tz extraction
\begin_inset CommandInset label
LatexCommand label
name "sec:Perl-tz-extraction-ReadZones"

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Note Note
status collapsed

\begin_layout Plain Layout
[Initially,
 render this as a separate file,
 tz_extract.pl;
 later incorporate into import_safersleep.pl;
 still later make a library component]
\end_layout

\end_inset


\end_layout

\begin_layout Subsection
\begin_inset Argument 1
status open

\begin_layout Plain Layout
Perl
\end_layout

\end_inset

Perl overview
\end_layout

\begin_layout Standard
Here we convert tz files to table entries.
 The basic ideas:
\end_layout

\begin_layout Enumerate
Read each data file from {
\emph on
africa
\emph default
,
 
\emph on
antarctica
\emph default
,
 
\emph on
asia
\emph default
,
 
\emph on
australasia
\emph default
,
 
\emph on
europe
\emph default
,
 
\emph on
northamerica
\emph default
,
 
\emph on
southamerica
\emph default
}.
 Ignore all comments,
 then parse each file,
 line-by-line.
 
\end_layout

\begin_layout Enumerate
Place rules in an associative array,
 allowing access to rules by name (primarily) and then secondarily by 
\begin_inset Quotes eld
\end_inset

from/to
\begin_inset Quotes erd
\end_inset

 entry.
 Practically,
 this means an associative array for the rule name,
 and a sub-array (sequential) for all of the 
\begin_inset Quotes eld
\end_inset

sub-rules
\begin_inset Quotes erd
\end_inset

.
 
\end_layout

\begin_layout Enumerate
Work through each Zone entry,
 parsing each line as a 
\begin_inset Quotes eld
\end_inset

secondary rule
\begin_inset Quotes erd
\end_inset

;
\end_layout

\begin_layout Enumerate
Resolve
\begin_inset space ~
\end_inset

Link entries;
\end_layout

\begin_layout Enumerate
For each Zone,
 from 1900 (or earlier) to the current time,
 establish a unique line for each year,
 applying all rules,
 and enter this line in the 
\series bold
daytime
\series default
 table.
 
\begin_inset Separator latexpar
\end_inset


\end_layout

\begin_deeper
\begin_layout Enumerate
If the line already exists,
 check it and report all differences.
 Have an overwrite/warn rule.
 
\end_layout

\end_deeper
\begin_layout Standard
\begin_inset Separator plain
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Subsubsection
Anomalies [explore]
\end_layout

\begin_layout Itemize
America/Montreal is missing from 
\emph on
zone.tab
\emph default
 and will need to be added or an error will occur,
 as this zone is still present in the 
\emph on
northamerica
\emph default
 file!
\begin_inset Foot
status open

\begin_layout Plain Layout
See 
\begin_inset CommandInset href
LatexCommand href
name "https://github.com/tzinfo/tzinfo-data/issues/2"
target "https://github.com/tzinfo/tzinfo-data/issues/2"
literal "false"

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Itemize
times like 24:00 or greater;
\end_layout

\begin_layout Itemize
rules extending over months
\end_layout

\begin_layout Itemize
bizarre stuff like Iranian rules (can't be predicted?)
\end_layout

\begin_layout Itemize
strange time zone abbreviations 
\begin_inset Note Note
status open

\begin_layout Plain Layout
(although we won't dwell on zone abbrevs)
\end_layout

\end_inset


\end_layout

\begin_layout Itemize
Rule lines defined but not used ?
\end_layout

\begin_layout Itemize
Check out Crimea
\end_layout

\end_inset


\end_layout

\begin_layout Subsection
Establish zones
\begin_inset CommandInset label
LatexCommand label
name "subsec:Establish-zones-ReadZone-tz"

\end_inset


\end_layout

\begin_layout Standard
The file 
\emph on
zone.tab 
\emph default
contains a list of all TZ zones,
 mapped to both a country code and a set of coordinates.
 The format is:
\end_layout

\begin_layout Standard
\begin_inset VSpace bigskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset space \hspace{}
\length -1cm
\end_inset


\begin_inset Tabular
<lyxtabular version="3" rows="10" columns="4">
<features tabularvalignment="middle">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\uuline off
\uwave off
\noun off
\color none
#code
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\uuline off
\uwave off
\noun off
\color none
coordinates
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\uuline off
\uwave off
\noun off
\color none
TZ
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
comments
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\uuline off
\uwave off
\noun off
\color none
AD
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\uuline off
\uwave off
\noun off
\color none
+4230+00131
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\uuline off
\uwave off
\noun off
\color none
Europe/Andorra
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\uuline off
\uwave off
\noun off
\color none
AE
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\uuline off
\uwave off
\noun off
\color none
+2518+05518
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\uuline off
\uwave off
\noun off
\color none
Asia/Dubai
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\uuline off
\uwave off
\noun off
\color none
AF
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\uuline off
\uwave off
\noun off
\color none
+3431+06912
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\uuline off
\uwave off
\noun off
\color none
Asia/Kabul
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\uuline off
\uwave off
\noun off
\color none
AG
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\uuline off
\uwave off
\noun off
\color none
+1703-06148
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\uuline off
\uwave off
\noun off
\color none
America/Antigua
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\uuline off
\uwave off
\noun off
\color none
AI
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\uuline off
\uwave off
\noun off
\color none
+1812-06304
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\uuline off
\uwave off
\noun off
\color none
America/Anguilla
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\uuline off
\uwave off
\noun off
\color none
AL
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\uuline off
\uwave off
\noun off
\color none
+4120+01950
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\uuline off
\uwave off
\noun off
\color none
Europe/Tirane
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\uuline off
\uwave off
\noun off
\color none
AM
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\uuline off
\uwave off
\noun off
\color none
+4011+04430
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\uuline off
\uwave off
\noun off
\color none
Asia/Yerevan
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\uuline off
\uwave off
\noun off
\color none
AO
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\uuline off
\uwave off
\noun off
\color none
-0848+01314
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\uuline off
\uwave off
\noun off
\color none
Africa/Luanda
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\uuline off
\uwave off
\noun off
\color none
AQ
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\uuline off
\uwave off
\noun off
\color none
-7750+16636
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\uuline off
\uwave off
\noun off
\color none
Antarctica/McMurdo
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\uuline off
\uwave off
\noun off
\color none
McMurdo,
 S Pole,
 Scott (NZ time)
\end_layout

\end_inset
</cell>
</row>
</lyxtabular>

\end_inset


\end_layout

\begin_layout Standard
\begin_inset VSpace bigskip
\end_inset


\end_layout

\begin_layout Standard
The coordinates have a sign followed by 4–7 characters:
\end_layout

\begin_layout Description
+/- north/south (first) then east/west.
 
\end_layout

\begin_layout Description
4 DDMM
\end_layout

\begin_layout Description
5 DDDMM
\end_layout

\begin_layout Description
6 DDMMSS
\end_layout

\begin_layout Description
7 DDDMMSS
\end_layout

\begin_layout Standard
We enter each zone as follows:
\end_layout

\begin_layout Enumerate
Read a line,
 and determine the country code from the two-letter code in the first column;
\end_layout

\begin_layout Enumerate
Read the north latitude and east longitude co-ordinates from the second column,
 and convert to degrees,
 minutes and seconds;
 then add up the fractions to get a decimal degree reading;
 then divide by 9,
 multiply by 100187903 and convert to an integer for co-ordinate storage (This all to encode offset as an integer in 
\series bold
\emph on
f
\emph default
ehr
\series default
 internal value);
 
\end_layout

\begin_layout Enumerate
Unless it already exists,
 create a new 
\series bold
PLACES
\series default
 entry,
 named according to the third column.
 
\end_layout

\begin_layout Standard
\begin_inset Separator plain
\end_inset


\end_layout

\begin_layout Standard
If 
\family typewriter
$zonecode
\family default
 is zero,
 then we read and re-install the lot;
 if a zone is supplied,
 then we currently limit our diagnostics to this zone,
 and don't write [explore].
 On leaving ReadZones
\begin_inset space ~
\end_inset

(),
 we return '' (an empty string) on success,
 a string on failure.
 
\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
[ we MUST check and see:
 if a given zone has NO entries,
 then inactivate it !!]
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

sub ReadZones # 
\end_layout

\begin_layout Plain Layout

{ my($zonecode,
 $zonedesc) = @_;
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  my($handDB) = $smalltime_h;
  
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

 my($cUPDATE) = 0;
 # No.
 of rows updated
\end_layout

\begin_layout Plain Layout

  my($cINSERT) = 0;
 # and inserts.
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  tz_cutoff_inactivate_all();
 
\end_layout

\begin_layout Plain Layout

  tz_rules_inactivate_all();
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  my($SingleZone) = ($zonecode != 0);
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  my($zonefile) = "zone.tab";
\end_layout

\begin_layout Plain Layout

  my($hzone);
 
\end_layout

\begin_layout Plain Layout

  open ($hzone,
 "$TZDIR/$zonefile") 
\end_layout

\begin_layout Plain Layout

     or die "
\backslash
n***ERROR*** Zone file '$TZDIR/$zonefile' not found,
 $!
\backslash
n";
\end_layout

\begin_layout Plain Layout

  my(@ZDAT) = <$hzone>;
\end_layout

\begin_layout Plain Layout

  close($hzone);
\end_layout

\begin_layout Plain Layout

  my($zl);
\end_layout

\begin_layout Plain Layout

for $zl (@ZDAT)
\end_layout

\begin_layout Plain Layout

  { chomp($zl);
 
\end_layout

\begin_layout Plain Layout

  if($zl =~ /^
\backslash
s*#/ )
\end_layout

\begin_layout Plain Layout

    { # print ' ';
       # skip comment line
\end_layout

\begin_layout Plain Layout

    } else
\end_layout

\begin_layout Plain Layout

    { &SetZone($zl,
 $zonedesc);
 
\end_layout

\begin_layout Plain Layout

    };
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

# ensure 'UTC' exists:
\end_layout

\begin_layout Plain Layout

  my($hack) = 'UT	+000000-000000	UTC/UTC	UTC';
\end_layout

\begin_layout Plain Layout

  &SetZone($hack,
 $zonedesc);
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
\begin_inset ERT
status open

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

#  # HACK to add Montreal,
 still appears elsewhere in TZ database:
\end_layout

\begin_layout Plain Layout

#  my($hack) = "CA	+453031-733314	America/Montreal	Eastern Time";
\end_layout

\begin_layout Plain Layout

#  &SetZone($hack,
 $zonedesc);
\end_layout

\begin_layout Plain Layout

  # end HACK
\end_layout

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
SetZone
\begin_inset space ~
\end_inset

() calls SaveZone
\begin_inset space ~
\end_inset

(),
 which stores the zone identity in 
\family typewriter
%ZONECODES
\family default
;
 now we use this to check whether there are widowed zones in the database—
active zone entries with no representation in this version of tz.
 We identify an active zone as a 
\series bold
PLACES
\series default
 entry with a parent (p_amended) value that refers to a country;
 all countries have place values in the range of 2–
\family typewriter
$TOPCOUNTRY
\family default
 (We here exclude the artefact UTC,
 which has a value of 1).
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

if(!
 $SingleZone)
\end_layout

\begin_layout Plain Layout

  { %REZONE = reverse %ZONECODES;
 # reverse the hash,
 NB.
 Global!
 
\end_layout

\begin_layout Plain Layout

    my($zq) = 
\begin_inset Quotes eld
\end_inset

SELECT place FROM PLACES 
\begin_inset Quotes eld
\end_inset


\end_layout

\begin_layout Plain Layout

            .
 
\begin_inset Quotes eld
\end_inset

WHERE p_amended between 2 and $TOPCOUNTRY AND reason > -1 ";
\end_layout

\begin_layout Plain Layout

    my(@OLDPLACES) = Timely::SQLManySQL($handDB,
 $zq,
 'get existing,
 active places');
 
\end_layout

\begin_layout Plain Layout

    print 
\begin_inset Quotes eld
\end_inset

There are 
\begin_inset Quotes eld
\end_inset

 .
 (scalar @OLDPLACES) .
 
\begin_inset Quotes eld
\end_inset

 old places
\backslash
n
\begin_inset Quotes erd
\end_inset

;
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

    my($pl);
 # NB.
 this is an array reference
\end_layout

\begin_layout Plain Layout

  for $pl (@OLDPLACES) 
\end_layout

\begin_layout Plain Layout

    { my($ky) = @$pl[0];
 
\end_layout

\begin_layout Plain Layout

      # print 
\begin_inset Quotes eld
\end_inset

[$ky]
\begin_inset Quotes erd
\end_inset

;
 
\end_layout

\begin_layout Plain Layout

    if(!
 exists $REZONE{$ky}) # inactive
\end_layout

\begin_layout Plain Layout

      { Timely::Warn(1,
 
\begin_inset Quotes eld
\end_inset

Retiring unused zone,
 code $ky
\backslash
n
\begin_inset Quotes erd
\end_inset

);
 
\end_layout

\begin_layout Plain Layout

        my($kq) = 
\begin_inset Quotes eld
\end_inset

UPDATE PLACES SET reason = -2 WHERE place = $ky
\begin_inset Quotes erd
\end_inset

;
 
\end_layout

\begin_layout Plain Layout

      if(Timely::DoSQL($handDB,
 $kq,
 
\begin_inset Quotes eld
\end_inset

retiring $ky
\begin_inset Quotes erd
\end_inset

) < 0)
\end_layout

\begin_layout Plain Layout

        { &Aagh(
\begin_inset Quotes eld
\end_inset

Failed to retire zone code $pl
\begin_inset Quotes erd
\end_inset

,
 __LINE__,
 0);
 
\end_layout

\begin_layout Plain Layout

        };
   # [more fancy ODBC bound statement would work better,
 btw] 
\end_layout

\begin_layout Plain Layout

      };
 
\end_layout

\begin_layout Plain Layout

    };
\end_layout

\begin_layout Plain Layout

  };
 
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Subsection
Establish leap seconds
\end_layout

\begin_layout Standard
The TZ database contains a current list of all leap seconds,
 so we parse this using the routine from Section
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:Parse-tz-leap"
nolink "false"

\end_inset

.
\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
[Ultimately must also check against database and update this]
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

my($leapfile) = "$TZDIR/leapseconds";
\end_layout

\begin_layout Plain Layout

  print("
\backslash
n Reading leap seconds from '$leapfile'");
 
\end_layout

\begin_layout Plain Layout

  my($hleap);
 
\end_layout

\begin_layout Plain Layout

  open ($hleap,
 $leapfile) or die "
\backslash
n***ERROR*** Could not find $leapfile,
 $!
\backslash
n";
\end_layout

\begin_layout Plain Layout

  my @LS = <$hleap>;
\end_layout

\begin_layout Plain Layout

  close $hleap;
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  &ReadLeapSeconds(@LS);
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Subsection
Read data files
\end_layout

\begin_layout Standard
We require the directory $TZDIR 
\begin_inset Note Note
status collapsed

\begin_layout Plain Layout
(defined in Section
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:initial-code-for-TZ"
nolink "false"

\end_inset

),
\end_layout

\end_inset

 containing the specified files.
 Most important are the Rule and Zone lines within these files.
 ParseRule
\begin_inset space ~
\end_inset

(
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:Parse-a-TZ-rule"
nolink "false"

\end_inset

) simply adds a line to the relevant rule (establishing it in the associative array 
\family typewriter
%RULES
\family default
 if it doesn't exist);
 The zone routines StartZone
\begin_inset space ~
\end_inset

(),
 MoreZone
\begin_inset space ~
\end_inset

() and EndZone
\begin_inset space ~
\end_inset

() progressively add more zone information.
 Each zone row may reference a rule with potentially many component lines.
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

  my($ZN) = '';
       # name of current zone
\end_layout

\begin_layout Plain Layout

  my($INZONE) = 0;
    # are we in a zone?
 [clumsy] 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  my @FILES = ('africa',
 'antarctica',
 'asia',
 'australasia',
 'europe',
 
\end_layout

\begin_layout Plain Layout

               'northamerica',
 'southamerica');
\end_layout

\begin_layout Plain Layout

      # at present ignore weird :
 factory,
 'backward',
 'backzone',
 'etcetera'.
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

foreach my $filename (@FILES)
\end_layout

\begin_layout Plain Layout

  { print "
\backslash
n
\backslash
n**PARSING MYZONE FILE $filename**";
\end_layout

\begin_layout Plain Layout

    my $path = "$TZDIR/$filename";
\end_layout

\begin_layout Plain Layout

    open(my $fh,
 '<',
 $path) 
\end_layout

\begin_layout Plain Layout

      or die "
\backslash
nCould not open '$path' for reading:
 $!";
\end_layout

\begin_layout Plain Layout

    my(@DAT) = <$fh>;
\end_layout

\begin_layout Plain Layout

    close($fh);
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

    my($ln);
\end_layout

\begin_layout Plain Layout

  for $ln (@DAT)
\end_layout

\begin_layout Plain Layout

    { 
\end_layout

\begin_layout Plain Layout

    if( $ln =~ /^(.*?)
\backslash
#/ )
\end_layout

\begin_layout Plain Layout

      { $ln = $1;
         # remove comment
\end_layout

\begin_layout Plain Layout

      };
\end_layout

\begin_layout Plain Layout

    if($ln =~ /^
\backslash
s*$/ )   # empty line
\end_layout

\begin_layout Plain Layout

      { # Timely::XPrint(0,
 ' ');
\end_layout

\begin_layout Plain Layout

      }
\end_layout

\begin_layout Plain Layout

    elsif($ln =~ /^Link/ )
\end_layout

\begin_layout Plain Layout

      { &MakeLink($ln);
\end_layout

\begin_layout Plain Layout

      }
\end_layout

\begin_layout Plain Layout

    elsif($ln =~ /^Rule/ )
\end_layout

\begin_layout Plain Layout

      { ## Timely::XPrint(0,
 'R');
\end_layout

\begin_layout Plain Layout

      if($INZONE)
\end_layout

\begin_layout Plain Layout

        { &EndZone($ZN);
\end_layout

\begin_layout Plain Layout

          $INZONE = 0;
   # terminate
\end_layout

\begin_layout Plain Layout

        };
\end_layout

\begin_layout Plain Layout

        &ParseRule($ln);
\end_layout

\begin_layout Plain Layout

      }
\end_layout

\begin_layout Plain Layout

    elsif($ln =~ /^Zone/ )
\end_layout

\begin_layout Plain Layout

      { ## Timely::XPrint(0,
 'Z');
\end_layout

\begin_layout Plain Layout

      if($INZONE)
\end_layout

\begin_layout Plain Layout

        { &EndZone($ZN);
\end_layout

\begin_layout Plain Layout

        };
\end_layout

\begin_layout Plain Layout

        $INZONE = 1;
\end_layout

\begin_layout Plain Layout

        $ZN = &StartZone($ln,
 $zonedesc);
 
\end_layout

\begin_layout Plain Layout

      }
\end_layout

\begin_layout Plain Layout

    elsif($INZONE)   # should be Zone continuation
\end_layout

\begin_layout Plain Layout

      { &MoreZone($ln,
 $ZN,
 $SingleZone);
 
\end_layout

\begin_layout Plain Layout

      } else 
\end_layout

\begin_layout Plain Layout

      { # Timely::XPrint(0,
  "
\backslash
n?=<$ln>
\backslash
n" );
\end_layout

\begin_layout Plain Layout

      };
\end_layout

\begin_layout Plain Layout

    };
  # end of data for this file
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  if($INZONE)
\end_layout

\begin_layout Plain Layout

    { &EndZone($ZN);
 
\end_layout

\begin_layout Plain Layout

    };
\end_layout

\begin_layout Plain Layout

    $INZONE = 0;
   # as new file will follow.
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
Formerly:
\end_layout

\begin_layout Plain Layout
\begin_inset ERT
status open

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  my($fl);
 
\end_layout

\begin_layout Plain Layout

for $fl (@FILES)
\end_layout

\begin_layout Plain Layout

  { print "
\backslash
n
\backslash
n**PARSING MYZONE FILE $fl**";
\end_layout

\begin_layout Plain Layout

    open (FL,
 "$TZDIR/$fl") or die "
\backslash
nFile $fl ($TZDIR) not found,
 $!
\backslash
n";
\end_layout

\begin_layout Plain Layout

    my(@DAT) = <FL>;
\end_layout

\begin_layout Plain Layout

    close(FL);
 
\end_layout

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Subsection
Create database zone rows
\begin_inset CommandInset label
LatexCommand label
name "subsec:Create-database-rows-tz"

\end_inset


\end_layout

\begin_layout Standard
Start with debugging.
 Obtain the zone array or fail;
 then iterate through each of the zone entries.
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

  # Timely::XPrint(10,
 "
\backslash
n *** CREATING DATABASE ZONE ROWS *** ");
\end_layout

\begin_layout Plain Layout

  print 
\begin_inset Quotes eld
\end_inset


\backslash
n Checking database zone rows:
 n=
\begin_inset Quotes eld
\end_inset

 .
 (scalar keys %ZONES);
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

NAMES:
 foreach my $nm ( sort keys %ZONES )
\end_layout

\begin_layout Plain Layout

  { ## start ZONE loop
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

    my($NM) = $nm;
\end_layout

\begin_layout Plain Layout

    my($region) = $ZONECODES{$NM};
  # clumsy but better than hack to %ZONES
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  if($SingleZone)  # not 'the lot'
\end_layout

\begin_layout Plain Layout

    { 
\end_layout

\begin_layout Plain Layout

    if($nm ne $zonedesc)
\end_layout

\begin_layout Plain Layout

      { next NAMES;
\end_layout

\begin_layout Plain Layout

      };
 
\end_layout

\begin_layout Plain Layout

      print 
\begin_inset Quotes eld
\end_inset


\backslash
nParsing:
 $nm ($region) $LOWYEAR ..
 $TOPYEAR
\backslash
n
\begin_inset Quotes erd
\end_inset

;
 
\end_layout

\begin_layout Plain Layout

    };
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  if( $NM eq 'UTC/UTC')         # [explore this special case] 
\end_layout

\begin_layout Plain Layout

    { next NAMES;
\end_layout

\begin_layout Plain Layout

    };
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

    ## Timely::XPrint(10,
  "
\backslash
n Zone=$nm" );
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
Of note is that the following code:
\end_layout

\begin_layout Quote

\family typewriter
SELECT north FROM PLACES ...
\end_layout

\begin_layout Standard
\SpecialChar ldots
 results in failure of the ODBC connection to provide a large negative integer to Perl (Win32::ODBC seems defective),
 so we cast the offending item to text (char and not varchar,
 as the latter cast isn't supported by MySQL).
 The addition of 
\family typewriter
AND reason > -1
\family default
 
\begin_inset Note Note
status open

\begin_layout Plain Layout
2020-12-05
\end_layout

\end_inset

allows suppression of obsolete places.
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

    my($qz) = "SELECT cast(north as char(13)) FROM PLACES 
\begin_inset Quotes eld
\end_inset


\end_layout

\begin_layout Plain Layout

              .
 
\begin_inset Quotes eld
\end_inset

where place = $region AND reason > -1";
\end_layout

\begin_layout Plain Layout

    my($north) = Timely::GetSQL($handDB,
 $qz,
 'get north/south for zone');
 
\end_layout

\begin_layout Plain Layout

  if(!
 defined $north)
\end_layout

\begin_layout Plain Layout

    { Timely::XPrint(0,
  "
\backslash
n*ERROR* Bad zone for $nm($region) <$qz>" );
 
\end_layout

\begin_layout Plain Layout

      next NAMES;
 # [check this branch]
\end_layout

\begin_layout Plain Layout

    };
\end_layout

\begin_layout Plain Layout

    my($rA) = $ZONES{$NM};
\end_layout

\begin_layout Plain Layout

  if( ref($rA) ne 'ARRAY' )
\end_layout

\begin_layout Plain Layout

    { 
\end_layout

\begin_layout Plain Layout

    if(!
 defined $LINKS{$NM} )
\end_layout

\begin_layout Plain Layout

       { &TimeWarn( "No zone definition for '$NM' :
 " .
 ref($rA) ,1,
 $NM,
 0);
\end_layout

\begin_layout Plain Layout

         # retire this zone in fehr:
\end_layout

\begin_layout Plain Layout

         my($qx) = 
\begin_inset Quotes eld
\end_inset

UPDATE PLACES SET reason = -1 WHERE place = $region
\begin_inset Quotes erd
\end_inset

;
 
\end_layout

\begin_layout Plain Layout

       if( Timely::DoSQL($handDB,
 $qx,
 'retire region') < 0)
\end_layout

\begin_layout Plain Layout

         { &Aagh("Failed to suppress region ($qx)",
 __LINE__,
 0 );
 
\end_layout

\begin_layout Plain Layout

         };
 
\end_layout

\begin_layout Plain Layout

         next NAMES;
  # next iteration of foreach loop 
\end_layout

\begin_layout Plain Layout

       };
\end_layout

\begin_layout Plain Layout

      print 
\begin_inset Quotes eld
\end_inset


\backslash
nLink:
 $NM -->
\begin_inset Quotes erd
\end_inset

 .
 $LINKS{$NM};
 
\end_layout

\begin_layout Plain Layout

      $NM = $LINKS{$NM};
\end_layout

\begin_layout Plain Layout

      $rA = $ZONES{$NM};
  # Fails if double indirection or read single *linked* name!
\end_layout

\begin_layout Plain Layout

    if(!
 defined $rA)
\end_layout

\begin_layout Plain Layout

      { return(".
 I couldn't resolve this!
\backslash
nRepeat  v  after saying:
   f $NM 
\backslash
n");
\end_layout

\begin_layout Plain Layout

      };
 
\end_layout

\begin_layout Plain Layout

    };
\end_layout

\begin_layout Plain Layout

    my(@A) = @$rA;
 # array of zone information rows 
\end_layout

\begin_layout Plain Layout

    my($v);
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  foreach $v (@A)
\end_layout

\begin_layout Plain Layout

    { &DebugZone($v,
 $SingleZone);
 
\end_layout

\begin_layout Plain Layout

    };
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
In the above we also accommodate symbolic references to other zones using $LINKS,
 as described in Section
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:Links-tz"
nolink "false"

\end_inset

.
\end_layout

\begin_layout Subsubsection
Span the years
\end_layout

\begin_layout Standard
\begin_inset Note Note
status collapsed

\begin_layout Plain Layout
The start and end years are defined in Section
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:initial-code-for-TZ"
nolink "false"

\end_inset

.
 
\end_layout

\end_inset

We have a rather strange requirement:
\end_layout

\begin_layout Itemize
In the Southern Hemisphere,
 daylight saving time will normally span the bounds of the year,
 so we carry the preceding DST over to the next year in 
\family typewriter
$DSTCARRY
\family default
 
\end_layout

\begin_layout Standard
The important routine here is 
\series bold
ZoneYear
\series default

\begin_inset space ~
\end_inset

(
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:TZ-zone-data-for-one-year"
nolink "false"

\end_inset

) —
 as the name suggests,
 it determines the entire (primary) database row for a given year and zone.
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

  # Calculate each database row over the full range of years,
 and write to database
\end_layout

\begin_layout Plain Layout

    my($year) = $LOWYEAR;
\end_layout

\begin_layout Plain Layout

    my($DSTCARRY) = 0;
\end_layout

\begin_layout Plain Layout

    my($LASTTRAN) = 0;
 # most recent transition
\end_layout

\begin_layout Plain Layout

    my($ZONEBASE) = 0;
 # basis for year start calculation by ZoneYear!
\end_layout

\begin_layout Plain Layout

  while($year <= $TOPYEAR+1)  # take one year above!
\end_layout

\begin_layout Plain Layout

    { ($ZONEBASE,
 $DSTCARRY) 
\end_layout

\begin_layout Plain Layout

         = &ZoneYear($SingleZone,
 $nm,
 $year,
 $ZONEBASE,
 $north,
 $DSTCARRY,
 @A);
\end_layout

\begin_layout Plain Layout

      # NB.
 values in $ZONEBASE,
 $DSTCARRY are in seconds.
 
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
(Write to / update database has now been removed)
\end_layout

\end_inset


\end_layout

\begin_layout Standard
If the time-zone offset changed in the previous year,
 update that year now that we have the new time-zone offset.
 
\end_layout

\begin_layout Standard
In any case,
 bump the year.
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

      $year ++;
  # bump
\end_layout

\begin_layout Plain Layout

    };
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard

\end_layout

\begin_layout Subsubsection
Done!
\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
As a frill,
 count the rows and end.
 
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

  };
  ## end of ZONE loop
\end_layout

\begin_layout Plain Layout

  return('');
 
\end_layout

\begin_layout Plain Layout

}  ## END OF ReadZones ROUTINE.
 
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Subsection
Leap seconds routines
\end_layout

\begin_layout Standard
Utility routines that handle leap seconds.
 
\end_layout

\begin_layout Standard
\begin_inset Note Note
status collapsed

\begin_layout Subsubsection
Load leap-second-adjustment data
\end_layout

\begin_layout Plain Layout
From the 
\series bold
\emph on
f
\emph default
ehr
\series default
 database,
 load leap second data from the 
\series bold
leapseconds 
\series default
table.
 
\end_layout

\begin_layout Plain Layout
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

sub FetchLeapData
\end_layout

\begin_layout Plain Layout

{ 
\end_layout

\begin_layout Plain Layout

  my($handDB) = $smalltime_h;
  
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  my($q) = "SELECT gpstime,
 utctime,
 toffset FROM leapseconds " 
\end_layout

\begin_layout Plain Layout

   .
 "order by leapsecond DESC";
  # topmost is first
\end_layout

\begin_layout Plain Layout

  my(@LEAPS) = Timely::SQLManySQL($handDB,
 $q,
 'get leap data');
\end_layout

\begin_layout Plain Layout

  return(@LEAPS);
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Note Note
status open

\begin_layout Plain Layout
2025-02-17:
 replaced 
\series bold
offset
\series default
 above with 
\series bold
toffset
\series default
 ;
 (reserved word now)
\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout
The caller will (and must) store the returned array in the global 
\family typewriter
@LEAPDATA
\family default
.
\end_layout

\end_inset


\end_layout

\begin_layout Subsubsection
Parse tz leap seconds
\begin_inset CommandInset label
LatexCommand label
name "subsec:Parse-tz-leap"

\end_inset


\end_layout

\begin_layout Standard
Confirm that the values in 
\family typewriter
@LEAPDATA
\family default
 correspond to those in the tz database.
 Submit all of the rows.
 Assumes that 
\family typewriter
@LEAPDATA
\family default
 has been populated.
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

sub ReadLeapSeconds # 
\end_layout

\begin_layout Plain Layout

{ my(@LS) = @_;
\end_layout

\begin_layout Plain Layout

  my($leap);
\end_layout

\begin_layout Plain Layout

  my($BASELEAP) = -9;
  # at baseline GPS is 9s before UTC,
 UTC generally slows
\end_layout

\begin_layout Plain Layout

  my($itop) = scalar @LEAPDATA;
 
\end_layout

\begin_layout Plain Layout

  my($ok) = 1;
\end_layout

\begin_layout Plain Layout

  Timely::Log("
\backslash
n  Debug LEAP DATA length = $itop");
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

for $leap (@LS)
\end_layout

\begin_layout Plain Layout

  { 
\end_layout

\begin_layout Plain Layout

  if($leap =~ /^(.*?)#/)
\end_layout

\begin_layout Plain Layout

    { $leap = $1;
\end_layout

\begin_layout Plain Layout

    };
\end_layout

\begin_layout Plain Layout

  if($leap !~ /^
\backslash
w*$/ ) # if non-empty,
 not just whitespace
\end_layout

\begin_layout Plain Layout

    { 
\end_layout

\begin_layout Plain Layout

    if($leap !~ /Leap
\backslash
s+(
\backslash
d{4})
\backslash
s(
\backslash
w{3})
\backslash
s(
\backslash
d{2})
\backslash
s(
\backslash
d{2}):(
\backslash
d{2}):(
\backslash
d{2})
\backslash
s([-+])
\backslash
sS/)
\end_layout

\begin_layout Plain Layout

                         #YYYY    MMM      DD        hh       mm     ss      +   S
\end_layout

\begin_layout Plain Layout

      { die "
\backslash
n***ERROR*** Unknown leap line:
 <$leap>
\backslash
n";
\end_layout

\begin_layout Plain Layout

        return;
\end_layout

\begin_layout Plain Layout

      };
\end_layout

\begin_layout Plain Layout

      $itop --;
 # move to corresponding data row;
\end_layout

\begin_layout Plain Layout

      my($d) = $LEAPDATA[$itop];
 
\end_layout

\begin_layout Plain Layout

      my(@D) = @$d;
 # dereference
\end_layout

\begin_layout Plain Layout

      my($utc) = $D[1]/1000000.0;
  # seconds
\end_layout

\begin_layout Plain Layout

      my($off) = $D[2];
\end_layout

\begin_layout Plain Layout

      my($YYYY,
 $MMM,
 $DD,
 $hh,
 $mm,
 $ss,
 $updn) = ($1,
 $2,
 $3,
 $4,
 $5,
 $6,
 $7);
\end_layout

\begin_layout Plain Layout

    if($ss != 60)
\end_layout

\begin_layout Plain Layout

      { die "
\backslash
n***ERROR*** Odd leap line:
 $YYYY $MMM $DD $hh $mm *$ss* $updn";
\end_layout

\begin_layout Plain Layout

        return;
\end_layout

\begin_layout Plain Layout

      };
\end_layout

\begin_layout Plain Layout

    if($updn ne '+')
\end_layout

\begin_layout Plain Layout

      { $BASELEAP --;
\end_layout

\begin_layout Plain Layout

        die "
\backslash
n***ERROR*** I can't handle '-' value in leap line";
  # [explore,
 fix]
\end_layout

\begin_layout Plain Layout

        return;
 # need to check handling before use,
 if this ever happens.
 
\end_layout

\begin_layout Plain Layout

      } else
\end_layout

\begin_layout Plain Layout

      { $BASELEAP ++;
 # Applies to times between $bigJ and the next cut.
 
\end_layout

\begin_layout Plain Layout

      };
\end_layout

\begin_layout Plain Layout

    if($BASELEAP != $off)
\end_layout

\begin_layout Plain Layout

      { die "
\backslash
n***ERROR*** mismatched leap seconds:
 $BASELEAP/$off";
\end_layout

\begin_layout Plain Layout

        return;
\end_layout

\begin_layout Plain Layout

      };
\end_layout

\begin_layout Plain Layout

      my($Mon) = &FetchMonth($MMM);
  # e.g.
 Jan->1
\end_layout

\begin_layout Plain Layout

      my($bigJ) = Timely::ToJulian($YYYY,
 $Mon,
 $DD,
 $hh,
 $mm,
 $ss,
 0,
 0,
 0);
 
\end_layout

\begin_layout Plain Layout

               # NOT GpsJulian ;
 and potential 60s value in $ss
\end_layout

\begin_layout Plain Layout

    if( abs($bigJ - $utc) > 0.01 ) # if difference is more than 10 ms:
\end_layout

\begin_layout Plain Layout

      { my($COOKED) = Timely::Greg($utc,
 0,
 0,
 0);
 # utc is in seconds [explore] 
\end_layout

\begin_layout Plain Layout

        Timely::XPrint(0,
 "
\backslash
n*ERROR* bad leap timestamp:
 $bigJ,
 
\begin_inset Quotes eld
\end_inset


\end_layout

\begin_layout Plain Layout

                 .
 
\begin_inset Quotes eld
\end_inset

$utc ($YYYY-$Mon-$DD $hh:$mm:$ss | $COOKED)" );
\end_layout

\begin_layout Plain Layout

        $ok = 0;
\end_layout

\begin_layout Plain Layout

      };
\end_layout

\begin_layout Plain Layout

    };
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

if(!
 $ok)
\end_layout

\begin_layout Plain Layout

  { die "
\backslash
n***ERROR*** Error in leap seconds";
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
In the above we add $delta to the timestamp because we always store GPS times,
 not UTC!
 
\begin_inset Note Note
status collapsed

\begin_layout Plain Layout
[Explore the assumption that the correct value to add is this ???]
\end_layout

\end_inset


\end_layout

\begin_layout Subsubsection
Populate leap data
\end_layout

\begin_layout Standard
Conversely,
 populate the 
\series bold
\emph on
f
\emph default
ehr
\series default
 leapseconds table.
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

sub PopulateLeapSeconds # 
\end_layout

\begin_layout Plain Layout

{ my($TZDIR) = @_;
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  my($handDB) = $smalltime_h;
  # CLUMSY 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  my($leapfile) = "$TZDIR/leapseconds";
\end_layout

\begin_layout Plain Layout

  print("
\backslash
n Populating leap seconds from '$leapfile'");
 
\end_layout

\begin_layout Plain Layout

  my($hleap);
 
\end_layout

\begin_layout Plain Layout

  open ($hleap,
 $leapfile) or die "
\backslash
n***ERROR*** No leap seconds source:
 $leapfile,
 $!
\backslash
n";
\end_layout

\begin_layout Plain Layout

  my @LS = <$hleap>;
\end_layout

\begin_layout Plain Layout

  close($hleap);
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  my($leap);
\end_layout

\begin_layout Plain Layout

  my($BASELEAP) = -9;
  # Baseline GPS time is 9s before UTC,
 UTC generally slows
\end_layout

\begin_layout Plain Layout

  my($leapsecond) = 0;
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

for $leap (@LS)
\end_layout

\begin_layout Plain Layout

  { 
\end_layout

\begin_layout Plain Layout

  if($leap =~ /^(.*?)#/)
\end_layout

\begin_layout Plain Layout

    { $leap = $1;
\end_layout

\begin_layout Plain Layout

    };
\end_layout

\begin_layout Plain Layout

  if($leap !~ /^
\backslash
w*$/ ) # if non-empty,
 not just whitespace
\end_layout

\begin_layout Plain Layout

    { 
\end_layout

\begin_layout Plain Layout

    if($leap !~ /Leap
\backslash
s+(
\backslash
d{4})
\backslash
s(
\backslash
w{3})
\backslash
s(
\backslash
d{2})
\backslash
s(
\backslash
d{2}):(
\backslash
d{2}):(
\backslash
d{2})
\backslash
s([-+])
\backslash
sS/)
\end_layout

\begin_layout Plain Layout

                        #YYYY    MMM      DD        hh       mm     ss      +   S
\end_layout

\begin_layout Plain Layout

      { die "
\backslash
n***ERROR*** Unknown leap line:
 <$leap>
\backslash
n";
\end_layout

\begin_layout Plain Layout

        return;
\end_layout

\begin_layout Plain Layout

      };
\end_layout

\begin_layout Plain Layout

      my($YYYY,
 $MMM,
 $DD,
 $hh,
 $mm,
 $ss,
 $updn) = ($1,
 $2,
 $3,
 $4,
 $5,
 $6,
 $7);
\end_layout

\begin_layout Plain Layout

    if($ss != 60)
\end_layout

\begin_layout Plain Layout

      { die "
\backslash
n***ERROR*** Unusual leap entry:
 $YYYY $MMM $DD $hh $mm *$ss* $updn";
\end_layout

\begin_layout Plain Layout

        return;
\end_layout

\begin_layout Plain Layout

      };
\end_layout

\begin_layout Plain Layout

    if($updn ne '+')
\end_layout

\begin_layout Plain Layout

      { $BASELEAP --;
\end_layout

\begin_layout Plain Layout

      } else
\end_layout

\begin_layout Plain Layout

      { $BASELEAP ++;
 # This applies to times between $bigJ and the next cut.
 
\end_layout

\begin_layout Plain Layout

      };
\end_layout

\begin_layout Plain Layout

      my($Mon) = &FetchMonth($MMM);
  # e.g.
 Jan->1
\end_layout

\begin_layout Plain Layout

      my($bigJ) = Timely::ToJulian($YYYY,
 $Mon,
 $DD,
 $hh,
 $mm,
 $ss,
 0,
 0,
 0);
 # NOT GpsJulian
\end_layout

\begin_layout Plain Layout

               # also take note of the 60s value in $ss.
 This could be 61 !
\end_layout

\begin_layout Plain Layout

      my($gps)= $bigJ+$BASELEAP;
     # to get gps,
 add offset to UTC value
\end_layout

\begin_layout Plain Layout

      my($q) = "INSERT INTO leapseconds (leapsecond,
 gpstime,
 utctime,
 toffset)"
\end_layout

\begin_layout Plain Layout

     .
 " VALUES ($leapsecond,
 $gps*1000000,
 $bigJ*1000000,
 $BASELEAP)";
 
\end_layout

\begin_layout Plain Layout

      # multiply seconds by 10^6 to get stored microseconds.
 
\end_layout

\begin_layout Plain Layout

    if( Timely::DoSQL($handDB,
 $q,
 'insert leapsecond row entry') < 0)
\end_layout

\begin_layout Plain Layout

      { &Aagh("Failed to insert leapsecond row ($q)",
 __LINE__,
 0 );
 
\end_layout

\begin_layout Plain Layout

        return;
\end_layout

\begin_layout Plain Layout

      };
 
\end_layout

\begin_layout Plain Layout

        # [ideally check entry not already present,
 and check for success[explore]]
\end_layout

\begin_layout Plain Layout

      $leapsecond ++;
\end_layout

\begin_layout Plain Layout

    };
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
2025-02-17:
 replaced 
\series bold
offset
\series default
 above with 
\series bold
toffset
\series default
 ;
 (reserved word now)
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
[The above routines share code,
 fix me]
\end_layout

\end_inset


\end_layout

\begin_layout Subsubsection
GpsOffset
\end_layout

\begin_layout Standard
Given a Julian day as seconds,
 return the GPS offset in 
\emph on
seconds
\emph default
.
 This is the number of seconds that GPS time leads UTC for the given time 
\family typewriter
$J
\family default
,
 which is assumed to be a GPS time,
 not a UTC time.
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

sub GpsOffset
\end_layout

\begin_layout Plain Layout

{ my($J);
\end_layout

\begin_layout Plain Layout

    ($J)=@_;
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  my($Ltop) = scalar @LEAPDATA;
 
\end_layout

\begin_layout Plain Layout

  my($i) = 0;
\end_layout

\begin_layout Plain Layout

while($i < $Ltop)
\end_layout

\begin_layout Plain Layout

  { my($d) = $LEAPDATA[$i];
\end_layout

\begin_layout Plain Layout

    my(@D) = @$d;
 # dereference 
\end_layout

\begin_layout Plain Layout

  if( $J >= ($D[0]/1000000.0) )  # note 0 index [check inequality for consistency ?]
\end_layout

\begin_layout Plain Layout

    { return($D[2]);
     # offset in seconds
\end_layout

\begin_layout Plain Layout

    };
\end_layout

\begin_layout Plain Layout

    $i ++;
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

  return(-9);
  # earliest value is a lag.
 
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Subsection
Major zone routines
\end_layout

\begin_layout Standard
These handle zone data encoded in lines of the TZ database,
 outlined at the start of Chapter
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand ref
reference "chap:Time-zones-TZ"
nolink "false"

\end_inset

.
\end_layout

\begin_layout Subsubsection
Set a zone
\end_layout

\begin_layout Standard
SetZone
\begin_inset space ~
\end_inset

() is invoked when we first encounter a zone name within ReadZone
\begin_inset space ~
\end_inset

(
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:Establish-zones-ReadZone-tz"
nolink "false"

\end_inset

).
 Given basic data,
 establish a zone.
 The principal subroutine here is SaveZone
\begin_inset space ~
\end_inset

(
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:Save-zone-details-tz"
nolink "false"

\end_inset

).
 Only later,
 when more specific zone information becomes available do we invoke StartZone
\begin_inset space ~
\end_inset

() etc —
 these routines merely modify the zone information in the associative array of zones,
 
\family typewriter
%ZONES
\family default
.
 
\end_layout

\begin_layout Standard
If a zone description is supplied in 
\family typewriter
$zonedesc
\family default
,
 then we are only interested in that zone,
 and ignore others.
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

sub SetZone # 
\end_layout

\begin_layout Plain Layout

{ my($zl,
 $zonedesc) = @_;
\end_layout

\begin_layout Plain Layout

 
\end_layout

\begin_layout Plain Layout

  my(@ZD) = split /
\backslash
s+/,
 $zl;
\end_layout

\begin_layout Plain Layout

  my($cc) = $ZD[0];
\end_layout

\begin_layout Plain Layout

  my($rawcoords) = $ZD[1];
\end_layout

\begin_layout Plain Layout

  my($zonename) = $ZD[2];
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

if(length $zonedesc > 0)
\end_layout

\begin_layout Plain Layout

  {
\end_layout

\begin_layout Plain Layout

  if($zonedesc ne $zonename) # if single zone and doesn't match:
\end_layout

\begin_layout Plain Layout

    { return('');
 # ignore
\end_layout

\begin_layout Plain Layout

    };
 
\end_layout

\begin_layout Plain Layout

    print 
\begin_inset Quotes eld
\end_inset

 [Setting zone $zonedesc:
 '$zl'] 
\begin_inset Quotes erd
\end_inset

;
 
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  # Timely::Log("
\backslash
nSetting zone:
 <$zl>=<$cc><$rawcoords><$zonename>");
\end_layout

\begin_layout Plain Layout

if(length $cc != 2)
\end_layout

\begin_layout Plain Layout

  { die "
\backslash
n***ERROR*** Bad 2-char country code:
 $cc
\backslash
n";
\end_layout

\begin_layout Plain Layout

    return;
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

if($rawcoords !~ /([+-])(
\backslash
d+)([+-])(
\backslash
d+)/ )
\end_layout

\begin_layout Plain Layout

  { die "
\backslash
n***ERROR*** Bad coordinates for $cc:
 $rawcoords";
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

  my($sN)   = $1;
    # sign
\end_layout

\begin_layout Plain Layout

  my($rawN) = $2;
\end_layout

\begin_layout Plain Layout

  my($sE)   = $3;
\end_layout

\begin_layout Plain Layout

  my($rawE) = $4;
\end_layout

\begin_layout Plain Layout

  my($North) = &NEncode($sN,
 $rawN);
\end_layout

\begin_layout Plain Layout

  my($East) = &NEncode($sE,
 $rawE);
\end_layout

\begin_layout Plain Layout

  my($ZID) = &FetchCountryCode($cc);
\end_layout

\begin_layout Plain Layout

if($ZID < 0)
\end_layout

\begin_layout Plain Layout

  { die "
\backslash
n***ERROR*** Country code not found:
 $cc
\backslash
n";
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

  &SaveZone($zonename,
 $ZID,
 $North,
 $East);
 # $ZID is country
\end_layout

\begin_layout Plain Layout

  return($zonename);
 
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
The returned value is currently unused.
 
\begin_inset Note Note
status open

\begin_layout Plain Layout
[might even be used to replace the clumsy storage of the zone in %ZONECODES]
\end_layout

\end_inset


\end_layout

\begin_layout Subsubsection
Encode degrees to integer
\end_layout

\begin_layout Standard
This conforms to my `standard' geospatial integer encoding in 
\series bold
\emph on
f
\emph default
ehr
\series default

\begin_inset Note Note
status open

\begin_layout Plain Layout
,
 
\begin_inset Quotes eld
\end_inset

accurate to 1
\begin_inset space \thinspace{}
\end_inset

cm or better
\begin_inset Quotes erd
\end_inset


\end_layout

\end_inset

.
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

sub NEncode # 
\end_layout

\begin_layout Plain Layout

{ my($sgn,
 $vlu) = @_;
\end_layout

\begin_layout Plain Layout

  my($vlen) = length $vlu;
\end_layout

\begin_layout Plain Layout

  # Perl 5.24 seems to have issues with $1 $2 $3 in the following ??
 
\end_layout

\begin_layout Plain Layout

  my($deg,
 $min,
 $sec);
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

if($vlen == 4)
\end_layout

\begin_layout Plain Layout

  { $vlu =~ /(
\backslash
d{2})(
\backslash
d{2})(.*)/;
\end_layout

\begin_layout Plain Layout

   # print "(Debug $1:$2:$3)";
 
\end_layout

\begin_layout Plain Layout

    ($deg,$min,$sec) = ($1,$2,$3);
\end_layout

\begin_layout Plain Layout

  }
\end_layout

\begin_layout Plain Layout

elsif($vlen == 5)
\end_layout

\begin_layout Plain Layout

  { $vlu =~ /(
\backslash
d{2})(
\backslash
d{3})(.*)/;
\end_layout

\begin_layout Plain Layout

   # print "(Debug $1:$2:$3)";
 
\end_layout

\begin_layout Plain Layout

    ($deg,$min,$sec) = ($1,$2,$3);
\end_layout

\begin_layout Plain Layout

  }
\end_layout

\begin_layout Plain Layout

elsif($vlen == 6)
\end_layout

\begin_layout Plain Layout

  { $vlu =~ /(
\backslash
d{2})(
\backslash
d{2})(
\backslash
d{2})/;
\end_layout

\begin_layout Plain Layout

   # print "(Debug $1:$2:$3)";
 
\end_layout

\begin_layout Plain Layout

    ($deg,$min,$sec) = ($1,$2,$3);
\end_layout

\begin_layout Plain Layout

  }
\end_layout

\begin_layout Plain Layout

elsif($vlen == 7)
\end_layout

\begin_layout Plain Layout

  { $vlu =~ /(
\backslash
d{3})(
\backslash
d{2})(
\backslash
d{2})/;
\end_layout

\begin_layout Plain Layout

   # print "(Debug $1:$2:$3)";
 
\end_layout

\begin_layout Plain Layout

    ($deg,$min,$sec) = ($1,$2,$3);
\end_layout

\begin_layout Plain Layout

  } else 
\end_layout

\begin_layout Plain Layout

  { die "
\backslash
n***ERROR*** Bad degree code:
 $sgn $vlu";
\end_layout

\begin_layout Plain Layout

           return;
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

 # print "(!!Debug $1:$2:$3!!)";
 
\end_layout

\begin_layout Plain Layout

 # my($deg) = $1;
\end_layout

\begin_layout Plain Layout

 # my($min) = $2;
\end_layout

\begin_layout Plain Layout

 # my($sec) = $3;
\end_layout

\begin_layout Plain Layout

if(length $sec == 0)  # ??
 can it be undefined
\end_layout

\begin_layout Plain Layout

  { $sec = 0;
 
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

   # Timely::XPrint(0,
 "<Encoding '$vlu'($vlen) '$deg:$min:$sec'>");
 
\end_layout

\begin_layout Plain Layout

  my($enc) = 100187903*($deg + $min/60 + $sec/3600)/9;
\end_layout

\begin_layout Plain Layout

if($sgn eq '-')
\end_layout

\begin_layout Plain Layout

  { $enc = -($enc);
                  # use sign,
 ignore '+' value [?
 check]
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

  my($ienc) = sprintf "%.0f",
 $enc;
  # round half to even 
\end_layout

\begin_layout Plain Layout

  return($ienc);
                     # integer value  
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Subsubsection
Fetch country code
\end_layout

\begin_layout Standard
Obtain database code for country,
 given its two-letter country code.
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

sub FetchCountryCode #
\end_layout

\begin_layout Plain Layout

{ my($cc) = @_;
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  my($handDB) = $smalltime_h;
  
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  my($q) = "SELECT country FROM countrycodes WHERE ccode='$cc'";
\end_layout

\begin_layout Plain Layout

  my($DBcode) = Timely::GetSQL($handDB,
 $q,
 'get country code');
 
\end_layout

\begin_layout Plain Layout

if(length $DBcode == 0)
\end_layout

\begin_layout Plain Layout

  { return(-1);
             # invalid
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

  return($DBcode);
 
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Subsubsection
Save zone details
\begin_inset CommandInset label
LatexCommand label
name "subsec:Save-zone-details-tz"

\end_inset


\end_layout

\begin_layout Standard
First check if zone is present in database.
 If not,
 insert it into the 
\series bold
PLACES
\series default
 table.
 We use several globals (
\family typewriter
$USERID
\family default
,
 $TZDATABASEID).
 
\begin_inset Note Note
status open

\begin_layout Plain Layout
2020-12-05
\end_layout

\end_inset

 The constraint 
\family typewriter
reason > -1
\family default
 will suppress obsolete locations like America/Montreal,
 which was incorrectly specified in early versions of tz as an individual timezone different from others in Quebec but here this is a two-edged sword—
how do we identify and handle existing (but retired) places?
 One answer is to select the reason instead of saying 
\family typewriter
AND reason > -1
\family default
,
 and then 
\emph on
not 
\emph default
add (and save) this zone if the place is retired.
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

sub SaveZone # 
\end_layout

\begin_layout Plain Layout

{ my($zonename,
 $COUNTRY,
 $North,
 $East) = @_;
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  my($handDB) = $smalltime_h;
  
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  my($q) = "SELECT place,
 reason FROM PLACES 
\begin_inset Quotes eld
\end_inset


\end_layout

\begin_layout Plain Layout

    .
 
\begin_inset Quotes eld
\end_inset

WHERE p_amended = $COUNTRY AND description = '$zonename'";
 
\end_layout

\begin_layout Plain Layout

    # might get away with just description but rather check country too.
 
\end_layout

\begin_layout Plain Layout

  my($zcode,
 $reason) = Timely::GetSQL($handDB,
 $q,
 'find zone');
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

if( (defined $zcode) 
\end_layout

\begin_layout Plain Layout

  &&(length $zcode > 0)
\end_layout

\begin_layout Plain Layout

  )
\end_layout

\begin_layout Plain Layout

  { Timely::Log("
\backslash
n  Zone ($COUNTRY:$zonename) found='$zcode'");
 
\end_layout

\begin_layout Plain Layout

  if($reason < 0) # [this option may need checking]
\end_layout

\begin_layout Plain Layout

    { Timely::XPrint(0,
 
\begin_inset Quotes eld
\end_inset


\backslash
n
\backslash
n*Warning* :
 zone is retired:
 '$zonename'
\backslash
n
\begin_inset Quotes erd
\end_inset

);
 
\end_layout

\begin_layout Plain Layout

      return(0);
  
\end_layout

\begin_layout Plain Layout

    };
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

    $ZONES{$zonename} = 1;
 # for later
\end_layout

\begin_layout Plain Layout

    $ZONECODES{$zonename} = $zcode;
\end_layout

\begin_layout Plain Layout

    return(0);
  # return value is unused at present 
\end_layout

\begin_layout Plain Layout

  };
  
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  my($newzone) = Timely::FetchKey('PLACES',
 'new zone code');
 
\end_layout

\begin_layout Plain Layout

  Timely::Log("
\backslash
nInserting new zone:
 $newzone=$COUNTRY/$zonename,
 N=$North E=$East");
\end_layout

\begin_layout Plain Layout

  my($qw) = "INSERT INTO PLACES "
\end_layout

\begin_layout Plain Layout

   .
 "(place,
 east,
 north,
 description,
 p_amended,
 t_amended,
 reason,
 
\begin_inset Quotes eld
\end_inset


\end_layout

\begin_layout Plain Layout

   .
    
\begin_inset Quotes eld
\end_inset

amender,
 src,
 chk)"
\end_layout

\begin_layout Plain Layout

   .
 " VALUES "
\end_layout

\begin_layout Plain Layout

   .
 "($newzone,
 $East,
 $North,
 '$zonename',
 $COUNTRY,
 0,
 0,
 
\begin_inset Quotes eld
\end_inset


\end_layout

\begin_layout Plain Layout

   .
    
\begin_inset Quotes eld
\end_inset

$USERID,
 $TZDATABASEID,
 0)";
 # no chk yet.
 
\end_layout

\begin_layout Plain Layout

  my($ok) = Timely::DoSQL($handDB,
 $qw,
 'make new zone');
 
\end_layout

\begin_layout Plain Layout

if($ok != 1)
\end_layout

\begin_layout Plain Layout

  { &Aagh( "
\backslash
nFailed to insert zone '$zonename' id=$newzone;
 $!
\backslash
n",
 __LINE__,
 0);
\end_layout

\begin_layout Plain Layout

    return(0);
 
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

  $ZONES{$zonename} = 1;
   # stub for later
\end_layout

\begin_layout Plain Layout

  $ZONECODES{$zonename} = $newzone;
\end_layout

\begin_layout Plain Layout

  return(1);
 # new zone created
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
Problem with East and Antarctica/Syowa,
 128 021 957 785
\end_layout

\end_inset


\end_layout

\begin_layout Subsubsection
Debug a zone
\end_layout

\begin_layout Standard
Explore the basic structure of the zone provided,
 and write to log.
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

sub DebugZone # 
\end_layout

\begin_layout Plain Layout

{ my($v,
 $SingleZone) = @_;
\end_layout

\begin_layout Plain Layout

  my(@V) = @$v;
\end_layout

\begin_layout Plain Layout

  my($GMTOFF) = $V[0];
 # Z in seconds
\end_layout

\begin_layout Plain Layout

  my($RULE)  = $V[1];
\end_layout

\begin_layout Plain Layout

    my($YYYY)  = $V[2];
\end_layout

\begin_layout Plain Layout

    my($MM)    = $V[3];
\end_layout

\begin_layout Plain Layout

    my($DD)    = $V[4];
\end_layout

\begin_layout Plain Layout

    my($hh)    = $V[5];
\end_layout

\begin_layout Plain Layout

    my($mm)    = $V[6];
\end_layout

\begin_layout Plain Layout

    my($FORMAT)= $V[7];
  
\end_layout

\begin_layout Plain Layout

    my($J)     = $V[8];
 # Julian seconds 
\end_layout

\begin_layout Plain Layout

  my($UNTIL) = "$YYYY $MM $DD $hh $mm";
\end_layout

\begin_layout Plain Layout

  my($RU);
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  my($err) = 0;
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

if($RULE eq '-')
\end_layout

\begin_layout Plain Layout

  { $RU = '<>';
\end_layout

\begin_layout Plain Layout

  }
\end_layout

\begin_layout Plain Layout

elsif(defined $RULES{$RULE})
\end_layout

\begin_layout Plain Layout

  {  $RU = '@' .
 $RULE;
  
\end_layout

\begin_layout Plain Layout

  }
\end_layout

\begin_layout Plain Layout

elsif( $RULE =~ /^
\backslash
d+:
\backslash
d+/ )
\end_layout

\begin_layout Plain Layout

  { $RU = "off=$RULE";
\end_layout

\begin_layout Plain Layout

  } else
\end_layout

\begin_layout Plain Layout

  { $RU = " -?- ($RULE) ";
\end_layout

\begin_layout Plain Layout

    $err = 1;
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

if($SingleZone)
\end_layout

\begin_layout Plain Layout

  { print 
\begin_inset Quotes eld
\end_inset

zone rule:
 $GMTOFF $RU:
 $UNTIL $FORMAT $J
\backslash
n
\begin_inset Quotes erd
\end_inset

;
 
\end_layout

\begin_layout Plain Layout

  };
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  Timely::Log( "
\backslash
n   $FORMAT '$GMTOFF' $RU --> '$UNTIL'/$J" );
  
\end_layout

\begin_layout Plain Layout

    # cf.
 below:
 my(@V) = ($GMTOFF,
 $RULES,
 $UNTIL);
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Subsection
Links
\begin_inset CommandInset label
LatexCommand label
name "subsec:Links-tz"

\end_inset


\end_layout

\begin_layout Standard
The format is along the lines of:
\end_layout

\begin_layout Quote
Link Europe/London Europe/Jersey 
\end_layout

\begin_layout Standard
This maps Europe/Jersey to the more widely used rules for Europe/London.
 We create a special associative table 
\family typewriter
%LINKS
\family default
 that allows link look-up:
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

sub MakeLink # 
\end_layout

\begin_layout Plain Layout

{ my($rw) = @_;
\end_layout

\begin_layout Plain Layout

if( $rw !~ /Link
\backslash
s(
\backslash
w+
\backslash
/
\backslash
w+)
\backslash
s(
\backslash
w+
\backslash
/
\backslash
w+)/ )
\end_layout

\begin_layout Plain Layout

  { die "
\backslash
n***ERROR*** Bad link <$rw>";
\end_layout

\begin_layout Plain Layout

    return;
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

  $LINKS{$2} = $1;
\end_layout

\begin_layout Plain Layout

  Timely::Log( "( $2-->$1 )" );
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
This is used in Section
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:Create-database-rows-tz"
nolink "false"

\end_inset

.
\end_layout

\begin_layout Section
Zone data for one year
\begin_inset CommandInset label
LatexCommand label
name "subsec:TZ-zone-data-for-one-year"

\end_inset


\end_layout

\begin_layout Standard
Process zone data for a single year.
 As we work through,
 Store
\begin_inset space ~
\end_inset

(
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:Push-to-store"
plural "false"
caps "false"
noprefix "false"
nolink "false"

\end_inset

) is invoked to temporarily store an entry in 
\family typewriter
@STORAGE
\family default
;
 finally,
 FinalStore
\begin_inset space ~
\end_inset

(
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:Fetch-from-store-FinalStore"
plural "false"
caps "false"
noprefix "false"
nolink "false"

\end_inset

) works through this array and writes relevant entries to the database table 
\series bold
timely
\series default
.
 
\end_layout

\begin_layout Standard
The arguments are:
\end_layout

\begin_layout Description
SingleZone Only true (1) if we're dealing with just a single zone
\end_layout

\begin_layout Description
nm The 
\family typewriter
$nm
\family default
 variable,
 the zone name,
 is just for decoration (comments)
\end_layout

\begin_layout Description
year The year being processed
\end_layout

\begin_layout Description
ZONEBASE The Z offset for date calculation
\end_layout

\begin_layout Description
north A positive or negative value—
a positive number if we're north of the equator 
\end_layout

\begin_layout Description
DSTCARRY carried over daylight saving (seconds)
\end_layout

\begin_layout Description
@A An array of all the data for this zone,
 obtained from 
\family typewriter
%ZONES
\family default
.
\end_layout

\begin_layout Standard

\family typewriter
$DSTCARRY
\family default
 is daylight saving time carried over to 
\begin_inset Quotes eld
\end_inset

the time of this rule
\begin_inset Quotes erd
\end_inset

.
 
\begin_inset Note Note
status collapsed

\begin_layout Plain Layout
[THE FOLLOWING IS MADE MORE COMPLEX BY THE FACT THAT THE TIMESTAMPS ARE LOCAL,
 THAT IS,
 I NEED TO ADJUST THE Julian TIMESTAMP BY THE LOCAL (wall clock,
 CURRENT) TIME OFFSET to get the proleptic GPS time;
 in addition,
 there is the matter of leap seconds ![EXPLORE]
\end_layout

\begin_layout Plain Layout
NB.
 THE 'UNTIL' TIME also MUST BE ADJUSTED FOR GPS/LOCAL TIME [FIX ME]
\end_layout

\begin_layout Plain Layout
Check out Singapore:
 http://www.math.nus.edu.sg/aslaksen/teaching/timezone.html
\end_layout

\end_inset

 Each such line in @A is pertinent to a series of years up to the transition time specified within this line;
 any zone line may also specify a 
\begin_inset Quotes eld
\end_inset

rule
\begin_inset Quotes erd
\end_inset

 that contains multiple sub-rules,
 each with applicability to a range of years.
 The first zone line applies until the cutoff date specified in that line (
\family typewriter
$Jtrans
\family default
);
 if we next encounter a year after this cutoff,
 we apply the subsequent rule to that year provided the year (
\family typewriter
$yea
\family default
r) is 
\emph on
between 
\emph default
the cutoffs for the two rules.
 The value in 
\family typewriter
$ZONEBASE
\family default
 is an offset used as a basis for date calculation,
 a fraction of one day expressed in seconds.
 It's important to note that 
\family typewriter
$DSTCARRY
\family default
 is copied into 
\family typewriter
$RUNNING_DST
\family default
,
 which may be modified.
 
\end_layout

\begin_layout Standard
ZoneYear
\begin_inset space ~
\end_inset

() 
\series bold
returns
\series default
 two values,
 
\family typewriter
$CURRENT_ZO
\family default
,
 
\family typewriter
$RUNNING_DST
\family default
:
 we must maintain the current zone offset and current DST value for the next year.
 
\end_layout

\begin_layout Standard
In the following,
 take note of the value in 
\family typewriter
$Jraw
\family default
 and its important derivative—
the widely-used transition time 
\family typewriter
$Jtrans
\family default
.
 This is the Julian equivalent of the transition time for a rule,
 but needs to be modified by the current DST and zone offset.
 
\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
[THE ISSUE HERE IS THAT IF WE ALTER DST within the NEXTZONE loop,
 the transition time is fucked up [technical term] fix me!]
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

sub ZoneYear # 
\end_layout

\begin_layout Plain Layout

{ my($SingleZone,
 $nm,
 $year,
 $ZONEBASE,
 $north,
 $DSTCARRY,
 @A) = @_;
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  Timely::Log( "
\backslash
n
\backslash
n** Processing $nm $year (z=
\begin_inset Quotes eld
\end_inset

 .
 &Tim($ZONEBASE) .
 '|d=' 
\end_layout

\begin_layout Plain Layout

        .
 &Tim($DSTCARRY) .
 
\begin_inset Quotes eld
\end_inset

):" );
  # nasty
\end_layout

\begin_layout Plain Layout

    my($LASTZO) = $ZONEBASE;
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  my($LASTTRAN) = 0;
 
\end_layout

\begin_layout Plain Layout

if($SingleZone)
\end_layout

\begin_layout Plain Layout

  { print 
\begin_inset Quotes eld
\end_inset


\backslash
n$year:
 
\begin_inset Quotes erd
\end_inset

;
 
\end_layout

\begin_layout Plain Layout

  };
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  # 'start/end of the year' won't accord with UTC start unless zone offset=0.
 Adjust:
\end_layout

\begin_layout Plain Layout

  my($YearBot) = Timely::GpsJulian($year,
  1,
  1,
  0,
  0,
  0,
 0,
 $ZONEBASE,
 $DSTCARRY);
\end_layout

\begin_layout Plain Layout

  my($YearTop) = Timely::GpsJulian($year,
 12,
 31,
 23,
 59,
 59,
 0,
 $ZONEBASE,
 $DSTCARRY);
 
\end_layout

\begin_layout Plain Layout

              #                            ^ 1 second taken off "just in case" 
\end_layout

\begin_layout Plain Layout

              # BUT NOTE that DST may well change for the latter,
 as may the zone!
\end_layout

\begin_layout Plain Layout

  &StartStorage($nm,
 $year);
\end_layout

\begin_layout Plain Layout

   # NB final 2 values submitted to GpsJulian_() are seconds
\end_layout

\begin_layout Plain Layout

  ##&Debug(0,
 ' from ' .
 &Dat($YearBot) .
 ' to ' .
 &Dat($YearTop) );
 
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
In the above,
 if we are to be pedantic,
 we must eventually amend 
\family typewriter
$YearTop
\family default
,
 but this has no practical effect.
 Initialise:
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

  my($FORMAT);
                 # although retrieved,
 this variable is not used
\end_layout

\begin_layout Plain Layout

  my($Jtrans);
                   # transition (cutoff) time as Julian
\end_layout

\begin_layout Plain Layout

  my($LAST_ZO) = 0;
            # [???]
\end_layout

\begin_layout Plain Layout

  my($CURRENT_ZO) = $ZONEBASE;
 # [horrendous,
 redundant mess]
\end_layout

\begin_layout Plain Layout

  my($TOPPED) = 0;
             # =1 means "value in $CURRENT_ZO is now final" 
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
[?
 check utility of $TOPPED ??]
\end_layout

\end_inset


\end_layout

\begin_layout Subsection
Process each zone rule
\end_layout

\begin_layout Standard
Check multiple zone rules in @A.
 It's important that we work through @A in the sequence in which the zone rules are presented in the TZ database,
 from early to late.
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

  my($v);
\end_layout

\begin_layout Plain Layout

  my($DONE) = 0;
 
\end_layout

\begin_layout Plain Layout

  my($PENDING_START) = 0;
\end_layout

\begin_layout Plain Layout

  my($BETWEEN) = 0;
\end_layout

\begin_layout Plain Layout

  my($RUNNING_DST) = $DSTCARRY;
  # [another ugly monster]
\end_layout

\begin_layout Plain Layout

  #&Debug(0,
 "
\backslash
nrunDST1=" .
 &Tim($RUNNING_DST) );
\end_layout

\begin_layout Plain Layout

  my($zod);
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Subsubsection
Main Zone loop
\end_layout

\begin_layout Standard
As noted above the array @A was supplied as the final argument of ZoneYear
\begin_inset space ~
\end_inset

().
 We work through each row!
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

NEXTZONE:
 foreach $v (@A)  # Usually ONE zone specification applies to a year
\end_layout

\begin_layout Plain Layout

                    #   but tricky with transitions:
 the specification (e.g.
 rule)
\end_layout

\begin_layout Plain Layout

                    #   for the NEXT year applies after the transition!
\end_layout

\begin_layout Plain Layout

  { my(@V) = @$v;
   #  Each 'rule' in turn contains sub-rules,
 $v a reference 
\end_layout

\begin_layout Plain Layout

    my($GMTOFF)= $V[0];
  # the zone offset applies UP TO the transition,
 in seconds
\end_layout

\begin_layout Plain Layout

    my($RULE)  = $V[1];
\end_layout

\begin_layout Plain Layout

    my($YYYY)  = $V[2];
  # the year alone is supplied to ApplyRule 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

    my($MM)    = $V[3];
    # These values all redundant but debugging...
\end_layout

\begin_layout Plain Layout

    my($DD)    = $V[4];
    #
\end_layout

\begin_layout Plain Layout

    my($h)     = $V[5];
    #
\end_layout

\begin_layout Plain Layout

    my($m)     = $V[6];
    # # end redundant.
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

    $FORMAT    = $V[7];
 # the standard 8 variables
\end_layout

\begin_layout Plain Layout

    my($Jraw)  = $V[8];
 # Julian day for the above YYYY-MM-DD etc.
 
\end_layout

\begin_layout Plain Layout

    my($sufx)  = $V[9];
 # suffix for this date,
 added belatedly [D'Oh]
\end_layout

\begin_layout Plain Layout

   my($tz_cutoff) = $V[10];
 # added for source debugging
\end_layout

\begin_layout Plain Layout

    $zod = 1;
\end_layout

\begin_layout Plain Layout

    $Jtrans = &FixBySuffix($sufx,
 $Jraw,
 $GMTOFF,
 $RUNNING_DST);
 
\end_layout

\begin_layout Plain Layout

    $LASTZO = $GMTOFF;
   # retain zone offset used to determine Jtrans
\end_layout

\begin_layout Plain Layout

      # As per the suffix,
 convert time based on current zone offset and 
\end_layout

\begin_layout Plain Layout

      #    on current daylight saving ($dst)
\end_layout

\begin_layout Plain Layout

      # NB.
 Latter more complex based as may be subsequent
\end_layout

\begin_layout Plain Layout

      #    DST transitions in the rules themselves.
 
\end_layout

\begin_layout Plain Layout

      # $DSTCARRY may be adjusted below,
 for the next round of NEXTZONE.
\end_layout

\begin_layout Plain Layout

    $Jtrans = Timely::ApplyGps($Jtrans);
 # adjust to GPS time!
\end_layout

\begin_layout Plain Layout

    ($CURRENT_ZO,
 $TOPPED) = 
\end_layout

\begin_layout Plain Layout

         &TryZone($GMTOFF,
 $Jtrans,
 $YearBot,
 $YearTop,
 $CURRENT_ZO,
 $TOPPED);
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
The value in 
\family typewriter
$Jtrans
\family default
 is important because it will become the source of the transition value 
\family typewriter
$zone_transition
\family default
.
\end_layout

\end_inset


\end_layout

\begin_layout Standard

\family typewriter
\begin_inset Note Note
status open

\begin_layout Plain Layout

\family typewriter
$CURRENT_ZO
\family default
 always tracks the currently applicable zone offset,
 and is used by Store
\begin_inset space ~
\end_inset

() as the zone offset,
 with one exception —
 in the unusual circumstances of Section
\begin_inset space ~
\end_inset

.
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
Debugging only:
\end_layout

\begin_layout Plain Layout
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

    &Debug(0,"
\backslash
nROW($tz_cutoff) = " .
 &Pad( &Tim($GMTOFF) ,
 7) 
\end_layout

\begin_layout Plain Layout

            .
 " rule=" .
 &Pad($RULE,12) .
 &Pad(" $YYYY-$MM-$DD $h:$m",
 18)
\end_layout

\begin_layout Plain Layout

            .
 ':
 ' .
 &Dat($Jtrans) .
 "<-"  
\end_layout

\begin_layout Plain Layout

            .
 &Pad(  "{" .
 &Tim($CURRENT_ZO) .
 "," .
 &Tim($RUNNING_DST) .
 "}"  ,
 16)
\end_layout

\begin_layout Plain Layout

            .
 "(" .
 &Pad( $FORMAT .
 ')' ,6 ) .
 "
\backslash
t");
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Subsubsection
Rule evaluation
\end_layout

\begin_layout Standard
Our evaluation process is as follows:
\end_layout

\begin_layout Enumerate
Zone rules only apply until the specified cutoff timestamp.
 If the bottom of the year under evaluation is above the cutoff timestamp in Jtrans,
 the rule can't apply,
 so we skip it;
\end_layout

\begin_layout Enumerate
Otherwise,
 a '-' rule forces us to alter the transition point (starting point for the next DST offset,
 we turn off DST up to the transition) to the cutoff timestamp,
 provided this timestamp is within the current year!
\end_layout

\begin_layout Enumerate
Otherwise a rule like '1:00' forces a new DST value that always applies from the preceding transition point until the current cutoff timestamp;
\end_layout

\begin_layout Enumerate
Otherwise apply the named rule.
 This itself is a bit tricky,
 as a named rule that 
\begin_inset Quotes eld
\end_inset

doesn't apply
\begin_inset Quotes erd
\end_inset

 can be followed (on rare occasions) by another zone rule.
 See for example America/Nipigon 1940.
 
\end_layout

\begin_layout Standard
In the following,
 it's important not to apply a rule after it's expired.
 This is more tricky than it seems.
 Many zone rules simply specify 
\begin_inset Quotes eld
\end_inset

up to (e.g.) 1900
\begin_inset Quotes erd
\end_inset

,
 so we should not apply the rule if we're in 1900,
 i.e.
 the bottom of the year is above the first day of 1900.
 It's important to realise that the zone offset that applies up till this point is 
\emph on
not 
\emph default
the preceding offset,
 but 
\family typewriter
$GMTOFF
\family default
 (See the construction of 
\family typewriter
$Jtrans
\family default
 above).
 
\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
[THIS IS THE CLUMSIEST IF / ELSIF IN THE HISTORY OF PROGRAMMING.
 :-( ]
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

    my($oktm);
\end_layout

\begin_layout Plain Layout

  if($YearBot > $Jtrans)    # NOT >= cf Asia/Khandyga 2004
\end_layout

\begin_layout Plain Layout

    { #&Debug(0,
 "skip ROW,
 " .
 &Dat($YearBot) .
 " > " .
 &Dat($Jtrans)  );
\end_layout

\begin_layout Plain Layout

    if($SingleZone)
\end_layout

\begin_layout Plain Layout

      { print '^ ';
 
\end_layout

\begin_layout Plain Layout

      };
 
\end_layout

\begin_layout Plain Layout

      next NEXTZONE;
\end_layout

\begin_layout Plain Layout

    }
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Subsubsection
Dash rule
\end_layout

\begin_layout Standard
This applies OFF between the preceding transition (
\family typewriter
$LASTTRAN
\family default
) and the current cutoff time (in 
\family typewriter
$Jtrans
\family default
),
 but only if we've entered with DST currently on;
 there is no value in recording an 
\begin_inset Quotes eld
\end_inset

end
\begin_inset Quotes erd
\end_inset

 if DST is already off!
 Note the storage of 
\family typewriter
$LASTTRAN
\family default
:
 MUST NOT allow subsequent rules to apply retroactively before this timestamp,
 for example as incorrectly occurred with Asia/Gaza 2008 around 08-31.
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

  elsif($RULE eq '-')
\end_layout

\begin_layout Plain Layout

    { $RUNNING_DST = 0;
   # applies until the transition,
 whenever it is
\end_layout

\begin_layout Plain Layout

    if($SingleZone)
\end_layout

\begin_layout Plain Layout

      { print '- ';
 
\end_layout

\begin_layout Plain Layout

      };
 
\end_layout

\begin_layout Plain Layout

    if($Jtrans < $YearTop)
\end_layout

\begin_layout Plain Layout

      { $Jtrans = Timely::ApplyGps( &FixBySuffix($sufx,
 $Jraw,
 $GMTOFF,
 $RUNNING_DST) );
 
\end_layout

\begin_layout Plain Layout

           # DST changed,
 but retroactive
\end_layout

\begin_layout Plain Layout

      if( &Store($LASTTRAN,
 $Jtrans,
 $RUNNING_DST,
 $CURRENT_ZO,
 $sufx,
 
\end_layout

\begin_layout Plain Layout

                 DASHRULE,
 0,
 $SingleZone) )
\end_layout

\begin_layout Plain Layout

        { #&Debug(0,
 "
\backslash
nrunDST2=0" );
\end_layout

\begin_layout Plain Layout

          $LASTTRAN = $Jtrans;
\end_layout

\begin_layout Plain Layout

        };
 
\end_layout

\begin_layout Plain Layout

      } else       # if at or after year top
\end_layout

\begin_layout Plain Layout

      { last NEXTZONE;
  
\end_layout

\begin_layout Plain Layout

      };
\end_layout

\begin_layout Plain Layout

    }
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Subsubsection
Fixed DST rule
\end_layout

\begin_layout Standard
Here,
 the daylight saving value is bizarrely specified as a 
\begin_inset Quotes eld
\end_inset

rule
\begin_inset Quotes erd
\end_inset

,
 applying retroactively—
in contrast,
 `Rule' rules apply DST prospectively.
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

  elsif($RULE =~ /
\backslash
d+:
\backslash
d+/)   # value applies UP TO $Jtrans
\end_layout

\begin_layout Plain Layout

    { $RUNNING_DST = &FixTime($RULE);
   # new DST offset in seconds
\end_layout

\begin_layout Plain Layout

      $Jtrans = Timely::ApplyGps( &FixBySuffix($sufx,
 $Jraw,
 $GMTOFF,
 $RUNNING_DST) );
\end_layout

\begin_layout Plain Layout

         # DST changed,
 but retroactive [check this,
 it works] 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

    if($SingleZone)
\end_layout

\begin_layout Plain Layout

      { print ':
 ';
 
\end_layout

\begin_layout Plain Layout

      };
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

    if($Jtrans < $YearTop)
\end_layout

\begin_layout Plain Layout

      { 
\end_layout

\begin_layout Plain Layout

      if( &Store($LASTTRAN,
 $Jtrans,
 $RUNNING_DST,
 $CURRENT_ZO,
 $sufx,
 
\end_layout

\begin_layout Plain Layout

                 FIXEDDST,
 0,
 $SingleZone) )
\end_layout

\begin_layout Plain Layout

        { #&Debug(0,
 "
\backslash
nrunDST3=0" );
\end_layout

\begin_layout Plain Layout

          $LASTTRAN = $Jtrans;
\end_layout

\begin_layout Plain Layout

        };
 
\end_layout

\begin_layout Plain Layout

      } else       # if at or after year top
\end_layout

\begin_layout Plain Layout

      { last NEXTZONE;
  
\end_layout

\begin_layout Plain Layout

      };
\end_layout

\begin_layout Plain Layout

    }
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Subsubsection
Rule 
\begin_inset Quotes eld
\end_inset

just applies
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Standard
Cut is above top of year (Next rule applies retrospectively!!)
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

  elsif($Jtrans > $YearTop) # if rule "just applies":
\end_layout

\begin_layout Plain Layout

    { 
\end_layout

\begin_layout Plain Layout

    if($SingleZone)
\end_layout

\begin_layout Plain Layout

      { print '> ';
 
\end_layout

\begin_layout Plain Layout

      };
 
\end_layout

\begin_layout Plain Layout

      ($oktm,
 $RUNNING_DST) 
\end_layout

\begin_layout Plain Layout

         = &ApplyRule($nm,
 $year,
 $RULE,
 $RUNNING_DST,
 0,
 $LASTTRAN,
 
\end_layout

\begin_layout Plain Layout

                      $CURRENT_ZO,
 $LASTZO,
 $SingleZone);
\end_layout

\begin_layout Plain Layout

          # no transition
\end_layout

\begin_layout Plain Layout

       #&Debug(0,
 "
\backslash
nrunDST5=" .
 &Tim($RUNNING_DST) );
 
\end_layout

\begin_layout Plain Layout

       last NEXTZONE;
\end_layout

\begin_layout Plain Layout

    } 
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Subsubsection
A transition is present
\end_layout

\begin_layout Standard
This transition is between year start and year end.
 ApplyRule
\begin_inset space ~
\end_inset

() may well invoke Store
\begin_inset space ~
\end_inset

() successfully,
 in which case a transition time is returned and put in 
\family typewriter
$oktm
\family default
.
 However,
 if no store occurred,
 or the storage was unsuccessful,
 then $oktm is zero.
 
\end_layout

\begin_layout Standard
The test 
\family typewriter
if($Jtrans > $oktm)
\family default
 is somewhat mysterious.
 This will clearly apply if 
\family typewriter
$oktm
\family default
 is zero;
 it will also apply if the current transition time (for this transition) is above the time specified 
\emph on
up to which the most recent rule stored within ApplyRule
\begin_inset space ~
\end_inset

()
\emph default
 applies.
 For example,
 take the Asia/Gaza rule:
\end_layout

\begin_layout Quote

\family typewriter
2:00 Zion EET/EEST 1948 May 15
\end_layout

\begin_layout Standard
\begin_inset Separator plain
\end_inset


\end_layout

\begin_layout Standard
The Zion rules of apparent relevance are:
\end_layout

\begin_layout Quote

\family typewriter
Rule Zion 1948 only - May 23 0:00 2:00 DD
\end_layout

\begin_layout Quote

\family typewriter
Rule Zion 1948 only - Sep 1 0:00 1:00 D
\end_layout

\begin_layout Quote

\family typewriter
Rule Zion 1948 1949 - Nov 1 2:00 0 S
\end_layout

\begin_layout Standard
\begin_inset Separator plain
\end_inset


\end_layout

\begin_layout Standard
None of these applies,
 but we still wish to signal the `transition'—
admittedly somewhat meaningless.
\begin_inset Note Note
status open

\begin_layout Plain Layout
[can we just toss these?
 cf:
 
\begin_inset ERT
status open

\begin_layout Plain Layout

 select f.*,
 P.description from timely f inner join timely s on f.timekey = s.timekey-1 and f.region = s.region inner join PLACES P on f.region = P.place where f.ignored = 0 and s.ignored = 0 and f.zone_offset = s.zone_offset AND f.dst = s.dst;
\end_layout

\end_inset


\end_layout

\end_inset

 More substantial is e.g.
 America/Araguaina 1990:
 
\end_layout

\begin_layout Quote

\family typewriter
-3:00 Brazil -03/-02 1990 Sep 17
\end_layout

\begin_layout Quote

\family typewriter
-3:00 - -03 1995 Sep 14
\end_layout

\begin_layout Standard
\begin_inset Separator plain
\end_inset


\end_layout

\begin_layout Standard
The rules:
\end_layout

\begin_layout Quote

\family typewriter
Rule Brazil 1989 only - Oct 15 0:00 1:00 -
\end_layout

\begin_layout Quote

\family typewriter
Rule Brazil 1990 only - Feb 11 0:00 0 -
\end_layout

\begin_layout Quote

\family typewriter
Rule Brazil 1990 only - Oct 21 0:00 1:00 -
\end_layout

\begin_layout Standard
ApplyRule
\begin_inset space ~
\end_inset

() has stored the Feb 11 transition to DST=0;
 we must still store the September 17 transition that encompasses the DST that applies till then!
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

  else                  # more interesting,
 as CURRENT transition is present:
\end_layout

\begin_layout Plain Layout

    { 
\end_layout

\begin_layout Plain Layout

    if($SingleZone)
\end_layout

\begin_layout Plain Layout

      { print '?
 ';
 
\end_layout

\begin_layout Plain Layout

      };
 
\end_layout

\begin_layout Plain Layout

      ($oktm,
 $RUNNING_DST) # [ *** EXPLORE AND FIX THIS NASTY HACK *** ]
\end_layout

\begin_layout Plain Layout

         = &ApplyRule($nm,
 $year,
 $RULE,
 $RUNNING_DST,
 $Jtrans,
 $LASTTRAN,
 
\end_layout

\begin_layout Plain Layout

                      $CURRENT_ZO,
 $LASTZO,
 $SingleZone);
 
\end_layout

\begin_layout Plain Layout

       #&Debug(0,
 "
\backslash
nrunDST6=" .
 &Tim($RUNNING_DST) );
\end_layout

\begin_layout Plain Layout

       # KNOW  $Jtrans < $YearTop
\end_layout

\begin_layout Plain Layout

     # a catch if rule already set AFTER $Jtrans:
\end_layout

\begin_layout Plain Layout

    if($Jtrans > $oktm)
\end_layout

\begin_layout Plain Layout

      { #&Debug(0,
 ' ===unfulfilled=== ' );
 
\end_layout

\begin_layout Plain Layout

        $Jtrans = Timely::ApplyGps( &FixBySuffix($sufx,
 $Jraw,
 
\end_layout

\begin_layout Plain Layout

                             $GMTOFF,
 $RUNNING_DST) );
 # DST changed?
 
\end_layout

\begin_layout Plain Layout

        ##
\end_layout

\begin_layout Plain Layout

      if( &Store($LASTTRAN,
 $Jtrans,
 $RUNNING_DST,
 $CURRENT_ZO,
 $sufx,
 
\end_layout

\begin_layout Plain Layout

                 FIXEDDZ,
 0,
 $SingleZone) )
\end_layout

\begin_layout Plain Layout

        { $LASTTRAN = $Jtrans;
\end_layout

\begin_layout Plain Layout

        } else
\end_layout

\begin_layout Plain Layout

        { # [debug statement will appear within &Store] 
\end_layout

\begin_layout Plain Layout

        };
 
\end_layout

\begin_layout Plain Layout

      } else 
\end_layout

\begin_layout Plain Layout

      { # #&Debug(0,
 "
\backslash
n --********skipped********-- as " .
 &Tim($Jtrans) 
\end_layout

\begin_layout Plain Layout

        #       .
 ' < ' .
 &Tim($oktm) );
 
\end_layout

\begin_layout Plain Layout

        $LASTTRAN = $oktm;
\end_layout

\begin_layout Plain Layout

      };
\end_layout

\begin_layout Plain Layout

    };
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
Continue:
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

  };
   # End of NEXTZONE loop.
 
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
We now store each rule in the database.
 There's a catch,
 as the DST value used to establish 
\family typewriter
$YearTop
\family default
 may have been inaccurate,
 so I adjust this appropriately.
 I also need to pass on the last transaction timestamp (
\family typewriter
$LASTTRAN
\family default
) as explained in FinalStore
\begin_inset space ~
\end_inset

(
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:Fetch-from-store-FinalStore"
plural "false"
caps "false"
noprefix "false"
nolink "false"

\end_inset

).
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

  $YearTop = Timely::GpsJulian($year,
 12,
 31,
 23,
 59,
 59,
 0,
 $CURRENT_ZO,
 $RUNNING_DST);
 
\end_layout

\begin_layout Plain Layout

  &FinalStore($nm,
 $year,
 $YearBot,
 $YearTop,
 $RUNNING_DST,
 
\end_layout

\begin_layout Plain Layout

              $CURRENT_ZO,
 $LASTTRAN,
 $SingleZone);
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
That's it:
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

  return($CURRENT_ZO,
 $RUNNING_DST);
 
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard

\end_layout

\begin_layout Subsubsection
Start storage
\end_layout

\begin_layout Standard
Because of the multiple entries in this table,
 we will have to clumsily delete all 
\series bold
timely
\series default
 entries for this zone and year before we create new entries.
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

sub StartStorage
\end_layout

\begin_layout Plain Layout

{ my($zone,
 $year);
 
\end_layout

\begin_layout Plain Layout

    ($zone,
 $year) =@_;
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  @STORAGE = ();
  # clear storage
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Subsection
Push to store
\begin_inset CommandInset label
LatexCommand label
name "subsec:Push-to-store"

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Note Note
status collapsed

\begin_layout Plain Layout
What about Minsk 1941-06-27 19:00:00 ?
\end_layout

\begin_layout Itemize
Europe/Minsk 1992.
 There's a moderate proliferation of overlapping rules here:
\begin_inset Separator latexpar
\end_inset


\end_layout

\begin_deeper
\begin_layout Itemize
EET applies until Mar 29 at 0:00
\series bold
s
\series default
,
 with GMT+2h,
 i.e.
 @1992-03-28 22:00:00;
\end_layout

\begin_layout Itemize
EEST (daylight saving of +1h) applies until Sep 27 at 00:00s,
 by a similar fixed rule.
 This is @1992-09-26 22:00:00.
\end_layout

\begin_layout Itemize
\begin_inset Quotes eld
\end_inset

Russia
\begin_inset Quotes erd
\end_inset

 then applies with a GMT offset of +3h until 2011.
 If we require consistency at the transition,
 then looking back at the Russian rules,
 then:
\begin_inset Separator latexpar
\end_inset


\end_layout

\begin_deeper
\begin_layout Itemize
In 1992 DST was turned on at 23:00 on the last Sat of March,
 i.e.
 28 March at 23:00 i.e.
 @1992-03-28 21:00 [or should this be 20:00 ???????]
\end_layout

\begin_layout Itemize
and off on the last Sat of Sep,
 i.e.
 26 September,
 at 23:00w,
 i.e.
 @1992-03-26 21:00 minus the current DST [why is this incorrect ?????????????]
\end_layout

\end_deeper
\begin_layout Itemize
Now,
\end_layout

\end_deeper
\begin_layout Plain Layout
\begin_inset Separator plain
\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset ERT
status open

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

Europe/Minsk
\end_layout

\begin_layout Plain Layout

			2:00	-	EET	1930 Jun 21
\end_layout

\begin_layout Plain Layout

			3:00	-	MSK	1941 Jun 28
\end_layout

\begin_layout Plain Layout

			1:00	C-Eur	CE%sT	1944 Jul  3
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

C-Eur
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

Rule	C-Eur	1940	only	-	Apr	 1	 2:00s	1:00	S
\end_layout

\begin_layout Plain Layout

Rule	C-Eur	1942	only	-	Nov	 2	 2:00s	0	-
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

==
\end_layout

\begin_layout Plain Layout

==UNTIL 1941-06-28 00:00w no DST,
 z=3:00
\end_layout

\begin_layout Plain Layout

==from 1940-04-01 02:00s DST continues at +1:00 with z=+1:00.
 THIS MEANS THAT this continues from the transition until Nov 1942.
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

The transition is surely at 1941-06-27 21:00:00.
 AT THIS POINT WE:
 change z from +3:00 to 1:00 AND institute DST of +1:00
\end_layout

\begin_layout Plain Layout

Delta z is -2,
 the times in UTC are:
\end_layout

\begin_layout Plain Layout

Wall 1941-06-28 00:00 - baseline 3 is 1941-06-27 21:00
\end_layout

\begin_layout Plain Layout

At this point,
 delta z => wall 1941-06-27 22:00 i.e.
 JUMP BACK 2 hours
\end_layout

\begin_layout Plain Layout

  BUT adding DST => wall 23:00 !
 BUT ALSO JUMP FORWARD 1 hour.
 EFFECTIVELY JUMP *back* 1 hour.
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

u 1941-06-27 20:59:59 => wall 23:59:59
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

u 1941-06-27 21:00:00 => wall 23:00:00*
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

u 1941-06-27 21:59:59 => 23:59:59*
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

u 1941-06-27 22:00:00 => 00:00:00 [but this is still starred by my program ???] 
\end_layout

\begin_layout Plain Layout

*** IN OTHER WORDS,
 MY PGM IS MISCALCULATING THE SHADOW,
 should be -2h+1h = -1 hour.
 cf:
 
\end_layout

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
Arguments are:
\end_layout

\begin_layout Description
$LASTTRAN The most recent transaction Julian timestamp in seconds
\end_layout

\begin_layout Description
$tran The current transition time (also Julian seconds).
 
\end_layout

\begin_layout Description
$dst DST prevailing at the transition,
 in seconds
\end_layout

\begin_layout Description
$zoff Z in seconds,
 the zone offset at the transition 
\end_layout

\begin_layout Description
$mod Date modifier (tz suffix code e.g.
 's')
\end_layout

\begin_layout Description
$type Type of change (see below)
\end_layout

\begin_layout Description
$term 0 unless the invoker is FinalStore
\begin_inset space ~
\end_inset

() —
 then it's 1.
 
\end_layout

\begin_layout Description
$SingleZone
\end_layout

\begin_layout Standard
Put a rule in the global 
\family typewriter
@STORAGE
\family default
.
 As a precautionary measure 
\begin_inset Note Note
status open

\begin_layout Plain Layout
[explore this]
\end_layout

\end_inset

 I supply a 
\family typewriter
$LASTTRAN
\family default
 value as the first argument.
 If the transition timestamp is before this,
 a warning is issued,
 and nothing is stored!
 The return value is the transition time,
 or 0 on failure.
 The 
\family typewriter
$type
\family default
 is the type of change (an added check);
 
\family typewriter
$mod
\family default
 is the modifier for the date.
 The type constant 
\begin_inset Note Note
status open

\begin_layout Plain Layout
(all defined in Section
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:Constants"
plural "false"
caps "false"
noprefix "false"
nolink "false"

\end_inset

) 
\end_layout

\end_inset

specifies the context in which Store
\begin_inset space ~
\end_inset

() was invoked:
\end_layout

\begin_layout Description
DASHRULE A 'dash' rule;
 
\end_layout

\begin_layout Description
FIXEDDST A 'fixed DST' rule;
 
\end_layout

\begin_layout Description
FIXEDDZ A current,
 fixed transition;
 
\end_layout

\begin_layout Description
DSTTRAN A DST transition;
 
\end_layout

\begin_layout Description
FINALRULE A mandatory 
\begin_inset Quotes eld
\end_inset

final store
\begin_inset Quotes erd
\end_inset

,
 invoked by FinalStore
\begin_inset space ~
\end_inset

(
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:Fetch-from-store-FinalStore"
plural "false"
caps "false"
noprefix "false"
nolink "false"

\end_inset

) to ensure there's always a year-end entry,
 which minimises searching.
 
\end_layout

\begin_layout Standard
\begin_inset Separator plain
\end_inset


\end_layout

\begin_layout Standard
A concluding issue concerns the case where two transitions occur at the same time—
for example in Asia/Aqtau we have the zone rules:
\end_layout

\begin_layout Quote

\family typewriter
5:00 RussiaAsia +05/+06 1994 Sep 25 2:00s
\end_layout

\begin_layout Quote

\family typewriter
4:00 RussiaAsia +04/+05 2004 Oct 31 2:00s
\end_layout

\begin_layout Standard
\SpecialChar ldots
 as well as:
\end_layout

\begin_layout Quote

\family typewriter
Rule RussiaAsia 1984 1995 - Sep lastSun 2:00s 0 -
\end_layout

\begin_layout Standard
\begin_inset Separator plain
\end_inset


\end_layout

\begin_layout Standard
In other words the zone offset decreases by an hour 
\emph on
and
\emph default
 DST turns off at 1994-09-25 02:00 (wall time ignoring DST).
 If we process these separately,
 there's also the danger that we miscalculate the two transition times as different,
 but the main issue is that we need to 
\emph on
combine
\emph default
 the DST+Zone changes.
 These issues are all handled by FinalStore
\begin_inset space ~
\end_inset

(
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:Fetch-from-store-FinalStore"
plural "false"
caps "false"
noprefix "false"
nolink "false"

\end_inset

).
 
\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
&Store ($tran,
 $dst,
 $zoff,
 $mod,
 $type,
 $term,
 $SingleZone);
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

sub Store # 
\end_layout

\begin_layout Plain Layout

{ my($LASTTRAN,
 $tran,
 $dst,
 $zoff,
 $mod,
 $type,
 $term,
 $SingleZone);
 
\end_layout

\begin_layout Plain Layout

    ($LASTTRAN,
 $tran,
 $dst,
 $zoff,
 $mod,
 $type,
 $term,
 $SingleZone) =@_;
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  #&Debug(0,
 "
\backslash
n    ==>STORE " .
 &Dat($tran) .
 ' d=' .
 &Tim($dst) .
 ' z=' 
\end_layout

\begin_layout Plain Layout

  #      .
 &Tim($zoff) .
 " $mod/$type" );
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

if($tran < $LASTTRAN)
\end_layout

\begin_layout Plain Layout

  { Timely::Warn(0,
 
\begin_inset Quotes eld
\end_inset

Antecedent rule compensation:
 
\begin_inset Quotes eld
\end_inset

 .
 &JulianDay($tran) 
\end_layout

\begin_layout Plain Layout

           .
 
\begin_inset Quotes eld
\end_inset

 
\begin_inset Quotes erd
\end_inset

 .
 &JulianDay($LASTTRAN) .
 
\begin_inset Quotes erd
\end_inset

 
\begin_inset Quotes eld
\end_inset

 .
 &Dat($tran) 
\end_layout

\begin_layout Plain Layout

           .
 ' < ' .
 &Dat($LASTTRAN) );
 
\end_layout

\begin_layout Plain Layout

    return(0);
 # no!
 
\end_layout

\begin_layout Plain Layout

  };
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  ## We now store *seconds* in first three values in @STORAGE rows:
 
\end_layout

\begin_layout Plain Layout

  my @INS = ($tran,
 $dst,
 $zoff,
 $mod,
 $type,
 $term);
  # array to insert
\end_layout

\begin_layout Plain Layout

  my($off) = scalar @STORAGE;
 # get size of @STORAGE
\end_layout

\begin_layout Plain Layout

  my($more) = 1;
 
\end_layout

\begin_layout Plain Layout

while(  $more
\end_layout

\begin_layout Plain Layout

      &&($off >= 1)
\end_layout

\begin_layout Plain Layout

     )
\end_layout

\begin_layout Plain Layout

  { $off --;
\end_layout

\begin_layout Plain Layout

    my($v) = $STORAGE[$off];
 # get top
\end_layout

\begin_layout Plain Layout

    my($t,
 $d,
 $z) = @$v;
\end_layout

\begin_layout Plain Layout

  if($tran >= $t) # IF the same (=) then insert above current
\end_layout

\begin_layout Plain Layout

    { $more = 0;
 # terminate,
 the usual behaviour
\end_layout

\begin_layout Plain Layout

      $off ++;
   # will insert ABOVE current element
\end_layout

\begin_layout Plain Layout

    };
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

  splice @STORAGE,
 $off,
 0,
 
\backslash
@INS;
  # if $off is zero,
 inserts at start
\end_layout

\begin_layout Plain Layout

  return($tran);
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Subsubsection
Reconcile & write
\begin_inset CommandInset label
LatexCommand label
name "subsec:Fetch-from-store-FinalStore"

\end_inset


\end_layout

\begin_layout Standard
The final transaction must always be after the most recent transaction,
 so we check for this using 
\family typewriter
$LASTTRAN
\family default
.
 If we don't do this,
 then a transition on 31 December will fail to take effect.
 An example is America/Matamoros 1921.
 There are two further issues:
\end_layout

\begin_layout Enumerate
It is possible that a timestamp may have been miscalculated,
 for example if we altered the zone offset and then changed DST,
 the adjusted transition for the DST will be out by the zone change.
 We need to fix this and 
\emph on
then
\emph default
 check for identical transition timestamps.
 Our algorithm:
\end_layout

\begin_deeper
\begin_layout Enumerate
Work through,
 and where zone changes,
 record this,
 together with the transition time;
 
\end_layout

\begin_layout Enumerate
If subsequent transition + transition change is equal to transition time,
 then replace transition time for that row.
 An example occurs for Asia/Aqtau at 1994-09-25 02:00:00s.
\end_layout

\end_deeper
\begin_layout Enumerate
If two entries in 
\family typewriter
@STORAGE
\family default
 (a stack,
 in order) have the same timestamp,
 this 
\emph on
may
\emph default
 just be redundant,
 but we must ensure that if they represent two different transactions (e.g.
 change DST,
 change Zone offset) these are combined into one entry in 
\series bold
timely
\series default
;
\end_layout

\begin_layout Standard
\begin_inset Separator plain
\end_inset


\end_layout

\begin_layout Standard
The third to seventh arguments (
\family typewriter
$YearBot
\family default
 – 
\family typewriter
$LASTTRAN
\family default
) are all expressed in seconds,
 not Julian day numbers!
 
\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
select * from timely t inner join timely u on t.transition = u.transition and t.region = u.region where t.timekey <> u.timekey;
\end_layout

\begin_layout Plain Layout
== ^^ these are all problematic in that they occur as year overlaps.
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

sub FinalStore # 
\end_layout

\begin_layout Plain Layout

{ my($zone,
 $year,
 $YearBot,
 $YearTop,
 $CURRENT_DST,
 $CURRENT_ZO,
 
\end_layout

\begin_layout Plain Layout

     $LASTTRAN,
 $SingleZone);
 
\end_layout

\begin_layout Plain Layout

    ($zone,
 $year,
 $YearBot,
 $YearTop,
 $CURRENT_DST,
 $CURRENT_ZO,
 
\end_layout

\begin_layout Plain Layout

     $LASTTRAN,
 $SingleZone) =@_;
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  my($handDB) = $smalltime_h;
  
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

if($SingleZone)
\end_layout

\begin_layout Plain Layout

  { print 
\begin_inset Quotes eld
\end_inset


\backslash
n  (.)
\begin_inset Quotes erd
\end_inset

;
 
\end_layout

\begin_layout Plain Layout

  };
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

if($LASTTRAN > $YearTop)
\end_layout

\begin_layout Plain Layout

  { $YearTop = $LASTTRAN + 1;
 # +1 second,
 always above most recent 'true' row
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  &Store($LASTTRAN,
 $YearTop,
 $CURRENT_DST,
 $CURRENT_ZO,
 '',
 FINALRULE,
 
\end_layout

\begin_layout Plain Layout

         1,
 $SingleZone);
  # cap entries,
 discard return value
\end_layout

\begin_layout Plain Layout

  # the above will succeed,
 NB.
 assures >= one entry per zone per year!
\end_layout

\begin_layout Plain Layout

 
\end_layout

\begin_layout Plain Layout

if($SingleZone)
\end_layout

\begin_layout Plain Layout

  { print 
\begin_inset Quotes eld
\end_inset


\backslash
n[n = 
\begin_inset Quotes eld
\end_inset

 .
 (scalar @STORAGE) .
 '] ';
 
\end_layout

\begin_layout Plain Layout

  };
 
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
Debugging:
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

  my($region) = $ZONECODES{$zone};
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

if(!
 $SingleZone)  # do NOT alter SQL if single zone:
 
\end_layout

\begin_layout Plain Layout

  { my($qdel) = "DELETE FROM timely WHERE region = $region AND year = $year";
\end_layout

\begin_layout Plain Layout

  if( Timely::DoSQL($handDB,
 $qdel,
 'delete old entries') < 0)
\end_layout

\begin_layout Plain Layout

    { &Aagh("Failed to delete old entries ($qdel)",
 __LINE__,
 0);
\end_layout

\begin_layout Plain Layout

      return;
 
\end_layout

\begin_layout Plain Layout

    };
 
\end_layout

\begin_layout Plain Layout

  };
 
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Note Note
status collapsed

\begin_layout Plain Layout
\begin_inset ERT
status open

\begin_layout Plain Layout

#  &Debug(0,
 "
\backslash
n STORED RULES:
 zone=$zone|$region year=$year,
 n=" .
 scalar @STORAGE
\end_layout

\begin_layout Plain Layout

#          .
 ' ' .
 &Dat($YearBot) .
 '<-->' .
 & Dat($YearTop) 
\end_layout

\begin_layout Plain Layout

#        );
 
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
For each storage item,
 perform some checks.
 The 
\begin_inset Quotes eld
\end_inset

Redundant tz entry
\begin_inset Quotes erd
\end_inset

 message will be triggered if two identical rules exist,
 for example the specification for the zone America/Argentina/Buenos_Aires includes:
\end_layout

\begin_layout Quote

\family typewriter
-4:00 - -04 1930 Dec
\family default
 and 
\end_layout

\begin_layout Quote

\family typewriter
-4:00 Arg -04/-03 1969 Oct 5
\family default
 
\end_layout

\begin_layout Standard
\begin_inset Separator plain
\end_inset


\end_layout

\begin_layout Standard
The latter specifies the rules for Arg that include:
 
\end_layout

\begin_layout Quote

\family typewriter
Rule Arg 1930 only - Dec 1 0:00 1:00 -
\family default
 
\end_layout

\begin_layout Standard
This rule translates to 
\begin_inset Quotes eld
\end_inset

daylight saving terminates on 1 Dec at 0:00 wall time,
 in other words,
 GMT-4;
 but the first of the above rules 
\begin_inset Quotes eld
\end_inset

applies
\begin_inset Quotes erd
\end_inset

 GMT-4 (with no other specifications) until 
\begin_inset Quotes eld
\end_inset

December 1930
\begin_inset Quotes erd
\end_inset

 without any other specification.
 My code currently translates this last to the same timestamp,
 and registers a `collision'.
 
\end_layout

\begin_layout Standard
\begin_inset Note Note
status collapsed

\begin_layout Plain Layout
What about Asia/Gaza 2008 notably 08-31 ?
\end_layout

\begin_layout Plain Layout
\begin_inset ERT
status open

\begin_layout Plain Layout

# Zone	NAME		STDOFF	RULES	FORMAT	[UNTIL]
\end_layout

\begin_layout Plain Layout

Zone	Asia/Gaza	2:17:52	-	LMT	1900 Oct
\end_layout

\begin_layout Plain Layout

			2:00	Zion	EET/EEST 1948 May 15
\end_layout

\begin_layout Plain Layout

			2:00 EgyptAsia	EE%sT	1967 Jun  5
\end_layout

\begin_layout Plain Layout

			2:00	Zion	I%sT	1996
\end_layout

\begin_layout Plain Layout

			2:00	Jordan	EE%sT	1999
\end_layout

\begin_layout Plain Layout

			2:00 Palestine	EE%sT	2008 Aug 29  0:00  <=
\end_layout

\begin_layout Plain Layout

			2:00	-	EET	2008 Sep                  <=
\end_layout

\begin_layout Plain Layout

			2:00 Palestine	EE%sT	2010               <= 
\end_layout

\begin_layout Plain Layout

			2:00	-	EET	2010 Mar 27  0:01
\end_layout

\begin_layout Plain Layout

			2:00 Palestine	EE%sT	2011 Aug  1
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

With Palestine as follows:
 
\end_layout

\begin_layout Plain Layout

# Rule	NAME	FROM	TO	-	IN	ON			AT	SAVE	LETTER/S
\end_layout

\begin_layout Plain Layout

...
\end_layout

\begin_layout Plain Layout

Rule Palestine	2007	only	-	Sep	13		2:00	0	-
\end_layout

\begin_layout Plain Layout

Rule Palestine	2008	2009	-	Mar	lastFri   0:00	1:00	S
\end_layout

\begin_layout Plain Layout

Rule Palestine	2008	only	-	Sep	 1		0:00	0	-
\end_layout

\begin_layout Plain Layout

Rule Palestine	2009	only	-	Sep	 4		1:00	0	-
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

IN OTHER WORDS:
\end_layout

\begin_layout Plain Layout

STDOFF is always +2:00
\end_layout

\begin_layout Plain Layout

Until 2008-08-29 00:00:00w  we are on Palestine
\end_layout

\begin_layout Plain Layout

Until 2008-09-[01 00:00:00w] we are just pure z=+2
\end_layout

\begin_layout Plain Layout

Until 2010-[01-01 00:00:00w] we are back on Palestine
\end_layout

\begin_layout Plain Layout

Until 2010-03-27 00:01:00w  we are pure z=+2
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

In terms of the Palestine rule until 2008 we are on no DST,
 
\end_layout

\begin_layout Plain Layout

Then FROM lastFri Mar at 00:00w DST is +1:00,
\end_layout

\begin_layout Plain Layout

Then FROM Sep 1 00:00w DST is back to 0
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

THIS SHOULD WORK OUT AS FOLLOWS:
\end_layout

\begin_layout Plain Layout

Turn ON DST on last Friday in March (27th) at 00:00:00
\end_layout

\begin_layout Plain Layout

Turn OFF Palestine i.e.
 DST on 2008-08-29 at 00:00:00,
 but also
\end_layout

\begin_layout Plain Layout

Turn ON Palestine (with antecedents) 2008-09-01 00:00:00,
 until 2010 i.e.
 cancel the DST woopsie!!
 
\end_layout

\begin_layout Plain Layout

BUT the antecedents include TURN OFF DST on September 1,
 2008 at 00:00!
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

The sequence is currently interpreted as:
\end_layout

\begin_layout Plain Layout

 2454553.4168287036 / @2008-03-27 22:00:00 z=120 d=0 --> @2008-03-28 00:00:00 
\end_layout

\begin_layout Plain Layout

 2454707.3751620371 / @2008-08-28 21:00:00 z=120 d=60 --> @2008-08-29 00:00:00  <================ NB.
 DST included.
 
\end_layout

\begin_layout Plain Layout

*** 2454710.3751620371 / @2008-08-31 21:00:00 z=120 d=60 --> @2008-09-01 00:00:00 <== this is wrong ******* 
\end_layout

\begin_layout Plain Layout

 2454710.4168287036 / @2008-08-31 22:00:00 z=120 d=0 --> @2008-09-01 00:00:00 
\end_layout

\begin_layout Plain Layout

 2454832.4168171296 / @2008-12-31 21:59:59 z=120 d=0 --> @2008-12-31 23:59:59 *
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

THERE ARE TWO PROBLEMS HERE:
 
\end_layout

\begin_layout Plain Layout

1.
 In trying to implement 
\begin_inset Quotes eld
\end_inset

Palestine
\begin_inset Quotes erd
\end_inset

 until 2008-09-01 00:00w,
 we ignore the DST cancellation on 08-29;
\end_layout

\begin_layout Plain Layout

2.
 The wall transition time 2008-08-31 21:00:00 also falsely takes the DST into account.
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

Correct interpretation:
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

A.		2:00 Palestine	EE%sT	2008 Aug 29  0:00  <=
\end_layout

\begin_layout Plain Layout

Until 29 August 00:00,
 we're on Palestine:
\end_layout

\begin_layout Plain Layout

	A1.
 Rule Palestine	2007	only	-	Sep	13		2:00	0	-
\end_layout

\begin_layout Plain Layout

	FROM:
 2007-09-13 no DST
\end_layout

\begin_layout Plain Layout

	A2.
 Rule Palestine	2008	2009	-	Mar	lastFri   0:00	1:00	S
\end_layout

\begin_layout Plain Layout

	FROM:
 2008-03-lastFri DST=+1:00
\end_layout

\begin_layout Plain Layout

B.
 		2:00	-	EET	2008 Sep                  <=
\end_layout

\begin_layout Plain Layout

Until 1 September 00:00,
 we're on z+2,
 [*implicit* DST=0]!
\end_layout

\begin_layout Plain Layout

C.
 		2:00 Palestine	EE%sT	2010               <= 
\end_layout

\begin_layout Plain Layout

Until 2010,
 we're back on Palestine:
 this *does not* apply before 1 September 00:00w.
 
\end_layout

\begin_layout Plain Layout

	C1.
 Rule Palestine	2008	2009	-	Mar	lastFri   0:00	1:00	S
\end_layout

\begin_layout Plain Layout

	FROM:
 2008-03-lastFri DST=+1:00
\end_layout

\begin_layout Plain Layout

	C2.
 Rule Palestine	2008	only	-	Sep	 1		0:00	0	-
\end_layout

\begin_layout Plain Layout

	FROM:
 2009-09-01 00:00:00w,
 DST is explicitly zero.
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

IN OTHER WORDS,
 I have misinterpreted B.
 and allowed retrospective application of Palestine before end of B.
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

The problem is that B.
 applies *from* @2008-08-28 21:00:00 until 1 September.
 but,
 C1 is seen to establish DST+1:00 and then C2 is seen to extend from 1 hour before the transition,
 which is wrong.
 we cannot have a rule applying for any time before the transition,
 and actually taking effect.
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

Do we fix it in the creation or in the instantiation?
 Surely the former!
 DO NOT INSERT A RULE WHICH APPLIES BEFORE THE '-' *upto*!
 How can this even happen?
 
\end_layout

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout
** Processing Asia/Gaza 2008 (z=120|d=0):
 from @2007-12-31 22:00:00 to @2008-12-31 21:59:59
\end_layout

\begin_layout Plain Layout
runDST1=0 `:@1900-10-01 00:00:09,
 z=138,
 new DST=0--->wall:@1900-09-30 21:42:17`
\end_layout

\begin_layout Plain Layout
==> ZO left at 120
\end_layout

\begin_layout Plain Layout
ROW(1381) = 138 rule=- 1900-Oct-0 0:0 :
 @1900-09-30 21:42:08<-{120,0} (LMT) skip ROW,
 @2007-12-31 22:00:00 > @1900-09-30 21:42:08 `:@1948-05-15 00:00:09,
 z=120,
 new DST=0--->wall:@1948-05-14 22:00:09`
\end_layout

\begin_layout Plain Layout
==> ZO left at 120
\end_layout

\begin_layout Plain Layout
ROW(1382) = 120 rule=Zion 1948-May-15 0:0 :
 @1948-05-14 22:00:00<-{120,0} (EET/EEST) skip ROW,
 @2007-12-31 22:00:00 > @1948-05-14 22:00:00 `:@1967-06-05 00:00:09,
 z=120,
 new DST=0--->wall:@1967-06-04 22:00:09`
\end_layout

\begin_layout Plain Layout
==> ZO left at 120
\end_layout

\begin_layout Plain Layout
ROW(1383) = 120 rule=EgyptAsia 1967-Jun-5 0:0 :
 @1967-06-04 22:00:00<-{120,0} (EE%sT) skip ROW,
 @2007-12-31 22:00:00 > @1967-06-04 22:00:00 `:@1995-12-31 23:59:50,
 z=120,
 new DST=0--->wall:@1995-12-31 21:59:50`
\end_layout

\begin_layout Plain Layout
==> ZO left at 120
\end_layout

\begin_layout Plain Layout
ROW(1384) = 120 rule=Zion 1996-0-0 0:0 :
 @1995-12-31 22:00:00<-{120,0} (I%sT) skip ROW,
 @2007-12-31 22:00:00 > @1995-12-31 22:00:00 `:@1998-12-31 23:59:48,
 z=120,
 new DST=0--->wall:@1998-12-31 21:59:48`
\end_layout

\begin_layout Plain Layout
==> ZO left at 120
\end_layout

\begin_layout Plain Layout
ROW(1385) = 120 rule=Jordan 1999-0-0 0:0 :
 @1998-12-31 22:00:00<-{120,0} (EE%sT) skip ROW,
 @2007-12-31 22:00:00 > @1998-12-31 22:00:00 `:@2008-08-28 23:59:46,
 z=120,
 new DST=0--->wall:@2008-08-28 21:59:46`
\end_layout

\begin_layout Plain Layout
==> ZO changed from 120 to 120
\end_layout

\begin_layout Plain Layout
ROW(1386) = 120 rule=Palestine 2008-Aug-29 0:00 :
 @2008-08-28 22:00:00<-{120,0} (EE%sT)
\end_layout

\begin_layout Plain Layout
apply:
 [bias=120 carry=0 tr=@2008-08-28 22:00:00 lasttr=@_](
\end_layout

\begin_layout Plain Layout
Testing rule[1717]:
 2020,
 max,
 Mar,
 Sat>=24,
 0:00,
 0.0416666666666667-->
\end_layout

\begin_layout Plain Layout
--skip Palestine (2020)(
\end_layout

\begin_layout Plain Layout
Testing rule[1715]:
 2019,
 only,
 Mar,
 29,
 0:00,
 0.0416666666666667-->
\end_layout

\begin_layout Plain Layout
--skip Palestine (2019)(
\end_layout

\begin_layout Plain Layout
Testing rule[1713]:
 2016,
 2018,
 Mar,
 Sat>=24,
 1:00,
 0.0416666666666667-->
\end_layout

\begin_layout Plain Layout
--skip Palestine (2016)(
\end_layout

\begin_layout Plain Layout
Testing rule[1711]:
 2015,
 only,
 Mar,
 28,
 0:00,
 0.0416666666666667-->
\end_layout

\begin_layout Plain Layout
--skip Palestine (2015)(
\end_layout

\begin_layout Plain Layout
Testing rule[1707]:
 2012,
 2014,
 Mar,
 lastThu,
 24:00,
 0.0416666666666667-->
\end_layout

\begin_layout Plain Layout
--skip Palestine (2012)(
\end_layout

\begin_layout Plain Layout
Testing rule[1705]:
 2011,
 only,
 Aug,
 30,
 0:00,
 0.0416666666666667-->
\end_layout

\begin_layout Plain Layout
--skip Palestine (2011)(
\end_layout

\begin_layout Plain Layout
Testing rule[1703]:
 2011,
 only,
 Apr,
 1,
 0:01,
 0.0416666666666667-->
\end_layout

\begin_layout Plain Layout
--skip Palestine (2011)(
\end_layout

\begin_layout Plain Layout
Testing rule[1701]:
 2010,
 only,
 Mar,
 26,
 0:00,
 0.0416666666666667-->
\end_layout

\begin_layout Plain Layout
--skip Palestine (2010)(
\end_layout

\begin_layout Plain Layout
Testing rule[1698]:
 2008,
 2009,
 Mar,
 lastFri,
 0:00,
 0.0416666666666667--><zj 2008 3-28 0:00:0>
\end_layout

\begin_layout Plain Layout
* rule +60 2008-03-28 00:00:00 Palestine(2008) :
 from=2008 to=2009 Mar lastFri 0:00 (
\end_layout

\begin_layout Plain Layout
Testing rule[1695]:
 2006,
 2007,
 Apr,
 1,
 0:00,
 0.0416666666666667--><zj 2007 4-1 0:00:0>(
\end_layout

\begin_layout Plain Layout
Testing rule[1691]:
 1999,
 2005,
 Apr,
 Fri>=15,
 0:00,
 0.0416666666666667-->2453475.50015046 d=15 dow=5 <zj 2005 4-15 0:00:0>(
\end_layout

\begin_layout Plain Layout
Testing rule[1692]:
 1999,
 2003,
 Oct,
 Fri>=15,
 0:00,
 0-->2452927.50015046 d=15 dow=3 <zj 2003 10-17 0:00:0>(
\end_layout

\begin_layout Plain Layout
Testing rule[1693]:
 2004,
 only,
 Oct,
 1,
 1:00,
 0--><zj 2004 10-1 1:00:0>(
\end_layout

\begin_layout Plain Layout
Testing rule[1694]:
 2005,
 only,
 Oct,
 4,
 2:00,
 0--><zj 2005 10-4 2:00:0>(
\end_layout

\begin_layout Plain Layout
Testing rule[1696]:
 2006,
 only,
 Sep,
 22,
 0:00,
 0--><zj 2006 9-22 0:00:0>(
\end_layout

\begin_layout Plain Layout
Testing rule[1697]:
 2007,
 only,
 Sep,
 13,
 2:00,
 0--><zj 2007 9-13 2:00:0>(
\end_layout

\begin_layout Plain Layout
Testing rule[1699]:
 2008,
 only,
 Sep,
 1,
 0:00,
 0--><zj 2008 9-1 0:00:0>
\end_layout

\begin_layout Plain Layout
* rule OFF 2008-09-01 00:00:00 Palestine(2008) :
 from=2008 to=only Sep 1 0:00 (
\end_layout

\begin_layout Plain Layout
Testing rule[1700]:
 2009,
 only,
 Sep,
 4,
 1:00,
 0-->
\end_layout

\begin_layout Plain Layout
--skip Palestine (2009)(
\end_layout

\begin_layout Plain Layout
Testing rule[1702]:
 2010,
 only,
 Aug,
 11,
 0:00,
 0-->
\end_layout

\begin_layout Plain Layout
--skip Palestine (2010)(
\end_layout

\begin_layout Plain Layout
Testing rule[1704]:
 2011,
 only,
 Aug,
 1,
 0:00,
 0-->
\end_layout

\begin_layout Plain Layout
--skip Palestine (2011)(
\end_layout

\begin_layout Plain Layout
Testing rule[1706]:
 2011,
 only,
 Sep,
 30,
 0:00,
 0-->
\end_layout

\begin_layout Plain Layout
--skip Palestine (2011)(
\end_layout

\begin_layout Plain Layout
Testing rule[1708]:
 2012,
 only,
 Sep,
 21,
 1:00,
 0-->
\end_layout

\begin_layout Plain Layout
--skip Palestine (2012)(
\end_layout

\begin_layout Plain Layout
Testing rule[1709]:
 2013,
 only,
 Sep,
 27,
 0:00,
 0-->
\end_layout

\begin_layout Plain Layout
--skip Palestine (2013)(
\end_layout

\begin_layout Plain Layout
Testing rule[1710]:
 2014,
 only,
 Oct,
 24,
 0:00,
 0-->
\end_layout

\begin_layout Plain Layout
--skip Palestine (2014)(
\end_layout

\begin_layout Plain Layout
Testing rule[1712]:
 2015,
 only,
 Oct,
 23,
 1:00,
 0-->
\end_layout

\begin_layout Plain Layout
--skip Palestine (2015)(
\end_layout

\begin_layout Plain Layout
Testing rule[1714]:
 2016,
 2018,
 Oct,
 Sat>=24,
 1:00,
 0-->
\end_layout

\begin_layout Plain Layout
--skip Palestine (2016)(
\end_layout

\begin_layout Plain Layout
Testing rule[1716]:
 2019,
 only,
 Oct,
 Sat>=24,
 0:00,
 0-->
\end_layout

\begin_layout Plain Layout
--skip Palestine (2019)(
\end_layout

\begin_layout Plain Layout
Testing rule[1718]:
 2020,
 max,
 Oct,
 Sat>=24,
 1:00,
 0-->
\end_layout

\begin_layout Plain Layout
--skip Palestine (2020)
\end_layout

\begin_layout Plain Layout
Applying 3 rules (1):
 `:@2007-09-13 01:59:46,
 z=120,
 new DST=0--->wall:@2007-09-12 23:59:46`
\end_layout

\begin_layout Plain Layout
Rule:
 3 (1697) _ @2007-09-13 00:00:00 <--(,z120,
 d0) runDST7=0 `:@2008-03-27 23:59:46,
 z=120,
 new DST=0--->wall:@2008-03-27 21:59:46`
\end_layout

\begin_layout Plain Layout
Rule:
 2 (1698) * @2008-03-27 22:00:00 <--(,z120,
 d0)
\end_layout

\begin_layout Plain Layout
TESTING T=@2008-03-27 22:00:00,
 tr=@2008-08-28 22:00:00,
 delta=0
\end_layout

\begin_layout Plain Layout
Apply:
 Start DST
\end_layout

\begin_layout Plain Layout

\series bold
==>STORE @2008-03-27 22:00:00 d=0 z=120 /x runDST7=60 `:@2008-08-31 23:59:46,
 z=120,
 new DST=60--->wall:@2008-08-31 20:59:46`
\end_layout

\begin_layout Plain Layout
Rule:
 1 (1699) * @2008-08-31 21:00:00 <--(,z120,
 d60)
\end_layout

\begin_layout Plain Layout
TESTING T=@2008-08-31 21:00:00,
 tr=@2008-08-28 22:00:00,
 delta=60 *SKIP to END(Palestine :
 2008 0) as @2008-08-31 22:00:00 adjusted by 60 and 0 is above transition @2008-08-28 22:00:00
\end_layout

\begin_layout Plain Layout
apply returns:
 t=@2008-03-28 00:00:00,
 d=60
\end_layout

\begin_layout Plain Layout
runDST6=60 `:@2008-08-28 23:59:46,
 z=120,
 new DST=60--->wall:@2008-08-28 20:59:46`
\end_layout

\begin_layout Plain Layout

\series bold
==>STORE @2008-08-28 21:00:00 d=60 z=120 /z `:@2008-08-31 23:59:46,
 z=120,
 new DST=60--->wall:@2008-08-31 20:59:46`
\end_layout

\begin_layout Plain Layout
==> ZO changed from 120 to 120
\end_layout

\begin_layout Plain Layout
ROW(
\series bold
\size giant
1387
\series default
\size default
) = 120 rule=- 2008-Sep-0 0:0 :
 @2008-08-31 21:00:00<-{120,60} (EET) `:@2008-08-31 23:59:46,
 z=120,
 new DST=0--->wall:@2008-08-31 21:59:46`
\end_layout

\begin_layout Plain Layout

\series bold
\size giant
==>STORE @2008-08-31 22:00:00 d=0 z=120 /-
\end_layout

\begin_layout Plain Layout
runDST2=0 `:@2009-12-31 23:59:45,
 z=120,
 new DST=0--->wall:@2009-12-31 21:59:45`
\end_layout

\begin_layout Plain Layout
==> ZO finalised from 120 to 120
\end_layout

\begin_layout Plain Layout
ROW(1388) = 120 rule=Palestine 2010-0-0 0:0 :
 @2009-12-31 22:00:00<-{120,0} (EE%sT)
\end_layout

\begin_layout Plain Layout
apply:
 [bias=120 carry=0 tr=@_ lasttr=@2008-08-31 22:00:00](
\end_layout

\begin_layout Plain Layout
Testing rule[1717]:
 2020,
 max,
 Mar,
 Sat>=24,
 0:00,
 0.0416666666666667-->
\end_layout

\begin_layout Plain Layout
--skip Palestine (2020)(
\end_layout

\begin_layout Plain Layout
Testing rule[1715]:
 2019,
 only,
 Mar,
 29,
 0:00,
 0.0416666666666667-->
\end_layout

\begin_layout Plain Layout
--skip Palestine (2019)(
\end_layout

\begin_layout Plain Layout
Testing rule[1713]:
 2016,
 2018,
 Mar,
 Sat>=24,
 1:00,
 0.0416666666666667-->
\end_layout

\begin_layout Plain Layout
--skip Palestine (2016)(
\end_layout

\begin_layout Plain Layout
Testing rule[1711]:
 2015,
 only,
 Mar,
 28,
 0:00,
 0.0416666666666667-->
\end_layout

\begin_layout Plain Layout
--skip Palestine (2015)(
\end_layout

\begin_layout Plain Layout
Testing rule[1707]:
 2012,
 2014,
 Mar,
 lastThu,
 24:00,
 0.0416666666666667-->
\end_layout

\begin_layout Plain Layout
--skip Palestine (2012)(
\end_layout

\begin_layout Plain Layout
Testing rule[1705]:
 2011,
 only,
 Aug,
 30,
 0:00,
 0.0416666666666667-->
\end_layout

\begin_layout Plain Layout
--skip Palestine (2011)(
\end_layout

\begin_layout Plain Layout
Testing rule[1703]:
 2011,
 only,
 Apr,
 1,
 0:01,
 0.0416666666666667-->
\end_layout

\begin_layout Plain Layout
--skip Palestine (2011)(
\end_layout

\begin_layout Plain Layout
Testing rule[1701]:
 2010,
 only,
 Mar,
 26,
 0:00,
 0.0416666666666667-->
\end_layout

\begin_layout Plain Layout
--skip Palestine (2010)(
\end_layout

\begin_layout Plain Layout
Testing rule[1698]:
 2008,
 2009,
 Mar,
 lastFri,
 0:00,
 0.0416666666666667--><zj 2008 3-28 0:00:0>
\end_layout

\begin_layout Plain Layout
* rule +60 2008-03-28 00:00:00 Palestine(2008) :
 from=2008 to=2009 Mar lastFri 0:00 (
\end_layout

\begin_layout Plain Layout
Testing rule[1695]:
 2006,
 2007,
 Apr,
 1,
 0:00,
 0.0416666666666667--><zj 2007 4-1 0:00:0>(
\end_layout

\begin_layout Plain Layout
Testing rule[1691]:
 1999,
 2005,
 Apr,
 Fri>=15,
 0:00,
 0.0416666666666667-->2453475.50015046 d=15 dow=5 <zj 2005 4-15 0:00:0>(
\end_layout

\begin_layout Plain Layout
Testing rule[1692]:
 1999,
 2003,
 Oct,
 Fri>=15,
 0:00,
 0-->2452927.50015046 d=15 dow=3 <zj 2003 10-17 0:00:0>(
\end_layout

\begin_layout Plain Layout
Testing rule[1693]:
 2004,
 only,
 Oct,
 1,
 1:00,
 0--><zj 2004 10-1 1:00:0>(
\end_layout

\begin_layout Plain Layout
Testing rule[1694]:
 2005,
 only,
 Oct,
 4,
 2:00,
 0--><zj 2005 10-4 2:00:0>(
\end_layout

\begin_layout Plain Layout
Testing rule[1696]:
 2006,
 only,
 Sep,
 22,
 0:00,
 0--><zj 2006 9-22 0:00:0>(
\end_layout

\begin_layout Plain Layout
Testing rule[1697]:
 2007,
 only,
 Sep,
 13,
 2:00,
 0--><zj 2007 9-13 2:00:0>(
\end_layout

\begin_layout Plain Layout
Testing rule[1699]:
 2008,
 only,
 Sep,
 1,
 0:00,
 0--><zj 2008 9-1 0:00:0>
\end_layout

\begin_layout Plain Layout
* rule OFF 2008-09-01 00:00:00 Palestine(2008) :
 from=2008 to=only Sep 1 0:00 (
\end_layout

\begin_layout Plain Layout
Testing rule[1700]:
 2009,
 only,
 Sep,
 4,
 1:00,
 0-->
\end_layout

\begin_layout Plain Layout
--skip Palestine (2009)(
\end_layout

\begin_layout Plain Layout
Testing rule[1702]:
 2010,
 only,
 Aug,
 11,
 0:00,
 0-->
\end_layout

\begin_layout Plain Layout
--skip Palestine (2010)(
\end_layout

\begin_layout Plain Layout
Testing rule[1704]:
 2011,
 only,
 Aug,
 1,
 0:00,
 0-->
\end_layout

\begin_layout Plain Layout
--skip Palestine (2011)(
\end_layout

\begin_layout Plain Layout
Testing rule[1706]:
 2011,
 only,
 Sep,
 30,
 0:00,
 0-->
\end_layout

\begin_layout Plain Layout
--skip Palestine (2011)(
\end_layout

\begin_layout Plain Layout
Testing rule[1708]:
 2012,
 only,
 Sep,
 21,
 1:00,
 0-->
\end_layout

\begin_layout Plain Layout
--skip Palestine (2012)(
\end_layout

\begin_layout Plain Layout
Testing rule[1709]:
 2013,
 only,
 Sep,
 27,
 0:00,
 0-->
\end_layout

\begin_layout Plain Layout
--skip Palestine (2013)(
\end_layout

\begin_layout Plain Layout
Testing rule[1710]:
 2014,
 only,
 Oct,
 24,
 0:00,
 0-->
\end_layout

\begin_layout Plain Layout
--skip Palestine (2014)(
\end_layout

\begin_layout Plain Layout
Testing rule[1712]:
 2015,
 only,
 Oct,
 23,
 1:00,
 0-->
\end_layout

\begin_layout Plain Layout
--skip Palestine (2015)(
\end_layout

\begin_layout Plain Layout
Testing rule[1714]:
 2016,
 2018,
 Oct,
 Sat>=24,
 1:00,
 0-->
\end_layout

\begin_layout Plain Layout
--skip Palestine (2016)(
\end_layout

\begin_layout Plain Layout
Testing rule[1716]:
 2019,
 only,
 Oct,
 Sat>=24,
 0:00,
 0-->
\end_layout

\begin_layout Plain Layout
--skip Palestine (2019)(
\end_layout

\begin_layout Plain Layout
Testing rule[1718]:
 2020,
 max,
 Oct,
 Sat>=24,
 1:00,
 0-->
\end_layout

\begin_layout Plain Layout
--skip Palestine (2020)
\end_layout

\begin_layout Plain Layout
Applying 3 rules (1):
 `:@2007-09-13 01:59:46,
 z=120,
 new DST=0--->wall:@2007-09-12 23:59:46`
\end_layout

\begin_layout Plain Layout
Rule:
 3 (1697) _ @2007-09-13 00:00:00 <--(,z120,
 d0) runDST7=0 `:@2008-03-27 23:59:46,
 z=120,
 new DST=0--->wall:@2008-03-27 21:59:46`
\end_layout

\begin_layout Plain Layout

\series bold
\size giant
Rule:
 2 (1698) * @2008-03-27 22:00:00 <--(,z120,
 d0) 0 runDST7=60 `:@2008-08-31 23:59:46,
 z=120,
 new DST=60--->wall:@2008-08-31 20:59:46`
\end_layout

\begin_layout Plain Layout

\series bold
\size giant
Rule:
 1 (1699) * @2008-08-31 21:00:00 <--(,z120,
 d60)
\end_layout

\begin_layout Plain Layout
TESTING T=@2008-08-31 21:00:00,
 tr=@_,
 delta=60
\end_layout

\begin_layout Plain Layout
Apply:
 End DST.
\end_layout

\begin_layout Plain Layout

\series bold
\size giant
==>STORE @2008-08-31 21:00:00 d=60 z=120 /x runDST7=0
\end_layout

\begin_layout Plain Layout
apply returns:
 t=@2008-08-31 23:00:00,
 d=0
\end_layout

\begin_layout Plain Layout
runDST5=0
\end_layout

\begin_layout Plain Layout

\series bold
==>STORE @2008-12-31 21:59:59 d=0 z=120 /y
\end_layout

\begin_layout Plain Layout
STORED RULES:
 zone=Asia/Gaza|3298 year=2008,
 n=5 @2007-12-31 22:00:00<-->@2008-12-31 21:59:59
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

  my($ins);
\end_layout

\begin_layout Plain Layout

  my($kept_tran,
 $kept_dst,
 $kept_zoff)=(0,0,0);
\end_layout

\begin_layout Plain Layout

foreach $ins (@STORAGE)
\end_layout

\begin_layout Plain Layout

  { my($tran,
 $dst,
 $zoff,
 $mod,
 $type,
 $IGNORED) = @$ins;
   # retrieve stored values 
\end_layout

\begin_layout Plain Layout

    # Retrieved values for $tran,
 $dst,
 $zoff are in *seconds*
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

    # Sort out the 'Aqtau' issue:
\end_layout

\begin_layout Plain Layout

    my($deltaz) = $zoff - $kept_zoff;
 
\end_layout

\begin_layout Plain Layout

  if( &CloseEnough($tran + $deltaz,
 $kept_tran) ) # [smarter than == ]
\end_layout

\begin_layout Plain Layout

    { # Once adjusted for zone offset change,
 we have a collision:
 
\end_layout

\begin_layout Plain Layout

      $tran = $kept_tran;
 
\end_layout

\begin_layout Plain Layout

    };
 
\end_layout

\begin_layout Plain Layout

    # end 'Aqtau'.
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

    my($isdup) = ( ($kept_tran == $tran)
\end_layout

\begin_layout Plain Layout

               &&($kept_dst == $dst)
\end_layout

\begin_layout Plain Layout

               &&($kept_zoff == $zoff)
\end_layout

\begin_layout Plain Layout

               );
 
\end_layout

\begin_layout Plain Layout

  if($isdup)
\end_layout

\begin_layout Plain Layout

    { Timely::XPrint( 0,
 
\begin_inset Quotes eld
\end_inset


\backslash
n  Redundant tz entry $year:
 (
\begin_inset Quotes eld
\end_inset

 .
 &JulianDay($tran) 
\end_layout

\begin_layout Plain Layout

                .
 
\begin_inset Quotes eld
\end_inset

) (d=
\begin_inset Quotes eld
\end_inset

 .
 &Tim($dst) .
 ';z=' .
 &Tim($zoff) .
 
\begin_inset Quotes eld
\end_inset

) zone=$zone,
 
\begin_inset Quotes eld
\end_inset

 
\end_layout

\begin_layout Plain Layout

                .
 &JulianDay($YearBot) .
 
\begin_inset Quotes eld
\end_inset

 -- 
\begin_inset Quotes eld
\end_inset

 .
 &JulianDay($YearTop) 
\end_layout

\begin_layout Plain Layout

                .
 ' dst max=' .
 &Tim(MAXDST) .
 ' z max=' .
 &Tim(MAXZOFF) );
 
\end_layout

\begin_layout Plain Layout

    }
\end_layout

\begin_layout Plain Layout

  elsif( ($tran < $YearBot)
\end_layout

\begin_layout Plain Layout

        ||($tran > $YearTop)
\end_layout

\begin_layout Plain Layout

 ##     ||($dst < 0)  ## NO!
 $dst can be < 0 [explore in detail 4/12/2020] 
\end_layout

\begin_layout Plain Layout

        ||( abs($zoff) > MAXZOFF) # [ideally need test rtn]
\end_layout

\begin_layout Plain Layout

        ||( $dst > MAXDST)        # [likewise]
\end_layout

\begin_layout Plain Layout

       )
\end_layout

\begin_layout Plain Layout

    { Timely::XPrint(0,
 "
\backslash
n       *DEFECTIVE* timely entry suppressed:
 " 
\end_layout

\begin_layout Plain Layout

        .
 ' d=' .
 &Tim($dst) .
 ' max=' .
 &Tim(MAXDST) 
\end_layout

\begin_layout Plain Layout

        .
 ' z=' .
 &Tim($zoff) .
 ' max=' .
 &Tim(MAXZOFF)
\end_layout

\begin_layout Plain Layout

        .
 " $mod/$type> ");
    # [consider forcing an error]
\end_layout

\begin_layout Plain Layout

    } else # not defective:
 
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
Not defective:
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

    { ($kept_tran,
 $kept_dst,
 $kept_zoff) = ($tran,
 $dst,
 $zoff);
 
\end_layout

\begin_layout Plain Layout

      my($HTRAN)= &MegaDate($tran);
 # convert to big integer,
 from 'Julian day' value
\end_layout

\begin_layout Plain Layout

      my($HDST) = &MegaDate($dst);
\end_layout

\begin_layout Plain Layout

      my($HZOFF)= &MegaDate($zoff);
\end_layout

\begin_layout Plain Layout

       
\end_layout

\begin_layout Plain Layout

    if($SingleZone)
\end_layout

\begin_layout Plain Layout

      { print " !
\begin_inset Quotes erd
\end_inset

 .
 &JulianDay($tran) .
 
\begin_inset Quotes eld
\end_inset

(" .
 &Dat($tran) .
 ') d=' .
 &Tim($dst) 
\end_layout

\begin_layout Plain Layout

            .
 ' z=' .
 &Tim($zoff) .
 " $mod/$type" ;
\end_layout

\begin_layout Plain Layout

      } else  # currently do NOT alter SQL if single zone:
 
\end_layout

\begin_layout Plain Layout

      { 
\end_layout

\begin_layout Plain Layout

        my($qq) = "SELECT zone_offset,
 dst FROM timely " 
\end_layout

\begin_layout Plain Layout

                .
 "WHERE region=$region and transition=$HTRAN";
 
\end_layout

\begin_layout Plain Layout

          ## Do *not* include year,
 allows duplicate transitions at year borders
\end_layout

\begin_layout Plain Layout

          ## .
 "WHERE region=$region and year=$year and transition=$HTRAN";
\end_layout

\begin_layout Plain Layout

        my($oz,
 $od) = Timely::GetSQL($handDB,
 $qq,
 'ensure no duplicate');
\end_layout

\begin_layout Plain Layout

        # NB.
 these values are microseconds.
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

      if(defined $oz)
\end_layout

\begin_layout Plain Layout

        { my($HOZ) = Timely::HugeToJ($oz);
\end_layout

\begin_layout Plain Layout

          my($HOD) = Timely::HugeToJ($od);
 # convert to Julian fragment 
\end_layout

\begin_layout Plain Layout

        if(  &CloseEnough($HOZ,
 $zoff)
\end_layout

\begin_layout Plain Layout

          && &CloseEnough($HOD,
 $dst)
\end_layout

\begin_layout Plain Layout

          ) ## if concordant 
\end_layout

\begin_layout Plain Layout

          { &TimeWarn('Duplicate timely entry (' .
 &Tim($zoff) .
 ',
 ' 
\end_layout

\begin_layout Plain Layout

                    .
 &Tim($dst) .
 
\begin_inset Quotes eld
\end_inset

) 
\begin_inset Quotes eld
\end_inset

 ## .
 
\begin_inset Quotes eld
\end_inset

as <$qq>
\begin_inset Quotes erd
\end_inset

  
\end_layout

\begin_layout Plain Layout

            .
 &Tim( Timely::HugeToJ($oz) ) .
 ',
 ' .
 &Tim( Timely::HugeToJ($od) ),
   
\end_layout

\begin_layout Plain Layout

                    55,
 $zone,
 $year);
\end_layout

\begin_layout Plain Layout

          } else # discordant
\end_layout

\begin_layout Plain Layout

          { Timely::XPrint(0,
 
\begin_inset Quotes eld
\end_inset


\backslash
nIGNORED discord:
 Z=
\begin_inset Quotes eld
\end_inset

 .
 &Tim($zoff) .
 ' ' .
 &Tim($HOZ) 
\end_layout

\begin_layout Plain Layout

                    .
 ';
 DST=' .
 &Tim($dst) .
 ' ' .
 &Tim($HOD) 
\end_layout

\begin_layout Plain Layout

                    .
 
\begin_inset Quotes eld
\end_inset

;
 zone=$REZONE{$region} ($region),
 transition=
\begin_inset Quotes erd
\end_inset

 .
 &Dat($tran) 
\end_layout

\begin_layout Plain Layout

                  );
\end_layout

\begin_layout Plain Layout

           # These do not impact on existing transitions.
 Do NOT translate/amend!
 
\end_layout

\begin_layout Plain Layout

          };
 
\end_layout

\begin_layout Plain Layout

        } else # not duplicate 
\end_layout

\begin_layout Plain Layout

        { my($tkey) = Timely::FetchKey('timely',
 'timely code');
 
\end_layout

\begin_layout Plain Layout

          my($qi) = "INSERT INTO timely (timekey,
 region,
 year,
 transition,
 
\begin_inset Quotes eld
\end_inset

 
\end_layout

\begin_layout Plain Layout

                   .
 
\begin_inset Quotes eld
\end_inset

zone_offset,
 dst,
 ignored)"
\end_layout

\begin_layout Plain Layout

           .
 "VALUES ($tkey,
 $region,
 $year,
 $HTRAN,
 $HZOFF,
 $HDST,
 $IGNORED)";
 
\end_layout

\begin_layout Plain Layout

           # [?
 ver,
 chk] 
\end_layout

\begin_layout Plain Layout

        if( Timely::DoSQL($handDB,
 $qi,
 'insert row') < 0)
\end_layout

\begin_layout Plain Layout

          { &Aagh("failed to insert row ($qi)",
 __LINE__,
 0);
 
\end_layout

\begin_layout Plain Layout

            return;
\end_layout

\begin_layout Plain Layout

          };
\end_layout

\begin_layout Plain Layout

        };
 # end else (not duplicate) 
\end_layout

\begin_layout Plain Layout

      };
  # end else (not single zone) 
\end_layout

\begin_layout Plain Layout

       
\end_layout

\begin_layout Plain Layout

    };
  # end else (not defective)
\end_layout

\begin_layout Plain Layout

  };
  # end foreach
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Subsubsection
Close enough
\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
Use this more widely?
\end_layout

\end_inset

Ensure two numbers are within an `epsilon' of one another.
 The submitted values should be Julian day numbers or fragments of a day.
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

sub CloseEnough # 
\end_layout

\begin_layout Plain Layout

{ my($J,
 $K) = @_;
\end_layout

\begin_layout Plain Layout

  return( abs($J-$K) < EPSILONSECONDS );
 
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
[not a very good rtn]
\end_layout

\end_inset


\end_layout

\begin_layout Subsubsection
Big Julian number
\begin_inset CommandInset label
LatexCommand label
name "subsec:Big-Julian-number__MegaDate"

\end_inset


\end_layout

\begin_layout Standard
Formerly converted Julian day number to microseconds;
 now simply multiply by 1M.
 
\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
Convert from Julian day number to microseconds (big integer) —
 would seem easy to 
\begin_inset Quotes eld
\end_inset

just multiply
\begin_inset Quotes erd
\end_inset

 but precision is poor.
 We hack this,
 at present,
 as big integer multiplication in Perl has previously had 
\begin_inset Quotes eld
\end_inset

side-effects
\begin_inset Quotes erd
\end_inset

 for me,
 and I haven't explored recent improvements,
 if there are any.
\end_layout

\end_inset


\end_layout

\begin_layout Standard

\emph on
\begin_inset Note Note
status open

\begin_layout Plain Layout

\emph on
[FIX THE FOLLOWING,
 USE Math::BigInt,
 but Nb return value as a string,
 not a big integer!]
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

sub MegaDate #
\end_layout

\begin_layout Plain Layout

{ my($d);
\end_layout

\begin_layout Plain Layout

    ($d)=@_;
\end_layout

\begin_layout Plain Layout

if(!
 defined $d)
\end_layout

\begin_layout Plain Layout

  {  # [warn here?]
\end_layout

\begin_layout Plain Layout

    return(0);
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

if( length($d) < 2)   # '0' will match,
 as will ''
\end_layout

\begin_layout Plain Layout

  { # [warn here?] 
\end_layout

\begin_layout Plain Layout

    return(0);
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

if ($d !~ /^-?
\backslash
d+
\backslash
.?
\backslash
d*$/ ) # at present don't allow leading/trailing space.
 
\end_layout

\begin_layout Plain Layout

   { Timely::XPrint(0,
 "
\backslash
nBad number for Julian day in seconds '$d'");
  # [?
 &Aagh_()]
\end_layout

\begin_layout Plain Layout

     &LogError("Bad number for Julian day '$d'");
 # [Who will read the log?] 
\end_layout

\begin_layout Plain Layout

     return(0);
 
\end_layout

\begin_layout Plain Layout

   };
\end_layout

\begin_layout Plain Layout

  
\end_layout

\begin_layout Plain Layout

  return($d*1000000);
 # KISS.
 
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Subsubsection
Running zone
\end_layout

\begin_layout Standard
The first five arguments are all values in seconds;
 the last is Boolean.
 
\end_layout

\begin_layout Standard
If current cutoff Julian time (
\family typewriter
$j
\family default
) is within this year (between 
\family typewriter
$lo
\family default
 and 
\family typewriter
$hi
\family default
),
 return the zone offset supplied in the first parameter.
 Otherwise,
 the basic idea is that if it's earlier,
 return the current value (in 
\family typewriter
$ZO
\family default
);
 if it's later,
 then return the value that obtains after the end of the year,
 as this extends backwards in time to affect the current year (Zone rules work backwards).
 There is a catch,
 in that once we've encountered a rule subsequent to the current year,
 then we do NOT wish to overwrite this with any later rules,
 which can never apply.
 Hence the clumsy use of the Boolean value 
\family typewriter
$TOPPED
\family default
,
 which tops off the value.
 
\end_layout

\begin_layout Standard
In other words,
 the value returned is always the most recent zone offset that applies before or to the current year.
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

sub TryZone # 
\end_layout

\begin_layout Plain Layout

{ my($GMTOFF,
 $j,
 $lo,
 $hi,
 $ZO,
 $TOPPED) = @_;
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

if($j >= $lo && $j < $hi)
\end_layout

\begin_layout Plain Layout

  { #&Debug(0,
 "
\backslash
n==> ZO changed from " .
 &Tim($ZO) .
 " to " .
 &Tim($GMTOFF));
\end_layout

\begin_layout Plain Layout

    return($GMTOFF,
 0);
 
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

if( ($j < $lo)
\end_layout

\begin_layout Plain Layout

  || $TOPPED
\end_layout

\begin_layout Plain Layout

  )
\end_layout

\begin_layout Plain Layout

  { #&Debug(0,
 "
\backslash
n==> ZO left at " .
 &Tim($ZO) );
\end_layout

\begin_layout Plain Layout

    return($ZO,
 $TOPPED);
 
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

  ## if $TOPPED NOT set AND $j >= $hi
\end_layout

\begin_layout Plain Layout

    #&Debug(0,
 "
\backslash
n==> ZO finalised from " .
 &Tim($ZO) .
 " to " .
 &Tim($GMTOFF) );
\end_layout

\begin_layout Plain Layout

  return($GMTOFF,
 1);
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
After establishing it,
 it's important 
\emph on
not 
\emph default
to alter the first returned parameter,
 as this is [currently,
 at least] the lead-in zone offset for the current year.
 Must amalgamate with Between
\begin_inset space ~
\end_inset

() below.
\end_layout

\end_inset


\end_layout

\begin_layout Subsubsection
Simple 
\begin_inset Quotes eld
\end_inset

between
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Standard
The lower limit is included,
 the upper,
 excluded.
 Alter zone transition if in the transition period,
 otherwise return the old value.
 
\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
The zone offset we record is the first zone offset for the year of interest.
 There are several possibilities —
 first,
 the only applicable rule may refer to a year that is after the 
\begin_inset Quotes eld
\end_inset

year of interest
\begin_inset Quotes erd
\end_inset

,
 in which case the zone offset for that rule applies.
 Second,
 there may be more than one zone referred to in the year of interest,
 in which case the first zone offset for that year is taken as the zone offset.
 As we never submit an offset for an inapplicable rule (one that terminated before the start of the year of interest),
 the decision is simple:
 return the old value unless it's -999,
 which signals a zone offset that hasn't yet been set!
\end_layout

\end_inset


\end_layout

\begin_layout Standard

\family typewriter
$ZO
\family default
 is used to track current zone offset,
 whatever.
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

sub Between # 
\end_layout

\begin_layout Plain Layout

{ my($zone_transition,
 $j,
 $lo,
 $hi) = @_;
\end_layout

\begin_layout Plain Layout

if($j >= $lo && $j < $hi)
\end_layout

\begin_layout Plain Layout

  { 
\end_layout

\begin_layout Plain Layout

    #&Debug(0,
 '<yes>');
\end_layout

\begin_layout Plain Layout

    return($j);
 
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

  #&Debug(0,
 '<no>');
\end_layout

\begin_layout Plain Layout

  return($zone_transition);
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim} 
\end_layout

\end_inset


\end_layout

\begin_layout Section
Apply rule
\begin_inset CommandInset label
LatexCommand label
name "subsec:Apply-rule-tz"

\end_inset


\end_layout

\begin_layout Standard
Only invoked from within ZoneYear
\begin_inset space ~
\end_inset

(
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:TZ-zone-data-for-one-year"
plural "false"
caps "false"
noprefix "false"
nolink "false"

\end_inset

).
 Given the `name' of a rule in 
\family typewriter
$rnam
\family default
 (which may simply be an offset —
 this we ignore)
\begin_inset Note Note
status open

\begin_layout Plain Layout
[explain,
 explore]
\end_layout

\end_inset

,
 determine whether the rule applies to the 
\family typewriter
$zone
\family default
 for this year (
\family typewriter
$yr
\family default
).
 Invokes Store
\begin_inset space ~
\end_inset

() as appropriate.
 
\end_layout

\begin_layout Standard
We also supply the current zone offset,
 and the carried over DST from the preceding year (or zero if there was no carry over).
 A clumsy revision of my clunky original.
 A good source of rule specifications is the file 
\emph on
zic.8.txt
\emph default
 located within the 
\emph on
tzcode20???.gz
\emph default
 zipped file obtained from IANA.
 
\begin_inset Note Note
status collapsed

\begin_layout Plain Layout
[NB.
 Look into zdump as described in 
\emph on
zdump.txt
\emph default
]
\end_layout

\end_inset

 For a fair overview,
 see 
\begin_inset CommandInset href
LatexCommand href
name "http://www.cstdbill.com/tzdb/tz-how-to.html"
target "http://www.cstdbill.com/tzdb/tz-how-to.html"
literal "false"

\end_inset

.
\end_layout

\begin_layout Enumerate
Identify all rules that apply to this year (
\family typewriter
$yr
\family default
) from the rule set in 
\family typewriter
$rnam
\family default
.
 Remember that rules apply 
\emph on
prospectively
\emph default
,
 unlike transitions.
 
\end_layout

\begin_layout Enumerate
Actually apply the rules to generate daylight saving timestamps:
 a start time,
 an end time,
 and a DST offset.
 This is made difficult because:
\begin_inset Separator latexpar
\end_inset


\end_layout

\begin_deeper
\begin_layout Enumerate
Starting and ending rules may have different years;
\end_layout

\begin_layout Enumerate
The specified day for this year can be something like 
\begin_inset Quotes eld
\end_inset

The first Sunday 
\emph on
after
\emph default
 the 7th of August
\begin_inset Quotes erd
\end_inset

,
 or even 
\emph on
before
\emph default
 a date.
 
\end_layout

\begin_deeper
\begin_layout Enumerate
The 
\begin_inset Quotes eld
\end_inset

first
\begin_inset Quotes erd
\end_inset

 can wrap around to a succeeding or even back to a previous month.
 
\end_layout

\end_deeper
\begin_layout Enumerate
Reference times may be GMT,
 local time (excluding currently applicable DST),
 or 
\begin_inset Quotes eld
\end_inset

wall time
\begin_inset Quotes erd
\end_inset

 (which includes current DST).
\end_layout

\begin_layout Enumerate
DST can be carried from one year to the next.
\end_layout

\begin_layout Enumerate
There may potentially be multiple episodes of 
\begin_inset Quotes eld
\end_inset

turning on
\begin_inset Quotes erd
\end_inset

 and 
\begin_inset Quotes eld
\end_inset

turning off
\begin_inset Quotes erd
\end_inset

 of DST within a given year.
\end_layout

\end_deeper
\begin_layout Standard
The 
\family typewriter
$zone_transition
\family default
 variable is interesting as you'd think that any rule can only logically apply between the preceding transition and the current transition in this variable.
 For example,
 if a zone line specifies C-Eur applies up till 1945,
 and the preceding transition is 18 April 1941 at 23:00 (wall time),
 then when we apply a rule to 1941,
 we'd expect the C-Eur rules for 1941 only to apply after 18 April.
 There is however a catch.
 DST in this instance was established on April 1 1940 (at 2:00s) and not repealed until November 2 1942 at 2:00s.
 
\end_layout

\begin_layout Subsection
A further problem
\end_layout

\begin_layout Standard
There's yet another issue.
 When we apply a DST-changing rule,
 the wall time will be affected.
 It is common to determine transition times based on wall time,
 so after we've changed DST,
 the relationship between any 
\begin_inset Quotes eld
\end_inset

UTC
\begin_inset Quotes erd
\end_inset

 time and the specified wall time will change.
 Now if you go back to ZoneYear
\begin_inset space ~
\end_inset

(
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:TZ-zone-data-for-one-year"
nolink "false"

\end_inset

) and examine it carefully,
 it extracts one or more zone rules and applies them.
 Each such rule will contain a transition time—
and this was determined using the 
\begin_inset Quotes eld
\end_inset

then
\begin_inset Quotes erd
\end_inset

 DST and zone offset values.
 
\end_layout

\begin_layout Standard
If these change,
 we need to amend the subsequent transition times!
 The invoker can do this,
 simply knowing the old and new DST values.
 We thus return the value 
\family typewriter
$RUNNING_DST
\family default
,
 supplied as 
\family typewriter
$DSTCARRY
\family default
.
 
\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
[what about 
\begin_inset Quotes eld
\end_inset

RUNNING_ZONE_TIME
\begin_inset Quotes erd
\end_inset

 ??
 [explore,
 although the current regimen works.]]
\end_layout

\end_inset


\end_layout

\begin_layout Subsection
Yet more
\end_layout

\begin_layout Standard
There's another issue,
 exemplified by Asia/Gaza around 27 August–1 September.
 A simple zone rule applies until 1 September 00:00 wall time,
 but an incautious subsequent invocation of Palestine creates a spurious short-lived,
 apparent rule just before the termination of the zone rule!
 This can however be trapped by Store
\begin_inset space ~
\end_inset

(),
 which will only store a rule if the timestamp provided is after 
\family typewriter
$LASTTRAN
\family default
.
 
\end_layout

\begin_layout Subsection
Return values
\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
[explain]
\end_layout

\end_inset

Two values are returned:
\end_layout

\begin_layout Description
$STOREDOK The result of the most recent Store
\begin_inset space ~
\end_inset

() invocation.
 If none occurred,
 then zero.
 Note that Store
\begin_inset space ~
\end_inset

() can return a value of zero,
 if nothing was stored.
 
\end_layout

\begin_layout Description
$RUNNING_DST As above,
 the current DST that prevails on leaving.
 This starts off as 
\family typewriter
$DSTCARRY
\family default
,
 but can take on a new value including zero.
 
\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
\begin_inset Separator plain
\end_inset


\end_layout

\begin_layout Plain Layout
The return of zero in 
\family typewriter
$STOREDOK
\family default
 needs a bit of investigation.
 It can occur if:
\end_layout

\begin_layout Itemize
There's a rule definition error;
\end_layout

\begin_layout Itemize
There's no rule match.
\end_layout

\end_inset


\end_layout

\begin_layout Subsection
Code
\begin_inset CommandInset label
LatexCommand label
name "subsec:Code-Apply-Rule"

\end_inset


\end_layout

\begin_layout Standard
Submitted parameters:
\end_layout

\begin_layout Description
zone name of zone
\end_layout

\begin_layout Description
yr year eg.
 2001
\end_layout

\begin_layout Description
rnam the rule name
\end_layout

\begin_layout Description
DSTCARRY DST carried in to rule,
 in seconds 
\end_layout

\begin_layout Description
zone_transition set to a transition value if a transition is present,
 in seconds
\end_layout

\begin_layout Description
LASTTRAN prior transition [explore,
 notably the value in 
\family typewriter
$DSTCARRY
\family default
],
 in seconds
\end_layout

\begin_layout Description
CURRENT_ZO the zone offset that currently pertains,
 in seconds
\end_layout

\begin_layout Description
LASTZO Most recent zone offset,
 in seconds
\end_layout

\begin_layout Description
SingleZone Are we simply 
\emph on
debugging
\emph default
 a single zone?
 (1;
 otherwise 0).
 
\end_layout

\begin_layout Standard
We continually keep track of the current DST in 
\family typewriter
$RUNNING_DST
\family default
.
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

sub ApplyRule # 
\end_layout

\begin_layout Plain Layout

    # [the utility of the $LASTZO parameter seems doubtful:
 check me!]
\end_layout

\begin_layout Plain Layout

{ my($zone,
 $yr,
 $rnam,
 $DSTCARRY,
 $zone_transition,
 $LASTTRAN,
 $CURRENT_ZO,
 
\end_layout

\begin_layout Plain Layout

     $LASTZO,
 $SingleZone) = @_;
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

if($SingleZone)
\end_layout

\begin_layout Plain Layout

  { print 
\begin_inset Quotes eld
\end_inset

[$rnam] 
\begin_inset Quotes erd
\end_inset

;
\end_layout

\begin_layout Plain Layout

  };
 
\end_layout

\begin_layout Plain Layout

  my($zoneinfo) = 
\begin_inset Quotes eld
\end_inset

$zone|$yr|$rnam
\begin_inset Quotes erd
\end_inset

;
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  my($RUNNING_DST) = $DSTCARRY;
\end_layout

\begin_layout Plain Layout

  my($STOREDOK) = 0;
 
\end_layout

\begin_layout Plain Layout

  my($DELTA_Z) = $CURRENT_ZO - $LASTZO;
  # find any change in zone offset
\end_layout

\begin_layout Plain Layout

      #  from when original timestamp was determined.
 Must subtract from original 
\end_layout

\begin_layout Plain Layout

    my($dst_defer_start,
 $dst_defer_offset,
 $dst_defer_T) = (0,0,0);
 # see below
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
\begin_inset ERT
status open

\begin_layout Plain Layout

#  &Debug(0,"
\backslash
n  apply:
 [bias=" .
 &Tim($CURRENT_ZO) .
 " carry=" .
 &Tim($DSTCARRY)
\end_layout

\begin_layout Plain Layout

#         .
 " tr=" .
 &Dat($zone_transition) .
 " lasttr=" .
 &Dat($LASTTRAN) 
\end_layout

\begin_layout Plain Layout

#         .
 "]" );
 
\end_layout

\begin_layout Plain Layout

    my($dst_defer_start,
 $dst_defer_offset,
 $dst_defer_T) = (0,0,0);
 # peculiar use below
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Subsection
A rule
\end_layout

\begin_layout Standard
Look up the rule by name:
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

  my($rv) = $RULES{$rnam};
  # assume exists
\end_layout

\begin_layout Plain Layout

if( ref($rv) ne "ARRAY" )
\end_layout

\begin_layout Plain Layout

    { Timely::XPrint(0,
  "
\backslash
n ERROR ***Bad definition*** for rule $rnam:
 ($yr) " 
\end_layout

\begin_layout Plain Layout

            .
 ref($rv) ) ;
\end_layout

\begin_layout Plain Layout

      return(0,$RUNNING_DST);
\end_layout

\begin_layout Plain Layout

    };
\end_layout

\begin_layout Plain Layout

  my(@R) = @$rv;
    # dereference    
\end_layout

\begin_layout Plain Layout

  my($r);
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  my(%OFFSET) = ();
 # will associate timestamp with offset!
\end_layout

\begin_layout Plain Layout

  my(%SUFFIX) = ();
 # used for TZ suffixes associated with a timestamp
\end_layout

\begin_layout Plain Layout

  my(%CURRENT)= ();
 # only true if $yr WITHIN RANGE of specified rule,
 default false
\end_layout

\begin_layout Plain Layout

  my(%IDS) = ();
 # for rule IDs
\end_layout

\begin_layout Plain Layout

  # [explore zone time change/DST change alters timestamp order once suffix applied!?]
\end_layout

\begin_layout Plain Layout

  # [this is theoretical rather than a concern]
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  # an optimisation [see usage]:
\end_layout

\begin_layout Plain Layout

  my($CARRYOVER) = 0;
     # value is Julian seconds.
 
\end_layout

\begin_layout Plain Layout

  my($CARRYsuffix) = '';
\end_layout

\begin_layout Plain Layout

  my($CARRYsave) = '';
\end_layout

\begin_layout Plain Layout

  my($CARRYid) = '';
 
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Subsection
Does the rule apply?
\begin_inset CommandInset label
LatexCommand label
name "subsec:Does-a-rule-apply-tz"

\end_inset


\end_layout

\begin_layout Standard
The main 
\begin_inset Quotes eld
\end_inset

for
\begin_inset Quotes erd
\end_inset

 loop that identifies all rules of interest.
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

for $r (@R)
\end_layout

\begin_layout Plain Layout

  { my($FROM,
 $TO,
 $IN,
 $ON,
 $AT,
 $SAVE,
 $tz_rule) = @$r;
\end_layout

\begin_layout Plain Layout

    my($RULETEXT) = "
\backslash
n  Testing rule[$tz_rule]:
 
\begin_inset Quotes eld
\end_inset

 
\end_layout

\begin_layout Plain Layout

                  .
 
\begin_inset Quotes eld
\end_inset

$FROM,
 $TO,
 $IN,
 $ON,
 $AT,
 $SAVE-->";
 # debug only
\end_layout

\begin_layout Plain Layout

    my($VALID) = 1;
 # default to 'ok' for each rule.
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  if($SingleZone)
\end_layout

\begin_layout Plain Layout

    { # Timely::XPrint( 0,
 
\begin_inset Quotes eld
\end_inset

($RULETEXT
\begin_inset Quotes erd
\end_inset

 );
\end_layout

\begin_layout Plain Layout

      Timely::XPrint(0,
 '(' );
 
\end_layout

\begin_layout Plain Layout

    };
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  if($yr < $FROM)  # if year of interest is BEFORE the FROM of the rule
\end_layout

\begin_layout Plain Layout

    { #&Debug(0,
 "
\backslash
n  --skip $rnam ($FROM)" );
   # cannot apply here.
\end_layout

\begin_layout Plain Layout

    } else
\end_layout

\begin_layout Plain Layout

    {
\end_layout

\begin_layout Plain Layout

    if($SingleZone)
\end_layout

\begin_layout Plain Layout

      { # print 
\begin_inset Quotes eld
\end_inset

,
\begin_inset Quotes erd
\end_inset

;
  # [hmm,
 needs refining]
\end_layout

\begin_layout Plain Layout

      };
 
\end_layout

\begin_layout Plain Layout

    if( ( ($TO eq 'only')  # if precisely the year of interest
\end_layout

\begin_layout Plain Layout

        &&($yr == $FROM)
\end_layout

\begin_layout Plain Layout

        )
\end_layout

\begin_layout Plain Layout

      ||($TO eq 'max')     # OR all years
\end_layout

\begin_layout Plain Layout

      ||( ($TO ne 'only')  # OR year of interest is in the range
\end_layout

\begin_layout Plain Layout

        &&($yr <= $TO)
\end_layout

\begin_layout Plain Layout

        )
\end_layout

\begin_layout Plain Layout

      )
\end_layout

\begin_layout Plain Layout

      { my($ts,
 $sfx) = &FixRuleDate($yr,
 $IN,
 $ON,
 $AT,
 $zoneinfo);
 # NO GPS-adjust
\end_layout

\begin_layout Plain Layout

      if($ts == 0) # often just a date excursion:
 
\end_layout

\begin_layout Plain Layout

        { Timely::XPrint(0,
 
\begin_inset Quotes eld
\end_inset

 Skipped rule[a]:
 $FROM,
 $TO,
 $IN,
 $ON,
 $AT,
 $SAVE 
\begin_inset Quotes eld
\end_inset


\end_layout

\begin_layout Plain Layout

                   .
 
\begin_inset Quotes eld
\end_inset

in zone $zone :
 $yr,
 $rnam
\begin_inset Quotes erd
\end_inset

);
\end_layout

\begin_layout Plain Layout

          # return(0,0);
\end_layout

\begin_layout Plain Layout

          $VALID = 0;
 # prevent creation of rule..
\end_layout

\begin_layout Plain Layout

        };
 
\end_layout

\begin_layout Plain Layout

      if($VALID)
\end_layout

\begin_layout Plain Layout

        { $OFFSET{$ts} = $SAVE;
  # timestamp as key!
 $ts *seconds*(Julian) like $SAVE 
\end_layout

\begin_layout Plain Layout

          $SUFFIX{$ts} = $sfx;
   # see suffix use below...
\end_layout

\begin_layout Plain Layout

          $CURRENT{$ts} = 1;
     # FLAG rule as relevant to CURRENT year
\end_layout

\begin_layout Plain Layout

          $IDS{$ts} = $tz_rule;
  # 
\end_layout

\begin_layout Plain Layout

        if($SingleZone)
\end_layout

\begin_layout Plain Layout

          { print 
\begin_inset Quotes eld
\end_inset

$TO
\begin_inset Quotes erd
\end_inset

;
  
\end_layout

\begin_layout Plain Layout

          };
 
\end_layout

\begin_layout Plain Layout

        };
 
\end_layout

\begin_layout Plain Layout

        my($sav) = 'OFF     ';
\end_layout

\begin_layout Plain Layout

      if($SAVE != 0)           # numeric value,
 0 signals OFF
\end_layout

\begin_layout Plain Layout

        { $sav = &Pad( '+' .
 &Tim($SAVE),8 );
\end_layout

\begin_layout Plain Layout

        };
\end_layout

\begin_layout Plain Layout

        Timely::Log("
\backslash
n   * rule $sav" .
 &GDat($ts) .
 " $rnam($yr) :
 
\begin_inset Quotes eld
\end_inset


\end_layout

\begin_layout Plain Layout

            .
 
\begin_inset Quotes eld
\end_inset

from=$FROM to=$TO $IN $ON $AT ");
 
\end_layout

\begin_layout Plain Layout

        # not yet GPS-adjusted
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
Now here's a peculiar anomaly.
 I call this the 
\begin_inset Quotes eld
\end_inset

year minus one
\begin_inset Quotes erd
\end_inset

 problem.
 A rule may apply in the current year,
 but the logic may depend on its application in the preceding year as well!
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

      if($FROM < $yr)  # must apply to the preceding year
\end_layout

\begin_layout Plain Layout

        { my($prior) = $yr-1;
\end_layout

\begin_layout Plain Layout

          my($ts,
 $sfx) = &FixRuleDate($prior,
 $IN,
 $ON,
 $AT,
 $zoneinfo);
  # "year-1"
\end_layout

\begin_layout Plain Layout

        if($ts == 0) # error
\end_layout

\begin_layout Plain Layout

          { Timely::XPrint(0,
 
\begin_inset Quotes eld
\end_inset

 Skipped rule[b]:
 $FROM,
 $TO,
 $IN,
 $ON,
 $AT,
 $SAVE 
\begin_inset Quotes eld
\end_inset


\end_layout

\begin_layout Plain Layout

                     .
 
\begin_inset Quotes eld
\end_inset

in zone $zone :
 $yr,
 $rnam
\begin_inset Quotes erd
\end_inset

);
\end_layout

\begin_layout Plain Layout

            $VALID = 0;
 
\end_layout

\begin_layout Plain Layout

          };
  
\end_layout

\begin_layout Plain Layout

        if($VALID)
\end_layout

\begin_layout Plain Layout

          { $OFFSET{$ts} = $SAVE;
     # save DST,
 seconds 
\end_layout

\begin_layout Plain Layout

            $SUFFIX{$ts} = $sfx;
      # suffix
\end_layout

\begin_layout Plain Layout

            $CURRENT{$ts} = 0;
        # SIGNAL only for use in DST calculations
\end_layout

\begin_layout Plain Layout

            $IDS{$ts} = $tz_rule;
  # 
\end_layout

\begin_layout Plain Layout

          if($SingleZone)
\end_layout

\begin_layout Plain Layout

            { # print 
\begin_inset Quotes eld
\end_inset

<
\begin_inset Quotes erd
\end_inset

;
  
\end_layout

\begin_layout Plain Layout

            };
 
\end_layout

\begin_layout Plain Layout

          };
 
\end_layout

\begin_layout Plain Layout

          my($gr) = Timely::Greg($ts,
 0,
 0,
 0);
 # is NOT GPS-adjusted
\end_layout

\begin_layout Plain Layout

          Timely::Log( "
\backslash
n _  PRIOR $rnam($prior) :
 $gr" );
 # 
\end_layout

\begin_layout Plain Layout

        };
\end_layout

\begin_layout Plain Layout

      } else  # NOT active but potentially relevant in terms of DST carry-over:
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
Things are a bit more tricky if the year is not current,
 but there is the possibility that daylight saving may need to be carried over from a previous year.
 Each such rule starts and ends before the current year (
\family typewriter
$yr
\family default
) —
 we are interested in the last year in which the rule applied.
 
\end_layout

\begin_layout Standard
\begin_inset Note Note
status collapsed

\begin_layout Plain Layout
[THIS CAN BE SUBSTANTIALLY OPTIMISED:
\end_layout

\begin_layout Enumerate
Create a CARRYOVER variable,
 and associated CARRYSUFFIX and CARRYSAVE values.
 Initialise CARRYOVER to 0.
\end_layout

\begin_layout Enumerate
If in the following section and $VALID *and* $ts > CARRYOVER,
 overwrite CARRYOVER with $ts,
 CARRYSUFFIX with $sfx,
 CARRYSAVE with $SAVE.
\end_layout

\begin_layout Enumerate
When out of the main loop,
 store these values in %OFFSET,
 %SUFFIX,
 %CURRENT.
\end_layout

\begin_layout Plain Layout
\begin_inset Separator plain
\end_inset


\end_layout

\begin_layout Plain Layout
This is because we are only ever interested in the most recent daylight saving carryover from a previous year [EXPLORE] [is this for sure with super DST?]
\end_layout

\begin_layout Plain Layout
New:
\end_layout

\begin_layout Plain Layout
\begin_inset ERT
status open

\begin_layout Plain Layout

  my($CARRYOVER) = 0;
 
\end_layout

\begin_layout Plain Layout

  my($CARRYsuffix) = '';
\end_layout

\begin_layout Plain Layout

  my($CARRYsave) = '';
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

 ...
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

if($VALID)
\end_layout

\begin_layout Plain Layout

  { 
\end_layout

\begin_layout Plain Layout

  if($ts > $CARRYOVER)
\end_layout

\begin_layout Plain Layout

    { $CARRYOVER = $ts;
\end_layout

\begin_layout Plain Layout

      $CARRYsuffix = $sfx;
\end_layout

\begin_layout Plain Layout

      $CARRYsave = $SAVE;
 
\end_layout

\begin_layout Plain Layout

    };
\end_layout

\begin_layout Plain Layout

  if($SingleZone)
\end_layout

\begin_layout Plain Layout

    { print 
\begin_inset Quotes eld
\end_inset

-y
\begin_inset Quotes erd
\end_inset

;
  
\end_layout

\begin_layout Plain Layout

    };
 
\end_layout

\begin_layout Plain Layout

  };
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

 ..
 # later
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

if($CARRYOVER > 0)
\end_layout

\begin_layout Plain Layout

  { $OFFSET{$CARRYOVER} = $CARRYsave;
  # use timestamp as key!
\end_layout

\begin_layout Plain Layout

    $SUFFIX{$CARRYOVER} = $CARRYsuffix;
   # see suffix use below...
\end_layout

\begin_layout Plain Layout

    $CURRENT{$CARRYOVER} = 0;
     # only interested in DST
\end_layout

\begin_layout Plain Layout

  };
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout
Formerly:
\end_layout

\begin_layout Plain Layout
\begin_inset ERT
status open

\begin_layout Plain Layout

 
\end_layout

\begin_layout Plain Layout

      if($VALID)
\end_layout

\begin_layout Plain Layout

        { $OFFSET{$ts} = $SAVE;
  # use timestamp as key!
\end_layout

\begin_layout Plain Layout

          $SUFFIX{$ts} = $sfx;
   # see suffix use below...
\end_layout

\begin_layout Plain Layout

          $CURRENT{$ts} = 0;
     # only interested in DST
\end_layout

\begin_layout Plain Layout

          my($gr) = Timely::Greg($ts*86400,
 0,
 0,
 0);
 # is NOT GPS-adjusted
\end_layout

\begin_layout Plain Layout

          Timely::Log("
\backslash
n _  dst $rnam($FROM--$top) :
 $gr=" .
 &Tim(86400*$SAVE) );
 
\end_layout

\begin_layout Plain Layout

        if($SingleZone)
\end_layout

\begin_layout Plain Layout

          { print 
\begin_inset Quotes eld
\end_inset

-y
\begin_inset Quotes erd
\end_inset

;
  
\end_layout

\begin_layout Plain Layout

          };
 
\end_layout

\begin_layout Plain Layout

        };
 
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
The use of 
\family typewriter
$CARRYOVER
\family default
 allows us to limit this exception to the most recent such rule:
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

      { my($top) = $TO;
  # CANNOT be 'max'
\end_layout

\begin_layout Plain Layout

      if($top eq 'only')
\end_layout

\begin_layout Plain Layout

        { $top = $FROM;
\end_layout

\begin_layout Plain Layout

        };
\end_layout

\begin_layout Plain Layout

        my($ts,
 $sfx) = &FixRuleDate($top,
 $IN,
 $ON,
 $AT,
 $zoneinfo);
\end_layout

\begin_layout Plain Layout

      if($ts == 0) # error
\end_layout

\begin_layout Plain Layout

        { Timely::XPrint(0,
 
\begin_inset Quotes eld
\end_inset

 Skipped rule[c]:
 $FROM,
 $TO,
 $IN,
 $ON,
 $AT,
 $SAVE 
\begin_inset Quotes eld
\end_inset


\end_layout

\begin_layout Plain Layout

                   .
 
\begin_inset Quotes eld
\end_inset

in zone $zone :
 $yr,
 $rnam
\begin_inset Quotes erd
\end_inset

);
\end_layout

\begin_layout Plain Layout

          $VALID = 0;
 
\end_layout

\begin_layout Plain Layout

        };
\end_layout

\begin_layout Plain Layout

      if($VALID)
\end_layout

\begin_layout Plain Layout

        { 
\end_layout

\begin_layout Plain Layout

        if($ts > $CARRYOVER) # update to most recent timestamp:
 [explore] 
\end_layout

\begin_layout Plain Layout

          { $CARRYOVER = $ts;
\end_layout

\begin_layout Plain Layout

            $CARRYsuffix = $sfx;
\end_layout

\begin_layout Plain Layout

            $CARRYsave = $SAVE;
 
\end_layout

\begin_layout Plain Layout

            $CARRYid = $tz_rule;
  # 
\end_layout

\begin_layout Plain Layout

          if($SingleZone)
\end_layout

\begin_layout Plain Layout

            { print 
\begin_inset Quotes eld
\end_inset

<-
\begin_inset Quotes erd
\end_inset

;
  
\end_layout

\begin_layout Plain Layout

            };
 
\end_layout

\begin_layout Plain Layout

          } 
\end_layout

\begin_layout Plain Layout

        elsif($SingleZone)
\end_layout

\begin_layout Plain Layout

          { print 
\begin_inset Quotes eld
\end_inset

-
\begin_inset Quotes erd
\end_inset

;
  # nice try,
 but..
\end_layout

\begin_layout Plain Layout

          };
 
\end_layout

\begin_layout Plain Layout

        };
 
\end_layout

\begin_layout Plain Layout

      };
\end_layout

\begin_layout Plain Layout

    };
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  if($SingleZone)
\end_layout

\begin_layout Plain Layout

    { print ')';
\end_layout

\begin_layout Plain Layout

    };
 
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  # [in following ?
 ensure $OFFSET{$CARRYOVER} doesn't already exist?
 [explore]] 
\end_layout

\begin_layout Plain Layout

if($CARRYOVER > 0)
\end_layout

\begin_layout Plain Layout

  { $OFFSET{$CARRYOVER} = $CARRYsave;
  # use timestamp as key!
\end_layout

\begin_layout Plain Layout

    $SUFFIX{$CARRYOVER} = $CARRYsuffix;
   # see suffix use below...
\end_layout

\begin_layout Plain Layout

    $CURRENT{$CARRYOVER} = 0;
     # only interested in DST
\end_layout

\begin_layout Plain Layout

    $IDS{$CARRYOVER} = $CARRYid;
  # 
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
Exit if no match,
 otherwise initialise variables for the next section:
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

my($numhash) = scalar(keys %OFFSET);
 
\end_layout

\begin_layout Plain Layout

if($numhash < 1)
\end_layout

\begin_layout Plain Layout

  { #&Debug(0,
 '<nil>');
  
\end_layout

\begin_layout Plain Layout

  if( $zone_transition && $RUNNING_DST ) # if transition,
 carry moved in,
 END OFF!
\end_layout

\begin_layout Plain Layout

    { #&Debug(0,
 "
\backslash
n  apply both OFF:
 t was " .
 &Dat($zone_transition) 
\end_layout

\begin_layout Plain Layout

      #         .
 ',
 d was ' .
 &Tim($RUNNING_DST) );
\end_layout

\begin_layout Plain Layout

      return(0,
 0);
   # do NOT return $RUNNING_DST.
 [might check this]
\end_layout

\begin_layout Plain Layout

    };
 
\end_layout

\begin_layout Plain Layout

    #&Debug(0,
 "
\backslash
n  apply t OFF:
 t was" .
 &Dat($zone_transition) 
\end_layout

\begin_layout Plain Layout

    #         .
 ',
 d=' .
 &Tim($RUNNING_DST) );
\end_layout

\begin_layout Plain Layout

    return(0,0);
 # [odd]
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  print '.';
 # eye candy says "one or more rules are being processed..."
\end_layout

\begin_layout Plain Layout

  # process timestamps in ascending order,
 to obtain DST start,
 end.
\end_layout

\begin_layout Plain Layout

  # This is important as wall clock time depends on preceding DST :-(
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Subsection
Process rules in order
\begin_inset CommandInset label
LatexCommand label
name "subsec:Process-rules-in-order-for-tz"

\end_inset


\end_layout

\begin_layout Standard
Process timestamps in ascending order.
 We determine 
\family typewriter
$Tm
\family default
,
 a GPS timestamp that describes the time contained in each rule.
 
\end_layout

\begin_layout Standard
The DST offset for each timestamp (seconds) is stored in 
\family typewriter
%OFFSET
\family default
;
 the suffix that determines modification of the timestamp (wall time,
 local time or GMT) is stored in 
\family typewriter
%SUFFIX
\family default
,
 and whether the line is 
\begin_inset Quotes eld
\end_inset

historical
\begin_inset Quotes erd
\end_inset

 (only used to determined carried-over DST from past years) or current (applies to current year) is contained in 
\family typewriter
%CURRENT
\family default
.
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

  my($ts);
\end_layout

\begin_layout Plain Layout

  my($rulecount) = scalar %OFFSET;
 
\end_layout

\begin_layout Plain Layout

  Timely::Log("
\backslash
n
\backslash
n  Applying $rulecount rules ($SingleZone):");
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

SORTED:
 foreach $ts (sort keys %OFFSET)  # sort timestamps ASC (various formats!
 )
\end_layout

\begin_layout Plain Layout

  { my($De) = $OFFSET{$ts};
 
\end_layout

\begin_layout Plain Layout

    my($suff) = $SUFFIX{$ts};
 
\end_layout

\begin_layout Plain Layout

    my($Tm) = &FixBySuffix($suff,
 $ts,
 $CURRENT_ZO,
 $RUNNING_DST);
  
\end_layout

\begin_layout Plain Layout

              # adjust TO GMT,
 seconds ($ts is in seconds too)
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

    my($tz_rule) = $IDS{$ts};
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  if($SingleZone)
\end_layout

\begin_layout Plain Layout

    { print 
\begin_inset Quotes eld
\end_inset

[$suff,
\begin_inset Quotes erd
\end_inset

 .
 &Dat($Tm);
   # [hmm] 
\end_layout

\begin_layout Plain Layout

    };
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

    # THERE'S A POTENTIAL PROBLEM HERE.
 For example,
 $zone_transition was calculated
\end_layout

\begin_layout Plain Layout

    # previously and may have had a different DST applied,
 but later we depend on
\end_layout

\begin_layout Plain Layout

    # a comparison between $Tm and this!
\end_layout

\begin_layout Plain Layout

    my($DELTA_DST) = $RUNNING_DST - $DSTCARRY;
 # ?
 DST changed since zone_transition ...
\end_layout

\begin_layout Plain Layout

    $Tm = Timely::ApplyGps($Tm);
   # convert to GPS time 
\end_layout

\begin_layout Plain Layout

              # relevant,
 as $suff may implicate current wall clock time!
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
In the above,
 the calculation of 
\family typewriter
$Tm
\family default
 the Julian day of the adjusted timestamp is pivotal.
 Next,
 we consider the rules.
 
\end_layout

\begin_layout Standard
Debugging:
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

    my($fancy) = '_';
   # only relevant to carried over DST
\end_layout

\begin_layout Plain Layout

  if($CURRENT{$ts})
\end_layout

\begin_layout Plain Layout

    { $fancy = '*';
     # rule is applicable to this year,
 in all its splendour
\end_layout

\begin_layout Plain Layout

    };
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
\begin_inset ERT
status open

\begin_layout Plain Layout

#    &Debug(0,
 "
\backslash
n    Rule:
 $rulecount ($tz_rule) $fancy " .
 &Dat($Tm) 
\end_layout

\begin_layout Plain Layout

#           .
 &Pad( " <--($suff,z" .
 &Tim($CURRENT_ZO) .
 ",
 d" .
 &Tim($RUNNING_DST) .
 ")" ,
 16)
\end_layout

\begin_layout Plain Layout

#           .
 "
\backslash
t" );
  # conversion details
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Subsubsection
An anomaly
\end_layout

\begin_layout Standard
There is a problem typified by the rules for Europe/Belgrade in 1941.
 A new rule applies only after a transition,
 but it's possible that parts of the new rule extend backward in time,
 with daylight saving having been carried over for several years.
 In the example,
 up to the transition point on Friday 18 April at 11pm,
 there was no DST,
 but we then apply the C-Eur rule.
 In this rule,
 looking retrospectively,
 DST was turned on in 1940 but only removed in 1942,
 so DST must be active at the transition point.
 
\end_layout

\begin_layout Standard
I thus record rules that applied prior to the current year.
 This is tricky.
 Consider for example Zone=America/St_Johns.
 The daylight saving rules (and there are many) start and end at different times,
 overlapping in ways that mean you can't simply work forward from the first to the last start date.
\end_layout

\begin_layout Standard
Even this is however not sufficient,
 for the following reason,
 exemplified by St John's.
 An 
\begin_inset Quotes eld
\end_inset

on
\begin_inset Quotes erd
\end_inset

 rule may terminate in the year prior to the year of interest,
 but the 
\begin_inset Quotes eld
\end_inset

off
\begin_inset Quotes erd
\end_inset

 rule may persist to the year of interest.
 Because we don't take this 
\begin_inset Quotes eld
\end_inset

off
\begin_inset Quotes erd
\end_inset

 rule into account in our determination of DST carrying,
 we falsely assume that DST is still active,
 whereas it was turned off.
 This is the rationale for the 
\begin_inset Quotes eld
\end_inset

year minus one
\begin_inset Quotes erd
\end_inset

 code in Section
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:Does-a-rule-apply-tz"
nolink "false"

\end_inset

.
\end_layout

\begin_layout Standard
All values stored are Julian but 
\emph on
not 
\emph default
yet adjusted for GPS,
 DST or zone offset.
 The code is very finicky.
\begin_inset Note Note
status open

\begin_layout Plain Layout
[?
 clean up this description]
\end_layout

\end_inset


\end_layout

\begin_layout Subsection
A prior rule
\end_layout

\begin_layout Standard
If the rule we're looking at doesn't apply to the current year,
 but is merely an exercise in looking back to see whether DST is turned on,
 then turn on or off,
 storing the 
\begin_inset Quotes eld
\end_inset

legacy values
\begin_inset Quotes erd
\end_inset

:

\series bold
 
\begin_inset Note Note
status collapsed

\begin_layout Plain Layout

\series bold
[This is potentially more finicky still,
 as the legacy DST rule may not apply if the on/off criterion is above the transition date for the last year [explore]]
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

  if(!
 $CURRENT{$ts} )  # if only looking at carry over of DST...
\end_layout

\begin_layout Plain Layout

    { # do nothing
\end_layout

\begin_layout Plain Layout

    if($SingleZone)
\end_layout

\begin_layout Plain Layout

      { print ':';
 # [use a better indicator?] 
\end_layout

\begin_layout Plain Layout

      };
 
\end_layout

\begin_layout Plain Layout

    }
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Subsection
Too early
\begin_inset CommandInset label
LatexCommand label
name "subsec:After-a-transition-tz"

\end_inset


\end_layout

\begin_layout Standard
A previous transition point has already been passed:
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

     elsif
\end_layout

\begin_layout Plain Layout

      ( ($Tm + $DELTA_DST - $DELTA_Z < $LASTTRAN ) # applies before _prior_ transition
\end_layout

\begin_layout Plain Layout

      )
\end_layout

\begin_layout Plain Layout

      { Timely::Log('< *skip,
 before prior transition ' &Tim($DELTA_DST)  
\end_layout

\begin_layout Plain Layout

        .
 '>' );
   # [?DELTA_Z] 
\end_layout

\begin_layout Plain Layout

      if($SingleZone)
\end_layout

\begin_layout Plain Layout

        { print 
\begin_inset Quotes eld
\end_inset

<
\begin_inset Quotes erd
\end_inset

;
  
\end_layout

\begin_layout Plain Layout

        };
 
\end_layout

\begin_layout Plain Layout

      }
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
Hmm.
 technically there is DELTA_Z associated with LASTTRAN and with $zone_transition??
\end_layout

\end_inset


\end_layout

\begin_layout Subsection
A current rule
\end_layout

\begin_layout Standard
Otherwise,
 give it the works —
 the rule is 
\begin_inset Quotes eld
\end_inset

active
\begin_inset Quotes erd
\end_inset

.
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

    else  # is CURRENT rule:
\end_layout

\begin_layout Plain Layout

    { 
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
There's still a residual problem,
 exemplified by America/Montevideo 1942.
 We end off the 
\begin_inset Quotes eld
\end_inset

old dst carry over check
\begin_inset Quotes erd
\end_inset

 above with the legacy DST on at the time of entering the target year.
 But we need to turn it off using a rule that applies in the current year,
 if before the transition time.
 This is done below (
\begin_inset Quotes eld
\end_inset

–DST disabled
\begin_inset Quotes erd
\end_inset

),
 simply setting 
\family typewriter
$RUNNING_DST
\family default
 = 0 if 
\family typewriter
$De
\family default
 is 0 before the transition and 
\family typewriter
$tran
\family default
 is set.
 
\end_layout

\begin_layout Standard

\series bold
\begin_inset Note Note
status collapsed

\begin_layout Plain Layout

\series bold
[THERE IS HOWEVER A RESIDUAL PROBLEM.
 TRY America/Montevideo 1942.
 Here we correctly set the end time at 1 January,
 and the start time at the transition —
 14 December.
 However,
 we have a second pass.
 Now the second pass looks back and sees that DST is still active at the end of 1941 (with +30',
 as it happens).
 This DST is carried over,
 and the first rule encountered is skipped.
 This is just wrong!
 There are two ways of sorting this out.
 Either force these rules to 
\begin_inset Quotes eld
\end_inset

dst-style rules
\begin_inset Quotes erd
\end_inset

 even though they're in the current year,
 OR simply turn off the carry if you encounter a skipped rule in phase 2]
\end_layout

\end_inset


\end_layout

\begin_layout Subsection
Too late
\end_layout

\begin_layout Standard
Now for our options.
 The first is:
\end_layout

\begin_layout Itemize
we're in a transition year (
\family typewriter
$zone_transition
\family default
 is nonzero);
\end_layout

\begin_layout Itemize
but 
\family typewriter
$LASTTRAN
\family default
 is zero —
 we're not yet examining a rule that applies 
\emph on
after
\emph default
 the transition;
 and
\end_layout

\begin_layout Itemize
the 
\family typewriter
$Tm
\family default
 value is after the transition point,
 so we ignore this rule,
 as it doesn't yet apply.
 
\end_layout

\begin_layout Standard
Let's explore this:
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

#   &Debug(0,
 "
\backslash
n      TESTING T=" .
 &Dat($Tm) .
 ',
 tr=' .
 &Dat($zone_transition) 
\end_layout

\begin_layout Plain Layout

#           .
 ',
 delta=' .
 &Tim($DELTA_DST) );
\end_layout

\begin_layout Plain Layout

    if( $zone_transition
\end_layout

\begin_layout Plain Layout

      && ($Tm + $DELTA_DST - $DELTA_Z > $zone_transition)  
\end_layout

\begin_layout Plain Layout

      )     # rule can only apply < tr  
\end_layout

\begin_layout Plain Layout

      { Timely::Log(" *SKIP to END($rnam :
 $yr " .
 &Tim($De) .
 ") as " 
\end_layout

\begin_layout Plain Layout

           .
 &Dat( $Tm + $DELTA_DST )  .
 " adjusted by " .
 &Tim($DELTA_DST) 
\end_layout

\begin_layout Plain Layout

           .
 ' and ' .
 &Tim($DELTA_Z)
\end_layout

\begin_layout Plain Layout

           .
 " is above transition ".
 &Dat($zone_transition) );
\end_layout

\begin_layout Plain Layout

      if($SingleZone)
\end_layout

\begin_layout Plain Layout

        { print 
\begin_inset Quotes eld
\end_inset

>
\begin_inset Quotes erd
\end_inset

;
  
\end_layout

\begin_layout Plain Layout

        };
 
\end_layout

\begin_layout Plain Layout

        $rulecount --;
 
\end_layout

\begin_layout Plain Layout

        last SORTED;
  # and finished as all others will be above too!
 [EXPLORE]
\end_layout

\begin_layout Plain Layout

      }
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Subsection
Just right
\end_layout

\begin_layout Standard
Otherwise,
 the rule applies.
 We may be turning DST on or off.
 
\end_layout

\begin_layout Subsubsection
The end of DST
\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
Ordinarily we should simply store set $RUNNING_DST,
 the current DST value,
 to zero.
 There are a few catches:
\end_layout

\begin_layout Itemize
if there's already an end,
 we have a problem (likely due to multiple transitions).
 We here retain the 
\begin_inset Quotes eld
\end_inset

old
\begin_inset Quotes erd
\end_inset

 end value,
 as we always try to take the later value as the end of DST;
\end_layout

\begin_layout Itemize
if $RUNNING_DST is zero,
 there's another inconsistency (a bad carry in?).
\end_layout

\end_inset


\end_layout

\begin_layout Standard
Final else within main loop:
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

    else
\end_layout

\begin_layout Plain Layout

      { #&Debug(0,
 
\begin_inset Quotes eld
\end_inset


\backslash
n      Apply:
 
\begin_inset Quotes eld
\end_inset

);
 
\end_layout

\begin_layout Plain Layout

      if($De == 0) # if end of daylight saving  [END OF DAYLIGHT SAVING]
\end_layout

\begin_layout Plain Layout

        { Timely::Log('End DST.');
  
\end_layout

\begin_layout Plain Layout

      if($SingleZone)
\end_layout

\begin_layout Plain Layout

        { print 
\begin_inset Quotes eld
\end_inset


\backslash
n  (-)
\begin_inset Quotes erd
\end_inset

;
 # [ugh]
\end_layout

\begin_layout Plain Layout

        };
 
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
The end of DST is problematic for 
\emph on
established
\emph default
 timestamps based on wall time—
as they will need to have the daylight saving surgically excised :) 
\end_layout

\begin_layout Subsubsection
Start of DST
\end_layout

\begin_layout Standard
Alternatively,
 
\family typewriter
$De
\family default
 is nonzero,
 we're starting DST.
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

        } else   # [start of DST]
\end_layout

\begin_layout Plain Layout

        { Timely::Log('Start DST');
 
\end_layout

\begin_layout Plain Layout

          my($plus) = '+';
 
\end_layout

\begin_layout Plain Layout

        if($RUNNING_DST)
\end_layout

\begin_layout Plain Layout

          { Timely::Log(" **NOTE** super DST:
 " .
 &Tim($RUNNING_DST) 
\end_layout

\begin_layout Plain Layout

                 .
 ' -> ' .
 &Tim($De) ) ;
\end_layout

\begin_layout Plain Layout

            $plus = '++';
 
\end_layout

\begin_layout Plain Layout

          };
\end_layout

\begin_layout Plain Layout

        if($SingleZone)
\end_layout

\begin_layout Plain Layout

          { print 
\begin_inset Quotes eld
\end_inset


\backslash
n  ($plus)
\begin_inset Quotes erd
\end_inset

;
\end_layout

\begin_layout Plain Layout

          };
 
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
Else start DST:
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}  
\end_layout

\begin_layout Plain Layout

        };
  # [end "start of DST" section!]
\end_layout

\begin_layout Plain Layout

          $STOREDOK = &Store($LASTTRAN,
 $Tm,
 $RUNNING_DST,
 $CURRENT_ZO,
 $suff,
 
\end_layout

\begin_layout Plain Layout

                             DSTTRAN,
 0,
 $SingleZone);
 # seconds
\end_layout

\begin_layout Plain Layout

      };
\end_layout

\begin_layout Plain Layout

    };
   # end of final HUGE else within SORTED loop
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

    $RUNNING_DST = $De;
\end_layout

\begin_layout Plain Layout

    #&Debug(0,
 "  runDST7=" .
 &Tim($RUNNING_DST) );
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  if($SingleZone)
\end_layout

\begin_layout Plain Layout

    { print 
\begin_inset Quotes eld
\end_inset

]
\begin_inset Quotes erd
\end_inset

;
  
\end_layout

\begin_layout Plain Layout

    };
 
\end_layout

\begin_layout Plain Layout

    $rulecount --;
 
\end_layout

\begin_layout Plain Layout

  };
   # END of SORTED loop.
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Subsection
Done
\end_layout

\begin_layout Standard
Exit:
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

if($STOREDOK > 0)
\end_layout

\begin_layout Plain Layout

  { $STOREDOK += 7200;
  # add 2h,
 just in case [hack]
\end_layout

\begin_layout Plain Layout

  };
 
\end_layout

\begin_layout Plain Layout

  #&Debug(0,
 "
\backslash
n  apply returns:
 $STOREDOK,
 t=" .
 &Dat($STOREDOK) 
\end_layout

\begin_layout Plain Layout

  #        .
 ';
 d=' .
 &Tim($RUNNING_DST) );
\end_layout

\begin_layout Plain Layout

  return($STOREDOK,
 $RUNNING_DST);
 
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Subsection
Subsidiary DST routines
\end_layout

\begin_layout Subsubsection
Pad
\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
[clumsy]
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

sub Pad #
\end_layout

\begin_layout Plain Layout

{ my($s,
 $L) = @_;
\end_layout

\begin_layout Plain Layout

while(length $s < $L)
\end_layout

\begin_layout Plain Layout

  { $s = "$s ";
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

 return($s);
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Subsubsection
\begin_inset Quotes eld
\end_inset

Dat
\begin_inset Quotes erd
\end_inset

 &c
\end_layout

\begin_layout Standard
This is a simpler version of Greg
\begin_inset space ~
\end_inset

().
 We assume the supplied value is GPS adjusted,
 but do 
\emph on
not
\emph default
 perform daylight saving or zone adjustments!
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

sub Dat # Submitted Julian value is in seconds not days 
\end_layout

\begin_layout Plain Layout

{ my($J) = @_;
\end_layout

\begin_layout Plain Layout

  return( Timely::Greg($J,0,0,1) );
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
In the following variant,
 also in seconds,
 we 
\emph on
also do not
\emph default
 assume GPS adjustment:
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

sub GDat # 
\end_layout

\begin_layout Plain Layout

{ my($J) = @_;
\end_layout

\begin_layout Plain Layout

  return( Timely::Greg($J,0,0,0) );
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Subsubsection
Fix by suffix
\begin_inset CommandInset label
LatexCommand label
name "subsec:Fix-by-suffix"

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Description
s local standard time = wall time 
\emph on
without
\emph default
 DST!
\end_layout

\begin_layout Description
g GMT
\end_layout

\begin_layout Description
u UTC,
 the same as GMT
\end_layout

\begin_layout Description
z nautical time zone,
 also = GMT
\end_layout

\begin_layout Description
w Wall clock time—
a usage that causes a lot of pain in translation.
\end_layout

\begin_layout Description
\begin_inset space ~
\end_inset

 If there is no suffix,
 this is the same as the 
\series bold
w
\series default
 suffix
\end_layout

\end_inset


\end_layout

\begin_layout Standard
Given a `raw' timestamp,
 depending on the character value in $suff,
 
\begin_inset Note Note
status open

\begin_layout Plain Layout
(As listed in Section
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand ref
reference "sec:How-tz-works"
plural "false"
caps "false"
noprefix "false"
nolink "false"

\end_inset

)
\end_layout

\end_inset

 perform one of the following:
\end_layout

\begin_layout Description
w Adjust from local wall clock time to GMT;
\end_layout

\begin_layout Description
s Adjust from local standard time (excludes any DST which might be present) to GMT;
\end_layout

\begin_layout Description
<nothing> Assume wall clock time,
 and adjust accordingly as for `w'
\end_layout

\begin_layout Description
<anything
\begin_inset space ~
\end_inset

else> Assume GMT,
 simply return the time value.
 This corresponds to 
\series bold
g
\series default
,
 
\series bold
u
\series default
 and 
\series bold
z
\series default
.
 
\end_layout

\begin_layout Standard
Things are made more complex by the possibility that the GMT offset of a local timestamp and indeed the daylight saving time adjustment might depend on whether it's above or below a transition point (
\family typewriter
$zone_transition
\family default
).
 The interesting thing is that the comparison depends on adjustment of the timestamp for existing DST and GMT offset!
 
\begin_inset Note Note
status open

\begin_layout Plain Layout
[explore]
\end_layout

\end_inset


\end_layout

\begin_layout Standard
Logically,
 if the resultant timestamp is above a transition,
 then it must be adjusted by:
\end_layout

\begin_layout Itemize
The new DST that applies after the transition;
\end_layout

\begin_layout Itemize
The zone offset that applies after the transition.
\end_layout

\begin_layout Standard
This is tricky,
 as we'll sometimes be called on to adjudicate a timestamp that is close to the transition,
 without knowledge of the new offset 
\begin_inset Note Note
status open

\begin_layout Plain Layout
[???
 EXPLORE]
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
@1942-12-14 00:00:09,
 bias=-224.73,
 z=-210.00,
 new DST=0.00,
 tran=@1942-12-14 03:00:00,
 carry=30.00—
>wall:@1942-12-14 03:30:09`
\end_layout

\begin_layout Plain Layout
THE BLOODY bias IS JUST WRONG.
\end_layout

\begin_layout Plain Layout
The only THING WE CAN KNOW BEFORE THE TRANSITION IS z=$GMTOFF.
\end_layout

\begin_layout Plain Layout
!
\end_layout

\end_inset


\end_layout

\begin_layout Standard
All of 
\family typewriter
$T,

\family default
 
\family typewriter
$GMTOFF
\family default
 and 
\family typewriter
$newdst
\family default
 are in seconds,
 not Julian days or parts thereof.
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

sub FixBySuffix # 
\end_layout

\begin_layout Plain Layout

{ my($suff,
 $T,
 $GMTOFF,
 $newdst) = @_;
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  my($naah) = 0;
\end_layout

\begin_layout Plain Layout

#  &Debug($naah,
 "  `$suff:" .
 &Dat($T) 
\end_layout

\begin_layout Plain Layout

#        .
 ',
 z=' .
 &Tim($GMTOFF) .
 ',
 new DST=' .
 &Tim($newdst) 
\end_layout

\begin_layout Plain Layout

#        .
 '--->' );
 
\end_layout

\begin_layout Plain Layout

if($suff =~ /[guz]/)
\end_layout

\begin_layout Plain Layout

  { #&Debug($naah,
 "gmt`" );
 
\end_layout

\begin_layout Plain Layout

    return($T);
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

if($suff eq 's') # standard local time (excluding daylight saving)
\end_layout

\begin_layout Plain Layout

  { $T -= $GMTOFF;
\end_layout

\begin_layout Plain Layout

    #&Debug($naah,
 "local:" .
 &Dat($T) .
 "`" );
\end_layout

\begin_layout Plain Layout

    return($T);
        # time has GMT offset added in,
 so subtract it
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

if( (length $suff == 0)
\end_layout

\begin_layout Plain Layout

  ||($suff eq 'w') # wall clock time
\end_layout

\begin_layout Plain Layout

  )
\end_layout

\begin_layout Plain Layout

  { $T -= $GMTOFF;
\end_layout

\begin_layout Plain Layout

    $T -= $newdst;
\end_layout

\begin_layout Plain Layout

    #&Debug($naah,
 "wall:" .
 &Dat($T) .
 "`" );
\end_layout

\begin_layout Plain Layout

    return($T);
 # both DST and GMT have been ADDED 
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  die "...
\backslash
n*ERROR* Bad suffix ($suff) for time
\begin_inset Quotes erd
\end_inset

 .
 &JulianDay($T);
\end_layout

\begin_layout Plain Layout

  return(0);
 
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
We have a substantial problem in the above —
 different GMT offsets may well apply before and after the timestamp specified in 
\family typewriter
$zone_transition
\family default
.
 Now the latter value is specified as a proleptic GPS time,
 but the value in $T may be (and usually is) a wall clock time.
 Even if it's a 
\begin_inset Quotes eld
\end_inset

standard local time
\begin_inset Quotes erd
\end_inset

 the GPS adjustment will differ depending on whether the value is after or before the transition.
 
\end_layout

\begin_layout Standard
To make the comparison,
 we thus need to make the same adjustments we did to 
\family typewriter
$zone_transition
\family default
.
 This involves:
\end_layout

\begin_layout Enumerate
subtracting 
\family typewriter
$BIAS
\family default
;
\end_layout

\begin_layout Enumerate
subtracting 
\family typewriter
$DSTCARRY
\family default
;
\end_layout

\begin_layout Enumerate
GPS adjustment by a few seconds.
 
\end_layout

\begin_layout Subsubsection
Fix time
\begin_inset CommandInset label
LatexCommand label
name "subsec:Fix-time-tz"

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
[REALLY MUST APPLY THIS EARLIER THAN WE DO.
 See usage.
 fix me!]
\end_layout

\begin_layout Plain Layout
Also get rid of similar,
 duplicate routine(s).
\end_layout

\end_inset


\end_layout

\begin_layout Standard
Given a time as hh:mm:ss,
 hh:mm or hh,
 convert to seconds.
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

sub FixTime # 
\end_layout

\begin_layout Plain Layout

{ my($t) = @_;
\end_layout

\begin_layout Plain Layout

  my($sign) = 1;
\end_layout

\begin_layout Plain Layout

  ## my($naah) = 1;
\end_layout

\begin_layout Plain Layout

  ## &Debug($naah,
 "<<$t ~ " );
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

if($t =~ /^-/ )
\end_layout

\begin_layout Plain Layout

  { $sign = -1;
\end_layout

\begin_layout Plain Layout

  };
               # [this whole rtn is clumsy]
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  my($r);
\end_layout

\begin_layout Plain Layout

if($t =~ /(
\backslash
d+):(
\backslash
d+):(
\backslash
d+)$/ )   #  [hours,
 minutes,
 seconds]
\end_layout

\begin_layout Plain Layout

  { return( $sign * ($1*3600 + $2*60 + $3) );
 # NB.
 sign distributes over the lot
\end_layout

\begin_layout Plain Layout

    ## $r = $sign .
 ($1/24 + $2/(24*60) + $3/(24*3600));
\end_layout

\begin_layout Plain Layout

    ## &Debug($naah,
 "$r>> " );
\end_layout

\begin_layout Plain Layout

    ##return (  $r  );
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

if($t =~ /(
\backslash
d+):(
\backslash
d+)$/ )  # [hours,
 minutes] 
\end_layout

\begin_layout Plain Layout

  { return( $sign * ($1*3600 + $2*60) );
 
\end_layout

\begin_layout Plain Layout

    # $r = $sign .
 ($1/24 + $2/(24*60));
\end_layout

\begin_layout Plain Layout

    # &Debug($naah,
 "$r>> " );
\end_layout

\begin_layout Plain Layout

    # return (  $r  );
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

if($t =~ /(
\backslash
d+)$/ )  # [hours]
\end_layout

\begin_layout Plain Layout

  { return( $sign * $1*3600 );
 
\end_layout

\begin_layout Plain Layout

    # $r = $sign .
 ($1/24);
\end_layout

\begin_layout Plain Layout

    # &Debug($naah,
 "$r>> " );
\end_layout

\begin_layout Plain Layout

    # return (  $r   );
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

  die "
\backslash
n***ERROR bad time:
 $t";
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Subsubsection
Fix rule date
\begin_inset CommandInset label
LatexCommand label
name "subsec:Fix-rule-date-tz"

\end_inset


\end_layout

\begin_layout Standard
This routine deals with anomalies like 
\begin_inset Quotes eld
\end_inset

lastSun
\begin_inset Quotes erd
\end_inset

 and 
\begin_inset Quotes eld
\end_inset

Sun>=1
\begin_inset Quotes erd
\end_inset

.
 The rule \SpecialChar ldots

\end_layout

\begin_layout Quote

\family typewriter
Rule Zion 2005 2012 - Apr Fri<=1 2:00 1:00 D
\end_layout

\begin_layout Standard
\SpecialChar ldots
 is a problem!
 This is the only usage in tz of 
\begin_inset Quotes eld
\end_inset

<=
\begin_inset Quotes erd
\end_inset

;
 the rubric in the file 
\emph on
asia
\emph default
 explains that:
 
\end_layout

\begin_layout Quotation
The proposed law agreed upon by the Knesset Interior Committee on 2005-02-14 is that,
 for 2005 and beyond,
 DST starts at 02:00 the last Friday before April 2nd (i.e.
 the last Friday in March or April 1st itself if it falls on a Friday) and ends at 02:00 on the Saturday night _before_ the fast of Yom Kippur.
\end_layout

\begin_layout Standard
\begin_inset Separator plain
\end_inset


\end_layout

\begin_layout Standard
The values returned are a Julian value in seconds,
 and a text suffix.
 
\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
[This needs fixing]
\end_layout

\begin_layout Plain Layout

\series bold
Another issue is e.g.
 >=31 —
 this must extend into the next month,
 and not return an error/warning.
\end_layout

\begin_layout Plain Layout
[Fix me!]
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
MUST ALSO EXAMINE:
\end_layout

\begin_layout Plain Layout

\series bold
Rule Japan 1948 1951 - Sep Sat>=8 25:00 0 S
\end_layout

\begin_layout Plain Layout
#
\end_layout

\begin_layout Plain Layout
# My best guess at a Syrian rule is "the Friday nearest April 1";
\end_layout

\begin_layout Plain Layout
#
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Note Note
status collapsed

\begin_layout Plain Layout
[NEEDS A LOT OF WORK as ddval can be e.g.
 'lastThu']
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

sub FixRuleDate # 
\end_layout

\begin_layout Plain Layout

{ my($yr,
 $MMM,
 $dd,
 $hhmm,
 $zoneinfo) = @_;
\end_layout

\begin_layout Plain Layout

  my($mo) = &FetchMonth($MMM);
\end_layout

\begin_layout Plain Layout

if($mo < 1)
\end_layout

\begin_layout Plain Layout

  { Timely::Warn(3,
 "BAD RULE month:
 $yr m=$MMM($mo) $dd $hhmm");
\end_layout

\begin_layout Plain Layout

    return(0,0);
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  my($aday) = $dd;
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  # last of month eg 'lastSun'
\end_layout

\begin_layout Plain Layout

if( $dd =~ /^last(
\backslash
w+)$/ )
\end_layout

\begin_layout Plain Layout

  { my($wday) = $1;
\end_layout

\begin_layout Plain Layout

    $aday = &FetchLast($yr,
 $mo,
 $wday);
\end_layout

\begin_layout Plain Layout

  }
\end_layout

\begin_layout Plain Layout

  # MMM>=n e.g.
 'Sun>=1'
\end_layout

\begin_layout Plain Layout

elsif( $dd =~ /^(
\backslash
w{3})>=(
\backslash
d+)$/ )
\end_layout

\begin_layout Plain Layout

  { ($aday,
 $mo) = &FetchFirst($yr,
 $mo,
 $1,
 $2);
\end_layout

\begin_layout Plain Layout

  }
\end_layout

\begin_layout Plain Layout

elsif( $dd =~ /^(
\backslash
w{3})<=(
\backslash
d+)$/ ) # only instance is Zion !
\end_layout

\begin_layout Plain Layout

  { # Timely::Warn(0,
 
\begin_inset Quotes eld
\end_inset

Testing <= [Zion]
\begin_inset Quotes erd
\end_inset

);
 
\end_layout

\begin_layout Plain Layout

    ($aday,
 $mo) = &FetchBefore($yr,
 $mo,
 $1,
 $2);
 
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

  # $aday now should be numeric:
 
\end_layout

\begin_layout Plain Layout

if( $aday !~ /^
\backslash
d+$/ )
\end_layout

\begin_layout Plain Layout

  { Timely::Warn(3,
 "Failed date criterion($yr,
 $MMM ..
 $hhmm):
 '$dd'");
 
\end_layout

\begin_layout Plain Layout

    return(0,
 0);
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  my($hh);
\end_layout

\begin_layout Plain Layout

  my($mm);
\end_layout

\begin_layout Plain Layout

  my($ss) = 0;
 
\end_layout

\begin_layout Plain Layout

  my($SUFFIX) = '';
\end_layout

\begin_layout Plain Layout

if($hhmm =~ /^(
\backslash
d+):(
\backslash
d+):(
\backslash
d+)([guzsw]*)$/ ) # clumsy
\end_layout

\begin_layout Plain Layout

  { $hh = $1;
\end_layout

\begin_layout Plain Layout

    $mm = $2;
\end_layout

\begin_layout Plain Layout

    $ss = $3;
\end_layout

\begin_layout Plain Layout

    $SUFFIX = $4;
\end_layout

\begin_layout Plain Layout

  }
\end_layout

\begin_layout Plain Layout

elsif($hhmm !~ /^(
\backslash
d+):(
\backslash
d+)([guzsw]*)$/ )   # technically ([guzsw]?) is better
\end_layout

\begin_layout Plain Layout

  { 
\end_layout

\begin_layout Plain Layout

  if($hhmm =~ /^0$/ )
\end_layout

\begin_layout Plain Layout

    { $hh = 0;
\end_layout

\begin_layout Plain Layout

      $mm = 0;
\end_layout

\begin_layout Plain Layout

      Timely::Log(" --assumed time '0:00' $yr $mo $aday <$hhmm>",
 10);
\end_layout

\begin_layout Plain Layout

    } else
\end_layout

\begin_layout Plain Layout

    { Timely::Warn(3,
 "BAD hours/min ($zoneinfo) $yr $mo $aday $hhmm");
\end_layout

\begin_layout Plain Layout

      return(0,0);
\end_layout

\begin_layout Plain Layout

    };
\end_layout

\begin_layout Plain Layout

  } else
\end_layout

\begin_layout Plain Layout

  { $hh = $1;
\end_layout

\begin_layout Plain Layout

    $mm = $2;
\end_layout

\begin_layout Plain Layout

    $SUFFIX = $3;
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

  my($J) = &ZoneJulian($yr,
 $mo,
 $aday,
 $hh,
 $mm,
 $ss);
 # seconds
\end_layout

\begin_layout Plain Layout

  return($J,
 $SUFFIX);
  # NB.
 $J is *not* GPS-adjusted!
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Subsubsection
Fetch last 
\end_layout

\begin_layout Standard
Given the name of a day,
 fetch that last day (e.g.
 Sunday) for the given year and month,
 as a Julian value.
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

sub FetchLast # 
\end_layout

\begin_layout Plain Layout

{ my($yy,
 $mm,
 $day) = @_;
\end_layout

\begin_layout Plain Layout

  my(@MONS) = (31,
 28,
 31,
 30,
 31,
 30,
 31,
 31,
 30,
 31,
 30,
 31);
\end_layout

\begin_layout Plain Layout

    # what about leap years?
 [??????????????????
 fix me]
\end_layout

\begin_layout Plain Layout

  my(%WD) = ('Sun',
 0,
 'Mon',
 1,
 'Tue',
 2,
 'Wed',
 3,
 'Thu',
 4,
 'Fri',
 5,
 'Sat',
 6);
\end_layout

\begin_layout Plain Layout

if(!
 defined $WD{$day})
\end_layout

\begin_layout Plain Layout

  { die "
\backslash
n***ERROR*** Bad weekday:
 $yy $mm $day";
\end_layout

\begin_layout Plain Layout

    return(0);
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

  my($daycode) = $WD{$day};
\end_layout

\begin_layout Plain Layout

if(!
 defined $MONS[$mm-1])
\end_layout

\begin_layout Plain Layout

  { die "
\backslash
n***ERROR***Bad month:
 $yy $mm $day";
\end_layout

\begin_layout Plain Layout

    return(0);
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

  my($topday) = $MONS[$mm-1];
\end_layout

\begin_layout Plain Layout

  my($Jtest) = Timely::GpsJulian($yy,
 $mm,
 $topday,
 0,
 0,
 0,
 0,
 0,
 0)/86400;
\end_layout

\begin_layout Plain Layout

  my($mod) = int($Jtest+2) % 7;
   # modulo seven.
 +2 TO MAKE Sun=0
\end_layout

\begin_layout Plain Layout

while($mod != $daycode)
\end_layout

\begin_layout Plain Layout

  { $topday --;
\end_layout

\begin_layout Plain Layout

    $mod --;
\end_layout

\begin_layout Plain Layout

   if($mod < 0)
\end_layout

\begin_layout Plain Layout

     { $mod = 6;
 # wrap [check this always exits,
 hmm]
\end_layout

\begin_layout Plain Layout

     };
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

  return($topday);
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Subsubsection
Fetch first
\end_layout

\begin_layout Standard
Similar to fetch last,
 but identifies the 
\emph on
first
\emph default
 instance of a particular day (e.g.
 Sunday) 
\emph on
after or on
\emph default
 a given day of the month (e.g.
 the 15th).
 If the day is after the end of the month,
 segue into the following month!
 
\end_layout

\begin_layout Standard
This necessitates returning two values—
both month and day.
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

sub FetchFirst # 
\end_layout

\begin_layout Plain Layout

{ my($yy,
 $mo,
 $day,
 $cut) = @_;
\end_layout

\begin_layout Plain Layout

  my(@MONS) = (31,
 28,
 31,
 30,
 31,
 30,
 31,
 31,
 30,
 31,
 30,
 31);
\end_layout

\begin_layout Plain Layout

  if( &IsLeapYear($yy) )
\end_layout

\begin_layout Plain Layout

    { $MONS[1] = 29;
 
\end_layout

\begin_layout Plain Layout

    };
 
\end_layout

\begin_layout Plain Layout

  my(%WD) = ('Sun',
 0,
 'Mon',
 1,
 'Tue',
 2,
 'Wed',
 3,
 'Thu',
 4,
 'Fri',
 5,
 'Sat',
 6);
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

if(!
 defined $WD{$day})
\end_layout

\begin_layout Plain Layout

  { Timely::Warn(3,
 "BAD weekday:
 $yy $mo $day");
\end_layout

\begin_layout Plain Layout

    return('',
 $mo);
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  my($wantday) = $WD{$day};
\end_layout

\begin_layout Plain Layout

if(!
 defined $MONS[$mo-1])
\end_layout

\begin_layout Plain Layout

  { Timely::Warn(3,
 "BAD month:
 $yy $mo $day");
\end_layout

\begin_layout Plain Layout

    return('',
 $mo);
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  my($topday) = $MONS[$mo-1];
\end_layout

\begin_layout Plain Layout

  my($Jtest) = Timely::GpsJulian($yy,
 $mo,
 $cut,
 0,
 0,
 0,
 0,
 0,
 0)/86400;
  # first day
\end_layout

\begin_layout Plain Layout

  my($dayofweek) = int($Jtest+2) % 7;
   # modulo seven.
 +2 TO MAKE Sun=0 :
 CURRENT DAY
\end_layout

\begin_layout Plain Layout

  #&Debug(0,
 "$Jtest d=$cut dow=$dayofweek ");
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  # We now need to adjust $cut upwards,
 until it meets the right day.
\end_layout

\begin_layout Plain Layout

  # corresponds to incr $dayofweek commensurately until matches $wantday(0=sun).
\end_layout

\begin_layout Plain Layout

  # (The catch is that we may need to wrap $dayofweek around);
 
\end_layout

\begin_layout Plain Layout

  # We can also wrap into the next month
\end_layout

\begin_layout Plain Layout

  my($delta) = $wantday - $dayofweek;
 # desired day - current e.g.
 Wed-Sun = 3-0 = 3.
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

if($delta < 0)  # will have to wrap around e.g.
 Sun-Wed = 0-3 = -3,
 i.e.
 add 7.
 
\end_layout

\begin_layout Plain Layout

  { $cut += (7+$delta);
 
\end_layout

\begin_layout Plain Layout

  } 
\end_layout

\begin_layout Plain Layout

elsif($delta > 0) # 
\end_layout

\begin_layout Plain Layout

  { $cut += $delta;
 
\end_layout

\begin_layout Plain Layout

  };
 # else $cut is correct :
 the same day!
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  # check that cut isn't ridiculous:
\end_layout

\begin_layout Plain Layout

if($cut > $topday)
\end_layout

\begin_layout Plain Layout

  { ## Timely::Warn(0,
 "FetchFirst($yy-$mo-$day) wrapped $cut after month ($topday)!");
\end_layout

\begin_layout Plain Layout

    $cut -= $topday;
 
\end_layout

\begin_layout Plain Layout

    $mo ++;
 
\end_layout

\begin_layout Plain Layout

  if($mo > 12)
\end_layout

\begin_layout Plain Layout

    { Timely::Warn(3,
 
\begin_inset Quotes eld
\end_inset

FetchFirst($yy-$mo-$day) can't advance date past year end($topday)
\begin_inset Quotes erd
\end_inset

);
 
\end_layout

\begin_layout Plain Layout

      return('',
 $mo);
 
\end_layout

\begin_layout Plain Layout

    };
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  return($cut,
 $mo);
 
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Note Note
status collapsed

\begin_layout Plain Layout
Formerly:
\end_layout

\begin_layout Plain Layout
\begin_inset ERT
status open

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

while($mod != $daycode)  # clumsy [fix me]
\end_layout

\begin_layout Plain Layout

  { $mod ++;
\end_layout

\begin_layout Plain Layout

   if($mod > 6)
\end_layout

\begin_layout Plain Layout

     { $mod = 0;
 # wrap [check this always exits,
 hmm]
\end_layout

\begin_layout Plain Layout

     };
\end_layout

\begin_layout Plain Layout

   $cut ++;
 
\end_layout

\begin_layout Plain Layout

   if($cut > $topday) # crazy
\end_layout

\begin_layout Plain Layout

     { Timely::Warn(3,
 "
\backslash
n***ERROR*** FetchFirst($yy-$mm-$day) Cutoff day $cut after month end($topday)!");
\end_layout

\begin_layout Plain Layout

       return('');
\end_layout

\begin_layout Plain Layout

     };
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Subsubsection
Leap year?
\end_layout

\begin_layout Standard
Crude:
 A leap year if divisible by 4 unless divisible by 100 unless divisible by 400.
 
\begin_inset Note Note
status open

\begin_layout Plain Layout
[can be shortened considerably]
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

sub IsLeapYear
\end_layout

\begin_layout Plain Layout

{ my($yy);
    # clumsy,
 use @
\end_layout

\begin_layout Plain Layout

    ($yy)=@_;
\end_layout

\begin_layout Plain Layout

if(($yy % 4) != 0)
\end_layout

\begin_layout Plain Layout

  { return(0);
 # not a leap year,
 not divisible by 4.
 
\end_layout

\begin_layout Plain Layout

  };
 
\end_layout

\begin_layout Plain Layout

if(($yy % 100) != 0)
\end_layout

\begin_layout Plain Layout

  { return(1);
 # is a leap year
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

  return(($yy % 400) == 0);
 # is a leap year if divisible by 400.
 
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Subsection
J to DOW
\end_layout

\begin_layout Plain Layout
Convert Julian to day of week.
 [write this convenience fx]
\end_layout

\end_inset


\end_layout

\begin_layout Subsection
Fetch before
\end_layout

\begin_layout Standard
Implementing 
\family typewriter
$day <= $cut
\family default
 :
 this can (and does) wrap back to the preceding month.
 Note the potential for sharing code (arrays) etc.
 with FetchFirst
\begin_inset space ~
\end_inset

().
 
\end_layout

\begin_layout Standard
NB.
 At present we do 
\emph on
not
\emph default
 wrap around back to the preceding year,
 we don't allow e.g.
 <1 January.
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

sub FetchBefore # 
\end_layout

\begin_layout Plain Layout

{ my($yy,
 $mo,
 $day,
 $cut) = @_;
\end_layout

\begin_layout Plain Layout

  my(@MONS) = (31,
 28,
 31,
 30,
 31,
 30,
 31,
 31,
 30,
 31,
 30,
 31);
\end_layout

\begin_layout Plain Layout

  ## 
\end_layout

\begin_layout Plain Layout

  if( &IsLeapYear($yy) )
\end_layout

\begin_layout Plain Layout

    { $MONS[1] = 29;
 
\end_layout

\begin_layout Plain Layout

    };
 
\end_layout

\begin_layout Plain Layout

  my(%WD) = ('Sun',
 0,
 'Mon',
 1,
 'Tue',
 2,
 'Wed',
 3,
 'Thu',
 4,
 'Fri',
 5,
 'Sat',
 6);
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

if(!
 defined $WD{$day})
\end_layout

\begin_layout Plain Layout

  { Timely::Warn(3,
 "BAD weekday:
 $yy $mo $day");
\end_layout

\begin_layout Plain Layout

    return('',
 $mo);
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  my($wantday) = $WD{$day};
\end_layout

\begin_layout Plain Layout

if(!
 defined $MONS[$mo-1])
\end_layout

\begin_layout Plain Layout

  { Timely::Warn(3,
 "BAD month:
 $yy $mo $day");
\end_layout

\begin_layout Plain Layout

    return('',
 $mo);
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  my($Jtest) = Timely::GpsJulian($yy,
 $mo,
 $cut,
 0,
 0,
 0,
 0,
 0,
 0)/86400;
  # last day
\end_layout

\begin_layout Plain Layout

  my($dayofweek) = int($Jtest+2) % 7;
   # modulo seven.
 +2 TO MAKE Sun=0 :
 CURRENT DAY
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  # move back
\end_layout

\begin_layout Plain Layout

  my($delta) = $dayofweek - $wantday ;
 # eg.
 Tue wants Sunday = 2-0 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

if($delta < 0)  # will have to wrap back e.g.
 Sunday wants Tuesday = 0-2 
\end_layout

\begin_layout Plain Layout

  { $cut -= (7+$delta);
 
\end_layout

\begin_layout Plain Layout

  } 
\end_layout

\begin_layout Plain Layout

elsif($delta > 0) # 
\end_layout

\begin_layout Plain Layout

  { $cut -= $delta;
 
\end_layout

\begin_layout Plain Layout

  };
 # else $cut is correct :
 the same day!
 
\end_layout

\begin_layout Plain Layout

  # Timely::XPrint(0,
 
\begin_inset Quotes eld
\end_inset

 Debug:
 cut is $cut,
\begin_inset Quotes erd
\end_inset

);
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  # check that cut isn't bad:
\end_layout

\begin_layout Plain Layout

if($cut < 1)
\end_layout

\begin_layout Plain Layout

  { 
\end_layout

\begin_layout Plain Layout

  if($mo < 2)
\end_layout

\begin_layout Plain Layout

    { Timely::Warn(3,
 
\begin_inset Quotes eld
\end_inset

FetchBefore($yy-$mo-$day) can't move date before yr start($cut)
\begin_inset Quotes erd
\end_inset

);
 
\end_layout

\begin_layout Plain Layout

      return('',
 $mo);
 
\end_layout

\begin_layout Plain Layout

    };
\end_layout

\begin_layout Plain Layout

    # Timely::Warn(0,
 "FetchBefore($yy-$mo-$day) wrapped $cut back!");
\end_layout

\begin_layout Plain Layout

    my($lasttopday) = $MONS[$mo-2];
\end_layout

\begin_layout Plain Layout

    $cut += $lasttopday;
  # add negative value or zero (0=last day of previous month)
\end_layout

\begin_layout Plain Layout

    $mo --;
 
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  return($cut,
 $mo);
 
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Subsection
\begin_inset CommandInset label
LatexCommand label
name "subsec:Parse-a-TZ-rule"

\end_inset

Parse a TZ rule
\end_layout

\begin_layout Standard
This uses the global 
\family typewriter
%RULES
\family default
.
 Here the daylight saving time is converted to a numeric value using FixTime
\begin_inset space ~
\end_inset

(
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:Fix-time-tz"
nolink "false"

\end_inset

).
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

sub ParseRule # 
\end_layout

\begin_layout Plain Layout

{ my($ln) = @_;
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  my($r,
 $NAME,
 $FROM,
 $TO,
 $TYPE,
 $IN,
 $ON,
 $AT,
 $SAVE,
 $LETTERS) = split /
\backslash
s+/,
 $ln;
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

if(!
 defined $LETTERS)
\end_layout

\begin_layout Plain Layout

  { Timely::Log( "
\backslash
n?R=<$ln>
\backslash
n" ) ;
\end_layout

\begin_layout Plain Layout

    return(0);
 
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

  my($tz_rule) = &tz_rule_save($NAME,
 $FROM,
 $TO,
 $IN,
 $ON,
 $AT,
 $SAVE);
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  # here must check format of rule components,
 might restructure...
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  my($saving) = &FixTime($SAVE);
 # seconds 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  # end check.
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  my (@V) = ($FROM,
 $TO,
 $IN,
 $ON,
 $AT,
 $saving,
 $tz_rule);
 # the key variables 
\end_layout

\begin_layout Plain Layout

    # note that $saving at index 5 is in seconds.
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

   # format is Rule NAME etc.
 
\end_layout

\begin_layout Plain Layout

if(defined $RULES{$NAME} )
\end_layout

\begin_layout Plain Layout

  { my ($R) = $RULES{$NAME};
\end_layout

\begin_layout Plain Layout

    my (@A) = @$R;
\end_layout

\begin_layout Plain Layout

    ## Timely::Log( " --existing rule,size=" .
 scalar @A );
 
\end_layout

\begin_layout Plain Layout

 
\end_layout

\begin_layout Plain Layout

# if we're in the N hemisphere,
 it's possible to have
\end_layout

\begin_layout Plain Layout

#   end rules appear before start rules,
 which means
\end_layout

\begin_layout Plain Layout

#   we can't compensate for the DST adequately.
 Fix this.
\end_layout

\begin_layout Plain Layout

#   (You also can't simply sort by time,
 as rules have different extent!)
\end_layout

\begin_layout Plain Layout

#   There is however a residual problem with 'super' DST (eg UK,
 Germany 1940s)
\end_layout

\begin_layout Plain Layout

#######################################################
\end_layout

\begin_layout Plain Layout

  if( !
 $saving ) # if an END of DST rule
\end_layout

\begin_layout Plain Layout

    { push( @A,
 
\backslash
@V);
     # push a reference
\end_layout

\begin_layout Plain Layout

    } else
\end_layout

\begin_layout Plain Layout

    { unshift( @A,
 
\backslash
@V);
  # put STARTing rules at start of array!
\end_layout

\begin_layout Plain Layout

    };
\end_layout

\begin_layout Plain Layout

#######################################################
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

    Timely::XPrint(0,
 'r');
\end_layout

\begin_layout Plain Layout

    $RULES{$NAME} = 
\backslash
@A;
 # and store as an array reference!
\end_layout

\begin_layout Plain Layout

  } else
\end_layout

\begin_layout Plain Layout

  { # Timely::Log(" --new rule--");
\end_layout

\begin_layout Plain Layout

    my(@A) = ( 
\backslash
@V );
   # create new array with reference
\end_layout

\begin_layout Plain Layout

    $RULES{$NAME} = 
\backslash
@A;
 
\end_layout

\begin_layout Plain Layout

    Timely::XPrint(0,
 'R');
 
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  return(1);
 
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
The value stored in the associative array 
\family typewriter
%RULES
\family default
 is a reference to an array.
 The latter array contains multiple sub-arrays,
 also stored as references.
 
\end_layout

\begin_layout Standard
I keep the 
\begin_inset Quotes eld
\end_inset

ENDing
\begin_inset Quotes erd
\end_inset

 rules at the end of the array so that when we parse rules we don't inconveniently encounter an 
\begin_inset Quotes eld
\end_inset

end of DST
\begin_inset Quotes erd
\end_inset

 rule (with a local timestamp that includes DST,
 D'Oh) before the starting rule —
 the ordering in TZ makes no such accommodation.
 
\end_layout

\begin_layout Subsection
Start a new zone
\end_layout

\begin_layout Standard
Accepts a line and zone description.
 
\begin_inset Note Note
status open

\begin_layout Plain Layout
[pretty up]
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

sub StartZone # 
\end_layout

\begin_layout Plain Layout

{ my($ln,
 $zonedesc) = @_;
\end_layout

\begin_layout Plain Layout

  
\end_layout

\begin_layout Plain Layout

  my(@ZDAT) = split /
\backslash
s+/,
 $ln;
 
\end_layout

\begin_layout Plain Layout

  my($ZL) = scalar @ZDAT;
\end_layout

\begin_layout Plain Layout

if($ZL < 6)
\end_layout

\begin_layout Plain Layout

  { #  e.g.
 CET,
 WET etc
\end_layout

\begin_layout Plain Layout

    Timely::Log( " --short zone data length=$ZL:
 <$ln> -- " );
\end_layout

\begin_layout Plain Layout

  if($ZL < 5) # can't fix
\end_layout

\begin_layout Plain Layout

    { die "
\backslash
n***ERROR*** zone data too short <$ln>";
 # [explore use of Aagh_()]
\end_layout

\begin_layout Plain Layout

      return(0);
  
\end_layout

\begin_layout Plain Layout

    };
\end_layout

\begin_layout Plain Layout

    # here might compensate for missing final (end time) [?
 explore]
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
Some more checks:
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

  shift(@ZDAT);
  # discard 'Zone'
\end_layout

\begin_layout Plain Layout

  my($NAME)   = shift(@ZDAT);
\end_layout

\begin_layout Plain Layout

  my($SingleZone) = (length $zonedesc > 0);
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  # if zone description exists,
 check this single zone 
\end_layout

\begin_layout Plain Layout

if($SingleZone)
\end_layout

\begin_layout Plain Layout

  { 
\end_layout

\begin_layout Plain Layout

  if($NAME ne $zonedesc)    # and if no match:
\end_layout

\begin_layout Plain Layout

    { return('');
  # signal nil.
 
\end_layout

\begin_layout Plain Layout

    };
\end_layout

\begin_layout Plain Layout

    print 
\begin_inset Quotes eld
\end_inset


\backslash
n[Starting zone $zonedesc] 
\begin_inset Quotes erd
\end_inset

;
 
\end_layout

\begin_layout Plain Layout

  };
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  my(@V) = &ZoneX($SingleZone,
 @ZDAT);
   # this should set %ZONES entry..
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

if(!
 defined $ZONES{$NAME} )
\end_layout

\begin_layout Plain Layout

  { Timely::XPrint(0,
  "
\backslash
n *NOTE* Unknown zone:
 '$NAME',
 forcing:" );
 
\end_layout

\begin_layout Plain Layout

    # create it,
 otherwise WET,
 CET,
 MET,
 EET,
 EST,
 HST,
 MST,
 EST5EDT ...
 absent
\end_layout

\begin_layout Plain Layout

    # Also see the Montreal-related hack in ReadZones_()
\end_layout

\begin_layout Plain Layout

    my($ZID) = &FetchCountryCode('UT');
  # Rather use Universal Time than null 'XX' 
\end_layout

\begin_layout Plain Layout

    &SaveZone($NAME,
 $ZID,
 0,
 0);
 # also fills in ZONES,
 ZONECODES
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

  my($zn) = $ZONES{$NAME};
\end_layout

\begin_layout Plain Layout

if( ref($zn) eq 'ARRAY' )
\end_layout

\begin_layout Plain Layout

  { die "
\backslash
n***ERROR*** Duplicate zone:
 $NAME";
\end_layout

\begin_layout Plain Layout

    return(0);
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
Store,
 get identity of this zone row:
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

  my($zoneid) = $ZONECODES{$NAME};
\end_layout

\begin_layout Plain Layout

  my($tz_cutoff) = &tz_cutoff_save($ZDAT[0],
 $ZDAT[1],
 $zoneid,
 $ZDAT[3]);
\end_layout

\begin_layout Plain Layout

if(!
 defined $tz_cutoff || length $tz_cutoff < 1)
\end_layout

\begin_layout Plain Layout

  { die 
\begin_inset Quotes eld
\end_inset

Missing zone code for '$NAME'
\begin_inset Quotes erd
\end_inset

;
\end_layout

\begin_layout Plain Layout

  };
 
\end_layout

\begin_layout Plain Layout

  # [$jvs:
 fix me!
 must now include $tz_cutoff ID in 
\backslash
@V] 
\end_layout

\begin_layout Plain Layout

  push(@V,
 $tz_cutoff);
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  my(@A) = ( 
\backslash
@V );
   # create new array with reference
\end_layout

\begin_layout Plain Layout

  $ZONES{$NAME} = 
\backslash
@A;
 
\end_layout

\begin_layout Plain Layout

  Timely::Log( "
\backslash
n(Z:$NAME" );
 
\end_layout

\begin_layout Plain Layout

  return($NAME);
 
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
Note that there are some Zones that have no UNTIL entry (e.g.
 EST,
 MST,
 EST5EDT etc) and these will force an error in the above.
 
\begin_inset Note Note
status open

\begin_layout Plain Layout
[explore]
\end_layout

\end_inset


\end_layout

\begin_layout Subsection
Add to a zone
\begin_inset CommandInset label
LatexCommand label
name "subsec:Add-to-a"

\end_inset


\end_layout

\begin_layout Standard
Given a line of data and the name of a zone,
 split the line into components,
 parse the data,
 and push the parsed data to an array indexed to the name of the zone in 
\family typewriter
%ZONES
\family default
.
 The value of 
\family typewriter
$SingleZone
\family default
 is 1 iff we're dealing with just one zone.
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

sub MoreZone # 
\end_layout

\begin_layout Plain Layout

{ my($ln,
 $NAME,
 $SingleZone) = @_;
\end_layout

\begin_layout Plain Layout

  
\end_layout

\begin_layout Plain Layout

if(length $NAME < 1)  # Don't process.
 
\end_layout

\begin_layout Plain Layout

  { return(1);
\end_layout

\begin_layout Plain Layout

  };
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  my(@ZDAT) = split /
\backslash
s+/,
 $ln;
  # here,
 first datum should be null string 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

if($SingleZone)
\end_layout

\begin_layout Plain Layout

  { print 
\begin_inset Quotes eld
\end_inset

 zone:
 
\begin_inset Quotes eld
\end_inset

 .
 join('|',
 @ZDAT);
\end_layout

\begin_layout Plain Layout

  } else
\end_layout

\begin_layout Plain Layout

  { print 'z';
\end_layout

\begin_layout Plain Layout

  };
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  my($ZL) = scalar @ZDAT;
\end_layout

\begin_layout Plain Layout

if($ZL < 4)
\end_layout

\begin_layout Plain Layout

  { &TimeWarn( "short zone $ZL=<$ln>
\backslash
n",
 11,
 $NAME,
 0 );
  
\end_layout

\begin_layout Plain Layout

    return(0);
 
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  shift(@ZDAT);
  # discard first (null) element
\end_layout

\begin_layout Plain Layout

  my(@V) = &ZoneX($SingleZone,
 @ZDAT);
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

if(!
 defined $ZONES{$NAME} )           # [might move this up higher?]
\end_layout

\begin_layout Plain Layout

  { &TimeWarn( " (severe) missing zone:$NAME
\backslash
n",
 12,
 $NAME,
 0 );
\end_layout

\begin_layout Plain Layout

    # WHAT ABOUT DISCARDED DATA ?
 [explore]
\end_layout

\begin_layout Plain Layout

    return(0);
 
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  # store,
 get identity for this row:
\end_layout

\begin_layout Plain Layout

  my($tz_cutoff) = &tz_cutoff_save($ZDAT[0],
 $ZDAT[1],
 
\end_layout

\begin_layout Plain Layout

                                   $ZONECODES{$NAME},
 $ZDAT[3]);
\end_layout

\begin_layout Plain Layout

  push(@V,
 $tz_cutoff);
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  my ($R) = $ZONES{$NAME};
\end_layout

\begin_layout Plain Layout

  my (@A) = @$R;
\end_layout

\begin_layout Plain Layout

  push( @A,
 
\backslash
@V);
     # push a reference
\end_layout

\begin_layout Plain Layout

  $ZONES{$NAME} = 
\backslash
@A;
 # and store as an array reference!
\end_layout

\begin_layout Plain Layout

  # print 'z';
 
\end_layout

\begin_layout Plain Layout

  return(1);
 
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Subsubsection
Time-processing-specific warning
\end_layout

\begin_layout Standard
Increment warning count,
 and XPrint
\begin_inset space \thinspace{}
\end_inset

():
\begin_inset Note Note
status open

\begin_layout Plain Layout
[hmm]
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

sub TimeWarn #
\end_layout

\begin_layout Plain Layout

{ my($msg,
 $id,
 $zone,
 $year) = @_;
\end_layout

\begin_layout Plain Layout

  Timely::Warn(0,
 "-- [$id:$zone $year] $msg");
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Subsubsection
ZoneX
\begin_inset CommandInset label
LatexCommand label
name "subsec:ZoneX"

\end_inset


\end_layout

\begin_layout Standard
ZoneX
\begin_inset space ~
\end_inset

(),
 the zone extractor,
 is invoked by StartZone
\begin_inset space ~
\end_inset

() and MoreZone
\begin_inset space ~
\end_inset

().
 As its name suggests,
 it extracts zone data from the supplied array 
\family typewriter
@ZDAT
\family default
.
 
\emph on
Assumes
\emph default
 minimum length of 
\family typewriter
@ZDAT
\family default
 of 4.
 $SingleZone is set to 1 if we're only interested in a single zone.
 
\end_layout

\begin_layout Standard
The 
\begin_inset Quotes eld
\end_inset

usual
\begin_inset Quotes erd
\end_inset

 format of 
\family typewriter
@ZDAT
\family default
 is a GMT (Z) offset,
 followed by a rule (which may simply be '-'),
 then a formatting string like 'BMT' that is disregarded,
 followed by a terminal date that consists of at least a year,
 but also possibly a month (in a variety of formats),
 a day (optional) and a time.
 The time for the GMT offset and for the terminal date may be hh:mm or even hh:mm:ss.
 See for example Asia/Jakarta.
 
\end_layout

\begin_layout Standard
The return values:
\end_layout

\begin_layout Description
$GMTOFF This is Z,
 the zone offset (in seconds)
\end_layout

\begin_layout Description
$RUL The name of the rule for this zone row.
 The rule may be `-',
 signalling 
\begin_inset Quotes eld
\end_inset

No rule);
 
\end_layout

\begin_layout Description
$UNTIL The year until which this applies,
 which may be absent,
 signifying forever (for now).
 
\end_layout

\begin_layout Description
$MMM,
 $DD,
 $hh,
 $mm Month (0=absent) —
 used for debugging alone
\end_layout

\begin_layout Description
$FORMAT —
 the 
\begin_inset Quotes eld
\end_inset

time format
\begin_inset Quotes erd
\end_inset

,
 usually empty,
 indicating wall time,
 but may be one of a variety of characters.
 
\end_layout

\begin_layout Description
$J A Julian timestamp (end time) in seconds
\end_layout

\begin_layout Description
$suffix
\end_layout

\begin_layout Standard
\begin_inset Note Note
status collapsed

\begin_layout Plain Layout
[EXPLORE RAMIFICATIONS,
 FIX]
\end_layout

\end_inset

 
\end_layout

\begin_layout Standard
Unfortunately,
 there are many variants we have to deal with in the input data,
 for example we have 1995-Mar-lastSun in Asia/Aqtau!
\end_layout

\begin_layout Standard
The Julian value is the cutoff time,
 but it is not yet adjusted for region or DST,
 even if this is appropriate.
 
\end_layout

\begin_layout Standard
The invoker will inevitably store the returned values as an array in 
\family typewriter
%ZONES
\family default
,
 one of potentially many rows describing an individual zone.
 Later,
 ZoneYear
\begin_inset space ~
\end_inset

() will extract these rows and use ApplyRule
\begin_inset space ~
\end_inset

() to instantiate them as rows in the 
\series bold
timely
\series default
 table.
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

sub ZoneX # 
\end_layout

\begin_layout Plain Layout

{ my($SingleZone,
 @ZDAT) = @_;
\end_layout

\begin_layout Plain Layout

  my($lZ) = scalar @ZDAT;
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  my($GMTOFF) = &FixTime($ZDAT[0]);
 #seconds
\end_layout

\begin_layout Plain Layout

  # might here validate the zone time [explore]
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  my($RUL)  = $ZDAT[1];
\end_layout

\begin_layout Plain Layout

  my($FORMAT) = $ZDAT[2];
   # will become last entry
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  my($UNTIL)  = 9999;
  # ???
 [must accommodate missing value = ?
 "ad infinitum"]
\end_layout

\begin_layout Plain Layout

if($lZ < 4)
\end_layout

\begin_layout Plain Layout

  { Timely::Log("--short($lZ) zone data array:
 @ZDAT -- ");
 
\end_layout

\begin_layout Plain Layout

  } else
\end_layout

\begin_layout Plain Layout

  { $UNTIL = $ZDAT[3];
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

  my($MMM)    = '0';
 
\end_layout

\begin_layout Plain Layout

if($lZ > 4)
\end_layout

\begin_layout Plain Layout

  { $MMM  = $ZDAT[4];
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

  my($DD)     = '0';
\end_layout

\begin_layout Plain Layout

if($lZ > 5)
\end_layout

\begin_layout Plain Layout

  { $DD  = $ZDAT[5];
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

  my($hhmm)   = '0:0';
\end_layout

\begin_layout Plain Layout

if($lZ > 6)
\end_layout

\begin_layout Plain Layout

  { $hhmm = $ZDAT[6];
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

  my($hh)=$hhmm;
\end_layout

\begin_layout Plain Layout

  my($mm)=0;
\end_layout

\begin_layout Plain Layout

  my($ss)=0;
\end_layout

\begin_layout Plain Layout

  my($suffix) = '';
\end_layout

\begin_layout Plain Layout

if($hhmm =~ /(
\backslash
d+):(
\backslash
d+):(
\backslash
d+)([guzsw]*)/ )
\end_layout

\begin_layout Plain Layout

  { $hh = $1;
\end_layout

\begin_layout Plain Layout

    $mm = $2;
 
\end_layout

\begin_layout Plain Layout

    $ss = $3;
\end_layout

\begin_layout Plain Layout

    $suffix = $4;
  # clumsy
\end_layout

\begin_layout Plain Layout

  }
\end_layout

\begin_layout Plain Layout

elsif($hhmm =~ /(
\backslash
d+):(
\backslash
d+)([guzsw]*)/ )
\end_layout

\begin_layout Plain Layout

  { $hh = $1;
\end_layout

\begin_layout Plain Layout

    $mm = $2;
\end_layout

\begin_layout Plain Layout

    $suffix = $3;
  # clumsy
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  ######################################################
\end_layout

\begin_layout Plain Layout

  my($mo) = &FetchMonth($MMM);
\end_layout

\begin_layout Plain Layout

if($mo < 1)
\end_layout

\begin_layout Plain Layout

  { die "
\backslash
n***ERROR*** Bad rule date:
 $UNTIL $MMM $DD $hh $mm";
\end_layout

\begin_layout Plain Layout

    return(0);
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
A wrinkle:
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

  my($J);
 
\end_layout

\begin_layout Plain Layout

    # here must accommodate e.g.
 lastSun
\end_layout

\begin_layout Plain Layout

if( ($DD =~ /last/)
\end_layout

\begin_layout Plain Layout

  ||($DD =~ /first/)
\end_layout

\begin_layout Plain Layout

  ||($DD =~ /^
\backslash
w{3}>=
\backslash
d+/ )  # e.g.
 Sun>=
\end_layout

\begin_layout Plain Layout

  )
\end_layout

\begin_layout Plain Layout

  { ($J,
 $suffix) = &FixRuleDate($UNTIL,
 $mo,
 $DD,
 $hhmm,
 '');
 # $J is in seconds.
 
\end_layout

\begin_layout Plain Layout

                            # at present no zoneinfo here ^ [explore] 
\end_layout

\begin_layout Plain Layout

  if($J == 0) # error
\end_layout

\begin_layout Plain Layout

    { die (
\begin_inset Quotes eld
\end_inset

Bad rule in ZoneX:
 $RUL,
 $UNTIL,
 $mo,
 $DD,
 $hhmm,
 $FORMAT 
\begin_inset Quotes erd
\end_inset

);
 
\end_layout

\begin_layout Plain Layout

           # not $FROM,
 $TO,
 $IN,
 $ON,
 $AT,
 $SAVE
\end_layout

\begin_layout Plain Layout

      return(0,0);
\end_layout

\begin_layout Plain Layout

    };
 
\end_layout

\begin_layout Plain Layout

     #&Debug(0,
 "
\backslash
n Fixing anomalous Zone Rule date:
 $UNTIL $MMM $DD ->" .
 &Dat($J));
 
\end_layout

\begin_layout Plain Layout

  } else
\end_layout

\begin_layout Plain Layout

  { $J = &ZoneJulian($UNTIL,
 $mo,
 $DD,
 $hh,
 $mm,
 $ss);
  # seconds.
 
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

if($SingleZone)
\end_layout

\begin_layout Plain Layout

  { print 
\begin_inset Quotes eld
\end_inset

  :
 $GMTOFF,
 $RUL,
 $UNTIL,
 $MMM,
 $DD,
 $hh,
 $mm,
 $FORMAT,
 $J,
 $suffix
\backslash
n
\begin_inset Quotes erd
\end_inset

;
 
\end_layout

\begin_layout Plain Layout

  };
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  # do NOT invoke Timely::ApplyGps_()
\end_layout

\begin_layout Plain Layout

  return($GMTOFF,
 $RUL,
 $UNTIL,
 $MMM,
 $DD,
 $hh,
 $mm,
 $FORMAT,
 $J,
 $suffix);
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Subsubsection
ZoneJulian
\end_layout

\begin_layout Standard
Convert zone timestamp data to a Julian value.
 If no year is provided,
 default to far in the future!
 The Julian value is in seconds,
 not days!
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

sub ZoneJulian # 
\end_layout

\begin_layout Plain Layout

{ my($UNTIL,
 $fm,
 $DD,
 $hh,
 $mm,
 $ss) = @_;
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

if(!defined $UNTIL)
\end_layout

\begin_layout Plain Layout

  {$UNTIL = 9999;
  # might also log warning [?]
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

if(!
 defined $fm)
\end_layout

\begin_layout Plain Layout

  { die "
\backslash
n***ERROR*** Bad month for $UNTIL / $DD $hh $mm $ss";
\end_layout

\begin_layout Plain Layout

    return(0);
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

  #&Debug(0,
 "<zj $UNTIL $fm-$DD $hh:$mm:$ss>");
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

if($DD == 0) # artificial
\end_layout

\begin_layout Plain Layout

  { $DD = 1;
\end_layout

\begin_layout Plain Layout

  } 
\end_layout

\begin_layout Plain Layout

elsif($DD !~ /^
\backslash
d+$/)
\end_layout

\begin_layout Plain Layout

  { die "
\backslash
n Bad Zone date:
 $UNTIL $fm [$DD] $hh $mm";
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

  return( Timely::ToJulian($UNTIL,
 $fm,
 $DD,
 $hh,
 $mm,
 $ss,
 0,
 0,
 0) );
 
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
In the above,
 we must 
\emph on
not yet
\emph default
 convert to GPS time,
 as there will be further adjustments before we do this!
\end_layout

\begin_layout Subsubsection
Fetch month
\begin_inset CommandInset label
LatexCommand label
name "subsec:Fetch-month-tz"

\end_inset


\end_layout

\begin_layout Standard
Next,
 Jan–Dec converted to 1–12;
 0 to 1.
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

sub FetchMonth
\end_layout

\begin_layout Plain Layout

{ my($mm) = @_;
\end_layout

\begin_layout Plain Layout

  # permit numeric:
\end_layout

\begin_layout Plain Layout

if($mm =~ /^
\backslash
d+$/ )
\end_layout

\begin_layout Plain Layout

  {
\end_layout

\begin_layout Plain Layout

  if($mm == 0)  # turn 0 into 1
\end_layout

\begin_layout Plain Layout

    { return(1);
\end_layout

\begin_layout Plain Layout

    };
\end_layout

\begin_layout Plain Layout

    return($mm);
\end_layout

\begin_layout Plain Layout

  };
  # simply return numeric.
\end_layout

\begin_layout Plain Layout

my(%MTHS) = ('Jan',
 1,
 'Feb',
 2,
 'Mar',
 3,
 'Apr',
 4,
 'May',
 5,
 'Jun',
 6,
\end_layout

\begin_layout Plain Layout

    'Jul',
 7,
 'Aug',
 8,
 'Sep',
 9,
 'Oct',
 10,
 'Nov',
 11,
 'Dec',
 12,
 
\end_layout

\begin_layout Plain Layout

    0,
 1,
 '0',
 1);
 # 0-->1 !
\end_layout

\begin_layout Plain Layout

if( !
 defined $MTHS{$mm} )
\end_layout

\begin_layout Plain Layout

  { return(0);
  # fail 
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

  return( $MTHS{$mm} );
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Subsection
Terminate a zone
\begin_inset CommandInset label
LatexCommand label
name "subsec:Terminate-a-zone"

\end_inset


\end_layout

\begin_layout Standard
All this does is log the end of the zone by writing a right parenthesis.
 No checks are made of the ZONE,
 and it would theoretically be possible to add further zone data (although this would be unwise,
 and might even perhaps be checked for using a 
\begin_inset Quotes eld
\end_inset

closed zone
\begin_inset Quotes erd
\end_inset

 associative array [paranoid programmers only]).
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

sub EndZone # 
\end_layout

\begin_layout Plain Layout

{ my($ZN) = @_;
\end_layout

\begin_layout Plain Layout

if(length $ZN < 1)
\end_layout

\begin_layout Plain Layout

  { return(1);
\end_layout

\begin_layout Plain Layout

  };
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  Timely::XPrint(0,
  ')' );
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  return(1);
 
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Section
Testing zones
\begin_inset CommandInset label
LatexCommand label
name "sec:Testing-zones"

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
There is still a residual problem with Asia/Qyzylorda for 1982-04-01 00:00:00,
 and likewise for Aqtobe,
 Aqtau,
 and Oral.
\end_layout

\begin_layout Plain Layout
\begin_inset Note Note
status open

\begin_layout Plain Layout
Also try w 4-1 23:59:59.
\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Note Note
status open

\begin_layout Plain Layout
America/Kentucky/Louisville 1946 TZ appears to see DST running from 1 Jan to 2 Jun,
 and NOT (as I calculate) from 28 April.
 The rule that applies 
\emph on
until 
\emph default
1946 is US,
 but then Louisville applies until the sixties.
 This comprises DST start on the last Sunday in April (from 1941–1961) and a specific end on Jun 2 in 1946 alone.
 I can't see my error.
 By `US' rules,
 there should be no carry over from 1945.
\begin_inset Note Note
status collapsed

\begin_layout Plain Layout
America/Swift_Current 1946-07-10T05:00:00
\begin_inset Note Note
status collapsed

\begin_layout Plain Layout
Asia/Aqtau 1995-03-10T16:00:00.
 Here RussiaAsia rules transition from +5 to +4 on Mar lastSun 2:00.
 This rule turns DST on at the same time,
 and off on the last Sunday of September.
 My algorithm cocked up the calculation and puts it the March date in February ??
 [fix me]
\end_layout

\end_inset


\end_layout

\end_inset


\begin_inset Note Note
status collapsed

\begin_layout Plain Layout
Europe/Prague 1944-12-10T14:00:00;
 Europe/Bratislava 1944-12-10T14:00:00;
 [at transition,
 is on but new rule provides NO on,
 so must turn off!!!!!!!!!!!!!!]
\end_layout

\end_inset


\begin_inset Note Note
status collapsed

\begin_layout Itemize
Europe/Kiev 1991-12-10T15:00:00
\begin_inset Separator latexpar
\end_inset


\end_layout

\begin_deeper
\begin_layout Itemize
Why does the rule rule 
\begin_inset Quotes eld
\end_inset

+60.00 1990-03-25 02:00:00 Russia(1990) :
 from=1985 to=1991 Mar lastSun 2:00s
\begin_inset Quotes erd
\end_inset

 NOT apply before the transition?
\end_layout

\end_deeper
\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Note Note
status open

\begin_layout Plain Layout
Persistent failures with 
\family typewriter
\series bold
v all
\end_layout

\begin_layout Plain Layout
==Buenos Aires
\end_layout

\begin_layout Plain Layout
*** WARNING *** BAD zone,
 Perl DateTime said:
 'Invalid local time for date in time zone:
 America/Argentina/Buenos_Aires';
 1969-10-5 0:0:0
\end_layout

\begin_layout Plain Layout
Mismatch for America/Argentina/Buenos_Aires :
 mine=1969-10-05T03:00:00,
 tz=?
 (1969-10-5 0:0:0,
 2440499.62489583)...........................................................
\end_layout

\begin_layout Plain Layout
== [following is fine]
\end_layout

\begin_layout Plain Layout
g 1969-10-05 00:00:00--> Bad date for zone 3019(America/Argentina/Buenos_Aires):
 1969-10-05 00:00:00 (2440499.62489583 / -3600 )
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Section
Zone test
\begin_inset CommandInset label
LatexCommand label
name "sec:Zone-test"

\end_inset


\end_layout

\begin_layout Standard
In the menu invocation of ZoneTest
\begin_inset space ~
\end_inset

(),
 the user has the option of selecting the default date by specifying 
\begin_inset Quotes eld
\end_inset

t
\begin_inset Quotes erd
\end_inset

 alone,
 or the month,
 day and time,
 which follow the 
\begin_inset Quotes eld
\end_inset

t
\begin_inset Quotes erd
\end_inset

.
 If a year is also specified,
 then this year and all years 
\emph on
after this year
\emph default
 are tested!
 The addition of 
\family typewriter
AND reason > -1
\family default
 
\begin_inset Note Note
status open

\begin_layout Plain Layout
2020-12-05
\end_layout

\end_inset

allows suppression of obsolete places.
 
\end_layout

\begin_layout Standard
Rather than wiring in some arbitrary value,
 an attractive tweak is to default to the current MM-DD hh:mm:ss displayed at the bottom of the menu made by SetMenu
\begin_inset space ~
\end_inset

(),
 as this is visually consistent.
 
\begin_inset Note Note
status collapsed

\begin_layout Plain Layout
\begin_inset ERT
status open

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

#  my($MONTH) = 7;
  # [a bit kludgey] 
\end_layout

\begin_layout Plain Layout

#  my($DAY) = 10;
   # ...
  
\end_layout

\begin_layout Plain Layout

#  my($HOUR) = 12;
\end_layout

\begin_layout Plain Layout

#  my($MINUTE) = 0;
\end_layout

\begin_layout Plain Layout

#  my($SECOND) = 0;
\end_layout

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\end_inset

 
\end_layout

\begin_layout Standard
Testing always works 
\emph on
down
\emph default
 from the largest date in the
\emph on
 
\series bold
\emph default
timely
\series default
 table.
 The sequence of operations is:
\end_layout

\begin_layout Enumerate
Determine MM-DD hh:mm:ss.
 Options are:
\end_layout

\begin_deeper
\begin_layout Description
t alone defaults to the MM DD hh mm ss of the Julian value supplied in 
\family typewriter
$NUMBR
\family default
,
 taken as a GPS stamp,
 and converted to UTC Gregorian values.
\end_layout

\begin_layout Description
t
\begin_inset space ~
\end_inset

MM-DD
\begin_inset space ~
\end_inset

hh:mm:ss uses these supplied values
\end_layout

\begin_layout Description
t
\begin_inset space ~
\end_inset

YYYY-MM-DD
\begin_inset space ~
\end_inset

hh:mm:ss as above,
 use supplied values but only go down to year YYYY
\end_layout

\begin_layout Description
t
\begin_inset space ~
\end_inset

YYYY
\begin_inset space ~
\end_inset

ZZZZ-MM-DD
\begin_inset space ~
\end_inset

hh:mm:ss between the years YYYY(lower) and ZZZZ,
 but use supplied values
\end_layout

\begin_layout Description
t
\begin_inset space ~
\end_inset

YYYY uses `defaults',
 but only go 
\emph on
down to
\emph default
 year YYYY (from topmost acceptable year)
\end_layout

\begin_layout Description
t
\begin_inset space ~
\end_inset

YYYY
\begin_inset space ~
\end_inset

ZZZZ defaults,
 but between the years YYYY and ZZZZ.
 
\end_layout

\end_deeper
\begin_layout Enumerate
Check for silliness
\end_layout

\begin_layout Enumerate
Get a list of all active timezones from the 
\series bold
PLACES
\series default
 table in 
\series bold
\emph on
f
\emph default
ehr
\series default
:
 
\end_layout

\begin_layout Enumerate
For each year:
\end_layout

\begin_deeper
\begin_layout Enumerate
Convert Gregorian values to GPS Julian using Timely routine GpsJulian
\begin_inset space ~
\end_inset

(-) on the numeric values for the full Gregorian date;
\end_layout

\begin_layout Enumerate
Convert Julian back to Gregorian using FullGregorian
\begin_inset space ~
\end_inset

(-);
 
\end_layout

\begin_layout Enumerate
Check UTC value,
 using DateTime,
 establishing the 
\family typewriter
$dt1
\family default
 object as a date parser;
 
\end_layout

\begin_layout Enumerate
Then,
 
\emph on
for each zone:

\emph default
 
\end_layout

\begin_deeper
\begin_layout Enumerate
Use J2G
\begin_inset space ~
\end_inset

() to convert the 
\emph on
Julian
\emph default
 value to an appropriate Gregorian timestamp for this timezone.
 
\end_layout

\begin_layout Enumerate
Do something similar in DateTime,
 using the 
\family typewriter
$dt1
\family default
 object established above.
 
\end_layout

\begin_layout Enumerate
Compare the two Gregorian values,
 and report any discrepancy.
 
\end_layout

\end_deeper
\end_deeper
\begin_layout Standard
\begin_inset Separator plain
\end_inset


\end_layout

\begin_layout Standard
It's important to understand the limitations of the above approach used to implement the 
\series bold
t
\series default
 command,
 over and above the obvious issues that will arise if the version of DateTime doesn't match the version used in Timely.
 It's possible to create a wall time that is invalid,
 but that won't be picked up by the t screening mechanism,
 because every Julian value will have a UTC value and at least one corresponding Gregorian value,
 but the reverse doesn't necessarily hold.
 Contrast the use of 
\family typewriter
\series bold
t 10-05 00:00:00
\family default
\series default
 and 
\family typewriter
\series bold
w 10-05 00:00:00
\family default
\series default
,
 for example.
 This motivates for the 
\series bold
w
\series default
 command.
 
\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
\begin_inset Note Note
status open

\begin_layout Plain Layout

\emph on
[But what about t 1974-10-27 04:30:00 ???]
\end_layout

\begin_layout Plain Layout
t 1969-10-05 03:00:00 ???
\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout
There are some hiccoughs.
\end_layout

\begin_layout Enumerate
Analysing America/Santo_Domingo,
 u 1974-10-27 04:29:59 gives a wall time of 1974-10-26 23:29:59 and u 1974-10-27 05:00:00 jumps to 1974-10-27 01:00:00,
 but adding anything from 1 second to 30:00 to that first time gives an invalid date when submitted to tz and asked to convert from UTC to wall time.
 Clearly you can't have a gap in UTC.
\end_layout

\begin_layout Plain Layout
\begin_inset Separator plain
\end_inset


\end_layout

\begin_layout Plain Layout
The zone details are:
\end_layout

\begin_layout Plain Layout
\begin_inset Tabular
<lyxtabular version="3" rows="5" columns="4">
<features tabularvalignment="middle">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
STDOFF
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
RULES
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
FORMAT
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
UNTIL
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
-4:39:36
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
-
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
LMT
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
1890
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
-4:40
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
-
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
SDMT
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
1933 Apr 1 12:00 # S.
 Dom.
 MT
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
-5:00
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
DR
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
%s
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
1974 Oct 27
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
-4:00
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
-
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
AST
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
2000 Oct 29 2:00
\end_layout

\end_inset
</cell>
</row>
</lyxtabular>

\end_inset


\end_layout

\begin_layout Plain Layout
The specific rules for DR are:
\end_layout

\begin_layout Plain Layout
\begin_inset Tabular
<lyxtabular version="3" rows="7" columns="10">
<features tabularvalignment="middle">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
# Rule
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
NAME
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
FROM
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
TO
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
-
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
IN
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
ON
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
AT
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
SAVE
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
LETTER/S
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
Rule
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
DR
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
1966
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
only
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
-
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
Oct
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
30
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
0:00
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
1:00
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
EDT
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
Rule
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
DR
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
1967
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
only
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
-
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
Feb
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
28
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
0:00
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
0
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
EST
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
Rule
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
DR
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
1969
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
1973
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
-
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
Oct
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
lastSun
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
0:00
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
0:30
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
-0430
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
Rule
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
DR
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
1970
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
only
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
-
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
Feb
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
21
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
0:00
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
0
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
EST
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
Rule
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
DR
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
1971
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
only
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
-
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
Jan
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
20
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
0:00
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
0
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
EST
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
Rule
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
DR
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
1972
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
1974
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
-
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
Jan
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
21
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
0:00
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
0
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
EST
\end_layout

\end_inset
</cell>
</row>
</lyxtabular>

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Plain Layout

\emph on
Up to
\emph default
 the start of 27 October 1974,
 DR applies with an offset of -5 hours;
 after this wall time,
 there is no rule,
 just an offset of -4 hours,
 that is we jump forward at midnight according to the wall clock.
 But what about daylight saving,
 which applied as +30 minutes 
\emph on
from 
\emph default
the last Sunday of October in 1968–1973?
 This ended at the midnight between Jan 20 and Jan 21,
 in other words wall time of 1974-01-21 00:00:00.
\end_layout

\begin_layout Plain Layout
Why then does:
\end_layout

\begin_layout Itemize
My program used to see the transition as 2442347.6874305555 / @1974-10-27 04:30:00 z=-300 d=0 --> @1974-10-26 23:30:00.
 This is wrong.
\end_layout

\begin_layout Plain Layout
\begin_inset Separator plain
\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

sub ZoneTest # 
\end_layout

\begin_layout Plain Layout

{ my($arg,
 $NUMBR,
 $myLowYear,
 $myTopYear);
\end_layout

\begin_layout Plain Layout

    ($arg,
 $NUMBR,
 $myLowYear,
 $myTopYear)=@_;
\end_layout

\begin_layout Plain Layout

 
\end_layout

\begin_layout Plain Layout

  my($handDB) = $smalltime_h;
  
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

 my($stubyear,$MONTH,$DAY,
 $HOUR,$MINUTE,$SECOND) 
\end_layout

\begin_layout Plain Layout

               = Timely::FullGregorian($NUMBR,
 0,
        0,
        1);
\end_layout

\begin_layout Plain Layout

                             # no local ^,
 no DST ^,
 is GPS ^   
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

if(length $arg < 1)
\end_layout

\begin_layout Plain Layout

  { # do nothing,
 accept defaults..
\end_layout

\begin_layout Plain Layout

    my($pd) = Timely::PrettyDate(0,$stubyear,$MONTH,$DAY,
 $HOUR,$MINUTE,$SECOND);
 
\end_layout

\begin_layout Plain Layout

    print "
\backslash
n Testing default:
 
\begin_inset Quotes eld
\end_inset

 .
 substr($pd,
 4);
\end_layout

\begin_layout Plain Layout

    ShowEscMessage();
 
\end_layout

\begin_layout Plain Layout

  }
\end_layout

\begin_layout Plain Layout

elsif($arg =~ /^
\backslash
s*(
\backslash
d{4})
\backslash
s+(
\backslash
d{4})-(
\backslash
d+)-(
\backslash
d+)[ T]+(
\backslash
d+):(
\backslash
d+):(
\backslash
d+)
\backslash
s*$/ ) 
\end_layout

\begin_layout Plain Layout

  { $myLowYear = int($1) - 1;
   # low and high years
\end_layout

\begin_layout Plain Layout

    $myTopYear = int($2);
 
\end_layout

\begin_layout Plain Layout

    $MONTH  = $3;
\end_layout

\begin_layout Plain Layout

    $DAY    = $4;
\end_layout

\begin_layout Plain Layout

    $HOUR   = $5;
\end_layout

\begin_layout Plain Layout

    $MINUTE = $6;
\end_layout

\begin_layout Plain Layout

    $SECOND = $7;
\end_layout

\begin_layout Plain Layout

  } 
\end_layout

\begin_layout Plain Layout

elsif($arg =~ /
\backslash
s*(
\backslash
d{4})-(
\backslash
d+)-(
\backslash
d+)[ T]+(
\backslash
d+):(
\backslash
d+):(
\backslash
d+)
\backslash
s*$/ ) # + low yr
\end_layout

\begin_layout Plain Layout

  { $myLowYear = int($1) - 1;
 
\end_layout

\begin_layout Plain Layout

    $MONTH  = $2;
\end_layout

\begin_layout Plain Layout

    $DAY    = $3;
\end_layout

\begin_layout Plain Layout

    $HOUR   = $4;
\end_layout

\begin_layout Plain Layout

    $MINUTE = $5;
\end_layout

\begin_layout Plain Layout

    $SECOND = $6;
\end_layout

\begin_layout Plain Layout

  } 
\end_layout

\begin_layout Plain Layout

elsif($arg =~ /^
\backslash
s*(
\backslash
d+)-(
\backslash
d+)[ T]+(
\backslash
d+):(
\backslash
d+):(
\backslash
d+)
\backslash
s*$/ ) # just the month..
\end_layout

\begin_layout Plain Layout

  { $MONTH  = $1;
\end_layout

\begin_layout Plain Layout

    $DAY    = $2;
\end_layout

\begin_layout Plain Layout

    $HOUR   = $3;
\end_layout

\begin_layout Plain Layout

    $MINUTE = $4;
\end_layout

\begin_layout Plain Layout

    $SECOND = $5;
\end_layout

\begin_layout Plain Layout

  }
\end_layout

\begin_layout Plain Layout

elsif($arg =~ /^
\backslash
s*(
\backslash
d{4})
\backslash
s+(
\backslash
d{4})
\backslash
s*$/ ) # a range of years
\end_layout

\begin_layout Plain Layout

  { $myLowYear = int($1) - 1;
 
\end_layout

\begin_layout Plain Layout

    $myTopYear = int($2);
 
\end_layout

\begin_layout Plain Layout

  } 
\end_layout

\begin_layout Plain Layout

elsif($arg =~ /^
\backslash
s*(
\backslash
d{4})
\backslash
s*$/ ) # just the minimum year
\end_layout

\begin_layout Plain Layout

  { $myLowYear = int($1) - 1;
 
\end_layout

\begin_layout Plain Layout

  }
\end_layout

\begin_layout Plain Layout

 else
\end_layout

\begin_layout Plain Layout

  { print "
\backslash
n Unknown format,
 expected MM-DD hh:mm:ss e.g.
 12-31 20:30:00 ";
\end_layout

\begin_layout Plain Layout

    return;
 
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

if( ($myLowYear < $LOWYEAR)
\end_layout

\begin_layout Plain Layout

  ||($myTopYear > $TOPYEAR)
\end_layout

\begin_layout Plain Layout

  )
\end_layout

\begin_layout Plain Layout

  { print 
\begin_inset Quotes eld
\end_inset


\backslash
n Bad year range $myLowYear ..
 $myTopYear ($LOWYEAR :
 $TOPYEAR-1)
\begin_inset Quotes erd
\end_inset

;
\end_layout

\begin_layout Plain Layout

    return;
\end_layout

\begin_layout Plain Layout

  };
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  my($q) = "SELECT place,
 description FROM PLACES 
\begin_inset Quotes eld
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset

WHERE p_amended between 2 and $TOPCOUNTRY AND reason > -1";
\end_layout

\begin_layout Plain Layout

  #   ignore 1 = UTC stub.
 
\end_layout

\begin_layout Plain Layout

  # place is internal code,
 description is zone code:
\end_layout

\begin_layout Plain Layout

  my(@ZDAT) = Timely::SQLManySQL($handDB,
 $q,
 'get zones');
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
For each year,
 test the date for every zone.
 I convert the specified date (for each year) first into a Julian day,
 and then back to a Gregorian one.
 The Gregorian date values are then used to construct a DateTime object,
 as DateTime uses the TZ database.
 
\end_layout

\begin_layout Standard
As the timestamps stored in our database are all based on GPS times,
 the value submitted to J2G
\begin_inset space ~
\end_inset

() must be GPS-time based.
 When we convert this value back to Gregorian,
 we must thus also specify that the value is GPS-based.
 
\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
With the ReadKey problem,
 this doesn't work either:
\end_layout

\begin_layout Plain Layout
\begin_inset ERT
status open

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  ReadMode 'normal';
    # NOT 'raw';
 not 'cbreak';
 ?
 'normal' now doesn't help?;
  # for Term::ReadKey_()
\end_layout

\begin_layout Plain Layout

  # ReadMode 5;
 # NO!
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

    $key = ReadKey(0);
\end_layout

\begin_layout Plain Layout

  if(defined $key)
\end_layout

\begin_layout Plain Layout

    { print 
\begin_inset Quotes eld
\end_inset

..$key..
\begin_inset Quotes erd
\end_inset

;
 
\end_layout

\begin_layout Plain Layout

    if( ord($key) == 27 )
\end_layout

\begin_layout Plain Layout

      { print "
\backslash
n*Escaped*
\backslash
n";
 # 
\end_layout

\begin_layout Plain Layout

        $YEAR = $myLowYear-1;
  # [hmm,
 check this] 
\end_layout

\begin_layout Plain Layout

        next REDO;
    
\end_layout

\begin_layout Plain Layout

      };
 
\end_layout

\begin_layout Plain Layout

    };
 
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
In the following 
\family typewriter
$READKEYBLOCKINGPROBLEM
\family default
 was introduced to accommodate the case where ReadKey(-1) blocks (Perl-dependent).
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

  my($YEAR) = $myTopYear;
\end_layout

\begin_layout Plain Layout

  my($ERR) = 0;
\end_layout

\begin_layout Plain Layout

  my($ANOMALIES) = 0;
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

REDO:
 while($YEAR > $myLowYear)
\end_layout

\begin_layout Plain Layout

  { 
\end_layout

\begin_layout Plain Layout

  if( CheckForEscape() )
\end_layout

\begin_layout Plain Layout

    { $YEAR = $myLowYear-1;
\end_layout

\begin_layout Plain Layout

      next REDO;
             # 
\end_layout

\begin_layout Plain Layout

    };
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

    my($JD) = Timely::GpsJulian($YEAR,$MONTH,$DAY,
 $HOUR,$MINUTE,$SECOND,
 0,0,0);
   
\end_layout

\begin_layout Plain Layout

    my($xYYYY,
 $xMM,
 $xDD,
 $xh,
 $xm,
 $xs) = Timely::FullGregorian($JD,
 0,
 0,
 1);
 #1:GPS
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  my($dt1) = eval { DateTime->new( year => $xYYYY,
 month => $xMM,
 day => $xDD,
\end_layout

\begin_layout Plain Layout

       hour => $xh,
 minute => $xm,
 second => $xs,
\end_layout

\begin_layout Plain Layout

       time_zone => 'UTC') };
 
\end_layout

\begin_layout Plain Layout

  if(!
 $dt1)
\end_layout

\begin_layout Plain Layout

    { Timely::Warn(3,
 
\begin_inset Quotes eld
\end_inset

INVALID time zone (DateTime usage) 'UTC'
\begin_inset Quotes erd
\end_inset

);
 
\end_layout

\begin_layout Plain Layout

      last REDO;
 
\end_layout

\begin_layout Plain Layout

    };
 
\end_layout

\begin_layout Plain Layout

     Timely::XPrint(0,
  "
\backslash
n 
\begin_inset Quotes erd
\end_inset

 
\end_layout

\begin_layout Plain Layout

        .
 Timely::PrettyDate(0,$YEAR,
 $MONTH,
 $DAY,
 $HOUR,
 $MINUTE,
 $SECOND) .
 ' ' );
 
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
Now,
 for each zone,
 we compare the two dates —
 the Gregorian date obtained by applying J2G
\begin_inset space ~
\end_inset

() to the Julian day,
 for that zone;
 and a cloned copy of the UTC date,
 adjusted for the same zone.
 We currently ignore 
\begin_inset Quotes eld
\end_inset

anomalous
\begin_inset Quotes erd
\end_inset

 dates,
 signalled by a return value of zero from J2G.
\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
As J2G
\begin_inset space ~
\end_inset

() assumes that the Julian day submitted is proleptic GPS time,
 we must adjust the value accordingly.
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
[We also currently have a major problem where we specify a timestamp that occurs within a period of lack of validity due to a transition,
 e.g.
 leap forward at the start of spring [explore]]
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

    my($ref);
\end_layout

\begin_layout Plain Layout

  foreach $ref(@ZDAT)
\end_layout

\begin_layout Plain Layout

    { 
\end_layout

\begin_layout Plain Layout

      my($zid,
 $zone) = @$ref;
\end_layout

\begin_layout Plain Layout

      my($YYYY,$MM,$DD,$h,$m,$s,
 undef,undef,
 $hog,
 undef,
 undef) 
\end_layout

\begin_layout Plain Layout

                  # dummy values  ^    ^            ^      ^ 
\end_layout

\begin_layout Plain Layout

             = Timely::J2G(0,
 $zid,
 $JD);
 # JD is Gps-based 
\end_layout

\begin_layout Plain Layout

    if($YYYY == 0)  # anomalous date
\end_layout

\begin_layout Plain Layout

      { Timely::XPrint(0,
 "
\backslash
n     'Anomaly' skipped:
 $zid/$zone $YEAR $JD");
 
\end_layout

\begin_layout Plain Layout

        $ANOMALIES ++;
\end_layout

\begin_layout Plain Layout

      } else
\end_layout

\begin_layout Plain Layout

      { my($mine) = Timely::PrettyDate(1,$YYYY,
 $MM,
 $DD,
 $h,
 $m,
 $s);
 
\end_layout

\begin_layout Plain Layout

        # similar to Timely::Greg_()
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

       # trap failure of DateTime [??]
\end_layout

\begin_layout Plain Layout

       ## print 
\begin_inset Quotes eld
\end_inset


\backslash
ndebug ..
 '$zone'
\begin_inset Quotes erd
\end_inset

;
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

        my($dtest) = eval { $dt1->clone->set_time_zone( $zone ) };
\end_layout

\begin_layout Plain Layout

      if(!
 $dtest)
\end_layout

\begin_layout Plain Layout

        { Timely::Warn(3,
 
\begin_inset Quotes eld
\end_inset

INVALID time zone (Perl DateTime test) $zone
\begin_inset Quotes erd
\end_inset

);
\end_layout

\begin_layout Plain Layout

        } else
\end_layout

\begin_layout Plain Layout

        { my($yours) = $dtest->datetime();
  # format is identical
\end_layout

\begin_layout Plain Layout

        if($mine ne $yours)
\end_layout

\begin_layout Plain Layout

          { Timely::XPrint(0,
 "
\backslash
n   Mismatch $zid/$zone $mine v $yours" .
 $TICK);
 
\end_layout

\begin_layout Plain Layout

            $ERR++;
\end_layout

\begin_layout Plain Layout

          } else
\end_layout

\begin_layout Plain Layout

          { print '.';
 
\end_layout

\begin_layout Plain Layout

            ## &Debug (0,"
\backslash
n OK Zone $zone OK:
 $mine");
 
\end_layout

\begin_layout Plain Layout

          };
\end_layout

\begin_layout Plain Layout

        };
 
\end_layout

\begin_layout Plain Layout

      };
\end_layout

\begin_layout Plain Layout

    };
\end_layout

\begin_layout Plain Layout

  $YEAR --;
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

  Timely::XPrint( 0,
 "
\backslash
n
\backslash
n Errors=$ERR,
 $ANOMALIES anomalies for " .
 
\end_layout

\begin_layout Plain Layout

          ($myLowYear+1) .
 '--' 
\end_layout

\begin_layout Plain Layout

          .
 Timely::PrettyDate(1,$TOPYEAR,
 $MONTH,
 $DAY,
 $HOUR,
 $MINUTE,
 $SECOND) );
 
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
It's important to validate a given timestamp across zones.
 Simplest is just:
\end_layout

\begin_layout Enumerate
Determine a list of all valid time zone names;
\end_layout

\begin_layout Enumerate
Establish a timestamp;
\end_layout

\begin_layout Enumerate
Determine YYYY MM DD hh:mm:ss for all zones using both our routines and DateTime.
 
\end_layout

\begin_layout Enumerate
Compare the two and log variances.
\end_layout

\begin_layout Standard
\begin_inset Separator plain
\end_inset


\end_layout

\begin_layout Section
Wall test
\begin_inset CommandInset label
LatexCommand label
name "sec:Wall-test"

\end_inset


\end_layout

\begin_layout Standard
This is similar to the above ZoneTest
\begin_inset space ~
\end_inset

(
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:Testing-zones"
plural "false"
caps "false"
noprefix "false"
nolink "false"

\end_inset

) but does the 
\begin_inset Quotes eld
\end_inset

opposite
\begin_inset Quotes erd
\end_inset

.
 Given a date and a region,
 in 
\series bold
\emph on
f
\emph default
ehr
\series default
 convert this to a UTC time;
 in the tz database,
 establish the date for that region and similarly convert to UTC;
 then compare the two UTC values!
 The addition of 
\family typewriter
AND reason > -1
\family default
 
\begin_inset Note Note
status open

\begin_layout Plain Layout
2020-12-05
\end_layout

\end_inset

allows suppression of obsolete places.
 
\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
Formerly:
\end_layout

\begin_layout Plain Layout
\begin_inset ERT
status open

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

if(length $arg < 1)
\end_layout

\begin_layout Plain Layout

  { # do nothing,
 accept defaults..
\end_layout

\begin_layout Plain Layout

    print "
\backslash
n Testing default 
\begin_inset Quotes eld
\end_inset

 .
 Timely::PrettyDate(0,0,
 $MONTH,
 $DAY,
 $HOUR,
 $MINUTE,
 $SECOND) ;
 # [??
 fix year?] 
\end_layout

\begin_layout Plain Layout

  }
\end_layout

\begin_layout Plain Layout

elsif($arg =~ /
\backslash
s*(
\backslash
d{4})
\backslash
s*$/ ) # just the minimum year
\end_layout

\begin_layout Plain Layout

  { $myLowYear = int($1) - 1;
 
\end_layout

\begin_layout Plain Layout

  }
\end_layout

\begin_layout Plain Layout

elsif($arg =~ /^
\backslash
s*(
\backslash
d+)-(
\backslash
d+)[ T]+(
\backslash
d+):(
\backslash
d+):(
\backslash
d+)
\backslash
s*$/ )
\end_layout

\begin_layout Plain Layout

  { $MONTH  = $1;
\end_layout

\begin_layout Plain Layout

    $DAY    = $2;
\end_layout

\begin_layout Plain Layout

    $HOUR   = $3;
\end_layout

\begin_layout Plain Layout

    $MINUTE = $4;
\end_layout

\begin_layout Plain Layout

    $SECOND = $5;
\end_layout

\begin_layout Plain Layout

  }
\end_layout

\begin_layout Plain Layout

elsif($arg =~ /
\backslash
s*(
\backslash
d{4})-(
\backslash
d+)-(
\backslash
d+)[ T]+(
\backslash
d+):(
\backslash
d+):(
\backslash
d+)
\backslash
s*$/ ) # includes LOWEST year!
\end_layout

\begin_layout Plain Layout

  { $myLowYear = int($1) - 1;
 
\end_layout

\begin_layout Plain Layout

    $MONTH  = $2;
\end_layout

\begin_layout Plain Layout

    $DAY    = $3;
\end_layout

\begin_layout Plain Layout

    $HOUR   = $4;
\end_layout

\begin_layout Plain Layout

    $MINUTE = $5;
\end_layout

\begin_layout Plain Layout

    $SECOND = $6;
\end_layout

\begin_layout Plain Layout

  } 
\end_layout

\begin_layout Plain Layout

 else
\end_layout

\begin_layout Plain Layout

  { print "
\backslash
n Unknown _wall_ format,
 expected MM-DD hh:mm:ss e.g.
 12-31 20:30:00 ";
\end_layout

\begin_layout Plain Layout

    return;
 
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

sub WallTest # 
\end_layout

\begin_layout Plain Layout

{ my($arg,
 $NUMBR,
 $myLowYear,
 $myTopYear) = @_;
\end_layout

\begin_layout Plain Layout

 
\end_layout

\begin_layout Plain Layout

  my($handDB) = $smalltime_h;
  
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  # borrowed from ZoneTest_() :
 
\end_layout

\begin_layout Plain Layout

  my($stubyear,$MONTH,$DAY,
 $HOUR,$MINUTE,$SECOND) 
\end_layout

\begin_layout Plain Layout

         = Timely::FullGregorian($NUMBR,
 0,
        0,
        1);
\end_layout

\begin_layout Plain Layout

                       # no local ^,
 no DST ^,
 is GPS ^   
\end_layout

\begin_layout Plain Layout

if(length $arg < 1)
\end_layout

\begin_layout Plain Layout

  { # do nothing,
 accept defaults..
\end_layout

\begin_layout Plain Layout

    my($pd) = Timely::PrettyDate(0,$stubyear,$MONTH,$DAY,
 $HOUR,$MINUTE,$SECOND);
 
\end_layout

\begin_layout Plain Layout

    print "
\backslash
n Testing default:
 
\begin_inset Quotes eld
\end_inset

 .
 substr($pd,
 4);
\end_layout

\begin_layout Plain Layout

    ShowEscMessage();
 
\end_layout

\begin_layout Plain Layout

  }
\end_layout

\begin_layout Plain Layout

elsif($arg =~ /^
\backslash
s*(
\backslash
d{4})
\backslash
s+(
\backslash
d{4})-(
\backslash
d+)-(
\backslash
d+)[ T]+(
\backslash
d+):(
\backslash
d+):(
\backslash
d+)
\backslash
s*$/ ) 
\end_layout

\begin_layout Plain Layout

  { $myLowYear = int($1) - 1;
   # low and high years
\end_layout

\begin_layout Plain Layout

    $myTopYear = int($2);
 
\end_layout

\begin_layout Plain Layout

    $MONTH  = $3;
\end_layout

\begin_layout Plain Layout

    $DAY    = $4;
\end_layout

\begin_layout Plain Layout

    $HOUR   = $5;
\end_layout

\begin_layout Plain Layout

    $MINUTE = $6;
\end_layout

\begin_layout Plain Layout

    $SECOND = $7;
\end_layout

\begin_layout Plain Layout

  } 
\end_layout

\begin_layout Plain Layout

elsif($arg =~ /
\backslash
s*(
\backslash
d{4})-(
\backslash
d+)-(
\backslash
d+)[ T]+(
\backslash
d+):(
\backslash
d+):(
\backslash
d+)
\backslash
s*$/ ) # incl low year 
\end_layout

\begin_layout Plain Layout

  { $myLowYear = int($1) - 1;
 
\end_layout

\begin_layout Plain Layout

    $MONTH  = $2;
\end_layout

\begin_layout Plain Layout

    $DAY    = $3;
\end_layout

\begin_layout Plain Layout

    $HOUR   = $4;
\end_layout

\begin_layout Plain Layout

    $MINUTE = $5;
\end_layout

\begin_layout Plain Layout

    $SECOND = $6;
\end_layout

\begin_layout Plain Layout

  } 
\end_layout

\begin_layout Plain Layout

elsif($arg =~ /^
\backslash
s*(
\backslash
d+)-(
\backslash
d+)[ T]+(
\backslash
d+):(
\backslash
d+):(
\backslash
d+)
\backslash
s*$/ ) # just the month..
\end_layout

\begin_layout Plain Layout

  { $MONTH  = $1;
\end_layout

\begin_layout Plain Layout

    $DAY    = $2;
\end_layout

\begin_layout Plain Layout

    $HOUR   = $3;
\end_layout

\begin_layout Plain Layout

    $MINUTE = $4;
\end_layout

\begin_layout Plain Layout

    $SECOND = $5;
\end_layout

\begin_layout Plain Layout

  }
\end_layout

\begin_layout Plain Layout

elsif($arg =~ /^
\backslash
s*(
\backslash
d{4})
\backslash
s+(
\backslash
d{4})
\backslash
s*$/ ) # a range of years
\end_layout

\begin_layout Plain Layout

  { $myLowYear = int($1) - 1;
 
\end_layout

\begin_layout Plain Layout

    $myTopYear = int($2);
 
\end_layout

\begin_layout Plain Layout

  } 
\end_layout

\begin_layout Plain Layout

elsif($arg =~ /^
\backslash
s*(
\backslash
d{4})
\backslash
s*$/ ) # just the minimum year
\end_layout

\begin_layout Plain Layout

  { $myLowYear = int($1) - 1;
 
\end_layout

\begin_layout Plain Layout

  }
\end_layout

\begin_layout Plain Layout

 else
\end_layout

\begin_layout Plain Layout

  { print "
\backslash
n Unknown WALL format,
 expected MM-DD hh:mm:ss e.g.
 12-31 20:30:00 ";
\end_layout

\begin_layout Plain Layout

    return;
 
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

if( ($myLowYear < $LOWYEAR)
\end_layout

\begin_layout Plain Layout

  ||($myTopYear > $TOPYEAR-1)  # [check this]
\end_layout

\begin_layout Plain Layout

  )
\end_layout

\begin_layout Plain Layout

  { print 
\begin_inset Quotes eld
\end_inset


\backslash
n Bad year range $myLowYear ..
 $myTopYear ($LOWYEAR :
 
\begin_inset Quotes eld
\end_inset

 .($TOPYEAR-1).
 
\begin_inset Quotes eld
\end_inset

)
\begin_inset Quotes erd
\end_inset

;
\end_layout

\begin_layout Plain Layout

    return;
\end_layout

\begin_layout Plain Layout

  };
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  my($q) = "SELECT place,
 description FROM PLACES 
\begin_inset Quotes eld
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset

WHERE p_amended between 2 and $TOPCOUNTRY AND reason > -1";
\end_layout

\begin_layout Plain Layout

  # place is internal code,
 description is zone code:
\end_layout

\begin_layout Plain Layout

  my(@ZDAT) = Timely::SQLManySQL($handDB,
 $q,
 'get zones');
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
For each year,
 test the date for every zone.
 Simply determine the GPS time for that zone,
 based on the Gregorian date.
 
\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
For key interrupt in Perl,
 check out
\end_layout

\begin_layout Plain Layout
http://stackoverflow.com/questions/17646821/perl-code-required-to-break-loop-when-key-pressed
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

  my($YEAR) = $myTopYear;
\end_layout

\begin_layout Plain Layout

  my($ERR) = 0;
\end_layout

\begin_layout Plain Layout

  my($ANOMALIES) = 0;
 
\end_layout

\begin_layout Plain Layout

  my($ref);
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

REDO:
 while($YEAR > $myLowYear)
\end_layout

\begin_layout Plain Layout

  { print "
\backslash
n$YEAR ";
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  if( CheckForEscape() )
\end_layout

\begin_layout Plain Layout

    { $YEAR = $myLowYear-1;
  # [hmm,
 check this] 
\end_layout

\begin_layout Plain Layout

      next REDO;
             # 
\end_layout

\begin_layout Plain Layout

    };
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  foreach $ref(@ZDAT)
\end_layout

\begin_layout Plain Layout

    { my($zid,
 $zone) = @$ref;
\end_layout

\begin_layout Plain Layout

      my($JD,
 $shadow) = Timely::G2J(0,
 $zid,$YEAR,$MONTH,$DAY,$HOUR,$MINUTE,$SECOND);
   
\end_layout

\begin_layout Plain Layout

    if($shadow < 0)  # if failed,
 don't try
\end_layout

\begin_layout Plain Layout

      { my($yrs) 
\end_layout

\begin_layout Plain Layout

         = Timely::FetchTzDate($JD,
 $zone,
 $YEAR,$MONTH,$DAY,$HOUR,$MINUTE,$SECOND);
\end_layout

\begin_layout Plain Layout

      if(length $yrs < 1)
\end_layout

\begin_layout Plain Layout

        { Timely::XPrint(0,
 "
\backslash
n  Bad time(" .
 int($shadow/60) .
 " min):
 
\begin_inset Quotes eld
\end_inset

 
\end_layout

\begin_layout Plain Layout

          .
 Timely::PrettyDate(0,$YEAR,
 $MONTH,
 $DAY,
 $HOUR,
 $MINUTE,
 $SECOND) 
\end_layout

\begin_layout Plain Layout

          .
 
\begin_inset Quotes eld
\end_inset

 /$zone");
 
\end_layout

\begin_layout Plain Layout

          $ANOMALIES ++;
\end_layout

\begin_layout Plain Layout

        } else
\end_layout

\begin_layout Plain Layout

        { Timely::XPrint(0,
 "
\backslash
n   Mismatch!
 $zid/$zone NOT FOUND(sh=" .int($shadow/60)
\end_layout

\begin_layout Plain Layout

            .
 ") v $yrs" .
 $TICK);
 
\end_layout

\begin_layout Plain Layout

          $ERR++;
\end_layout

\begin_layout Plain Layout

        };
\end_layout

\begin_layout Plain Layout

      } else
\end_layout

\begin_layout Plain Layout

      { # this is GPS time,
 so adjust to UTC,
 and then get back Gregorian:
\end_layout

\begin_layout Plain Layout

        my($mine) = Timely::Greg($JD,0,0,1);
  # date as YYYY-MM-DD hh:mm:ss
\end_layout

\begin_layout Plain Layout

        $mine =~ s/ /T/;
  # replace ' ' with 'T'
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
Next do the same thing using the tz database (in Perl).
\begin_inset Foot
status collapsed

\begin_layout Plain Layout
For use of eval/or do to trap an error in Perl,
 see e.g.
 
\begin_inset CommandInset href
LatexCommand href
name "http://stackoverflow.com/questions/10342875/how-to-properly-use-the-try-catch-in-perl-that-error-pm-provides"
target "http://stackoverflow.com/questions/10342875/how-to-properly-use-the-try-catch-in-perl-that-error-pm-provides"
literal "false"

\end_inset

.
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

        # next do the same using the tz database:
\end_layout

\begin_layout Plain Layout

        my($yours) = 
\end_layout

\begin_layout Plain Layout

          Timely::FetchTzDate($JD,
 $zone,
 $YEAR,$MONTH,$DAY,$HOUR,$MINUTE,$SECOND);
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Subsection
A TZ catch
\begin_inset CommandInset label
LatexCommand label
name "subsec:A-TZ-catch"

\end_inset


\end_layout

\begin_layout Standard
There is a further catch —
 TZ skips the GMT value forward at the start of the shadow interval,
 while my code does this at the end.
 See Timely::InternalJulian
\begin_inset space ~
\end_inset

().
 Hence 
\family typewriter
$mine2
\family default
 below:
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

      if($mine ne $yours)
\end_layout

\begin_layout Plain Layout

        { my($mine2) = Timely::Greg($JD + $shadow,
 0,
 0,
 1);
 # compensate for TZ jump!
\end_layout

\begin_layout Plain Layout

          $mine2 =~ s/ /T/;
\end_layout

\begin_layout Plain Layout

        if($mine2 eq $yours)
\end_layout

\begin_layout Plain Layout

          { ## &Debug (0,"
\backslash
n OK Zone $zone OK(+) $mine");
 
\end_layout

\begin_layout Plain Layout

            print '+';
\end_layout

\begin_layout Plain Layout

          } else
\end_layout

\begin_layout Plain Layout

          { Timely::XPrint(0,
 "
\backslash
n   Mismatch(TZ) $zid/$zone $mine v $yours" .
 $TICK);
 
\end_layout

\begin_layout Plain Layout

            $ERR++;
\end_layout

\begin_layout Plain Layout

          };
\end_layout

\begin_layout Plain Layout

        } else
\end_layout

\begin_layout Plain Layout

        { ## &Debug (0,"
\backslash
n OK Zone $zone OK:
 $mine");
 
\end_layout

\begin_layout Plain Layout

          print '.';
\end_layout

\begin_layout Plain Layout

        };
\end_layout

\begin_layout Plain Layout

      };
\end_layout

\begin_layout Plain Layout

    };
  # end foreach
\end_layout

\begin_layout Plain Layout

    $YEAR --;
\end_layout

\begin_layout Plain Layout

  };
  # end while
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
Show error count and exit.
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

  Timely::XPrint( 0,
 "
\backslash
n
\backslash
n Errors=$ERR,
 $ANOMALIES anomalies "
\end_layout

\begin_layout Plain Layout

    .
 ($myLowYear+1) .
 "--
\begin_inset Quotes erd
\end_inset

 
\end_layout

\begin_layout Plain Layout

    .
 Timely::PrettyDate(0,$TOPYEAR,
 $MONTH,
 $DAY,
 $HOUR,
 $MINUTE,
 $SECOND) );
 
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Section
Around
\end_layout

\begin_layout Standard
Given a year,
 return all of the relevant transitions around that year (also for the preceding and following years),
 preformatted as date + zone offset + dst.
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

sub Around # 
\end_layout

\begin_layout Plain Layout

{ my($zone,
 $inp,
 $NUMBR);
\end_layout

\begin_layout Plain Layout

    ($zone,
 $inp,
 $NUMBR)=@_;
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  my($handDB) = $smalltime_h;
  
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  my($YEARTOP);
\end_layout

\begin_layout Plain Layout

  my($YEARBOT);
\end_layout

\begin_layout Plain Layout

if( $inp =~ /^
\backslash
s*(
\backslash
d{4})
\backslash
s+(
\backslash
d{4})
\backslash
s*$/ )
\end_layout

\begin_layout Plain Layout

  { $YEARTOP = $2;
\end_layout

\begin_layout Plain Layout

    $YEARBOT = $1;
\end_layout

\begin_layout Plain Layout

  }
\end_layout

\begin_layout Plain Layout

elsif($inp =~ /^
\backslash
s*(
\backslash
d{4}
\backslash
s*$)/ ) #  YYYY
\end_layout

\begin_layout Plain Layout

  { $YEARTOP = $1+1;
       # defaults to year-1 ..
 year+1 
\end_layout

\begin_layout Plain Layout

    $YEARBOT = $1-1;
    
\end_layout

\begin_layout Plain Layout

  } 
\end_layout

\begin_layout Plain Layout

elsif($inp =~ /^
\backslash
s*$/ )  # just space or empty 
\end_layout

\begin_layout Plain Layout

  { my($YYYY,$MM,$DD,$h,$m,$s,
 undef,undef,
 $hog,
 undef,
 undef)
\end_layout

\begin_layout Plain Layout

                # dummy values  ^    ^            ^      ^ 
\end_layout

\begin_layout Plain Layout

     = Timely::J2G(1,
 $zone,
 $NUMBR);
 
\end_layout

\begin_layout Plain Layout

  if(!
 $YYYY)
\end_layout

\begin_layout Plain Layout

    { return(" Bad year for 'around' using current:
 
\begin_inset Quotes eld
\end_inset

 
\end_layout

\begin_layout Plain Layout

             .
 &JulianDay($NUMBR) .
 
\begin_inset Quotes eld
\end_inset


\backslash
n");
 # unlikely?!
\end_layout

\begin_layout Plain Layout

    };
\end_layout

\begin_layout Plain Layout

    $YEARTOP = $YYYY+1;
 
\end_layout

\begin_layout Plain Layout

    $YEARBOT = $YYYY-1;
 
\end_layout

\begin_layout Plain Layout

  }
\end_layout

\begin_layout Plain Layout

else
\end_layout

\begin_layout Plain Layout

  { return( 
\begin_inset Quotes eld
\end_inset

Bad parameters for a '$inp'
\backslash
n
\begin_inset Quotes erd
\end_inset

 );
 
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  # better to sort here than in database,
 but for now...
\end_layout

\begin_layout Plain Layout

  my($q) = "SELECT transition,
 dst,
 zone_offset,
 ignored from timely "
\end_layout

\begin_layout Plain Layout

    .
 "WHERE region = $zone AND year BETWEEN $YEARBOT AND $YEARTOP "
\end_layout

\begin_layout Plain Layout

    .
 "ORDER BY transition";
  # ASCending order
\end_layout

\begin_layout Plain Layout

  ##  .
 "AND ignored = 0 ORDER BY transition";
  
\end_layout

\begin_layout Plain Layout

      # ENCOMPASSES year of interest!
\end_layout

\begin_layout Plain Layout

  my(@ROWS) = Timely::SQLManySQL($handDB,
 $q,
 'get all rows');
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  my($r);
\end_layout

\begin_layout Plain Layout

  my(@P) = ();
\end_layout

\begin_layout Plain Layout

foreach $r (@ROWS)
\end_layout

\begin_layout Plain Layout

  { my($TR,
 $D,
 $Z,
 $ign) = @$r;
  # transition,
 dst,
 zone,
 ignored
\end_layout

\begin_layout Plain Layout

    my($flag) = '';
\end_layout

\begin_layout Plain Layout

  if($ign) 
\end_layout

\begin_layout Plain Layout

    { $flag = '[x]';
 # signal this is supplementary,
 can be 'ignored' 
\end_layout

\begin_layout Plain Layout

    };
\end_layout

\begin_layout Plain Layout

    my($tr) = Timely::HugeToJ($TR);
\end_layout

\begin_layout Plain Layout

    my($d)  = Timely::HugeToJ($D);
\end_layout

\begin_layout Plain Layout

    my($z)  = Timely::HugeToJ($Z);
\end_layout

\begin_layout Plain Layout

    push(@P,
 sprintf( "%.10f",
 &JulianDay($tr) ) .
 ' / ' .
 &Dat($tr) 
\end_layout

\begin_layout Plain Layout

         .
 ' z=' .
 &Tim($z) .
 ' d=' .
 &Tim($d) .
 ' --> ' 
\end_layout

\begin_layout Plain Layout

         .
 &Dat( $tr+$z+$d ) .
 " $flag" );
 
\end_layout

\begin_layout Plain Layout

    # Dat_() value is GPS time,
 not adjusted for zone/DST.
\end_layout

\begin_layout Plain Layout

  };
  
\end_layout

\begin_layout Plain Layout

  ## separable..
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  print "
\backslash
n Transitions for $zone ($inp);
 
\begin_inset Quotes eld
\end_inset


\end_layout

\begin_layout Plain Layout

      .
 
\begin_inset Quotes eld
\end_inset

[x] signifies 'Ignorable:
 end of year prosthetic':" ;
\end_layout

\begin_layout Plain Layout

  my($rw);
 
\end_layout

\begin_layout Plain Layout

foreach $rw (@P)
\end_layout

\begin_layout Plain Layout

  { print "
\backslash
n $rw";
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

  print "
\backslash
n";
\end_layout

\begin_layout Plain Layout

  return('');
 # ok 
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
I append [x] to rows that have been inserted for convenience (at year end) but can be ignored.
 
\begin_inset Note Note
status open

\begin_layout Plain Layout
A potential problem is where we have a transition at the start of a new year,
 for example Auckland in 1945/46.
\end_layout

\end_inset


\end_layout

\begin_layout Subsubsection
Selective logging
\begin_inset CommandInset label
LatexCommand label
name "subsec:Selective-logging:Debug"

\end_inset


\end_layout

\begin_layout Standard
If 
\family typewriter
$BUG
\family default
 is nonzero,
 then only do we log the line.
 We also allow the submitted parameter ($naah) to suppress logging.
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

sub Debug #
\end_layout

\begin_layout Plain Layout

{ my($naah,
 $msg) = @_;
\end_layout

\begin_layout Plain Layout

if(!
 $BUG) 
\end_layout

\begin_layout Plain Layout

  { return;
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

if($naah)
\end_layout

\begin_layout Plain Layout

  { return;
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

  Timely::Log($msg);
 
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Section
List leap seconds
\begin_inset CommandInset label
LatexCommand label
name "subsec:List-leap-seconds"

\end_inset


\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

sub ListLeapseconds # 
\end_layout

\begin_layout Plain Layout

{ my($handDB) = $smalltime_h;
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  my($q) = "SELECT toffset,
 utctime from leapseconds WHERE 1 ";
  
\end_layout

\begin_layout Plain Layout

  my(@ROWS) = Timely::SQLManySQL($handDB,
 $q,
 'get leapseconds');
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  my($r);
\end_layout

\begin_layout Plain Layout

  print 
\begin_inset Quotes eld
\end_inset


\backslash
n ==================================================
\backslash
n
\begin_inset Quotes erd
\end_inset

;
 
\end_layout

\begin_layout Plain Layout

  print 
\begin_inset Quotes eld
\end_inset

                LIST OF LEAPSECONDS
\backslash
n
\begin_inset Quotes erd
\end_inset

;
 
\end_layout

\begin_layout Plain Layout

  print 
\begin_inset Quotes eld
\end_inset

 --------------------------------------------------
\backslash
n
\begin_inset Quotes erd
\end_inset

;
 
\end_layout

\begin_layout Plain Layout

  print  
\begin_inset Quotes eld
\end_inset

 Offset  Julian timestamp       Gregorian date
\backslash
n
\begin_inset Quotes erd
\end_inset

;
 
\end_layout

\begin_layout Plain Layout

foreach $r (@ROWS)
\end_layout

\begin_layout Plain Layout

  { my($offset,
 $TM) = @$r;
  
\end_layout

\begin_layout Plain Layout

    my($sp) = '';
 
\end_layout

\begin_layout Plain Layout

  if(length $offset < 2)
\end_layout

\begin_layout Plain Layout

    { $sp = ' ';
 
\end_layout

\begin_layout Plain Layout

    };
\end_layout

\begin_layout Plain Layout

    my($J) = $TM/1000000;
 # Julian day number,
 NOT GPS adjusted
\end_layout

\begin_layout Plain Layout

    my($YY,
 $MM,
 $DD,
 $h,
 $m,
 $s) = Timely::FullGregorian($J,
 0,
 0,
 0);
 # $J in seconds
\end_layout

\begin_layout Plain Layout

    print 
\begin_inset Quotes eld
\end_inset

  $sp $offset      
\begin_inset Quotes erd
\end_inset

 .
 sprintf( 
\begin_inset Quotes eld
\end_inset

%.4f
\begin_inset Quotes erd
\end_inset

,
 &JulianDay($J) ) 
\end_layout

\begin_layout Plain Layout

        .
 
\begin_inset Quotes eld
\end_inset

       
\begin_inset Quotes erd
\end_inset

 .
 Timely::PrettyDate(0,$YY,$MM,$DD,$h,$m,$s) .
 
\begin_inset Quotes erd
\end_inset


\backslash
n
\begin_inset Quotes erd
\end_inset

;
 
\end_layout

\begin_layout Plain Layout

  };
  
\end_layout

\begin_layout Plain Layout

  print 
\begin_inset Quotes eld
\end_inset

 --------------------------------------------------
\backslash
n
\begin_inset Quotes erd
\end_inset

;
 
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Section
Test one zone
\begin_inset CommandInset label
LatexCommand label
name "subsec:Test-one-zone"

\end_inset


\end_layout

\begin_layout Standard
Accepts:
\end_layout

\begin_layout Description
zone The zone
\end_layout

\begin_layout Description
inp A text input of parameter(s)
\end_layout

\begin_layout Description
intrv The interval between tests,
 in seconds.
 
\end_layout

\begin_layout Standard
Within a range of years (or just one),
 test the current,
 instantiated zone at a given interval.
 It's important to realise that we are simply testing each (incremented) Julian value by converting it to Gregorian using my internal algorithm,
 and back again.
 The Julian value increases monotonically,
 while we expect the Gregorian to jump around in accordance with DST and zone changes.
 If the Gregorian to Julian routine (G2J) is working correctly,
 then jumps forward at the start of DST should be seamless,
 and jumps back should be evidenced by a 
\begin_inset Quotes eld
\end_inset

shadow
\begin_inset Quotes erd
\end_inset

 value equal to the magnitude of the 
\begin_inset Quotes eld
\end_inset

groundhog time
\begin_inset Quotes erd
\end_inset

 spent running the hour again (as the Julian day value increases inexorably).
 
\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
[A problem is the start of the groundhog interval,
 for example just y 2000 should result in an error if this isn't accommodated (with the default i of 3000 s]
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

sub TestOneZone # 
\end_layout

\begin_layout Plain Layout

{ my($zone,
 $inp,
 $intrv);
\end_layout

\begin_layout Plain Layout

    ($zone,
 $inp,
 $intrv)=@_;
\end_layout

\begin_layout Plain Layout

  # might here check/sanitise,
 ensure intrv >= 1;
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  my($YYYY,
 $MM,
 $DD,
 $h,
 $m,
 $s,
 
\end_layout

\begin_layout Plain Layout

     $eYYYY,
 $eMM,
 $eDD,
 $eh,
 $em,
 $es) = &ReadDateRange($inp);
 
\end_layout

\begin_layout Plain Layout

if( $zone == Timely::GetUtcCode() )
\end_layout

\begin_layout Plain Layout

  { print 
\begin_inset Quotes eld
\end_inset

Not tested,
 zone is UTC
\backslash
n
\begin_inset Quotes erd
\end_inset

;
\end_layout

\begin_layout Plain Layout

    return;
\end_layout

\begin_layout Plain Layout

  };
 
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
Checks:
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

if( ($YYYY < 1)
\end_layout

\begin_layout Plain Layout

  ||($eYYYY < 1)
\end_layout

\begin_layout Plain Layout

  )
\end_layout

\begin_layout Plain Layout

  { print 
\begin_inset Quotes eld
\end_inset

Bad argument for zone '$inp'
\backslash
n
\begin_inset Quotes erd
\end_inset

;
\end_layout

\begin_layout Plain Layout

    return;
\end_layout

\begin_layout Plain Layout

  };
 
\end_layout

\begin_layout Plain Layout

if($eYYYY < $YYYY)
\end_layout

\begin_layout Plain Layout

  { print 
\begin_inset Quotes eld
\end_inset

Start $YYYY can't be before end $eYYYY
\backslash
n
\begin_inset Quotes erd
\end_inset

;
\end_layout

\begin_layout Plain Layout

    return;
\end_layout

\begin_layout Plain Layout

  };
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

if($intrv < 1)
\end_layout

\begin_layout Plain Layout

  { print "
\backslash
n Interval must be a second or greater";
\end_layout

\begin_layout Plain Layout

    return;
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

  print " Testing zone $zone from 
\begin_inset Quotes eld
\end_inset

 
\end_layout

\begin_layout Plain Layout

      .
 Timely::PrettyDate(0,
 $YYYY,
 $MM,
 $DD,
 $h,
 $m,
 $s) 
\end_layout

\begin_layout Plain Layout

      .
 
\begin_inset Quotes eld
\end_inset

 to 
\begin_inset Quotes eld
\end_inset

 .
 Timely::PrettyDate(0,
  $eYYYY,
 $eMM,
 $eDD,
 $eh,
 $em,
 $es) 
\end_layout

\begin_layout Plain Layout

      .
 
\begin_inset Quotes eld
\end_inset

,
 interval=$intrv" .
 "s
\backslash
n";
\end_layout

\begin_layout Plain Layout

  ShowEscMessage();
 
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
Setup.
 Note that 
\family typewriter
$shadow
\family default
 values are in seconds.
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

  my($JHi,
 $shadow1) = Timely::G2J(1,
 $zone,
 $eYYYY,
 $eMM,
 $eDD,
 $eh,
 $em,
 $es);
 #
\end_layout

\begin_layout Plain Layout

if( $JHi < MINIMUMDATE)
\end_layout

\begin_layout Plain Layout

  { Timely::Warn(3,
 "Bad top value in '$inp' (code $shadow1)");
 
\end_layout

\begin_layout Plain Layout

    return;
\end_layout

\begin_layout Plain Layout

  };
  
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  my($J,
 $shadow2) = Timely::G2J(1,
 $zone,
 $YYYY,
 $MM,
 $DD,
 $h,
 $m,
 $s);
 #
\end_layout

\begin_layout Plain Layout

if($J < MINIMUMDATE)
\end_layout

\begin_layout Plain Layout

  { print "
\backslash
nBad start value in '$inp' (code $shadow2)";
\end_layout

\begin_layout Plain Layout

    return;
\end_layout

\begin_layout Plain Layout

  };
    # might similarly check $shadow2
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  my($oops) = 0;
\end_layout

\begin_layout Plain Layout

  my($ok) = 0;
 
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
Loop around.
 From J2G
\begin_inset space ~
\end_inset

() retrieve a Gregorian timestamp and then convert this back to Julian.
 If the two values are discordant,
 we have a problem—
alert to this.
 See how G2J
\begin_inset space ~
\end_inset

() also returns a 
\begin_inset Quotes eld
\end_inset

shadow
\begin_inset Quotes erd
\end_inset

 value.
 This is ordinarily zero,
 but may be positive or negative if we have an ambivalent wall time (Gregorian time),
 noting that when the zone or daylight saving falls back,
 one wall time will map to two Julian timestamps.
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

REDO:
 while($J < $JHi)
\end_layout

\begin_layout Plain Layout

  { 
\end_layout

\begin_layout Plain Layout

  if( CheckForEscape() )
\end_layout

\begin_layout Plain Layout

    { $J = $JHi;
\end_layout

\begin_layout Plain Layout

      next REDO;
             # 
\end_layout

\begin_layout Plain Layout

    };
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

    my($YY,
 $MM,
 $DD,
 $h,
 $m,
 $s,undef,
 undef,
 $hog,
 undef,
 undef) 
\end_layout

\begin_layout Plain Layout

                   # dummy values  ^    ^            ^      ^
\end_layout

\begin_layout Plain Layout

          = Timely::J2G(1,
 $zone,
 $J);
 
\end_layout

\begin_layout Plain Layout

    my($K,
 $shadow3) = Timely::G2J(1,
 $zone,
 $YY,$MM,$DD,
 $h,$m,$s);
\end_layout

\begin_layout Plain Layout

    my($delta) = $K-$J;
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  if( (abs($delta) > 1)
\end_layout

\begin_layout Plain Layout

    || $shadow3
\end_layout

\begin_layout Plain Layout

    )
\end_layout

\begin_layout Plain Layout

    { my($d) = $delta;
 # for now simply transfer [explore]
\end_layout

\begin_layout Plain Layout

    if( ( abs($d+$shadow3) > 0 )  # if shadow doesn't accommodate discrepancy
\end_layout

\begin_layout Plain Layout

      &&($d)                      # and not just the first groundhog 
\end_layout

\begin_layout Plain Layout

      )
\end_layout

\begin_layout Plain Layout

      { Timely::XPrint(0,
 "
\backslash
n Discrepancy($d) at $J = 
\begin_inset Quotes eld
\end_inset

 
\end_layout

\begin_layout Plain Layout

        .
 Timely::PrettyDate(0,$YY,$MM,$DD,$h,$m,$s) 
\end_layout

\begin_layout Plain Layout

        .
 
\begin_inset Quotes eld
\end_inset

 (shadow=$shadow3),
 interval=$intrv,
 J=
\begin_inset Quotes erd
\end_inset

 
\end_layout

\begin_layout Plain Layout

        .
 sprintf(
\begin_inset Quotes eld
\end_inset

%.12f
\begin_inset Quotes erd
\end_inset

,
 $J) .
 ' K=' .
 sprintf(
\begin_inset Quotes eld
\end_inset

%.12f
\begin_inset Quotes erd
\end_inset

,
 $K) );
\end_layout

\begin_layout Plain Layout

        $oops ++;
\end_layout

\begin_layout Plain Layout

        print '?';
\end_layout

\begin_layout Plain Layout

      if($oops > $MAXOOPS)
\end_layout

\begin_layout Plain Layout

        { print "
\backslash
n Too many errors!";
\end_layout

\begin_layout Plain Layout

          return;
\end_layout

\begin_layout Plain Layout

        };
\end_layout

\begin_layout Plain Layout

      } else
\end_layout

\begin_layout Plain Layout

      { 
\end_layout

\begin_layout Plain Layout

      if($d)
\end_layout

\begin_layout Plain Layout

        { print '+';
   # signal concordant shadow value
\end_layout

\begin_layout Plain Layout

        } else
\end_layout

\begin_layout Plain Layout

        { print '-';
   # signal first shadow transition
\end_layout

\begin_layout Plain Layout

        };
\end_layout

\begin_layout Plain Layout

      };
\end_layout

\begin_layout Plain Layout

    };
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
Pretty dots:
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

  if($ok % (50*$PRETTYDOTS) == 0) # every $PRETTYDOTS dots
\end_layout

\begin_layout Plain Layout

    { print 
\begin_inset Quotes eld
\end_inset


\backslash
n
\begin_inset Quotes erd
\end_inset

 .
 &Dat($K) .
 ' ';
\end_layout

\begin_layout Plain Layout

    };
 
\end_layout

\begin_layout Plain Layout

  if($ok % 50 == 0)  # every 50 
\end_layout

\begin_layout Plain Layout

    { print '.';
\end_layout

\begin_layout Plain Layout

    };
\end_layout

\begin_layout Plain Layout

    $ok ++;
 
\end_layout

\begin_layout Plain Layout

    $J += $intrv;
 # use this instead of increasing $J by a fraction of a day
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

  Timely::XPrint(0,
 "
\backslash
n Internal reconciliation for zone $zone.
 Errors=$oops/$ok
\backslash
n");
 
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Subsection
Test and reconcile zone in range
\begin_inset CommandInset label
LatexCommand label
name "subsec:Test-and-reconcile-zone-in-range"

\end_inset


\end_layout

\begin_layout Standard
Given zone,
 testing interval and range of years,
 test at that interval as follows:
\end_layout

\begin_layout Enumerate
Get UTC value for year start,
 and convert to Julian;
\end_layout

\begin_layout Enumerate
Convert:
 
\end_layout

\begin_deeper
\begin_layout Enumerate
Convert using Timely to the corresponding wall time;
\end_layout

\begin_layout Enumerate
Do the same using tz (DateTime);
\end_layout

\begin_layout Enumerate
Issue a warning if the two don't match
\end_layout

\begin_layout Enumerate
Increment the Julian value by the specified interval,
 and repeat.
 
\end_layout

\end_deeper
\begin_layout Standard
This is similar to the 't' command in its use of timestamps,
 but performs an external reconciliation.
 
\begin_inset Note Note
status collapsed

\begin_layout Plain Layout
There's a subtle catch here
\begin_inset Note Note
status collapsed

\begin_layout Plain Layout
,
 explored in detail in Section
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:A-bit-of-a-problem"
plural "false"
caps "false"
noprefix "false"
nolink "false"

\end_inset


\end_layout

\end_inset

.
 
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

sub ReconcileOneZone # 
\end_layout

\begin_layout Plain Layout

{ my($zone,
 $zoneNAME,
 $inp,
 $intrv);
\end_layout

\begin_layout Plain Layout

    ($zone,
 $zoneNAME,
 $inp,
 $intrv)=@_;
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

if( $zone == Timely::GetUtcCode() )
\end_layout

\begin_layout Plain Layout

  { print 
\begin_inset Quotes eld
\end_inset

Not tested,
 zone is UTC
\backslash
n
\begin_inset Quotes erd
\end_inset

;
\end_layout

\begin_layout Plain Layout

    return;
\end_layout

\begin_layout Plain Layout

  };
 
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
Initial checks:
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

 my($YYYY,
 $MM,
 $DD,
 $h,
 $m,
 $s,
 
\end_layout

\begin_layout Plain Layout

   $eYYYY,
 $eMM,
 $eDD,
 $eh,
 $em,
 $es) = &ReadDateRange($inp);
 
\end_layout

\begin_layout Plain Layout

if( ($YYYY < 1)
\end_layout

\begin_layout Plain Layout

  ||($eYYYY < 1)
\end_layout

\begin_layout Plain Layout

  )
\end_layout

\begin_layout Plain Layout

  { print 
\begin_inset Quotes eld
\end_inset

Bad argument for zone '$inp'
\backslash
n
\begin_inset Quotes erd
\end_inset

;
\end_layout

\begin_layout Plain Layout

    return;
\end_layout

\begin_layout Plain Layout

  };
 
\end_layout

\begin_layout Plain Layout

if($eYYYY < $YYYY)
\end_layout

\begin_layout Plain Layout

  { print 
\begin_inset Quotes eld
\end_inset

Start $YYYY can't be before end $eYYYY
\backslash
n
\begin_inset Quotes erd
\end_inset

;
\end_layout

\begin_layout Plain Layout

    return;
\end_layout

\begin_layout Plain Layout

  };
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

if($intrv < 1)
\end_layout

\begin_layout Plain Layout

  { print "
\backslash
n Interval must be a second or greater";
\end_layout

\begin_layout Plain Layout

    return;
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

  print " Reconciling zone $zone from $YYYY-$MM-$DD $h:$m:$s to 
\begin_inset Quotes eld
\end_inset


\end_layout

\begin_layout Plain Layout

      .
 
\begin_inset Quotes eld
\end_inset

$eYYYY-$eMM-$eDD $eh:$em:$es,
 interval=$intrv
\backslash
n";
\end_layout

\begin_layout Plain Layout

  ShowEscMessage();
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  my($JHi) = Timely::GpsJulian($eYYYY,
 $eMM,
 $eDD,
 $eh,
 $em,
 $es,
  0,
 0,
 0);
 
\end_layout

\begin_layout Plain Layout

if( $JHi < MINIMUMDATE)
\end_layout

\begin_layout Plain Layout

  { Timely::Warn(3,
 "$eYYYY is too small");
 
\end_layout

\begin_layout Plain Layout

    return;
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

  my($J) = Timely::GpsJulian($YYYY,
 $MM,
 $DD,
 $h,
 $m,
 $s,
  0,
 0,
 0);
\end_layout

\begin_layout Plain Layout

if($J < MINIMUMDATE)
\end_layout

\begin_layout Plain Layout

  { Timely::Warn(3,
 "$YYYY is too small");
\end_layout

\begin_layout Plain Layout

    return;
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
Main loop:
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

  my($JMED) = $J;
 # seconds [fixup!]
\end_layout

\begin_layout Plain Layout

  my($ERR) = 0;
 
\end_layout

\begin_layout Plain Layout

  my($ANOMALIES) = 0;
 # [do we need this?
 explore] 
\end_layout

\begin_layout Plain Layout

  my($ok) = 0;
 
\end_layout

\begin_layout Plain Layout

REDO:
 while($J < $JHi)
\end_layout

\begin_layout Plain Layout

  { 
\end_layout

\begin_layout Plain Layout

  if( CheckForEscape() )
\end_layout

\begin_layout Plain Layout

    { $J = $JHi;
\end_layout

\begin_layout Plain Layout

      next REDO;
             # 
\end_layout

\begin_layout Plain Layout

    };
\end_layout

\begin_layout Plain Layout

    
\end_layout

\begin_layout Plain Layout

    #1.
 Turn Julian timestamp into UTC Gregorian 
\end_layout

\begin_layout Plain Layout

    $J = $JMED;
 # prevent cumulative error
\end_layout

\begin_layout Plain Layout

    my($YEAR,
 $jMM,
 $jDD,
 $jh,
 $jm,
 $js) = Timely::FullGregorian($J,
 0,
 0,
 1);
  
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

    #2.
 Turn Julian into *local* zone Gregorian
\end_layout

\begin_layout Plain Layout

    my($zYYYY,$zMM,$zDD,$zh,$zm,$zs,
 undef,
 undef,
 $hog,
 undef,
 undef) 
\end_layout

\begin_layout Plain Layout

                      # dummy values  ^    ^             ^      ^ 
\end_layout

\begin_layout Plain Layout

       = Timely::J2G(1,
 $zone,
 $J);
 
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
Anomaly?
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

  if($zYYYY == 0)  # anomalous date
\end_layout

\begin_layout Plain Layout

    { Timely::XPrint(0,
 "
\backslash
n   'Anomaly' skipped:
 $zone $J");
 
\end_layout

\begin_layout Plain Layout

      $ANOMALIES ++;
\end_layout

\begin_layout Plain Layout

    } else
\end_layout

\begin_layout Plain Layout

    { #3.
 Turn UTC Gregorian values into tz object 
\end_layout

\begin_layout Plain Layout

      my($dt1) = eval { DateTime->new( year => $YEAR,
 month => $jMM,
 day => $jDD,
\end_layout

\begin_layout Plain Layout

         hour => $jh,
 minute => $jm,
 second => $js,
 time_zone => 'UTC') };
     
\end_layout

\begin_layout Plain Layout

         
\end_layout

\begin_layout Plain Layout

      #4.
 Turn tz into cloned object for this zone 
\end_layout

\begin_layout Plain Layout

      my($dtest) = eval { $dt1->clone->set_time_zone( $zoneNAME ) };
\end_layout

\begin_layout Plain Layout

    if(!
 $dtest)
\end_layout

\begin_layout Plain Layout

      { Timely::Warn(3,
 
\begin_inset Quotes eld
\end_inset

INVALID(Perl DateTime test)$zone [$YEAR $jMM $jDD $jh $jm $js]
\begin_inset Quotes erd
\end_inset

);
 
\end_layout

\begin_layout Plain Layout

      } else 
\end_layout

\begin_layout Plain Layout

      { #5.
 compare local & tz 
\end_layout

\begin_layout Plain Layout

        my($mine) = Timely::PrettyDate(1,$zYYYY,
 $zMM,
 $zDD,
 $zh,
 $zm,
 $zs);
 
\end_layout

\begin_layout Plain Layout

        my($yours) = $dtest->datetime();
  # format is identical
\end_layout

\begin_layout Plain Layout

      if($mine ne $yours)
\end_layout

\begin_layout Plain Layout

        {           
\end_layout

\begin_layout Plain Layout

          Timely::XPrint( 0,
 "
\backslash
n   Mismatch $mine v external $yours =>" .
 &Dat($J) 
\end_layout

\begin_layout Plain Layout

                   .
 ' <=' .
 sprintf("%.12f",
 $J) );
 
\end_layout

\begin_layout Plain Layout

          $ERR++;
\end_layout

\begin_layout Plain Layout

        };
\end_layout

\begin_layout Plain Layout

      };
\end_layout

\begin_layout Plain Layout

    };
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
Pretty up,
 continue:
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

  if($ok % (50*$PRETTYDOTS) == 0) # every $PRETTYDOTS dots
\end_layout

\begin_layout Plain Layout

    { print 
\begin_inset Quotes eld
\end_inset


\backslash
n
\begin_inset Quotes erd
\end_inset

 .
 &Dat($J) .
 ' ';
\end_layout

\begin_layout Plain Layout

    };
 
\end_layout

\begin_layout Plain Layout

  if($ok % 50 == 0)  # every 50 
\end_layout

\begin_layout Plain Layout

    { print '.';
\end_layout

\begin_layout Plain Layout

    };
\end_layout

\begin_layout Plain Layout

    $ok ++;
 
\end_layout

\begin_layout Plain Layout

    $JMED += $intrv;
 # use this instead  [fix me!
 no longer needed!!] 
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
Done:
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

  Timely::XPrint(0,
 "
\backslash
n Reconciliation for zone $zone.
 
\begin_inset Quotes eld
\end_inset


\end_layout

\begin_layout Plain Layout

           .
 
\begin_inset Quotes eld
\end_inset

Errors=$ERR/$ok Anomalies=$ANOMALIES
\backslash
n");
 
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Subsection
Read date range
\end_layout

\begin_layout Standard
Complex,
 allowing for one or two dates;
 if just one date,
 then the second defaults to the end of the first year.
 Either date can be in format YYYY or YYYY-MM-DD hh:mm:ss.
 Somewhat forgiving.
 Returns twelve (!) values,
 the start YYYY MM DD h m s and likewise for the end date.
 Does not validate the dates.
 On error,
 returns a first value of 0.
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

sub ReadDateRange # 
\end_layout

\begin_layout Plain Layout

{ my($inp);
\end_layout

\begin_layout Plain Layout

    ($inp)=@_;
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  my($YYYY,
 $MM,
 $DD,
 $h,
 $m,
 $s) = (0,
 1,
 1,
 0,
 0,
 0);
 
\end_layout

\begin_layout Plain Layout

  my($eYYYY,
 $eMM,
 $eDD,
 $eh,
 $em,
 $es) = (0,
 12,
 31,
 23,
 59,
 59);
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  my($more);
 
\end_layout

\begin_layout Plain Layout

if($inp =~ /^
\backslash
s*(
\backslash
d{4})-(
\backslash
d+)-(
\backslash
d+)[ T](
\backslash
d+):(
\backslash
d+):(
\backslash
d+)(.*)$/ )
\end_layout

\begin_layout Plain Layout

  { ($YYYY,
 $MM,
 $DD,
 $h,
 $m,
 $s,
 $more) = ($1,
 $2,
 $3,
 $4,
 $5,
 $6,
 $7);
\end_layout

\begin_layout Plain Layout

  if($more =~ /^
\backslash
s*(
\backslash
d{4})-(
\backslash
d+)-(
\backslash
d+)[ T](
\backslash
d+):(
\backslash
d+):(
\backslash
d+)
\backslash
s*$/ )
\end_layout

\begin_layout Plain Layout

    { ($eYYYY,
 $eMM,
 $eDD,
 $eh,
 $em,
 $es) = ($1,
 $2,
 $3,
 $4,
 $5,
 $6);
\end_layout

\begin_layout Plain Layout

    } 
\end_layout

\begin_layout Plain Layout

  elsif($more =~ /^
\backslash
s*(
\backslash
d{4})
\backslash
s*$/ )
\end_layout

\begin_layout Plain Layout

    { $eYYYY = $1;
 
\end_layout

\begin_layout Plain Layout

    }
\end_layout

\begin_layout Plain Layout

  elsif($more =~ /^
\backslash
s*$/ )
\end_layout

\begin_layout Plain Layout

    { $eYYYY = $YYYY;
\end_layout

\begin_layout Plain Layout

    } 
\end_layout

\begin_layout Plain Layout

  else
\end_layout

\begin_layout Plain Layout

    { # FAIL:
 leave $YYYY at zero!
 
\end_layout

\begin_layout Plain Layout

    };
\end_layout

\begin_layout Plain Layout

  }
\end_layout

\begin_layout Plain Layout

elsif($inp =~ /^
\backslash
s*(
\backslash
d{4})
\backslash
s+(
\backslash
d{4})-(
\backslash
d+)-(
\backslash
d+)[ T](
\backslash
d+):(
\backslash
d+):(
\backslash
d+)
\backslash
s*$/ )
\end_layout

\begin_layout Plain Layout

  { ($YYYY,
  $eYYYY,
 $eMM,
 $eDD,
 $eh,
 $em,
 $es) = ($1,
  $2,
 $3,
 $4,
 $5,
 $6,
 $7);
\end_layout

\begin_layout Plain Layout

  } 
\end_layout

\begin_layout Plain Layout

elsif($inp =~ /^
\backslash
s*(
\backslash
d{4})
\backslash
s+(
\backslash
d{4})
\backslash
s*$/ )
\end_layout

\begin_layout Plain Layout

  { $YYYY = $1;
\end_layout

\begin_layout Plain Layout

    $eYYYY = $2;
 
\end_layout

\begin_layout Plain Layout

  }
\end_layout

\begin_layout Plain Layout

elsif($inp =~ /^
\backslash
s*(
\backslash
d{4})
\backslash
s*$/ )
\end_layout

\begin_layout Plain Layout

  { $YYYY = $1;
\end_layout

\begin_layout Plain Layout

    $eYYYY = $YYYY;
 
\end_layout

\begin_layout Plain Layout

  }
\end_layout

\begin_layout Plain Layout

else
\end_layout

\begin_layout Plain Layout

  { # leave YYYY at 0.
 
\end_layout

\begin_layout Plain Layout

  };
 
\end_layout

\begin_layout Plain Layout

 return($YYYY,
 $MM,
 $DD,
 $h,
 $m,
 $s,
  $eYYYY,
 $eMM,
 $eDD,
 $eh,
 $em,
 $es);
 
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Subsection
Show Escape Message
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

sub ShowEscMessage # 
\end_layout

\begin_layout Plain Layout

{ 
\end_layout

\begin_layout Plain Layout

if($READKEYBLOCKINGPROBLEM)
\end_layout

\begin_layout Plain Layout

  { return;
  # do nothing
\end_layout

\begin_layout Plain Layout

  };
 
\end_layout

\begin_layout Plain Layout

  print 
\begin_inset Quotes eld
\end_inset

 Press Esc to escape..
\backslash
n
\begin_inset Quotes erd
\end_inset

;
 
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Subsection
Check for Escape
\end_layout

\begin_layout Standard
If Esc key has been pressed (and this feature is enabled) then return 1;
 otherwise 0.
 $READKEYBLOCKINGPROBLEM is a global used because,
 when I changed in Windows to ActivePerl under Perl v
\begin_inset space ~
\end_inset

5.28,
 I encountered an error where the console blocks on 
\family typewriter
if(defined($key))
\family default
,
 waiting for input,
 regardless of ReadMode specifications.
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

sub CheckForEscape 
\end_layout

\begin_layout Plain Layout

{ 
\end_layout

\begin_layout Plain Layout

if($READKEYBLOCKINGPROBLEM)
\end_layout

\begin_layout Plain Layout

  { return(0);
\end_layout

\begin_layout Plain Layout

  };
 
\end_layout

\begin_layout Plain Layout

  ReadMode 4;
 # unbuffered 
\end_layout

\begin_layout Plain Layout

  my($key) = ReadKey(-1);
\end_layout

\begin_layout Plain Layout

  ReadMode 1;
 # normal.
\end_layout

\begin_layout Plain Layout

if( defined($key) ) # this should not block 
\end_layout

\begin_layout Plain Layout

  {
\end_layout

\begin_layout Plain Layout

  if(ord($key) == 27)  # Esc key pressed?
\end_layout

\begin_layout Plain Layout

    { return(1);
 
\end_layout

\begin_layout Plain Layout

    } else ## debug,
 but :
\end_layout

\begin_layout Plain Layout

    { print 
\begin_inset Quotes eld
\end_inset


\backslash
n==$key==
\backslash
n
\begin_inset Quotes erd
\end_inset

;
\end_layout

\begin_layout Plain Layout

    };
 
\end_layout

\begin_layout Plain Layout

  };
 
\end_layout

\begin_layout Plain Layout

  return(0);
 
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Section
Dates
\begin_inset CommandInset label
LatexCommand label
name "sec:Dates"

\end_inset


\end_layout

\begin_layout Subsection
Julian tests
\end_layout

\begin_layout Standard
Do not confuse Julian day numbers with Julian dates.
 
\begin_inset Note Note
status open

\begin_layout Plain Layout
[NB CHECK MY TERMINOLOGY,
 AS SOMETIMES I SURELY REFER TO 
\begin_inset Quotes eld
\end_inset

Julian date
\begin_inset Quotes erd
\end_inset

 when I mean Julian day number]
\end_layout

\end_inset


\end_layout

\begin_layout Standard
When we store 
\begin_inset Quotes eld
\end_inset

Julian day numbers
\begin_inset Quotes erd
\end_inset

 in 
\series bold
\emph on
f
\emph default
ehr
\series default
,
 we use big integer representations in microseconds since a reference point in the distant past (noon in Greenwich on January 1st,
 
\emph on
minus 4712
\emph default
);
 however it is more convenient (although less accurate) to use floating point calculations of 
\emph on
days
\emph default
 since this references time in both Perl and Javascript,
 as these default to floats.
 The Julian,
 floating point values are direct conversions of a familiar Gregorian date like 
\begin_inset Quotes eld
\end_inset

1901-01-01 12:00:00
\begin_inset Quotes erd
\end_inset

 to a corresponding float.
 But note there is also a 
\emph on
Julian calendar 
\emph default
last used in most countries in 1582.
 Even though we use Julian values,
 they refer to the (reformed) Gregorian calendar,
 so,
 for example,
 the above Gregorian date corresponds to 2415020.5 and not the matching Julian calendar date value of 2415032.5.
 (Take note that the Julian calendar took no account of fractional variations in leap values,
 simply allocating a leap day every fourth year;
 were you to stick to the Julian calendar,
 you'd have to accommodate this strangeness).
 
\end_layout

\begin_layout Standard
The following simply performs basic checks of the Julian conversion routines
\begin_inset Foot
status collapsed

\begin_layout Plain Layout
Reference at 
\begin_inset CommandInset href
LatexCommand href
name "http://mysite.verizon.net/aesir_research/date/back.htm"
target "http://mysite.verizon.net/aesir_research/date/back.htm"
literal "false"

\end_inset


\end_layout

\end_inset

:
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

sub TestJulian
\end_layout

\begin_layout Plain Layout

{ Timely::XPrint(0,
 "
\backslash
n *Testing reference dates* 
\backslash
n");
 
\end_layout

\begin_layout Plain Layout

  my($fail) =  &TestPair('1901',
 2415385.5,
 1901,1,1,
   0,0,0 );
  # start 20th century
\end_layout

\begin_layout Plain Layout

  $fail = &TestPair('UNIX',
 2440587.5,
 1970,1,1,
   0,0,0) || $fail;
  # UNIX reference
\end_layout

\begin_layout Plain Layout

  $fail = &TestPair(' DOS',
 2444239.5,
 1980,1,1,
   0,0,0) || $fail;
  # DOS reference
\end_layout

\begin_layout Plain Layout

  $fail = &TestPair('1900',
 2415020.5,
 1900,1,1,
   0,0,0) || $fail;
  # 1900
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  $fail = &TestPair('GREG',
 2299160.5,
 1582,10,15,
 0,0,0) || $fail;
  # D1 Gregorian reform
\end_layout

\begin_layout Plain Layout

  $fail = &TestPair('MJD0',
 2400000.5,
 1858,11,17,
 0,0,0) || $fail;
  # Modif.
 JD zero
\end_layout

\begin_layout Plain Layout

  $fail = &TestPair('RAT1',
 1721425.5,
 1,1,1,
      0,0,0) || $fail;
  # Rata die = 1
\end_layout

\begin_layout Plain Layout

  $fail = &TestPair('LAST',
 2299149.5,
 1582,10,4,
  0,0,0) || $fail;
  # 1D < Gregorian reform
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  $fail = &TestPair('1BC',
 1721059.5,
 0,1,1,
       0,0,0) || $fail;
  # D1,
 1BC (year 0)
\end_layout

\begin_layout Plain Layout

  $fail = &TestPair('JULI',
 38,
  -4712,1,1,
       12,0,0) || $fail;
  # JD reference
\end_layout

\begin_layout Plain Layout

  Timely::XPrint(0,
 "
\backslash
n
\backslash
n");
 
\end_layout

\begin_layout Plain Layout

if($fail)
\end_layout

\begin_layout Plain Layout

  { ## die "
\backslash
n*ERROR* Julian conversion(s) failed
\backslash
n";
\end_layout

\begin_layout Plain Layout

    return 1;
 # 
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

  
\end_layout

\begin_layout Plain Layout

  print 
\begin_inset Quotes eld
\end_inset

You shouldn't need to press a key now:
 yet you may ...
 
\backslash
n
\begin_inset Quotes erd
\end_inset

;
 
\end_layout

\begin_layout Plain Layout

  my($key);
 
\end_layout

\begin_layout Plain Layout

if(  defined( $key = ReadKey(-1) )  ) # this should not block 
\end_layout

\begin_layout Plain Layout

  { print 
\begin_inset Quotes eld
\end_inset

**Your Perl has a READ BLOCKING problem (accommodated)**
\backslash
n
\backslash
n
\begin_inset Quotes erd
\end_inset

;
\end_layout

\begin_layout Plain Layout

    $READKEYBLOCKINGPROBLEM = 1;
 
\end_layout

\begin_layout Plain Layout

  };
 
\end_layout

\begin_layout Plain Layout

  return($fail);
 
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
The subsidiary TestPair
\begin_inset space ~
\end_inset

().
 Because the reference dates supplied in 
\family typewriter
$Jref
\family default
 are Julian day numbers,
 we convert to seconds internally.
 A numeric value is returned—
1 for failure,
 0 for success.
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

sub TestPair # 
\end_layout

\begin_layout Plain Layout

{ my($name,
 $Jref,
 @SMART) = @_;
\end_layout

\begin_layout Plain Layout

  my($fail) = 0;
\end_layout

\begin_layout Plain Layout

  my($Zoff) = 0;
\end_layout

\begin_layout Plain Layout

  my($DST)  = 0;
\end_layout

\begin_layout Plain Layout

  my($delta) = 0.01;
 # 10ms.
 [explore]
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  $Jref *= 86400;
 # convert to seconds 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  my($J1) = Timely::ToJulian(@SMART,
 0,
 $Zoff,
 $DST);
 
\end_layout

\begin_layout Plain Layout

  my($diff) = $J1-$Jref;
 
\end_layout

\begin_layout Plain Layout

if( abs($diff) > $delta)
\end_layout

\begin_layout Plain Layout

  { $fail = 1;
\end_layout

\begin_layout Plain Layout

    Timely::XPrint(0,
  " -Failed- $name Julian test ($J1,
 d=$diff)
\backslash
n" );
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

  my(@GREG) = Timely::FullGregorian($J1,$Zoff,$DST,0);
\end_layout

\begin_layout Plain Layout

    # no GPS adjust so $DST is a redundant variable [fix me] 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

if(!
 &SameArray(
\backslash
@GREG,
 
\backslash
@SMART))  # avoid smart match.
 
\end_layout

\begin_layout Plain Layout

  { $fail = 1;
\end_layout

\begin_layout Plain Layout

    Timely::XPrint(0,
  " -Failed- $name Gregorian retest <@GREG>
\backslash
n" );
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

if(!
 $fail)
\end_layout

\begin_layout Plain Layout

  { Timely::XPrint(0,
 $name .
 $TICK .
 ' ');
  # eye candy
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

  return($fail);
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Note Note
status collapsed

\begin_layout Plain Layout
Perl smart match:
\end_layout

\begin_layout Plain Layout
http://stackoverflow.com/questions/1609467/in-perl-is-there-a-built-in-way-to-compare-two-arrays-for-equality
\end_layout

\begin_layout Plain Layout
$YY,$MM,$DD,$h,$m,$s
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Note Note
status collapsed

\begin_layout Plain Layout
The complexities of regex:
\end_layout

\begin_layout Plain Layout
If we say:
\end_layout

\begin_layout Plain Layout
perl -le "$A='foo$';$B='foo$';if($A =~ $B){print 'OK';}else{print 'Bah!';};"
\end_layout

\begin_layout Plain Layout
Then this will fail as $B is taken as regex,
 the $ is an end match,
 and so doesn't match the $ at the end of $A.
\end_layout

\begin_layout Plain Layout
The solution is quotemeta:
\end_layout

\begin_layout Plain Layout
perl -le "$A='foo$';$B='foo$';if($A =~ /
\backslash
Q$B
\backslash
E/){print 'OK';}else{print 'Bah!';};"
\end_layout

\begin_layout Plain Layout
Similarly:
\end_layout

\begin_layout Plain Layout
perl -le "@A=('foo$');@B=('foo$');$idx=0;if($A[$idx] =~ /
\backslash
Q$B[$idx]
\backslash
E/){print 'OK';}else{print 
\backslash
"Bah!()
\backslash
";};"
\end_layout

\end_inset


\end_layout

\begin_layout Standard
Check for identical arrays without smartmatch.
 It's sad that if you get rid of the `experimental' @A ~~ @B,
 you come up with something like:
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

sub SameArray # 
\end_layout

\begin_layout Plain Layout

{ my($rA,
 $rB) = @_;
 # two array references
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  my(@A) = @$rA;
\end_layout

\begin_layout Plain Layout

  my(@B) = @$rB;
\end_layout

\begin_layout Plain Layout

  my($aL) = scalar @A;
 
\end_layout

\begin_layout Plain Layout

if($aL != scalar @B)
\end_layout

\begin_layout Plain Layout

  { return(0);
 
\end_layout

\begin_layout Plain Layout

  };
 
\end_layout

\begin_layout Plain Layout

while($aL > 0)
\end_layout

\begin_layout Plain Layout

  { $aL --;
 
\end_layout

\begin_layout Plain Layout

  if($A[$aL] !~ /
\backslash
Q$B[$aL]
\backslash
E/) #note quotemeta 
\end_layout

\begin_layout Plain Layout

    { return(0);
\end_layout

\begin_layout Plain Layout

    };
 
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

  return(1);
 
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Section
Multitest
\begin_inset CommandInset label
LatexCommand label
name "sec:Multitest"

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
[?
 move elsewhere]
\end_layout

\end_inset


\end_layout

\begin_layout Standard
Fetch all transition points from 
\series bold
timely
\series default
 where ignored is 0 (not just end-of-year timestamps) and check them for that timezone.
\end_layout

\begin_layout Enumerate
SELECT region,
 transition FROM timely WHERE ignored = 0;
\end_layout

\begin_layout Enumerate
For each of these:
\end_layout

\begin_deeper
\begin_layout Enumerate
conver transition from microseconds to a Julian day number using HugeToJ
\begin_inset space ~
\end_inset

()
\end_layout

\begin_layout Enumerate
convert to Gregorian timestamp in our program using J2G
\begin_inset space ~
\end_inset

()
\end_layout

\begin_layout Enumerate
Similarly convert to tz timestamp;
 
\end_layout

\end_deeper
\begin_layout Enumerate
Compare the two,
 signal mismatch.
 
\end_layout

\begin_layout Standard
\begin_inset Separator plain
\end_inset


\end_layout

\begin_layout Standard
Have the option of constraining it to the current region;
 also v+n or v-n will add or subtract the specified number of seconds to each timestamp.
 
\begin_inset Note Note
status open

\begin_layout Plain Layout
[perhaps warn if trying the lot,
 as this will take time]
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
\begin_inset ERT
status open

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

 SELECT region,
 transition,
 description,
 ignored,
 GT(transition) FROM timely t 
\end_layout

\begin_layout Plain Layout

  INNER JOIN PLACES P on t.region = P.place WHERE ignored = 0
\end_layout

\begin_layout Plain Layout

  AND region = 3282;
 
\end_layout

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout
NB.
 At present we are reading in the transition,
\end_layout

\begin_layout Plain Layout
translating it to UTC in both systems and comparing the two.
\end_layout

\begin_layout Plain Layout
THE BIG ISSUE WITH v-1 IS THAT WITH THE AMBIGUITY tz TAKES US TO THE LATER DATE;
 my software uses the earlier one.
\end_layout

\begin_layout Plain Layout
The obvious solution here is for mine to do the same thing [or add DST DELTA].
\end_layout

\begin_layout Plain Layout
[explore alternative]
\end_layout

\begin_layout Plain Layout
==
\end_layout

\begin_layout Plain Layout
*look at
\end_layout

\begin_layout Plain Layout
v all
\end_layout

\begin_layout Plain Layout
== Several issues.
 Obvious is -ve DST problem,
 but there are more.
 Take each in turn.
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

sub Multitest #
\end_layout

\begin_layout Plain Layout

{ my($inp,
 $region) = @_;
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  my($handDB) = $smalltime_h;
  
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  my($q) = "SELECT region,
 transition,
 description FROM timely t 
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset

INNER JOIN PLACES P on t.region = P.place WHERE ignored = 0 "
\end_layout

\begin_layout Plain Layout

         .
 
\begin_inset Quotes eld
\end_inset

AND t.year < $TOPYEAR
\begin_inset Quotes erd
\end_inset

 ;
  ## limit top,
 prevent failure!
  
\end_layout

\begin_layout Plain Layout

  my($all) = 0;
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  # check v+ means add 1 second,
 v- subtracts
\end_layout

\begin_layout Plain Layout

  my($OFFSET) = 0;
 
\end_layout

\begin_layout Plain Layout

if($inp =~ /^
\backslash
+(
\backslash
d+)(.*)/)
\end_layout

\begin_layout Plain Layout

  { $OFFSET = 1000000*$1;
 # 1 second=1M
\end_layout

\begin_layout Plain Layout

    $inp = $2;
 # trim 
\end_layout

\begin_layout Plain Layout

  } 
\end_layout

\begin_layout Plain Layout

elsif($inp =~ /^(-
\backslash
d+)(.*)/) # [ugly]
\end_layout

\begin_layout Plain Layout

  { $OFFSET = 1000000*$1;
 # e.g.
 -1 s
\end_layout

\begin_layout Plain Layout

    $inp = $2;
 
\end_layout

\begin_layout Plain Layout

  };
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

if( $inp !~ /^
\backslash
s*all
\backslash
s*$/ ) # v all for the lot!
 
\end_layout

\begin_layout Plain Layout

  { $q .= 
\begin_inset Quotes eld
\end_inset

 and region = $region
\begin_inset Quotes erd
\end_inset

;
\end_layout

\begin_layout Plain Layout

  } else
\end_layout

\begin_layout Plain Layout

  { $all = 1;
\end_layout

\begin_layout Plain Layout

  };
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  my(@ZTRAN) = Timely::SQLManySQL($handDB,
 $q,
 'get zone transitions');
\end_layout

\begin_layout Plain Layout

  my($ERR) = 0;
\end_layout

\begin_layout Plain Layout

  my($ANOMALIES) = 0;
 
\end_layout

\begin_layout Plain Layout

  
\end_layout

\begin_layout Plain Layout

  my($ref);
 
\end_layout

\begin_layout Plain Layout

foreach $ref(@ZTRAN)
\end_layout

\begin_layout Plain Layout

  { my($zid,
 $TR,
 $rName) = @$ref;
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

    my($JD) = Timely::HugeToJ($TR+$OFFSET);
\end_layout

\begin_layout Plain Layout

    my($YYYY,$MM,$DD,$h,$m,$s,
 $dz,
 $dst,
 $hog,
 $deltz,
 $delds) 
\end_layout

\begin_layout Plain Layout

       = Timely::J2G(0,
 $zid,
 $JD);
 # JD is Gps-based,
 $dst is DST,
 and 
\end_layout

\begin_layout Plain Layout

       # $hog is zero unless we're in the groundhog hour.
 
\end_layout

\begin_layout Plain Layout

  if($YYYY == 0)  # anomalous date
\end_layout

\begin_layout Plain Layout

    { Timely::XPrint( 0,
 "
\backslash
n     'Out of range' date skipped:
 $zid/$rName 
\begin_inset Quotes eld
\end_inset

 
\end_layout

\begin_layout Plain Layout

             .
 &JulianDay($JD) );
 
\end_layout

\begin_layout Plain Layout

      $ANOMALIES ++;
\end_layout

\begin_layout Plain Layout

    } else
\end_layout

\begin_layout Plain Layout

    { my($mine) = Timely::Greg($JD,0,0,1);
  # standard date,
 then in TZ!
\end_layout

\begin_layout Plain Layout

      $mine =~ s/ /T/;
  # replace ' ' with 'T'
\end_layout

\begin_layout Plain Layout

      my($yours) =  Timely::FetchTzDate($JD,
 $rName,
 $YYYY,
 $MM,
 $DD,
 $h,
 $m,
 $s);
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim} 
\end_layout

\end_inset


\end_layout

\begin_layout Standard
If there's a mismatch,
 first check whether we're in the `groundhog' zone ($hog is non-zero).
 A simple example would be where DST has gone from 1 hour to zero.
 There are then two Julian times that correspond to a single wall time.
 Let's say the transition is at midnight:
 then each wall time in the range 11:00:00 to midnight (not including midnight) will have two Julian values.
 At the precise moment that we reach midnight the first time around,
 we jump back,
 so this Julian and that one hour earlier will correspond.
 The earlier time is signalled by $hog = -1,
 the later by 1.
 
\end_layout

\begin_layout Standard
There is a subtlety here.
 In translating Julian to Gregorian,
 I choose the earlier wall time;
 but where tz translates a wall time to UTC,
 as is performed by FetchTzDate
\begin_inset space ~
\end_inset

(),
 the later of the two timestamps is returned.
 We need to check for this discordance,
 and adjust.
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

    if($mine ne $yours)
\end_layout

\begin_layout Plain Layout

      { 
\end_layout

\begin_layout Plain Layout

      if($hog)  # $hog != 0 
\end_layout

\begin_layout Plain Layout

        { # crude hack [explore simply using delta values]
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

          # assume that:
 A.
 there are two dates
\end_layout

\begin_layout Plain Layout

          #              B.
 My program returned the earlier one
\end_layout

\begin_layout Plain Layout

          #              C.
 tz returned the later one
\end_layout

\begin_layout Plain Layout

          #              D.
 the discrepancy is ($deltz + $delds)
\end_layout

\begin_layout Plain Layout

          # E.g.
 Zone went back 2 h from +3 to +1 and DST went forward by 1 h,
 
\end_layout

\begin_layout Plain Layout

          #   then deltz = -2 and delds = 1,
 effectively back -1 hour.
\end_layout

\begin_layout Plain Layout

          #   Advance by the NEGATIVE of this value (tz takes the second time) 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

          my($truedelta) = $hog * ($deltz + $delds);
 # as is shadow,
 will be -ve.
 
\end_layout

\begin_layout Plain Layout

          my($fixmine) = Timely::Greg($JD,
 $truedelta,
 0,
 1);
 # adjust 
\begin_inset Quotes eld
\end_inset

as if
\begin_inset Quotes erd
\end_inset

 zone 
\end_layout

\begin_layout Plain Layout

          $fixmine =~ s/ /T/;
 
\end_layout

\begin_layout Plain Layout

        if($fixmine ne $yours)
\end_layout

\begin_layout Plain Layout

          { $ERR ++;
 
\end_layout

\begin_layout Plain Layout

            Timely::XPrint( 0,
 
\begin_inset Quotes eld
\end_inset


\backslash
nBad transition $rName(
\begin_inset Quotes eld
\end_inset

 .
 &JulianDay($JD) 
\end_layout

\begin_layout Plain Layout

                      .
 
\begin_inset Quotes eld
\end_inset

,$hog),
 mine=$mine tz=$yours,
 dz=
\begin_inset Quotes erd
\end_inset

 .
 &Tim($deltz) 
\end_layout

\begin_layout Plain Layout

                      .
 
\begin_inset Quotes eld
\end_inset

 dd=
\begin_inset Quotes erd
\end_inset

 .
 &Tim($delds) .
 
\begin_inset Quotes eld
\end_inset

,
 failed fix=$fixmine,
 Z=
\begin_inset Quotes erd
\end_inset

 
\end_layout

\begin_layout Plain Layout

                      .
 &Tim($dz) .
 
\begin_inset Quotes eld
\end_inset

,
 DST=
\begin_inset Quotes erd
\end_inset

 .
 &Tim($dst) );
 
\end_layout

\begin_layout Plain Layout

            ##Timely::XPrint(0,
 
\begin_inset Quotes eld
\end_inset


\backslash
n Transition Mismatch [ $mine | $yours,
 $rName($hog) { 
\begin_inset Quotes eld
\end_inset


\end_layout

\begin_layout Plain Layout

            ##           .
 &Tim($deltz) .
 ' ' .
 &Tim($delds) .
 
\begin_inset Quotes eld
\end_inset

 } ] 
\begin_inset Quotes erd
\end_inset

);
 # HMMM ???
 
\end_layout

\begin_layout Plain Layout

          };
 
\end_layout

\begin_layout Plain Layout

          #
\end_layout

\begin_layout Plain Layout

          print &Sign($hog);
 # + or - 
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
Otherwise,
 handle error:
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

        } else
\end_layout

\begin_layout Plain Layout

        { $ERR ++;
 
\end_layout

\begin_layout Plain Layout

        if(length $yours < 1)
\end_layout

\begin_layout Plain Layout

          { $yours = '?';
 
\end_layout

\begin_layout Plain Layout

          } else
\end_layout

\begin_layout Plain Layout

          { Timely::XPrint(0,
 
\begin_inset Quotes eld
\end_inset


\backslash
n
\begin_inset Quotes erd
\end_inset

);
 
\end_layout

\begin_layout Plain Layout

          };
 
\end_layout

\begin_layout Plain Layout

          Timely::XPrint( 0,
 
\begin_inset Quotes eld
\end_inset

Mismatch for $rName($JD):
 mine=$mine,
 tz=$yours (
\begin_inset Quotes eld
\end_inset

 
\end_layout

\begin_layout Plain Layout

                   .
 Timely::PrettyDate(0,$YYYY,$MM,$DD,$h,$m,$s) 
\end_layout

\begin_layout Plain Layout

                   .
 ') z=' .
 &Tim($dz) .
 ' d=' .
 &Tim($dst) .
 ' ' );
 
\end_layout

\begin_layout Plain Layout

        };
 
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
Repeat,
 end off:
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

      } else
\end_layout

\begin_layout Plain Layout

      { print '.';
 
\end_layout

\begin_layout Plain Layout

      };
 
\end_layout

\begin_layout Plain Layout

    };
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

  Timely::XPrint(0,
 "Errors=$ERR,
 $ANOMALIES anomalies
\backslash
n
\backslash
n");
 
\end_layout

\begin_layout Plain Layout

}  
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Section
Utilities
\end_layout

\begin_layout Subsection
Exit
\end_layout

\begin_layout Standard
The supplied 
\family typewriter
code
\family default
 value can be 
\emph on
text
\emph default
,
 although the default is 0.
 
\begin_inset Note Note
status open

\begin_layout Plain Layout
[nasty,
 explore]
\end_layout

\end_inset

 When we exit,
 however,
 we return that 0,
 or if non-zero,
 a failure code of 2.
 We must only COMMIT if the supplied code is zero.
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

sub ImplementExit #
\end_layout

\begin_layout Plain Layout

{ my($code) = @_;
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

if($code)
\end_layout

\begin_layout Plain Layout

  { $code = 2;
 # if non-zero [nasty,
 $code can be text [hmm] explore]
\end_layout

\begin_layout Plain Layout

  } else
\end_layout

\begin_layout Plain Layout

  { my($qc) = "COMMIT";
 
\end_layout

\begin_layout Plain Layout

    my($fail) = Timely::DoSQL($DATABASES{$BASEDATABASE},
 $qc,
 'commit');
 
\end_layout

\begin_layout Plain Layout

    &Print(0,
 "
\backslash
n  Result of commit:
 $fail");
 
\end_layout

\begin_layout Plain Layout

  if($fail)
\end_layout

\begin_layout Plain Layout

    { $code = $fail;
\end_layout

\begin_layout Plain Layout

    };
 
\end_layout

\begin_layout Plain Layout

  };
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  my(@WARNS) = Timely::ListWarnings();
 
\end_layout

\begin_layout Plain Layout

  Timely::XPrint(0,
 "
\backslash
nWarning counts:
 
\backslash
n -
\backslash
t*
\backslash
t**
\backslash
t***
\backslash
n " .
 join("
\backslash
t",@WARNS) );
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  my($db);
\end_layout

\begin_layout Plain Layout

foreach $db (keys(%DATABASES)) 
\end_layout

\begin_layout Plain Layout

  { DoClose( $db );
 
\end_layout

\begin_layout Plain Layout

    &Print(2,
 "
\backslash
n  Closed $db");
 
\end_layout

\begin_layout Plain Layout

  };
 
\end_layout

\begin_layout Plain Layout

  print "
\backslash
n Goodbye($code).
 
\backslash
n";
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  Timely::EndTimely();
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  exit($code);
   
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Subsubsection
Actually close database
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

sub DoClose #
\end_layout

\begin_layout Plain Layout

{ my($dbname);
\end_layout

\begin_layout Plain Layout

    ($dbname)=@_;
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  $DATABASES{$dbname}->disconnect();
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  delete($DATABASES{$dbname});
 # remove associative entry
\end_layout

\begin_layout Plain Layout

  &Print(2,
 " :
 ODBC,
 Closed $dbname");
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Subsection
Sign
\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
[clumsy,
 also present in timely_400.lyx ]
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

sub Sign # 
\end_layout

\begin_layout Plain Layout

{ my($n) = @_;
\end_layout

\begin_layout Plain Layout

if($n < 0)
\end_layout

\begin_layout Plain Layout

  { return('-');
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

  return('+');
 
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Subsection
DoWarn
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

sub DoWarn #
\end_layout

\begin_layout Plain Layout

{ my($level,
 $msg) = @_;
\end_layout

\begin_layout Plain Layout

  Timely::Warn($level,
 $msg);
 
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Subsection
Print
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

sub Print #
\end_layout

\begin_layout Plain Layout

{ my($level,
 $msg) = @_;
\end_layout

\begin_layout Plain Layout

  Timely::XPrint($level,
 $msg);
 
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Subsection
Aagh (modified)
\begin_inset CommandInset label
LatexCommand label
name "sec:Aagh"

\end_inset


\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

sub Aagh # 
\end_layout

\begin_layout Plain Layout

{ my($msg,
 $line,
 $foo);
\end_layout

\begin_layout Plain Layout

    ($msg,
 $line,
 $foo)=@_;
\end_layout

\begin_layout Plain Layout

  Timely::Aagh($msg,
 $line,
 $foo);
 
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Subsubsection
Short-term warning counts
\end_layout

\begin_layout Standard
Very simple at present,
 but we should consider recording the changes for the different levels,
 and not just a global count [explore].
 
\end_layout

\begin_layout Paragraph
Clear the count
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

sub ClearNewWarnings #
\end_layout

\begin_layout Plain Layout

{ $LOCALS{'wArnings'} = Timely::GetNewWarnings();
 
\end_layout

\begin_layout Plain Layout

  Timely::ClearWarnings();
 
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Section
Pre-processing
\begin_inset CommandInset label
LatexCommand label
name "sec:Pre-processing-preargs"

\end_inset


\end_layout

\begin_layout Standard
We allow command-line args.
 The options that we're interested in are along these lines:
 
\end_layout

\begin_layout Quote

\family typewriter
\series bold
perl seek.pl user=2001;
 
\end_layout

\begin_layout Standard
\begin_inset Separator plain
\end_inset


\end_layout

\begin_layout Standard
The terminal semicolon after arguments is optional.
 The options relevant to small_time are listed in Section
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand ref
reference "sec:Parse-single-pre-arg"
plural "false"
caps "false"
noprefix "false"
nolink "false"

\end_inset

.
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

sub PreArgs
\end_layout

\begin_layout Plain Layout

{ 
\end_layout

\begin_layout Plain Layout

foreach my $arg (@ARGV) 
\end_layout

\begin_layout Plain Layout

  { ParseOneArg($arg);
\end_layout

\begin_layout Plain Layout

  };
 
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
\begin_inset ERT
status open

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  my $i = 0;
\end_layout

\begin_layout Plain Layout

  print 
\begin_inset Quotes eld
\end_inset

Debug:
 argument count=
\begin_inset Quotes erd
\end_inset

 .
 $#ARGV .
 
\begin_inset Quotes eld
\end_inset


\backslash
n
\begin_inset Quotes erd
\end_inset

;
 
\end_layout

\begin_layout Plain Layout

while($i <= $#ARGV) # initial value -1 if no arguments.
\end_layout

\begin_layout Plain Layout

  { print 
\begin_inset Quotes eld
\end_inset

Debug:
 ARGUMENT $i is $ARGV[$i]
\backslash
n
\begin_inset Quotes erd
\end_inset

;
 
\end_layout

\begin_layout Plain Layout

    ParseOneArg($i,
 $ARGV[$i]);
 
\end_layout

\begin_layout Plain Layout

    $i ++;
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  ## $FORCE_UNSEEN = 0;
  # retired.
 
\end_layout

\begin_layout Plain Layout

  $THISPLACE = 0;
              # Current location:
 numeric code.
 
\end_layout

\begin_layout Plain Layout

  $BASESCRIPTNAME = 'sos';
 
\end_layout

\begin_layout Plain Layout

  $USERID = $default_user;
 
\end_layout

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Subsection
Parse single pre-arg
\begin_inset CommandInset label
LatexCommand label
name "sec:Parse-single-pre-arg"

\end_inset


\end_layout

\begin_layout Standard
The current options are:
\end_layout

\begin_layout Description
user= (Specify numeric identity of user cf.
 $USERID);
\end_layout

\begin_layout Description
db= (Identity of database e.g.
 fehr;
 currently defaults to SMALLTIME) 
\end_layout

\begin_layout Description
leapseconds= (Current number of leapseconds);
 
\end_layout

\begin_layout Description
topyear= alter $TOPYEAR,
 should not be under current year (Hmm,
 use with great caution).
 
\end_layout

\begin_layout Description
\begin_inset ERT
status open

\begin_layout Plain Layout

--
\end_layout

\end_inset

help
\end_layout

\begin_layout Standard
\begin_inset Separator plain
\end_inset


\end_layout

\begin_layout Standard
In this implementation,
 unlike in 
\series bold
vector seekwell
\series default
,
 we don't specify a script (sos=) nor do we allow a script line at the start.
 We allow some flexibility here—
a comma can separate arguments,
 which can be in any order.
 Note that my original code allowed semicolons (in Windows) but these have a special meaning on the Linux command line,
 hence the current use of commas!
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger 
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

sub ParseOneArg # 
\end_layout

\begin_layout Plain Layout

{ my ($arg) = @_;
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  # Extract specific pairs,
 first database:
 
\end_layout

\begin_layout Plain Layout

if($arg =~ s/db=(
\backslash
w+),?//) 
\end_layout

\begin_layout Plain Layout

{  $BASEDATABASE = $1;
\end_layout

\begin_layout Plain Layout

   # print "
\backslash
nDebug:
 TARGET DATABASE set to $BASEDATABASE
\backslash
n";
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout

  
\end_layout

\begin_layout Plain Layout

if($arg =~ s/user=(
\backslash
d+),?//) # Extract User ID
\end_layout

\begin_layout Plain Layout

  { $USERID = $1;
\end_layout

\begin_layout Plain Layout

    # print "
\backslash
nDebug:
 User set to $USERID
\backslash
n";
\end_layout

\begin_layout Plain Layout

  }
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

if($arg =~ s/leapseconds=(
\backslash
d+),?//)   # Extract Leapseconds
\end_layout

\begin_layout Plain Layout

  { $LEAPSECONDS = $1;
\end_layout

\begin_layout Plain Layout

    # print "
\backslash
nDebug:
 LEAPSECOND COUNT = $LEAPSECONDS
\backslash
n";
\end_layout

\begin_layout Plain Layout

  }
\end_layout

\begin_layout Plain Layout

  
\end_layout

\begin_layout Plain Layout

if($arg =~ s/topyear=(
\backslash
d{4}),?//)   # Extract year maximum
\end_layout

\begin_layout Plain Layout

  { $TOPYEAR = $1;
\end_layout

\begin_layout Plain Layout

  if($TOPYEAR < 2026)
\end_layout

\begin_layout Plain Layout

    { exit(BadTopYear);
 
\end_layout

\begin_layout Plain Layout

    };
 
\end_layout

\begin_layout Plain Layout

    # print "
\backslash
nDebug:
 TOP YEAR = $TOPYEAR
\backslash
n";
\end_layout

\begin_layout Plain Layout

  }
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

if($arg =~ /--help/) 
\end_layout

\begin_layout Plain Layout

  { print "
\backslash
nCommand-line examples:
\backslash
n user=2000 db=fehr leapseconds=27
\begin_inset Quotes erd
\end_inset


\end_layout

\begin_layout Plain Layout

        .
 
\begin_inset Quotes eld
\end_inset


\backslash
n";
\end_layout

\begin_layout Plain Layout

    exit(OnlyHelp);
 # 
\end_layout

\begin_layout Plain Layout

  }
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

if($arg =~ /^
\backslash
s*$/) # nothing of consequence
\end_layout

\begin_layout Plain Layout

  { return;
 
\end_layout

\begin_layout Plain Layout

  };
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  print(
\begin_inset Quotes eld
\end_inset

Unused residual command-line argument:
 '$arg'
\backslash
n
\begin_inset Quotes erd
\end_inset

);
 
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
This is fairly flexible,
 allowing terminal semicolons or even omission of spaces between;
 but ideally we should simply put in spaces and omit semicolons.
 
\end_layout

\begin_layout Standard
\begin_inset Note Note
status collapsed

\begin_layout Plain Layout
The original:
\end_layout

\begin_layout Plain Layout
\begin_inset ERT
status open

\begin_layout Plain Layout

sub ParseOneArg
\end_layout

\begin_layout Plain Layout

{ my($i,
 $arg) = @_;
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

 ## print 
\begin_inset Quotes eld
\end_inset


\backslash
nDebug:
 command-line argument $i is $arg
\begin_inset Quotes erd
\end_inset

;
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

if($arg =~ /(.*)db=(
\backslash
w+),?(.*)/ ) 
\end_layout

\begin_layout Plain Layout

  { $BASEDATABASE = $2;
 
\end_layout

\begin_layout Plain Layout

    $arg = 
\begin_inset Quotes eld
\end_inset

$1$3
\begin_inset Quotes erd
\end_inset

;
 
\end_layout

\begin_layout Plain Layout

    ## print( 
\begin_inset Quotes eld
\end_inset


\backslash
nDebug:
 TARGET DATABASE set to $BASEDATABASE 
\begin_inset Quotes erd
\end_inset

 );
 
\end_layout

\begin_layout Plain Layout

  };
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

if($arg =~ /(.*)user=(
\backslash
d+),?(.*)/ )
\end_layout

\begin_layout Plain Layout

  { $USERID = $2;
\end_layout

\begin_layout Plain Layout

    $arg = 
\begin_inset Quotes eld
\end_inset

$1$3
\begin_inset Quotes erd
\end_inset

;
 
\end_layout

\begin_layout Plain Layout

    ## print( 
\begin_inset Quotes eld
\end_inset


\backslash
nDebug:
 User set to $USERID 
\begin_inset Quotes erd
\end_inset

 );
 
\end_layout

\begin_layout Plain Layout

  };
 # 
\end_layout

\begin_layout Plain Layout

  
\end_layout

\begin_layout Plain Layout

if( $arg =~ /(.*)leapseconds=(
\backslash
d+),?(.*)/ )
\end_layout

\begin_layout Plain Layout

  { $LEAPSECONDS = $2;
 
\end_layout

\begin_layout Plain Layout

    $arg = 
\begin_inset Quotes eld
\end_inset

$1$3
\begin_inset Quotes erd
\end_inset

;
 
\end_layout

\begin_layout Plain Layout

    ## print( 
\begin_inset Quotes eld
\end_inset


\backslash
nDebug:
 LEAPSECOND COUNT = $1 
\begin_inset Quotes erd
\end_inset

 );
 
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

if( (length $arg < 1)
\end_layout

\begin_layout Plain Layout

  ||($arg =~ /^
\backslash
s+$/) # nothing of consequence
\end_layout

\begin_layout Plain Layout

  )
\end_layout

\begin_layout Plain Layout

  { return;
 
\end_layout

\begin_layout Plain Layout

  };
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

if($arg =~ '--help')
\end_layout

\begin_layout Plain Layout

  { print( 
\begin_inset Quotes eld
\end_inset


\backslash
nCommand-line examples:
\backslash
n user=2000 db=fehr leapseconds=27
\begin_inset Quotes erd
\end_inset

 .
\end_layout

\begin_layout Plain Layout

           
\begin_inset Quotes eld
\end_inset


\backslash
n
\begin_inset Quotes erd
\end_inset

 );
 
\end_layout

\begin_layout Plain Layout

    exit(OnlyHelp);
 
\end_layout

\begin_layout Plain Layout

  };
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

  print(
\begin_inset Quotes eld
\end_inset

Unused residual command-line argument:
 '$arg'
\backslash
n
\begin_inset Quotes erd
\end_inset

);
 
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout
here's Gemini's rewrite:
\end_layout

\begin_layout Plain Layout
\begin_inset ERT
status open

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

sub ParseOneArg {
\end_layout

\begin_layout Plain Layout

    # Using a reference or a direct scalar to modify the argument in place
\end_layout

\begin_layout Plain Layout

    my ($arg) = @_;
\end_layout

\begin_layout Plain Layout

    return unless defined $arg;
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

    # 1.
 Handle Help immediately
\end_layout

\begin_layout Plain Layout

    if ($arg =~ /--help/) {
\end_layout

\begin_layout Plain Layout

        print "
\backslash
nCommand-line examples:
\backslash
n user=2000;
 db=fehr;
 leapseconds=27;
\backslash
n";
\end_layout

\begin_layout Plain Layout

        exit(0);
 # Replace 'OnlyHelp' with your actual exit constant
\end_layout

\begin_layout Plain Layout

    }
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

    # 2.
 Extract specific pairs.
 
\end_layout

\begin_layout Plain Layout

    # We use /s (single line) and /i (case insensitive) if desired.
\end_layout

\begin_layout Plain Layout

    # The 's///' operator removes the match from $arg,
 cleaning it as we go.
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

    # Extract Database
\end_layout

\begin_layout Plain Layout

    if ($arg =~ s/db=(
\backslash
w+);?//) {
\end_layout

\begin_layout Plain Layout

        $BASEDATABASE = $1;
\end_layout

\begin_layout Plain Layout

        # print "
\backslash
nDebug:
 TARGET DATABASE set to $BASEDATABASE
\backslash
n";
\end_layout

\begin_layout Plain Layout

    }
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

    # Extract User ID
\end_layout

\begin_layout Plain Layout

    if ($arg =~ s/user=(
\backslash
d+);?//) {
\end_layout

\begin_layout Plain Layout

        $USERID = $1;
\end_layout

\begin_layout Plain Layout

        # print "
\backslash
nDebug:
 User set to $USERID
\backslash
n";
\end_layout

\begin_layout Plain Layout

    }
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

    # Extract Leapseconds
\end_layout

\begin_layout Plain Layout

    if ($arg =~ s/leapseconds=(
\backslash
d+);?//) {
\end_layout

\begin_layout Plain Layout

        $LEAPSECONDS = $1;
\end_layout

\begin_layout Plain Layout

        # print "
\backslash
nDebug:
 LEAPSECOND COUNT = $LEAPSECONDS
\backslash
n";
\end_layout

\begin_layout Plain Layout

    }
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

    # 3.
 Final cleanup:
 Remove whitespace and check if anything meaningful is left
\end_layout

\begin_layout Plain Layout

    $arg =~ s/^
\backslash
s+|
\backslash
s+$//g;
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

    if (length $arg > 0) {
\end_layout

\begin_layout Plain Layout

        print "Unused residual command-line argument:
 '$arg'
\backslash
n";
\end_layout

\begin_layout Plain Layout

    }
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Chapter
Batch files
\begin_inset CommandInset label
LatexCommand label
name "chap:Batch-files"

\end_inset


\end_layout

\begin_layout Standard
These require the usual 
\series bold
\emph on
smalltime
\series default
\emph default
 installation.
 In LyX,
 say File | Export | LaTeX(XeTeX) for both timely_400.lyx and small_time_400.lyx.
 
\end_layout

\begin_layout Standard
The first time,
 within the 
\emph on
~/smalltime/
\emph default
 directory ensure that 
\emph on
Dogwagger405.pl
\emph default
 is present,
 and say:
 
\end_layout

\begin_layout Quote

\family typewriter
\series bold
perl ./Dogwagger405.pl small_time_400.tex
\end_layout

\begin_layout Standard
\begin_inset Separator plain
\end_inset


\end_layout

\begin_layout Standard
Subsequently,
 the following batch files should work.
 
\end_layout

\begin_layout Section
makesmall.sh
\end_layout

\begin_layout Standard
Once created,
 run this by saying 
\family typewriter
\series bold
bash makesmall.sh
\family default
\series default
 from the Linux command line.
 For Windows,
 see later.
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger newTarget=`makesmall.sh' startComment=`# ' noWarn=`yes' startFile=`#!/bin/bash
\backslash
n' noTail=`yes'
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

  perl ./Dogwagger405.pl timely_400.tex
\end_layout

\begin_layout Plain Layout

if [ $?
 -ne 0 ]
\end_layout

\begin_layout Plain Layout

then 
\end_layout

\begin_layout Plain Layout

  echo Script aborted.
\end_layout

\begin_layout Plain Layout

  exit 1
\end_layout

\begin_layout Plain Layout

fi 
\end_layout

\begin_layout Plain Layout

  perl ./Dogwagger405.pl small_time_400.tex
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
The 
\family typewriter
if [ $?
 -ne ...

\family default
 instruction tests for the error code returned by the Perl script if it fails.
 
\end_layout

\begin_layout Section
makesmall.bat
\begin_inset CommandInset label
LatexCommand label
name "subsec:up.bat"

\end_inset


\end_layout

\begin_layout Standard
This extracts files from the current .tex file.
 Run from the Windows command line by simply saying 
\family typewriter
\series bold
make
\family default
\series default
 :
 
\begin_inset Note Note
status open

\begin_layout Plain Layout
1,025,000
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger newTarget=`makesmall.bat' startComment=`rem ' noWarn=`yes'
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

    echo off
\end_layout

\begin_layout Plain Layout

    cls
\end_layout

\begin_layout Plain Layout

    perl Dogwagger405.pl timely_400.tex || (goto :FAILED) 
\end_layout

\begin_layout Plain Layout

    perl Dogwagger405.pl small_time_400.tex || (goto :FAILED) 
\end_layout

\begin_layout Plain Layout

    echo Success!
\end_layout

\begin_layout Plain Layout

    exit /b 0 
\end_layout

\begin_layout Plain Layout

:FAILED
\end_layout

\begin_layout Plain Layout

    echo Error level was %errorlevel% 
\end_layout

\begin_layout Plain Layout

    exit /b %errorlevel% 
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
(Note that because we overwrite the file while it's executing as a batch,
 you might occasionally encounter some anomalies).
 
\end_layout

\begin_layout Section
runsmall.sh
\end_layout

\begin_layout Standard
This assumes we're in ~/smalltime/ and a copy of Dogwagger405.pl is present in this directory.
 There say:
\end_layout

\begin_layout Quote

\family typewriter
bash runsmall.sh
\end_layout

\begin_layout Standard
The following could be fancied up a bit.
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger newTarget=`runsmall.sh' startComment=`# ' noWarn=`yes' startFile=`#!/bin/bash
\backslash
n' noTail=`yes'
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

  cd perl 
\end_layout

\begin_layout Plain Layout

  perl small.pl 
\end_layout

\begin_layout Plain Layout

  cd ..
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Section
runsmall.bat
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\end_layout

\begin_layout Plain Layout

% Dogwagger newTarget=`runsmall.bat' startComment=`rem ' noWarn=`yes'
\end_layout

\begin_layout Plain Layout


\backslash
begin{verbatim}
\end_layout

\begin_layout Plain Layout

    cls
\end_layout

\begin_layout Plain Layout

    cd perl
\end_layout

\begin_layout Plain Layout

    perl small.pl
\end_layout

\begin_layout Plain Layout

    cd ..
\end_layout

\begin_layout Plain Layout

    rem that's it
\end_layout

\begin_layout Plain Layout


\backslash
end{verbatim}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
==
\end_layout

\begin_layout Plain Layout
== END OF THE MAIN SECTION ==
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\start_of_appendix
\begin_inset ERT
status open

\begin_layout Plain Layout

% this is the appendix.
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\align right
\begin_inset Formula $\blacksquare$
\end_inset


\end_layout

\begin_layout Chapter
Problems & To Do List
\end_layout

\begin_layout Section
Gotchas
\end_layout

\begin_layout Standard
NB.
 If your Perl date/time is not up to date with the current IANA tz rules,
 then discrepancies will abound.
\end_layout

\begin_layout Enumerate
Currently we need DELETE option permitted for the ODBC-associated user (e.g.
 `vanilla').
 Otherwise perl may crash.
 
\end_layout

\begin_layout Enumerate
If the initial running of 
\family typewriter
perl small.pl
\family default
 fails,
 then we may be left with residual rows in some tables,
 as currently the failure isn't transmitted to the caller,
 and the commit still seems to happen.
 If this happens,
 then manually enter mariadb/mysql and delete everything in tz_cutoffs,
 tz_rules,
 timely and leapseconds.
 ALSO SAY:
\end_layout

\begin_deeper
\begin_layout Quote

\family typewriter
DELETE FROM PLACES WHERE place BETWEEN 1 AND 999;
\end_layout

\begin_layout Quote
Caution is clearly advised.
 
\end_layout

\end_deeper
\begin_layout Chapter
Amendment Log
\end_layout

\begin_layout Section
Version 1.0
\end_layout

\begin_layout Standard
This is the base version.
 
\end_layout

\begin_layout Section
Version 4.0
\end_layout

\begin_layout Standard
A sudden jump to synch with timely 4.0 (Okay,
 I know).
 The main idea here is a substantial revision,
 hoiking all of the user-interface-based stuff out of the timely Perl module—
it didn't really belong there in a module.
 
\end_layout

\begin_layout Enumerate
Write an into that describes:
\end_layout

\begin_deeper
\begin_layout Enumerate
The absolute minimum files (timely,
 PLACES) with contents (put these up on GitHub too)
\end_layout

\begin_layout Enumerate
How to move these from 
\series bold
smalltime
\series default
 to another database such as 
\series bold
\emph on
f
\emph default
ehr
\series default
,
 honouring place identities.
 
\end_layout

\end_deeper
\begin_layout Enumerate
Write 
\emph on
runsmall.sh
\emph default
 
\end_layout

\begin_layout Enumerate
Must still test:
\end_layout

\begin_deeper
\begin_layout Enumerate
Check using:
 
\family typewriter
v all
\family default
 ;
 Initially had problems with new zone:
 America/Coyhaique [explore] This was because the Perl version was not completely up to date:
 
\end_layout

\begin_deeper
\begin_layout Quote

\family typewriter
The timezone 'America/Coyhaique' could not be loaded,
 or is an invalid name
\end_layout

\begin_layout Quote
In other words,
 our tz version is more recent than the Perl 
\begin_inset Quotes eld
\end_inset

reference
\begin_inset Quotes erd
\end_inset

 one!
 
\end_layout

\begin_layout Quote
[The `problem' disappears when the Perl is updated by:
 
\family typewriter
sudo cpanm DateTime::TimeZone
\family default
 ]
\end_layout

\end_deeper
\end_deeper
\begin_layout Enumerate
Need to support cmd line parameters NB.
 database name [ok] 
\end_layout

\begin_layout Standard
\begin_inset Separator plain
\end_inset


\end_layout

\end_body
\end_document
